//>>built
define("com/huayun/edit/components/EditPanel","dojo/request ../../webgis/Map ../../webgis/views/SceneView ../../webgis/layers/EditFeatureLayer ../../util/WKTGeometryFormater ../../webgis/geometry/Point ../../webgis/geometry/Polyline ../../webgis/geometry/Extent".split(" "),function(f,g,h,k,l,n,p,m){function e(a){this.container=a.container;this.dataSourceVo=a.dataSourceVo;this.mapVo=a.mapVo;this.wktGeometryFormatter=new l;this.service=this.dataSourceVo.services[this.mapVo.workspace];this.token=a.token;
this.filter=a.filter;this.currentEditTarget=a.currentEditTarget;this.editController=a.editController;this.mapId=a.mapId;this.addComplete=a.addComplete;this.selectedHook=a.selectedHook;this.lastEditTarget=null;this.editType="";var c=a.bgColor;this.map=new g;this.view=new h({container:a.container,map:this.map,backgroundColor:"rgb("+c+")"});this.query={url:this.service.description,filter:"map_id\x3d"+this.filter.mapId,access_token:this.token};this.filter?f(this.service.description+"SCH_MAP_INSTANCE?filter\x3dmap_id\x3d"+
this.filter.mapId+"\x26access_token\x3d"+this.token,{handleAs:"json"}).then(function(a){this.polygon=this.wktGeometryFormatter.toGeometry(a.data[0].SHAPE);this.view.setExtent(this.polygon.extent);this.createEditFeatureLayer(this.mapVo.layerVoList);this.view.refresh()}.bind(this)):(a=new m(0,0,this.container.clientWidth,this.container.clientHeight),this.view.setExtent(a),this.createEditFeatureLayer(this.mapVo.layerVoList),this.view.refresh());this.clickTimeId=null;this.view.domNode.addEventListener("click",
function(a){var c=this.view.screenToGeometry(a.clientX,a.clientY),b=this.view.queryGraphicsByGeometry(c,8);0<b.length&&(b=b[0],this.editController.currentEditLayer=b.layer.owner.owner,this.selectedHook.call(this,b));null!==this.currentEditTarget&&(clearTimeout(this.clickTimeId),this.clickTimeId=setTimeout(function(a){a=this._getCurrentEditFeatureLayer(this.currentEditTarget.name,this.currentEditTarget.viewId);this.editController.currentEditLayer=a;switch(this.editType){case "add":var b=this._createAttributes();
this._updateAttributes(b);this.editController.add({geoType:a.geoType,currentEditLayer:a,symbol:this.currentEditTarget.symbol,attributes:b,geometry:c});this.addComplete.call(this,b)}this.lastEditTarget=this.currentEditTarget}.bind(this,a),250))}.bind(this));this.view.domNode.addEventListener("dblclick",function(a){clearTimeout(this.clickTimeId);this.editController.endDraw()}.bind(this))}e.prototype.createEditFeatureLayer=function(a){for(var c=0,b=a.length;c<b;c++){var d=a[c];d.id="EditFeatureLayer_"+
c;d.query=this.query;d=new k(d,function(a){});this.map.addLayer(d)}};e.prototype.update=function(a){this.currentEditTarget=a.currentEditTarget;this.editType=a.type};e.prototype.delete=function(a){this.editController.delete(a)};e.prototype._updateAttributes=function(a){for(var c=0;c<a.length;c++){var b=a[c];"map_id"===b.name&&(b.value=this.mapId)}};e.prototype._getCurrentEditFeatureLayer=function(a,c){for(var b=0;b<this.map.allLayers.length;b++){var d=this.map.allLayers[b];if(d.name===a&&d.viewId===
c)return d}return null};e.prototype._createAttributes=function(){for(var a=[],c=0;c<this.currentEditTarget.attributes.length;c++){var b=this.currentEditTarget.attributes[c];a[a.length]={name:b.name,value:b.value}}return a};return e});