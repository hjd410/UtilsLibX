//>>built
define("com/huayun/widget/charts/AreaMap",["dojo/request","../../thematicmap/tool/FileParse","../../webgis/Map","../../webgis/views/SceneView","../../webgis/layers/FeatureLayer","../../webgis/layers/LabelLayer","../../util/JSONFormatterUtil","../../util/WKTGeometryFormater","../../core/Application"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9){function _a(_b){this.onClick=null;this.container=_b.container;this.config=_b.config;this.regNo=_b.regNo;this.accessToken=_b.accessToken;this.wktGeometryFormater=new _8();this.fileParse=new _2();this.map=new _3();this.view=new _4({container:this.container,map:this.map,rotateEnabled:false});_9.call(this,this.view._canvas);this.list=[];this._loadFile();};if(_9){_a.__proto__=_9;}_a.prototype=Object.create(_9&&_9.prototype);_a.prototype.constructor=_a;_a.prototype._loadFile=function(){this.fileParse.getAll(this.config,function(_c){var _d=_c.dataSourceVo;var _e=_c.diagramVo.mapVo;var _f=_e.workspace;var _10=_d.services[_f].description.split(",");this.service=_10[0];this.table=_10[1];this.list=_e.layerVoList;this._queryData();}.bind(this));};_a.prototype._queryData=function(){var _11=this.service+this.table+"?filter=reg_no="+this.regNo+"&access_token="+this.accessToken;_1(_11).then.call(this,function(_12){var _13=_7.string2Json(_12);var _14=_13.data[0]["SHAPE"];this.polygon=this.wktGeometryFormater.toGeometry(_14);this.view.setExtent(this.polygon.extent);this.currentRule=this.view.scale;this._createLayer(this.list);}.bind(this));};_a.prototype._createLayer=function(_15){for(var i=_15.length-1;i>-1;i--){var _16=_15[i];_16.id="FeatureLayer_"+i;var _17={url:this.service,filter:"",access_token:this.accessToken};if(_17.filter!==""){if(_16.dataSource.whereFilter!==""){_17.filter=_17.filter+"%26"+_16.dataSource.whereFilter;}}else{if(_16.dataSource.whereFilter!==""){_17.filter=_16.dataSource.whereFilter;}}_16.query=_17;_16.currentRule=this._getCurrentRule(_16.rules);var _18=new _5(_16,function(_19){});this.map.addLayer(_18);}var _1a=new _6({id:"labelLayer",layers:this.map.allLayers});this.map.addLayer(_1a);var _1b;var _1c=this;function _1d(){_1b=requestAnimationFrame(_1d);var _1e=true;for(var _1f in _1c.map.allLayers){var _20=_1c.map.allLayers[_1f];_1e=_1e&&_20.state;}if(_1e){cancelAnimationFrame(_1b);_1c.view.setExtent(_1c.polygon.extent);}};_1d.call(this);};_a.prototype._getCurrentRule=function(_21){for(var i=0;i<_21.length;i++){var _22=_21[i];if(this.currentRule>=_22.minScale&&this.currentRule<=_22.maxScale){return _22;}}return null;};_a.prototype.onMouseDown=function(evt){};_a.prototype.onMouseUp=function(evt){var _23=this.view.screenToGeometry(evt.canvasPosition[0],evt.canvasPosition[1]);var _24=this.view.queryGraphicsByGeometry(_23,0.01);if(_24.length===0){return;}evt.target=_24[0];if(this.onClick){this.onClick.call(this,evt);return undefined;}var _25=evt.target.feature.attributes;var lvl="";_25.forEach(function(_26){if(_26.name==="reg_no"){this.regNo=_26.value;}if(_26.name==="reg_lvl"){lvl=_26.value;}}.bind(this));if(lvl==="05"){return;}this.update();};_a.prototype.created=function(){};_a.prototype.update=function(){this.view.clear();for(var i=0;i<this.list.length;i++){var _27=this.list[i];_27.dataSource.whereFilter="p_reg_no="+this.regNo;}this._queryData();};return _a;});