//>>built
define("com/huayun/thematicmap/modules/DdSystemMap",["dojo/Deferred","dojo/request","dojo/promise/all","../../webgis/Map","../../util/JSONFormatterUtil","../../webgis/views/SceneView","../../webgis/layers/FeatureLayer","../../util/WKTGeometryFormater","../../webgis/layers/LabelLayer","../../webgis/utils/Color"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){function _b(_c,_d){this.backFun=_d;this.wktGeometryFormatter=new _8();var _e=_c.dataJSON.data[0]["SHAPE"];this.mapId=_c.dataJSON.data[0]["MAP_ID"];this.diagramVo=_c.diagramVo;var _f=_c.diagramVo.diagramVo.environmentVo.bgColor;this.polygon=this.wktGeometryFormatter.toGeometry(_e);var _10=_c.diagramVo.diagramVo.mapVo.workspace;this.service=_c.diagramVo.dataSourceVo.services[_10];this.token=_c.token;this.map=new _4();this.view=new _6({container:_c.container,map:this.map,backgroundColor:"rgb("+_f+")",rotateEnabled:false,antialias:_c.antialias});this.view.setExtent(this.polygon.extent);this.currentRule=this.view.scale;this.list=_c.diagramVo.diagramVo.mapVo.layerVoList;this.createLayer(this.list);};_b.prototype.createLayer=function(_11){for(var i=_11.length-1;i>-1;i--){var _12=_11[i];_12.id="FeatureLayer_"+i;var _13={url:this.service.description,filter:"map_id="+this.mapId,access_token:this.token};if(_13.filter!==""){if(_12.dataSource.whereFilter!==""){_13.filter=_13.filter+"%26"+_12.dataSource.whereFilter;}}else{if(_12.dataSource.whereFilter!==""){_13.filter=_12.dataSource.whereFilter;}}_12.query=_13;_12.currentRule=this.getCurrentRule(_12.rules);var _14=new _7(_12,function(_15){});this.map.addLayer(_14);}var _16=new _9({id:"labelLayer",layers:this.map.allLayers});this.map.addLayer(_16);var _17;var _18=this;function _19(){_17=requestAnimationFrame(_19);var _1a=true;for(var _1b in _18.map.allLayers){var _1c=_18.map.allLayers[_1b];_1a=_1a&&_1c.state;}if(_1a){cancelAnimationFrame(_17);_18.view.setExtent(_18.polygon.extent);_18.backFun();}};_19.call(this);};_b.prototype.getCurrentRule=function(_1d){for(var i=0;i<_1d.length;i++){var _1e=_1d[i];if(this.currentRule>=_1e.minScale&&this.currentRule<=_1e.maxScale){return _1e;}}return null;};_b.prototype.update=function(_1f){if(_1f.devId){function _20(){var _21=_1f.ptmsService.ptmsUrl+_1f.type+"?filter=DEV_ID="+_1f.devId+"&access_token="+_1f.ptmsService.accessToken;var _22=new _1();_2(_21).then(function(_23){_22.resolve(_23);});return _22.promise;};_3([_20()]).then(function(_24){this.view.clear();this.wktGeometryFormatter=new _8();var _25=_5.string2Json(_24[0]);var _26=_25.data[0]["SHAPE"];this.mapId=_25.data[0]["MAP_ID"];this.polygon=this.wktGeometryFormatter.toGeometry(_26);this.view.setExtent(this.polygon.extent);this.currentRule=this.view.scale;this.createLayer(this.list);}.bind(this));}else{}};_b.prototype.refresh=function(){this.view.clear();this.list=this.diagramVo.diagramVo.mapVo.layerVoList;this.createLayer(this.list);};_b.prototype.clear=function(){this.view.clear();this.view.threeRender();};return _b;});