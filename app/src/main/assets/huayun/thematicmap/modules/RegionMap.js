//>>built
define("com/huayun/thematicmap/modules/RegionMap",["dojo/Deferred","dojo/request","dojo/promise/all","../../webgis/Map","../../util/JSONFormatterUtil","../../webgis/views/SceneView","../../webgis/layers/FeatureLayer","../../util/WKTGeometryFormater","../../webgis/layers/LabelLayer","../../webgis/utils/Color"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){function _b(_c,_d){this.backFun=_d;this.color=null;this.wktGeometryFormater=new _8();var _e=_c.dataJSON.data[0]["SHAPE"];this.mapId=_c.dataJSON.data[0]["ORG_TYPE"];var _f=_c.diagramVo.diagramVo.environmentVo.bgColor;this.polygon=this.wktGeometryFormater.toGeometry(_e);var _10=_c.diagramVo.diagramVo.mapVo.workspace;this.service=_c.diagramVo.dataSourceVo.services[_10];this.token=_c.token;this.map=new _4();this.view=new _6({container:_c.container,map:this.map,backgroundColor:"rgb("+_f+")",rotateEnabled:false});this.view.setExtent(this.polygon.extent);this.currentRule=this.view.scale;this.list=_c.diagramVo.diagramVo.mapVo.layerVoList;this.createLayer(this.list);};_b.prototype.createLayer=function(_11){for(var i=_11.length-1;i>-1;i--){var _12=_11[i];_12.id="FeatureLayer_"+i;var _13={url:this.service.description,filter:"ORG_TYPE="+this.mapId,access_token:this.token};if(_13.filter!==""){if(_12.dataSource.whereFilter!==""){_13.filter=_13.filter+"%26"+_12.dataSource.whereFilter;}}else{if(_12.dataSource.whereFilter!==""){_13.filter=_12.dataSource.whereFilter;}}_12.query=_13;_12.currentRule=this.getCurrentRule(_12.rules);var _14=new _7(_12,function(_15){});this.map.addLayer(_14);}var _16=new _9({id:"labelLayer",layers:this.map.allLayers});this.map.addLayer(_16);var _17;var _18=this;function _19(){_17=requestAnimationFrame(_19);var _1a=true;for(var _1b in _18.map.allLayers){var _1c=_18.map.allLayers[_1b];_1a=_1a&&_1c.state;}if(_1a){cancelAnimationFrame(_17);_18.view.setExtent(_18.polygon.extent);_18.backFun();}};_19.call(this);};_b.prototype.getCurrentRule=function(_1d){for(var i=0;i<_1d.length;i++){var _1e=_1d[i];if(this.currentRule>=_1e.minScale&&this.currentRule<=_1e.maxScale){return _1e;}}return null;};_b.prototype.update=function(id,_1f,_20){function _21(){var _22=_1f.ptmsUrl+_20+"?filter=ORG_NO="+id+"&access_token="+_1f.accessToken;var _23=new _1();_2(_22).then(function(_24){_23.resolve(_24);});return _23.promise;};_3([_21()]).then(function(_25){this.view.clear();this.wktGeometryFormater=new _8();var _26=_5.string2Json(_25[0]);if(_26.data[0]["ORG_TYPE"]==="02"){this.list[0].dataSource.whereFilter="org_type=03";var _27=_26.data[0]["ORG_TYPE"];this.query={url:this.service.description,filter:"ORG_TYPE="+_27,access_token:this.token};}else{if(_26.data[0]["ORG_TYPE"]==="03"){this.list[0].dataSource.whereFilter="org_type=04";var _27=_26.data[0]["SUBBURO"];this.query={url:this.service.description,filter:"P_ORG_NO="+_27,access_token:this.token};}}var _28=_26.data[0]["SHAPE"];this.polygon=this.wktGeometryFormater.toGeometry(_28);this.view.setExtent(this.polygon.extent);this.currentRule=this.view.scale;this.createLayer(this.list);}.bind(this));};_b.prototype.changeColor=function(_29,_2a){if(_2a==="0"){this.color=_29.symbol.symbols[0].fillSymbol.color;var _2b=JSON.parse(JSON.stringify(_29.symbol));var c=_a.parse("#0F0");_2b.symbols[0].fillSymbol.color=[c.r,c.g,c.b,c.a];_2b.symbols[0].fillSymbol.uniforms["u_color"]=_2b.symbols[0].fillSymbol.color;_2b.symbols[0].fillSymbol.opacity=1;_2b.symbols[0].fillSymbol.uniforms["u_opacity"]=_2b.symbols[0].fillSymbol.opacity;_29.symbol=_2b;}else{var _2b=JSON.parse(JSON.stringify(_29.symbol));var c=_a.parse(this.color);_2b.symbols[0].fillSymbol.color=[c.r,c.g,c.b,c.a];_2b.symbols[0].fillSymbol.uniforms["u_color"]=_2b.symbols[0].fillSymbol.color;_2b.symbols[0].fillSymbol.opacity=1;_2b.symbols[0].fillSymbol.uniforms["u_opacity"]=_2b.symbols[0].fillSymbol.opacity;_29.symbol=_2b;this.color=null;}this.view.threeRender();};return _b;});