//>>built
define("com/huayun/webgis/data/FeatureIndex",["../gl/GridIndex","../data/ArrayType","../utils/utils","../layers/support/readTile","./Pbf","../gl/dataTransfer","../layers/support/style/expressionFactory","../layers/support/EvaluationParameters","./GeoJSONFeature","../utils/Constant","../utils/DictionaryCoder","../geometry/intersection_tests"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c){var _d=function _d(_e,_f,_10){this.tileID=_e;this.x=_e.canonical.x;this.y=_e.canonical.y;this.z=_e.canonical.z;this.grid=_f||new _1(_a.layout.EXTENT,16,0);this.grid3D=new _1(_a.layout.EXTENT,16,0);this.featureIndexArray=_10||new _2.FeatureIndexArray();};_d.prototype.insert=function insert(_11,_12,_13,_14,_15,_16){var key=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(_13,_14,_15);var _17=this.grid;for(var r=0;r<_12.length;r++){var _18=_12[r];var _19=[Infinity,Infinity,-Infinity,-Infinity];for(var i=0;i<_18.length;i++){var p=_18[i];_19[0]=Math.min(_19[0],p.x);_19[1]=Math.min(_19[1],p.y);_19[2]=Math.max(_19[2],p.x);_19[3]=Math.max(_19[3],p.y);}if(_19[0]<_a.layout.EXTENT&&_19[1]<_a.layout.EXTENT&&_19[2]>=0&&_19[3]>=0){_17.insert(key,_19[0],_19[1],_19[2],_19[3]);}}};_d.prototype.loadVTLayers=function loadVTLayers(){if(!this.vtLayers){this.vtLayers=new _5(this.rawTileData).readFields(_4,{},undefined);this.sourceLayerCoder=new _b(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]);}return this.vtLayers;};_d.prototype.query=function query(_1a,_1b,_1c){var _1d=this;this.loadVTLayers();var _1e=_1a.params||{},_1f=_a.layout.EXTENT/_1a.tileSize/_1a.scale,_20=_7.createFilter(_1e.filter);var _21=_1a.queryGeometry;var _22=_1a.queryPadding*_1f;var _23=_c.getBounds(_21);var _24=this.grid.query(_23.minX-_22,_23.minY-_22,_23.maxX+_22,_23.maxY+_22);_24.sort(_3.topDownFeatureComparator);var _25={};var _26;for(var k=0;k<_24.length;k++){var _27=_24[k];if(_27===_26){continue;}_26=_27;var _28=_1d.featureIndexArray.get(_27);var _29=null;_1d.loadMatchingFeature(_25,_28.bucketIndex,_28.sourceLayerIndex,_28.featureIndex,_20,_1e.layers,_1b,function(_2a,_2b){if(!_29){_29=_3.loadGeometry(_2a);}var _2c={};if(_2a.id){_2c=_1c.getState(_2b.sourceLayer||"_geojsonTileLayer",_2a.id);}return _2b.queryIntersectsFeature(_21,_2a,_2c,_29,_1d.z,_1a.transform,_1f,_1a.pixelPosMatrix);});}return _25;};_d.prototype.loadMatchingFeature=function loadMatchingFeature(_2d,_2e,_2f,_30,_31,_32,_33,_34){var _35=this.bucketLayerIDs[_2e];if(_32&&!_3.arraysIntersect(_32,_35)){return;}var _36=this.sourceLayerCoder.decode(_2f);var _37=this.vtLayers[_36];var _38=_37.feature(_30);if(!_31(new _8(this.tileID.overscaledZ),_38)){return;}for(var l=0;l<_35.length;l++){var _39=_35[l];if(_32&&_32.indexOf(_39)<0){continue;}var _3a=_33[_39];if(!_3a){continue;}var _3b=!_34||_34(_38,_3a);if(!_3b){continue;}var _3c=new _9(_38,this.z,this.x,this.y);_3c.layer=_3a.serialize();var _3d=_2d[_39];if(_3d===undefined){_3d=_2d[_39]=[];}_3d.push({featureIndex:_30,feature:_3c,intersectionZ:_3b});}};_d.prototype.lookupSymbolFeatures=function lookupSymbolFeatures(_3e,_3f,_40,_41,_42,_43){var _44={};this.loadVTLayers();var _45=_7.createFilter(_41);for(var i=0,_46=_3e;i<_46.length;i+=1){var _47=_46[i];this.loadMatchingFeature(_44,_3f,_40,_47,_45,_42,_43);}return _44;};_d.prototype.hasLayer=function hasLayer(id){for(var i$1=0,_48=this.bucketLayerIDs;i$1<_48.length;i$1+=1){var _49=_48[i$1];for(var i=0,_4a=_49;i<_4a.length;i+=1){var _4b=_4a[i];if(id===_4b){return true;}}}return false;};_6.register("FeatureIndex",_d,{omit:["rawTileData","sourceLayerCoder"]});return _d;});