//>>built
define("com/huayun/webgis/data/bucket/LineBucketSimplify",["../ArrayType","../../gl/SegmentVector"],function(_1,_2){var _3=63;var _4=15;var _5=1/2;var _6=Math.pow(2,_4-1)/_5;var _7=Math.cos(75/2*(Math.PI/180));function _8(_9,_a,_b,_c,up,_d,_e){_9.emplaceBack(_a.x,_a.y,_a.z||0,Math.round(_3*_b.x)+128,Math.round(_3*_b.y)+128,((_d===0?0:(_d<0?-1:1))+1)|(((_e*_5)&63)<<2),(_e*_5)>>6,_c?1:0,up?1:0);};var _f=function _f(_10){this.layoutVertexArray=new _1.StructArrayLayout7f2ib32();this.indexArray=new _1.StructArrayLayout3ui6();this.segments=new _2();};_f.prototype.addFeature=function addFeature(_11,_12,cap,_13,_14){for(var i=0;i<_11.length;i+=1){var _15=_11[i];this.addLine(_15,_12,cap,_13,_14);}};_f.prototype.upload=function upload(_16){if(!this.uploaded){this.layoutVertexBuffer=_16.createVertexBuffer(this.layoutVertexArray,[{name:"a_pos",type:"Float32",components:3,offset:0},{name:"a_data",type:"Float32",components:4,offset:12},{name:"a_normal",type:"Int16",components:2,offset:28}]);this.indexBuffer=_16.createIndexBuffer(this.indexArray);}this.uploaded=true;};_f.prototype.destroy=function destroy(){if(!this.layoutVertexBuffer){return;}this.layoutVertexBuffer.destroy();this.indexBuffer.destroy();this.segments.destroy();};_f.prototype.addLine=function addLine(_17,_18,cap,_19,_1a){var _1b=null;var len=_17.length;while(len>=2&&_17[len-1].equals(_17[len-2])){_17.splice(len-1);len--;}var _1c=0;while(_1c<len-1&&_17[_1c].equals(_17[_1c+1])){_1c++;}if(_18==="bevel"){_19=1.05;}var _1d=240;var _1e=_17[_1c];var _1f=this.segments.prepareSegment(len*10,this.layoutVertexArray,this.indexArray);this.distance=0;var _20=cap,_21=cap;var _22=true;var _23;var _24=undefined;var _25=undefined;var _26=undefined;var _27=undefined;var _28;var _29;this.e1=this.e2=this.e3=-1;for(var i=_1c;i<len;i++){_25=_17[i+1];if(_27){_26=_27;}if(_23){_24=_23;}_23=_17[i];_27=_25?_25.sub(_23)._unit()._perp():_26;_26=_26||_27;if(!_26){return;}var _2a=_26.add(_27);if(_2a.x!==0||_2a.y!==0){_2a._unit();}var _2b=_2a.x*_27.x+_2a.y*_27.y;var _2c=_2b!==0?1/_2b:Infinity;var _2d=_2b<_7&&_24&&_25;if(_2d&&i>_1c){var _2e=_23.dist(_24);if(_2e>2*_1d){var _2f=_23.sub(_23.sub(_24)._mult(_1d/_2e)._round());this.distance+=_2f.dist(_24);this.addCurrentVertex(_2f,this.distance,_26.mult(1),0,0,false,_1f,_1b);_24=_2f;}}var _30=_24&&_25;var _31=_30?_18:_25?_20:_21;if(_30&&_31==="round"){if(_2c<_1a){_31="miter";}else{if(_2c<=2){_31="fakeround";}}}if(_31==="miter"&&_2c>_19){_31="bevel";}if(_31==="bevel"){if(_2c>2){_31="flipbevel";}if(_2c<_19){_31="miter";}}if(_24){this.distance+=_23.dist(_24);}if(_31==="miter"){_2a._mult(_2c);this.addCurrentVertex(_23,this.distance,_2a,0,0,false,_1f,_1b);}else{if(_31==="flipbevel"){if(_2c>100){_2a=_27.clone().mult(-1);}else{var _32=_26.x*_27.y-_26.y*_27.x>0?-1:1;var _33=_2c*_26.add(_27).mag()/_26.sub(_27).mag();_2a._perp()._mult(_33*_32);}this.addCurrentVertex(_23,this.distance,_2a,0,0,false,_1f,_1b);this.addCurrentVertex(_23,this.distance,_2a.mult(-1),0,0,false,_1f,_1b);}else{if(_31==="bevel"||_31==="fakeround"){var _34=(_26.x*_27.y-_26.y*_27.x)>0;var _35=-Math.sqrt(_2c*_2c-1);if(_34){_29=0;_28=_35;}else{_28=0;_29=_35;}if(!_22){this.addCurrentVertex(_23,this.distance,_26,_28,_29,false,_1f,_1b);}if(_31==="fakeround"){var n=Math.floor((0.5-(_2b-0.5))*8);var _36=(void 0);for(var m=0;m<n;m++){_36=_27.mult((m+1)/(n+1))._add(_26)._unit();this.addPieSliceVertex(_23,this.distance,_36,_34,_1f,_1b);}this.addPieSliceVertex(_23,this.distance,_2a,_34,_1f,_1b);for(var k=n-1;k>=0;k--){_36=_26.mult((k+1)/(n+1))._add(_27)._unit();this.addPieSliceVertex(_23,this.distance,_36,_34,_1f,_1b);}}if(_25){this.addCurrentVertex(_23,this.distance,_27,-_28,-_29,false,_1f,_1b);}}else{if(_31==="butt"){if(!_22){this.addCurrentVertex(_23,this.distance,_26,0,0,false,_1f,_1b);}if(_25){this.addCurrentVertex(_23,this.distance,_27,0,0,false,_1f,_1b);}}else{if(_31==="square"){if(!_22){this.addCurrentVertex(_23,this.distance,_26,1,1,false,_1f,_1b);this.e1=this.e2=-1;}if(_25){this.addCurrentVertex(_23,this.distance,_27,-1,-1,false,_1f,_1b);}}else{if(_31==="round"){if(!_22){this.addCurrentVertex(_23,this.distance,_26,0,0,false,_1f,_1b);this.addCurrentVertex(_23,this.distance,_26,1,1,true,_1f,_1b);this.e1=this.e2=-1;}if(_25){this.addCurrentVertex(_23,this.distance,_27,-1,-1,true,_1f,_1b);this.addCurrentVertex(_23,this.distance,_27,0,0,false,_1f,_1b);}}}}}}}if(_2d&&i<len-1){var _37=_23.dist(_25);if(_37>2*_1d){var _38=_23.add(_25.sub(_23)._mult(_1d/_37)._round());this.distance+=_38.dist(_23);this.addCurrentVertex(_38,this.distance,_27.mult(1),0,0,false,_1f,_1b);_23=_38;}}_22=false;}};_f.prototype.addCurrentVertex=function addCurrentVertex(_39,_3a,_3b,_3c,_3d,_3e,_3f,_40){var _41;var _42=this.layoutVertexArray;var _43=this.indexArray;_41=_3b.clone();if(_3c){_41._sub(_3b.perp()._mult(_3c));}_8(_42,_39,_41,_3e,false,_3c,_3a);this.e3=_3f.vertexLength++;if(this.e1>=0&&this.e2>=0){_43.emplaceBack(this.e1,this.e2,this.e3);_3f.primitiveLength++;}this.e1=this.e2;this.e2=this.e3;_41=_3b.mult(-1);if(_3d){_41._sub(_3b.perp()._mult(_3d));}_8(_42,_39,_41,_3e,true,-_3d,_3a);this.e3=_3f.vertexLength++;if(this.e1>=0&&this.e2>=0){_43.emplaceBack(this.e1,this.e2,this.e3);_3f.primitiveLength++;}this.e1=this.e2;this.e2=this.e3;if(_3a>_6/2&&!_40){this.distance=0;this.addCurrentVertex(_39,this.distance,_3b,_3c,_3d,_3e,_3f);}};_f.prototype.addPieSliceVertex=function addPieSliceVertex(_44,_45,_46,_47,_48){_46=_46.mult(_47?-1:1);var _49=this.layoutVertexArray;var _4a=this.indexArray;_8(_49,_44,_46,false,_47,0,_45);this.e3=_48.vertexLength++;if(this.e1>=0&&this.e2>=0){_4a.emplaceBack(this.e1,this.e2,this.e3);_48.primitiveLength++;}if(_47){this.e2=this.e3;}else{this.e1=this.e3;}};return _f;});