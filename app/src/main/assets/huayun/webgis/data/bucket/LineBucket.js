//>>built
define("com/huayun/webgis/data/bucket/LineBucket",["../ArrayType","../../gl/SegmentVector","../../gl/members","../../gl/programConfig","../../gl/dataTransfer","com/huayun/webgis/layers/support/EvaluationParameters","../../utils/utils","../../utils/Constant"],function(_1,_2,_3,_4,_5,_6,_7,_8){var _9=function _9(_a){this.zoom=_a.zoom;this.overscaling=_a.overscaling;this.layers=_a.layers;this.layerIds=this.layers.map(function(_b){return _b.id;});this.index=_a.index;this.features=[];this.hasPattern=false;this.layoutVertexArray=new _1.StructArrayLayout2i4ub8();this.indexArray=new _1.StructArrayLayout3ui6();this.programConfigurations=new _4.ProgramConfigurationSet(_3.members$3,_a.layers,_a.zoom);this.segments=new _2();this.stateDependentLayerIds=this.layers.filter(function(l){return l.isStateDependent();}).map(function(l){return l.id;});};_9.prototype.populate=function populate(_c,_d){this.features=[];this.hasPattern=false;for(var i=0,_e=_c;i<_e.length;i+=1){var _f=_e[i];var _10=_f.feature;var _11=_f.index;var _12=_f.sourceLayerIndex;if(!this.layers[0]._featureFilter(new _6(this.zoom),_10)){continue;}var _13=_7.loadGeometry(_10);var _14={sourceLayerIndex:_12,index:_11,geometry:_13,properties:_10.properties,type:_10.type,patterns:{}};if(typeof _10.id!=="undefined"){_14.id=_10.id;}this.addFeature(_14,_13,_11,{});_d.featureIndex.insert(_10,_13,_11,_12,this.index);}};_9.prototype.update=function update(_15,_16,_17){if(!this.stateDependentLayers.length){return;}this.programConfigurations.updatePaintArrays(_15,_16,this.stateDependentLayers,_17);};_9.prototype.addFeatures=function addFeatures(_18,_19){for(var i=0,_1a=this.features;i<_1a.length;i+=1){var _1b=_1a[i];var _1c=_1b.geometry;this.addFeature(_1b,_1c,_1b.index,_19);}};_9.prototype.isEmpty=function isEmpty(){return this.layoutVertexArray.length===0;};_9.prototype.uploadPending=function uploadPending(){return !this.uploaded||this.programConfigurations.needsUpload;};_9.prototype.upload=function upload(_1d){if(!this.uploaded){this.layoutVertexBuffer=_1d.createVertexBuffer(this.layoutVertexArray,_3.members$3);this.indexBuffer=_1d.createIndexBuffer(this.indexArray);}this.programConfigurations.upload(_1d);this.uploaded=true;};_9.prototype.destroy=function destroy(){if(!this.layoutVertexBuffer){return;}this.layoutVertexBuffer.destroy();this.indexBuffer.destroy();this.programConfigurations.destroy();this.segments.destroy();};_9.prototype.addFeature=function addFeature(_1e,_1f,_20,_21){var _22=this.layers[0].layout;var _23=_22.get("line-join").evaluate(_1e,{});var cap=_22.get("line-cap");var _24=_22.get("line-miter-limit");var _25=_22.get("line-round-limit");for(var i=0,_26=_1f;i<_26.length;i+=1){var _27=_26[i];this.addLine(_27,_1e,_23,cap,_24,_25,_20,_21);}};_9.prototype.addLine=function addLine(_28,_29,_2a,cap,_2b,_2c,_2d,_2e){var _2f=null;var len=_28.length;while(len>=2&&_28[len-1].equals(_28[len-2])){len--;}var _30=0;while(_30<len-1&&_28[_30].equals(_28[_30+1])){_30++;}if(_2a==="bevel"){_2b=1.05;}var _31=_8.layout.SHARP_CORNER_OFFSET*16;var _32=this.segments.prepareSegment(len*10,this.layoutVertexArray,this.indexArray);this.distance=0;var _33=cap,_34=cap;var _35=true;var _36;var _37;var _38;var _39;var _3a;var _3b;var _3c;this.e1=this.e2=this.e3=-1;for(var i=_30;i<len;i++){_38=_28[i+1];if(_3a){_39=_3a;}if(_36){_37=_36;}_36=_28[i];_3a=_38?_38.sub(_36)._unit()._perp():_39;_39=_39||_3a;if(!_39){return;}var _3d=_39.add(_3a);if(_3d.x!==0||_3d.y!==0){_3d._unit();}var _3e=_3d.x*_3a.x+_3d.y*_3a.y;var _3f=_3e!==0?1/_3e:Infinity;var _40=_3e<_8.layout.COS_HALF_SHARP_CORNER&&_37&&_38;if(_40&&i>_30){var _41=_36.dist(_37);if(_41>2*_31){var _42=_36.sub(_36.sub(_37)._mult(_31/_41)._round());this.distance+=_42.dist(_37);this.addCurrentVertex(_42,this.distance,_39.mult(1),0,0,false,_32,_2f);_37=_42;}}var _43=_37&&_38;var _44=_43?_2a:_38?_33:_34;if(_43&&_44==="round"){if(_3f<_2c){_44="miter";}else{if(_3f<=2){_44="fakeround";}}}if(_44==="miter"&&_3f>_2b){_44="bevel";}if(_44==="bevel"){if(_3f>2){_44="flipbevel";}if(_3f<_2b){_44="miter";}}if(_37){this.distance+=_36.dist(_37);}if(_44==="miter"){_3d._mult(_3f);this.addCurrentVertex(_36,this.distance,_3d,0,0,false,_32,_2f);}else{if(_44==="flipbevel"){if(_3f>100){_3d=_3a.clone().mult(-1);}else{var _45=_39.x*_3a.y-_39.y*_3a.x>0?-1:1;var _46=_3f*_39.add(_3a).mag()/_39.sub(_3a).mag();_3d._perp()._mult(_46*_45);}this.addCurrentVertex(_36,this.distance,_3d,0,0,false,_32,_2f);this.addCurrentVertex(_36,this.distance,_3d.mult(-1),0,0,false,_32,_2f);}else{if(_44==="bevel"||_44==="fakeround"){var _47=(_39.x*_3a.y-_39.y*_3a.x)>0;var _48=-Math.sqrt(_3f*_3f-1);if(_47){_3c=0;_3b=_48;}else{_3b=0;_3c=_48;}if(!_35){this.addCurrentVertex(_36,this.distance,_39,_3b,_3c,false,_32,_2f);}if(_44==="fakeround"){var n=Math.floor((0.5-(_3e-0.5))*8);var _49=(void 0);for(var m=0;m<n;m++){_49=_3a.mult((m+1)/(n+1))._add(_39)._unit();this.addPieSliceVertex(_36,this.distance,_49,_47,_32,_2f);}this.addPieSliceVertex(_36,this.distance,_3d,_47,_32,_2f);for(var k=n-1;k>=0;k--){_49=_39.mult((k+1)/(n+1))._add(_3a)._unit();this.addPieSliceVertex(_36,this.distance,_49,_47,_32,_2f);}}if(_38){this.addCurrentVertex(_36,this.distance,_3a,-_3b,-_3c,false,_32,_2f);}}else{if(_44==="butt"){if(!_35){this.addCurrentVertex(_36,this.distance,_39,0,0,false,_32,_2f);}if(_38){this.addCurrentVertex(_36,this.distance,_3a,0,0,false,_32,_2f);}}else{if(_44==="square"){if(!_35){this.addCurrentVertex(_36,this.distance,_39,1,1,false,_32,_2f);this.e1=this.e2=-1;}if(_38){this.addCurrentVertex(_36,this.distance,_3a,-1,-1,false,_32,_2f);}}else{if(_44==="round"){if(!_35){this.addCurrentVertex(_36,this.distance,_39,0,0,false,_32,_2f);this.addCurrentVertex(_36,this.distance,_39,1,1,true,_32,_2f);this.e1=this.e2=-1;}if(_38){this.addCurrentVertex(_36,this.distance,_3a,-1,-1,true,_32,_2f);this.addCurrentVertex(_36,this.distance,_3a,0,0,false,_32,_2f);}}}}}}}if(_40&&i<len-1){var _4a=_36.dist(_38);if(_4a>2*_31){var _4b=_36.add(_38.sub(_36)._mult(_31/_4a)._round());this.distance+=_4b.dist(_36);this.addCurrentVertex(_4b,this.distance,_3a.mult(1),0,0,false,_32,_2f);_36=_4b;}}_35=false;}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,_29,_2d,_2e);};_9.prototype.addCurrentVertex=function addCurrentVertex(_4c,_4d,_4e,_4f,_50,_51,_52,_53){var _54;var _55=this.layoutVertexArray;var _56=this.indexArray;if(_53){_4d=_57(_4d,_53);}_54=_4e.clone();if(_4f){_54._sub(_4e.perp()._mult(_4f));}_58(_55,_4c,_54,_51,false,_4f,_4d);this.e3=_52.vertexLength++;if(this.e1>=0&&this.e2>=0){_56.emplaceBack(this.e1,this.e2,this.e3);_52.primitiveLength++;}this.e1=this.e2;this.e2=this.e3;_54=_4e.mult(-1);if(_50){_54._sub(_4e.perp()._mult(_50));}_58(_55,_4c,_54,_51,true,-_50,_4d);this.e3=_52.vertexLength++;if(this.e1>=0&&this.e2>=0){_56.emplaceBack(this.e1,this.e2,this.e3);_52.primitiveLength++;}this.e1=this.e2;this.e2=this.e3;if(_4d>_8.layout.MAX_LINE_DISTANCE/2&&!_53){this.distance=0;this.addCurrentVertex(_4c,this.distance,_4e,_4f,_50,_51,_52);}};_9.prototype.addPieSliceVertex=function addPieSliceVertex(_59,_5a,_5b,_5c,_5d,_5e){_5b=_5b.mult(_5c?-1:1);var _5f=this.layoutVertexArray;var _60=this.indexArray;if(_5e){_5a=_57(_5a,_5e);}_58(_5f,_59,_5b,false,_5c,0,_5a);this.e3=_5d.vertexLength++;if(this.e1>=0&&this.e2>=0){_60.emplaceBack(this.e1,this.e2,this.e3);_5d.primitiveLength++;}if(_5c){this.e2=this.e3;}else{this.e1=this.e3;}};function _58(_61,_62,_63,_64,up,dir,_65){_61.emplaceBack((_62.x<<1)+(_64?1:0),(_62.y<<1)+(up?1:0),Math.round(_8.layout.EXTRUDE_SCALE*_63.x)+128,Math.round(_8.layout.EXTRUDE_SCALE*_63.y)+128,((dir===0?0:(dir<0?-1:1))+1)|(((_65*_8.layout.LINE_DISTANCE_SCALE)&63)<<2),(_65*_8.layout.LINE_DISTANCE_SCALE)>>6);};function _57(_66,_67){return ((_66/_67.tileTotal)*(_67.end-_67.start)+_67.start)*(_8.layout.MAX_LINE_DISTANCE-1);};function _68(_69,_6a,len){var _6b,_6c;var _6d=0;for(var i=_6a;i<len-1;i++){_6b=_69[i];_6c=_69[i+1];_6d+=_6b.dist(_6c);}return _6d;};undefined;_5.register("LineBucket",_9,{omit:["layers","features"]});return _9;});