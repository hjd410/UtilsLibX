//>>built
define("com/huayun/webgis/data/bucket/FillBucket",["../ArrayType","../../gl/SegmentVector","../../utils/earcut","../../gl/programConfig","../../gl/members","../../gl/dataTransfer","com/huayun/webgis/layers/support/EvaluationParameters","../../utils/utils","../../utils/classifyRings","../../utils/Constant"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){function _b(_c){this.zoom=_c.zoom;this.overscaling=_c.overscaling;this.layers=_c.layers;this.layerIds=this.layers.map(function(_d){return _d.id;});this.index=_c.index;this.hasPattern=false;this.layoutVertexArray=new _1.StructArrayLayout2i4();this.indexArray=new _1.StructArrayLayout3ui6();this.indexArray2=new _1.StructArrayLayout2ui4();this.programConfigurations=new _4.ProgramConfigurationSet(_5.members$1,_c.layers,_c.zoom);this.segments=new _2();this.segments2=new _2();this.stateDependentLayerIds=this.layers.filter(function(l){return l.isStateDependent();}).map(function(l){return l.id;});};_b.prototype.populate=function populate(_e,_f){this.features=[];this.hasPattern=false;for(var i=0,_10=_e;i<_10.length;i+=1){var ref=_10[i];var _11=ref.feature;var _12=ref.index;var _13=ref.sourceLayerIndex;if(!this.layers[0]._featureFilter(new _7(this.zoom),_11)){continue;}var _14=_8.loadGeometry(_11);var _15={sourceLayerIndex:_13,index:_12,geometry:_14,properties:_11.properties,type:_11.type,patterns:{}};if(typeof _11.id!=="undefined"){_15.id=_11.id;}this.addFeature(_15,_14,_12,{});_f.featureIndex.insert(_11,_14,_12,_13,this.index);}};_b.prototype.update=function update(_16,_17,_18){if(!this.stateDependentLayers.length){return;}this.programConfigurations.updatePaintArrays(_16,_17,this.stateDependentLayers,_18);};_b.prototype.addFeatures=function addFeatures(_19,_1a){for(var i=0,_1b=this.features;i<_1b.length;i+=1){var _1c=_1b[i];var _1d=_1c.geometry;this.addFeature(_1c,_1d,_1c.index,_1a);}};_b.prototype.isEmpty=function isEmpty(){return this.layoutVertexArray.length===0;};_b.prototype.uploadPending=function uploadPending(){return !this.uploaded||this.programConfigurations.needsUpload;};_b.prototype.upload=function upload(_1e){if(!this.uploaded){this.layoutVertexBuffer=_1e.createVertexBuffer(this.layoutVertexArray,_5.members$1);this.indexBuffer=_1e.createIndexBuffer(this.indexArray);this.indexBuffer2=_1e.createIndexBuffer(this.indexArray2);}this.programConfigurations.upload(_1e);this.uploaded=true;};_b.prototype.destroy=function destroy(){if(!this.layoutVertexBuffer){return;}this.layoutVertexBuffer.destroy();this.indexBuffer.destroy();this.indexBuffer2.destroy();this.programConfigurations.destroy();this.segments.destroy();this.segments2.destroy();};_b.prototype.addFeature=function addFeature(_1f,_20,_21,_22){for(var i$4=0,_23=_9(_20,_a.layout.EARCUT_MAX_RINGS);i$4<_23.length;i$4+=1){var _24=_23[i$4];var _25=0;for(var i$2=0,_26=_24;i$2<_26.length;i$2+=1){var _27=_26[i$2];_25+=_27.length;}var _28=this.segments.prepareSegment(_25,this.layoutVertexArray,this.indexArray);var _29=_28.vertexLength;var _2a=[];var _2b=[];for(var i$3=0,_2c=_24;i$3<_2c.length;i$3+=1){var _2d=_2c[i$3];if(_2d.length===0){continue;}if(_2d!==_24[0]){_2b.push(_2a.length/2);}var _2e=this.segments2.prepareSegment(_2d.length,this.layoutVertexArray,this.indexArray2);var _2f=_2e.vertexLength;this.layoutVertexArray.emplaceBack(_2d[0].x,_2d[0].y);this.indexArray2.emplaceBack(_2f+_2d.length-1,_2f);_2a.push(_2d[0].x);_2a.push(_2d[0].y);for(var i=1;i<_2d.length;i++){this.layoutVertexArray.emplaceBack(_2d[i].x,_2d[i].y);this.indexArray2.emplaceBack(_2f+i-1,_2f+i);_2a.push(_2d[i].x);_2a.push(_2d[i].y);}_2e.vertexLength+=_2d.length;_2e.primitiveLength+=_2d.length;}var _30=_3.earcut(_2a,_2b);for(var i$1=0;i$1<_30.length;i$1+=3){this.indexArray.emplaceBack(_29+_30[i$1],_29+_30[i$1+1],_29+_30[i$1+2]);}_28.vertexLength+=_25;_28.primitiveLength+=_30.length/3;}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,_1f,_21,_22);};_6.register("FillBucket",_b,{omit:["layers","features"]});return _b;});