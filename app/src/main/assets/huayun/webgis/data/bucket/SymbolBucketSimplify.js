//>>built
define("com/huayun/webgis/data/bucket/SymbolBucketSimplify",["../ArrayType","../../gl/SegmentVector","../../gl/programConfig","../../gl/dataTransfer","../../gl/members","../../geometry/Point2D","../../layers/support/EvaluationParameters","../../layers/support/expression/Formatted","../../utils/utils","../../utils/Constant"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){var _b=function _b(){this.layoutVertexArray=new _1.StructArrayLayout4i4ui16();this.indexArray=new _1.StructArrayLayout3ui6();this.segments=new _2();this.dynamicLayoutVertexArray=new _1.StructArrayLayout3f12();this.opacityVertexArray=new _1.StructArrayLayout1ul4();this.placedSymbolArray=new _1.PlacedSymbolArray();};_b.prototype.upload=function upload(_c,_d,_e,_f){if(_e){this.layoutVertexBuffer=_c.createVertexBuffer(this.layoutVertexArray,_5.symbolLayoutAttributes.members);this.indexBuffer=_c.createIndexBuffer(this.indexArray,_d);this.dynamicLayoutVertexBuffer=_c.createVertexBuffer(this.dynamicLayoutVertexArray,_5.dynamicLayoutAttributes.members,true);this.opacityVertexBuffer=_c.createVertexBuffer(this.opacityVertexArray,_5.shaderOpacityAttributes,true);this.opacityVertexBuffer.itemSize=1;}if(_e||_f){this.programConfigurations.upload(_c);}};_b.prototype.destroy=function destroy(){if(!this.layoutVertexBuffer){return;}this.layoutVertexBuffer.destroy();this.indexBuffer.destroy();this.programConfigurations.destroy();this.segments.destroy();this.dynamicLayoutVertexBuffer.destroy();this.opacityVertexBuffer.destroy();};var _10=function _10(_11,_12,_13){this.layoutVertexArray=new _11();this.layoutAttributes=_12;this.indexArray=new _13();this.segments=new _2();this.collisionVertexArray=new _1.StructArrayLayout2ub2f12();};_10.prototype.upload=function upload(_14){this.layoutVertexBuffer=_14.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes);this.indexBuffer=_14.createIndexBuffer(this.indexArray);this.collisionVertexBuffer=_14.createVertexBuffer(this.collisionVertexArray,[{name:"a_placed",components:2,type:"Uint8",offset:0},{name:"a_shift",components:2,type:"Float32",offset:4}],true);};_10.prototype.destroy=function destroy(){if(!this.layoutVertexBuffer){return;}this.layoutVertexBuffer.destroy();this.indexBuffer.destroy();this.segments.destroy();this.collisionVertexBuffer.destroy();};_4.register("SymbolBuffers",_b);_4.register("CollisionBuffers",_10);function _15(_16,_17,_18){_16.sections.forEach(function(_19){var _1a=_17.layout.get("text-transform").evaluate(_18,{});if(_1a==="uppercase"){_19.text=_19.text.toLocaleUpperCase();}else{if(_1a==="lowercase"){_19.text=_19.text.toLocaleLowerCase();}}});return _16;};function _1b(_1c,_1d){var _1e=_1d.expression;if(_1e.kind==="constant"){var _1f=_1e.evaluate(new _7(_1c+1));return {kind:"constant",layoutSize:_1f};}else{if(_1e.kind==="source"){return {kind:"source"};}else{var _20=_1e.zoomStops;var _21=_1e.interpolationType;var _22=0;while(_22<_20.length&&_20[_22]<=_1c){_22++;}_22=Math.max(0,_22-1);var _23=_22;while(_23<_20.length&&_20[_23]<_1c+1){_23++;}_23=Math.min(_20.length-1,_23);var _24=_20[_22];var _25=_20[_23];if(_1e.kind==="composite"){return {kind:"composite",minZoom:_24,maxZoom:_25,interpolationType:_21};}var _26=_1e.evaluate(new _7(_24));var _27=_1e.evaluate(new _7(_25));return {kind:"camera",minZoom:_24,maxZoom:_25,minSize:_26,maxSize:_27,interpolationType:_21};}}};function _28(_29,_2a,_2b,ox,oy,tx,ty,_2c){_29.emplaceBack(_2a,_2b,Math.round(ox*32),Math.round(oy*32),tx,ty,_2c?_2c[0]:0,_2c?_2c[1]:0);};function _2d(_2e,p,_2f){_2e.emplaceBack(p.x,p.y,_2f);_2e.emplaceBack(p.x,p.y,_2f);_2e.emplaceBack(p.x,p.y,_2f);_2e.emplaceBack(p.x,p.y,_2f);};function _30(_31){var _32={};var _33={};var _34=[];var _35=0;function add(k){_34.push(_31[k]);_35++;};function _36(_37,_38,_39){var i=_33[_37];delete _33[_37];_33[_38]=i;_34[i].geometry[0].pop();_34[i].geometry[0]=_34[i].geometry[0].concat(_39[0]);return i;};function _3a(_3b,_3c,_3d){var i=_32[_3c];delete _32[_3c];_32[_3b]=i;_34[i].geometry[0].shift();_34[i].geometry[0]=_3d[0].concat(_34[i].geometry[0]);return i;};function _3e(_3f,_40,_41){var _42=_41?_40[0][_40[0].length-1]:_40[0][0];return (_3f+":"+(_42.x)+":"+(_42.y));};for(var k=0;k<_31.length;k++){var _43=_31[k];var _44=_43.geometry;var _45=_43.text?_43.text.toString():null;if(!_45){add(k);continue;}var _46=_3e(_45,_44),_47=_3e(_45,_44,true);if((_46 in _33)&&(_47 in _32)&&(_33[_46]!==_32[_47])){var j=_3a(_46,_47,_44);var i=_36(_46,_47,_34[j].geometry);delete _32[_46];delete _33[_47];_33[_3e(_45,_34[i].geometry,true)]=i;_34[j].geometry=(null);}else{if(_46 in _33){_36(_46,_47,_44);}else{if(_47 in _32){_3a(_46,_47,_44);}else{add(k);_32[_46]=_35-1;_33[_47]=_35-1;}}}}return _34.filter(function(f){return f.geometry;});};var _48=function _48(_49){this.collisionBoxArray=_49.collisionBoxArray;this.textSizeData={kind:"constant",layoutSize:layoutSize};};_48.prototype.createArrays=function createArrays(){this.text=new _b(new _3.ProgramConfigurationSet(_5.symbolLayoutAttributes.members,this.layers,this.zoom,function(_4a){return /^text/.test(_4a);}));this.icon=new _b(new _3.ProgramConfigurationSet(_5.symbolLayoutAttributes.members,this.layers,this.zoom,function(_4b){return /^icon/.test(_4b);}));this.collisionBox=new _10(_1.StructArrayLayout2i2i2i12,_a.collisionBoxLayout,_1.StructArrayLayout2ui4);this.collisionCircle=new _10(_1.StructArrayLayout2i2i2i12,_a.collisionCircleLayout,_1.StructArrayLayout3ui6);this.glyphOffsetArray=new _1.GlyphOffsetArray();this.lineVertexArray=new _1.SymbolLineVertexArray();this.symbolInstances=new _1.SymbolInstanceArray();};_48.prototype.calculateGlyphDependencies=function calculateGlyphDependencies(_4c,_4d,_4e,_4f){for(var i=0;i<_4c.length;i++){_4d[_4c.charCodeAt(i)]=true;if(_4e&&_4f){var _50=_a.verticalizedCharacterMap[_4c.charAt(i)];if(_50){_4d[_50.charCodeAt(0)]=true;}}}};_48.prototype.populate=function populate(_51,_52){var _53=this.layers[0];var _54=_53.layout;var _55=_54.get("text-font");var _56=_54.get("text-field");var _57=_54.get("icon-image");var _58=(_56.value.kind!=="constant"||_56.value.value.toString().length>0)&&(_55.value.kind!=="constant"||_55.value.value.length>0)&&(!(_56.value.value.toString().startsWith("##")));var _59=(_57.value.kind!=="constant"||_57.value.value&&_57.value.value.length>0)&&(!(_56.value.value.toString().startsWith("##")));var _5a=_54.get("symbol-sort-key");this.features=[];if(!_58&&!_59){return;}var _5b=_52.iconDependencies;var _5c=_52.glyphDependencies;var _5d=new _7(this.zoom);for(var i$1=0,_5e=_51;i$1<_5e.length;i$1+=1){var ref=_5e[i$1];var _5f=ref.feature;var _60=ref.index;var _61=ref.sourceLayerIndex;if(!_53._featureFilter(_5d,_5f)){continue;}var _62=(void 0);if(_58){var _63=_53.getValueAndResolveTokens("text-field",_5f);_62=_15(_63 instanceof _8?_63:_8.fromString(_63),_53,_5f);}var _64=(void 0);if(_59){_64=_53.getValueAndResolveTokens("icon-image",_5f);}if(!_62&&!_64){continue;}var _65=this.sortFeaturesByKey?_5a.evaluate(_5f,{}):undefined;var _66={text:_62,icon:_64,index:_60,sourceLayerIndex:_61,geometry:_9.loadGeometry(_5f),properties:_5f.properties,type:_a.geometryTypes[_5f.type],sortKey:_65};if(typeof _5f.id!=="undefined"){_66.id=_5f.id;}this.features.push(_66);if(_64){_5b[_64]=true;}if(_62){var _67=_55.evaluate(_5f,{}).join(",");var _68=_54.get("text-rotation-alignment")==="map"&&_54.get("symbol-placement")!=="point";for(var i=0,_69=_62.sections;i<_69.length;i+=1){var _6a=_69[i];var _6b=_9.allowsVerticalWritingMode(_62.toString());var _6c=_6a.fontStack||_67;var _6d=_5c[_6c]=_5c[_6c]||{};this.calculateGlyphDependencies(_6a.text,_6d,_68,_6b);}}}if(_54.get("symbol-placement")==="line"){this.features=_30(this.features);}if(this.sortFeaturesByKey){this.features.sort(function(a,b){return ((a.sortKey))-((b.sortKey));});}};_48.prototype.update=function update(_6e,_6f,_70){if(!this.stateDependentLayers.length){return;}this.text.programConfigurations.updatePaintArrays(_6e,_6f,this.layers,_70);this.icon.programConfigurations.updatePaintArrays(_6e,_6f,this.layers,_70);};_48.prototype.isEmpty=function isEmpty(){return this.symbolInstances.length===0;};_48.prototype.uploadPending=function uploadPending(){return !this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload;};_48.prototype.upload=function upload(_71){if(!this.uploaded){this.collisionBox.upload(_71);this.collisionCircle.upload(_71);}this.text.upload(_71,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload);this.icon.upload(_71,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload);this.uploaded=true;};_48.prototype.destroy=function destroy(){this.text.destroy();this.icon.destroy();this.collisionBox.destroy();this.collisionCircle.destroy();};_48.prototype.addToLineVertexArray=function addToLineVertexArray(_72,_73){var _74=this.lineVertexArray.length;if(_72.segment!==undefined){var _75=_72.dist(_73[_72.segment+1]);var _76=_72.dist(_73[_72.segment]);var _77={};for(var i=_72.segment+1;i<_73.length;i++){_77[i]={x:_73[i].x,y:_73[i].y,tileUnitDistanceFromAnchor:_75};if(i<_73.length-1){_75+=_73[i+1].dist(_73[i]);}}for(var i$1=_72.segment||0;i$1>=0;i$1--){_77[i$1]={x:_73[i$1].x,y:_73[i$1].y,tileUnitDistanceFromAnchor:_76};if(i$1>0){_76+=_73[i$1-1].dist(_73[i$1]);}}for(var i$2=0;i$2<_73.length;i$2++){var _78=_77[i$2];this.lineVertexArray.emplaceBack(_78.x,_78.y,_78.tileUnitDistanceFromAnchor);}}return {lineStartIndex:_74,lineLength:this.lineVertexArray.length-_74};};_48.prototype.addSymbols=function addSymbols(_79,_7a,_7b,_7c,_7d,_7e,_7f,_80,_81,_82){var _83=_79.indexArray;var _84=_79.layoutVertexArray;var _85=_79.dynamicLayoutVertexArray;var _86=_79.segments.prepareSegment(4*_7a.length,_79.layoutVertexArray,_79.indexArray,_7e.sortKey);var _87=this.glyphOffsetArray.length;var _88=_86.vertexLength;for(var i=0,_89=_7a;i<_89.length;i+=1){var _8a=_89[i];var tl=_8a.tl,tr=_8a.tr,bl=_8a.bl,br=_8a.br,tex=_8a.tex;var _8b=_86.vertexLength;var y=_8a.glyphOffset[1];_28(_84,_80.x,_80.y,tl.x,y+tl.y,tex.x,tex.y,_7b);_28(_84,_80.x,_80.y,tr.x,y+tr.y,tex.x+tex.w,tex.y,_7b);_28(_84,_80.x,_80.y,bl.x,y+bl.y,tex.x,tex.y+tex.h,_7b);_28(_84,_80.x,_80.y,br.x,y+br.y,tex.x+tex.w,tex.y+tex.h,_7b);_2d(_85,_80,0);_83.emplaceBack(_8b,_8b+1,_8b+2);_83.emplaceBack(_8b+1,_8b+2,_8b+3);_86.vertexLength+=4;_86.primitiveLength+=2;this.glyphOffsetArray.emplaceBack(_8a.glyphOffset[0]);}_79.placedSymbolArray.emplaceBack(_80.x,_80.y,_87,this.glyphOffsetArray.length-_87,_88,_81,_82,(_80.segment),_7b?_7b[0]:0,_7b?_7b[1]:0,_7c[0],_7c[1],_7f,(false),0);_79.programConfigurations.populatePaintArrays(_79.layoutVertexArray.length,_7e,_7e.index,{});};_48.prototype._addCollisionDebugVertex=function _addCollisionDebugVertex(_8c,_8d,_8e,_8f,_90,_91){_8d.emplaceBack(0,0);return _8c.emplaceBack(_8e.x,_8e.y,_8f,_90,Math.round(_91.x),Math.round(_91.y));};_48.prototype.addCollisionDebugVertices=function addCollisionDebugVertices(x1,y1,x2,y2,_92,_93,_94,_95){var _96=_92.segments.prepareSegment(4,_92.layoutVertexArray,_92.indexArray);var _97=_96.vertexLength;var _98=_92.layoutVertexArray;var _99=_92.collisionVertexArray;var _9a=_94.anchorX;var _9b=_94.anchorY;this._addCollisionDebugVertex(_98,_99,_93,_9a,_9b,new pointGeometry(x1,y1));this._addCollisionDebugVertex(_98,_99,_93,_9a,_9b,new pointGeometry(x2,y1));this._addCollisionDebugVertex(_98,_99,_93,_9a,_9b,new pointGeometry(x2,y2));this._addCollisionDebugVertex(_98,_99,_93,_9a,_9b,new pointGeometry(x1,y2));_96.vertexLength+=4;if(_95){var _9c=(_92.indexArray);_9c.emplaceBack(_97,_97+1,_97+2);_9c.emplaceBack(_97,_97+2,_97+3);_96.primitiveLength+=2;}else{var _9d=(_92.indexArray);_9d.emplaceBack(_97,_97+1);_9d.emplaceBack(_97+1,_97+2);_9d.emplaceBack(_97+2,_97+3);_9d.emplaceBack(_97+3,_97);_96.primitiveLength+=4;}};_48.prototype.addDebugCollisionBoxes=function addDebugCollisionBoxes(_9e,_9f,_a0){for(var b=_9e;b<_9f;b++){var box=(this.collisionBoxArray.get(b));var x1=box.x1;var y1=box.y1;var x2=box.x2;var y2=box.y2;var _a1=box.radius>0;this.addCollisionDebugVertices(x1,y1,x2,y2,_a1?this.collisionCircle:this.collisionBox,box.anchorPoint,_a0,_a1);}};_48.prototype.generateCollisionDebugBuffers=function generateCollisionDebugBuffers(){for(var i=0;i<this.symbolInstances.length;i++){var _a2=this.symbolInstances.get(i);this.addDebugCollisionBoxes(_a2.textBoxStartIndex,_a2.textBoxEndIndex,_a2);this.addDebugCollisionBoxes(_a2.iconBoxStartIndex,_a2.iconBoxEndIndex,_a2);}};_48.prototype._deserializeCollisionBoxesForSymbol=function _deserializeCollisionBoxesForSymbol(_a3,_a4,_a5,_a6,_a7){var _a8={};for(var k=_a4;k<_a5;k++){var box=(_a3.get(k));if(box.radius===0){_a8.textBox={x1:box.x1,y1:box.y1,x2:box.x2,y2:box.y2,anchorPointX:box.anchorPointX,anchorPointY:box.anchorPointY};_a8.textFeatureIndex=box.featureIndex;break;}else{if(!_a8.textCircles){_a8.textCircles=[];_a8.textFeatureIndex=box.featureIndex;}var _a9=1;_a8.textCircles.push(box.anchorPointX,box.anchorPointY,box.radius,box.signedDistanceFromAnchor,_a9);}}for(var k$1=_a6;k$1<_a7;k$1++){var _aa=(_a3.get(k$1));if(_aa.radius===0){_a8.iconBox={x1:_aa.x1,y1:_aa.y1,x2:_aa.x2,y2:_aa.y2,anchorPointX:_aa.anchorPointX,anchorPointY:_aa.anchorPointY};_a8.iconFeatureIndex=_aa.featureIndex;break;}}return _a8;};_48.prototype.deserializeCollisionBoxes=function deserializeCollisionBoxes(_ab){this.collisionArrays=[];for(var i=0;i<this.symbolInstances.length;i++){var _ac=this.symbolInstances.get(i);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(_ab,_ac.textBoxStartIndex,_ac.textBoxEndIndex,_ac.iconBoxStartIndex,_ac.iconBoxEndIndex));}};_48.prototype.hasTextData=function hasTextData(){return this.text.segments.get().length>0;};_48.prototype.hasIconData=function hasIconData(){return this.icon.segments.get().length>0;};_48.prototype.hasCollisionBoxData=function hasCollisionBoxData(){return this.collisionBox.segments.get().length>0;};_48.prototype.hasCollisionCircleData=function hasCollisionCircleData(){return this.collisionCircle.segments.get().length>0;};_48.prototype.addIndicesForPlacedTextSymbol=function addIndicesForPlacedTextSymbol(_ad){var _ae=this.text.placedSymbolArray.get(_ad);var _af=_ae.vertexStartIndex+_ae.numGlyphs*4;for(var _b0=_ae.vertexStartIndex;_b0<_af;_b0+=4){this.text.indexArray.emplaceBack(_b0,_b0+1,_b0+2);this.text.indexArray.emplaceBack(_b0+1,_b0+2,_b0+3);}};_48.prototype.getSortedSymbolIndexes=function getSortedSymbolIndexes(_b1){if(this.sortedAngle===_b1&&this.symbolInstanceIndexes!==undefined){return this.symbolInstanceIndexes;}var sin=Math.sin(_b1);var cos=Math.cos(_b1);var _b2=[];var _b3=[];var _b4=[];for(var i=0;i<this.symbolInstances.length;++i){_b4.push(i);var _b5=this.symbolInstances.get(i);_b2.push(Math.round(sin*_b5.anchorX+cos*_b5.anchorY)|0);_b3.push(_b5.featureIndex);}_b4.sort(function(_b6,_b7){return (_b2[_b6]-_b2[_b7])||(_b3[_b7]-_b3[_b6]);});return _b4;};_48.prototype.sortFeatures=function sortFeatures(_b8){var _b9=this;if(!this.sortFeaturesByY){return;}if(this.sortedAngle===_b8){return;}if(this.text.segments.get().length>1||this.icon.segments.get().length>1){return;}this.symbolInstanceIndexes=this.getSortedSymbolIndexes(_b8);this.sortedAngle=_b8;this.text.indexArray.clear();this.icon.indexArray.clear();this.featureSortOrder=[];for(var i$1=0,_ba=this.symbolInstanceIndexes;i$1<_ba.length;i$1+=1){var i=_ba[i$1];var _bb=this.symbolInstances.get(i);this.featureSortOrder.push(_bb.featureIndex);[_bb.rightJustifiedTextSymbolIndex,_bb.centerJustifiedTextSymbolIndex,_bb.leftJustifiedTextSymbolIndex].forEach(function(_bc,i,_bd){if(_bc>=0&&_bd.indexOf(_bc)===i){_b9.addIndicesForPlacedTextSymbol(_bc);}});if(_bb.verticalPlacedTextSymbolIndex>=0){this.addIndicesForPlacedTextSymbol(_bb.verticalPlacedTextSymbolIndex);}var _be=this.icon.placedSymbolArray.get(i);if(_be.numGlyphs){var _bf=_be.vertexStartIndex;this.icon.indexArray.emplaceBack(_bf,_bf+1,_bf+2);this.icon.indexArray.emplaceBack(_bf+1,_bf+2,_bf+3);}}if(this.text.indexBuffer){this.text.indexBuffer.updateData(this.text.indexArray);}};_48.MAX_GLYPHS=65535;_48.addDynamicAttributes=_2d;return _48;});