//>>built
define("com/huayun/webgis/data/bucket/SymbolBucket",["../ArrayType","../../gl/SegmentVector","../../gl/programConfig","../../gl/dataTransfer","../../gl/members","../../geometry/Point2D","../../layers/support/EvaluationParameters","../../layers/support/expression/Formatted","../../utils/utils","../../utils/Constant"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){var _b=function _b(_c){this.layoutVertexArray=new _1.StructArrayLayout4i4ui16();this.indexArray=new _1.StructArrayLayout3ui6();this.programConfigurations=_c;this.segments=new _2();this.dynamicLayoutVertexArray=new _1.StructArrayLayout3f12();this.opacityVertexArray=new _1.StructArrayLayout1ul4();this.placedSymbolArray=new _1.PlacedSymbolArray();};_b.prototype.upload=function upload(_d,_e,_f,_10){if(_f){this.layoutVertexBuffer=_d.createVertexBuffer(this.layoutVertexArray,_5.symbolLayoutAttributes.members);this.indexBuffer=_d.createIndexBuffer(this.indexArray,_e);this.dynamicLayoutVertexBuffer=_d.createVertexBuffer(this.dynamicLayoutVertexArray,_5.dynamicLayoutAttributes.members,true);this.opacityVertexBuffer=_d.createVertexBuffer(this.opacityVertexArray,_5.shaderOpacityAttributes,true);this.opacityVertexBuffer.itemSize=1;}if(_f||_10){this.programConfigurations.upload(_d);}};_b.prototype.destroy=function destroy(){if(!this.layoutVertexBuffer){return;}this.layoutVertexBuffer.destroy();this.indexBuffer.destroy();this.programConfigurations.destroy();this.segments.destroy();this.dynamicLayoutVertexBuffer.destroy();this.opacityVertexBuffer.destroy();};var _11=function _11(_12,_13,_14){this.layoutVertexArray=new _12();this.layoutAttributes=_13;this.indexArray=new _14();this.segments=new _2();this.collisionVertexArray=new _1.StructArrayLayout2ub2f12();};_11.prototype.upload=function upload(_15){this.layoutVertexBuffer=_15.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes);this.indexBuffer=_15.createIndexBuffer(this.indexArray);this.collisionVertexBuffer=_15.createVertexBuffer(this.collisionVertexArray,[{name:"a_placed",components:2,type:"Uint8",offset:0},{name:"a_shift",components:2,type:"Float32",offset:4}],true);};_11.prototype.destroy=function destroy(){if(!this.layoutVertexBuffer){return;}this.layoutVertexBuffer.destroy();this.indexBuffer.destroy();this.segments.destroy();this.collisionVertexBuffer.destroy();};_4.register("SymbolBuffers",_b);_4.register("CollisionBuffers",_11);function _16(_17,_18,_19){_17.sections.forEach(function(_1a){var _1b=_18.layout.get("text-transform").evaluate(_19,{});if(_1b==="uppercase"){_1a.text=_1a.text.toLocaleUpperCase();}else{if(_1b==="lowercase"){_1a.text=_1a.text.toLocaleLowerCase();}}});return _17;};function _1c(_1d,_1e){var _1f=_1e.expression;if(_1f.kind==="constant"){var _20=_1f.evaluate(new _7(_1d+1));return {kind:"constant",layoutSize:_20};}else{if(_1f.kind==="source"){return {kind:"source"};}else{var _21=_1f.zoomStops;var _22=_1f.interpolationType;var _23=0;while(_23<_21.length&&_21[_23]<=_1d){_23++;}_23=Math.max(0,_23-1);var _24=_23;while(_24<_21.length&&_21[_24]<_1d+1){_24++;}_24=Math.min(_21.length-1,_24);var _25=_21[_23];var _26=_21[_24];if(_1f.kind==="composite"){return {kind:"composite",minZoom:_25,maxZoom:_26,interpolationType:_22};}var _27=_1f.evaluate(new _7(_25));var _28=_1f.evaluate(new _7(_26));return {kind:"camera",minZoom:_25,maxZoom:_26,minSize:_27,maxSize:_28,interpolationType:_22};}}};function _29(_2a,_2b,_2c,ox,oy,tx,ty,_2d){_2a.emplaceBack(_2b,_2c,Math.round(ox*32),Math.round(oy*32),tx,ty,_2d?_2d[0]:0,_2d?_2d[1]:0);};function _2e(_2f,p,_30){_2f.emplaceBack(p.x,p.y,_30);_2f.emplaceBack(p.x,p.y,_30);_2f.emplaceBack(p.x,p.y,_30);_2f.emplaceBack(p.x,p.y,_30);};function _31(_32){var _33={};var _34={};var _35=[];var _36=0;function add(k){_35.push(_32[k]);_36++;};function _37(_38,_39,_3a){var i=_34[_38];delete _34[_38];_34[_39]=i;_35[i].geometry[0].pop();_35[i].geometry[0]=_35[i].geometry[0].concat(_3a[0]);return i;};function _3b(_3c,_3d,_3e){var i=_33[_3d];delete _33[_3d];_33[_3c]=i;_35[i].geometry[0].shift();_35[i].geometry[0]=_3e[0].concat(_35[i].geometry[0]);return i;};function _3f(_40,_41,_42){var _43=_42?_41[0][_41[0].length-1]:_41[0][0];return (_40+":"+(_43.x)+":"+(_43.y));};for(var k=0;k<_32.length;k++){var _44=_32[k];var _45=_44.geometry;var _46=_44.text?_44.text.toString():null;if(!_46){add(k);continue;}var _47=_3f(_46,_45),_48=_3f(_46,_45,true);if((_47 in _34)&&(_48 in _33)&&(_34[_47]!==_33[_48])){var j=_3b(_47,_48,_45);var i=_37(_47,_48,_35[j].geometry);delete _33[_47];delete _34[_48];_34[_3f(_46,_35[i].geometry,true)]=i;_35[j].geometry=(null);}else{if(_47 in _34){_37(_47,_48,_45);}else{if(_48 in _33){_3b(_47,_48,_45);}else{add(k);_33[_47]=_36-1;_34[_48]=_36-1;}}}}return _35.filter(function(f){return f.geometry;});};var _49=function _49(_4a){this.collisionBoxArray=_4a.collisionBoxArray;this.zoom=_4a.zoom;this.overscaling=_4a.overscaling;this.layers=_4a.layers;this.layerIds=this.layers.map(function(_4b){return _4b.id;});this.index=_4a.index;this.pixelRatio=_4a.pixelRatio;this.sourceLayerIndex=_4a.sourceLayerIndex;this.hasPattern=false;var _4c=this.layers[0];var _4d=_4c._unevaluatedLayout._values;this.textSizeData=_1c(this.zoom,_4d["text-size"]);this.iconSizeData=_1c(this.zoom,_4d["icon-size"]);var _4e=this.layers[0].layout;var _4f=_4e.get("symbol-sort-key");var _50=_4e.get("symbol-z-order");this.sortFeaturesByKey=_50!=="viewport-y"&&_4f.constantOr(1)!==undefined;var _51=_50==="viewport-y"||(_50==="auto"&&!this.sortFeaturesByKey);this.sortFeaturesByY=_51&&(_4e.get("text-allow-overlap")||_4e.get("icon-allow-overlap")||_4e.get("text-ignore-placement")||_4e.get("icon-ignore-placement"));this.stateDependentLayerIds=this.layers.filter(function(l){return l.isStateDependent();}).map(function(l){return l.id;});this.sourceID=_4a.sourceID;};_49.prototype.createArrays=function createArrays(){this.text=new _b(new _3.ProgramConfigurationSet(_5.symbolLayoutAttributes.members,this.layers,this.zoom,function(_52){return /^text/.test(_52);}));this.icon=new _b(new _3.ProgramConfigurationSet(_5.symbolLayoutAttributes.members,this.layers,this.zoom,function(_53){return /^icon/.test(_53);}));this.collisionBox=new _11(_1.StructArrayLayout2i2i2i12,_a.collisionBoxLayout,_1.StructArrayLayout2ui4);this.collisionCircle=new _11(_1.StructArrayLayout2i2i2i12,_a.collisionCircleLayout,_1.StructArrayLayout3ui6);this.glyphOffsetArray=new _1.GlyphOffsetArray();this.lineVertexArray=new _1.SymbolLineVertexArray();this.symbolInstances=new _1.SymbolInstanceArray();};_49.prototype.calculateGlyphDependencies=function calculateGlyphDependencies(_54,_55,_56,_57){for(var i=0;i<_54.length;i++){_55[_54.charCodeAt(i)]=true;if(_56&&_57){var _58=_a.verticalizedCharacterMap[_54.charAt(i)];if(_58){_55[_58.charCodeAt(0)]=true;}}}};_49.prototype.populate=function populate(_59,_5a){var _5b=this.layers[0];var _5c=_5b.layout;var _5d=_5c.get("text-font");var _5e=_5c.get("text-field");var _5f=_5c.get("icon-image");var _60=(_5e.value.kind!=="constant"||_5e.value.value.toString().length>0)&&(_5d.value.kind!=="constant"||_5d.value.value.length>0)&&!(_5e.value.value.toString().startsWith("##"));var _61=(_5f.value.kind!=="constant"||_5f.value.value&&_5f.value.value.length>0)&&!(_5f.value.value.startsWith("##"));var _62=_5c.get("symbol-sort-key");this.features=[];if(!_60&&!_61){return;}var _63=_5a.iconDependencies;var _64=_5a.glyphDependencies;var _65=new _7(this.zoom);for(var i$1=0,_66=_59;i$1<_66.length;i$1+=1){var ref=_66[i$1];var _67=ref.feature;var _68=ref.index;var _69=ref.sourceLayerIndex;if(!_5b._featureFilter(_65,_67)){continue;}var _6a=(void 0);if(_60){var _6b=_5b.getValueAndResolveTokens("text-field",_67);_6a=_16(_6b instanceof _8?_6b:_8.fromString(_6b),_5b,_67);}var _6c=(void 0);if(_61){_6c=_5b.getValueAndResolveTokens("icon-image",_67);}if(!_6a&&!_6c){continue;}var _6d=this.sortFeaturesByKey?_62.evaluate(_67,{}):undefined;var _6e={text:_6a,icon:_6c,index:_68,sourceLayerIndex:_69,geometry:_9.loadGeometry(_67),properties:_67.properties,type:_a.geometryTypes[_67.type],sortKey:_6d};if(typeof _67.id!=="undefined"){_6e.id=_67.id;}this.features.push(_6e);if(_6c){_63[_6c]=true;}if(_6a){var _6f=_5d.evaluate(_67,{}).join(",");var _70=_5c.get("text-rotation-alignment")==="map"&&_5c.get("symbol-placement")!=="point";for(var i=0,_71=_6a.sections;i<_71.length;i+=1){var _72=_71[i];var _73=_9.allowsVerticalWritingMode(_6a.toString());var _74=_72.fontStack||_6f;var _75=_64[_74]=_64[_74]||{};this.calculateGlyphDependencies(_72.text,_75,_70,_73);}}}if(_5c.get("symbol-placement")==="line"){this.features=_31(this.features);}if(this.sortFeaturesByKey){this.features.sort(function(a,b){return ((a.sortKey))-((b.sortKey));});}};_49.prototype.update=function update(_76,_77,_78){if(!this.stateDependentLayers.length){return;}this.text.programConfigurations.updatePaintArrays(_76,_77,this.layers,_78);this.icon.programConfigurations.updatePaintArrays(_76,_77,this.layers,_78);};_49.prototype.isEmpty=function isEmpty(){return this.symbolInstances.length===0;};_49.prototype.uploadPending=function uploadPending(){return !this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload;};_49.prototype.upload=function upload(_79){if(!this.uploaded){this.collisionBox.upload(_79);this.collisionCircle.upload(_79);}this.text.upload(_79,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload);this.icon.upload(_79,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload);this.uploaded=true;};_49.prototype.destroy=function destroy(){this.text.destroy();this.icon.destroy();this.collisionBox.destroy();this.collisionCircle.destroy();};_49.prototype.addToLineVertexArray=function addToLineVertexArray(_7a,_7b){var _7c=this.lineVertexArray.length;if(_7a.segment!==undefined){var _7d=_7a.dist(_7b[_7a.segment+1]);var _7e=_7a.dist(_7b[_7a.segment]);var _7f={};for(var i=_7a.segment+1;i<_7b.length;i++){_7f[i]={x:_7b[i].x,y:_7b[i].y,tileUnitDistanceFromAnchor:_7d};if(i<_7b.length-1){_7d+=_7b[i+1].dist(_7b[i]);}}for(var i$1=_7a.segment||0;i$1>=0;i$1--){_7f[i$1]={x:_7b[i$1].x,y:_7b[i$1].y,tileUnitDistanceFromAnchor:_7e};if(i$1>0){_7e+=_7b[i$1-1].dist(_7b[i$1]);}}for(var i$2=0;i$2<_7b.length;i$2++){var _80=_7f[i$2];this.lineVertexArray.emplaceBack(_80.x,_80.y,_80.tileUnitDistanceFromAnchor);}}return {lineStartIndex:_7c,lineLength:this.lineVertexArray.length-_7c};};_49.prototype.addSymbols=function addSymbols(_81,_82,_83,_84,_85,_86,_87,_88,_89,_8a){var _8b=_81.indexArray;var _8c=_81.layoutVertexArray;var _8d=_81.dynamicLayoutVertexArray;var _8e=_81.segments.prepareSegment(4*_82.length,_81.layoutVertexArray,_81.indexArray,_86.sortKey);var _8f=this.glyphOffsetArray.length;var _90=_8e.vertexLength;for(var i=0,_91=_82;i<_91.length;i+=1){var _92=_91[i];var tl=_92.tl,tr=_92.tr,bl=_92.bl,br=_92.br,tex=_92.tex;var _93=_8e.vertexLength;var y=_92.glyphOffset[1];_29(_8c,_88.x,_88.y,tl.x,y+tl.y,tex.x,tex.y,_83);_29(_8c,_88.x,_88.y,tr.x,y+tr.y,tex.x+tex.w,tex.y,_83);_29(_8c,_88.x,_88.y,bl.x,y+bl.y,tex.x,tex.y+tex.h,_83);_29(_8c,_88.x,_88.y,br.x,y+br.y,tex.x+tex.w,tex.y+tex.h,_83);_2e(_8d,_88,0);_8b.emplaceBack(_93,_93+1,_93+2);_8b.emplaceBack(_93+1,_93+2,_93+3);_8e.vertexLength+=4;_8e.primitiveLength+=2;this.glyphOffsetArray.emplaceBack(_92.glyphOffset[0]);}_81.placedSymbolArray.emplaceBack(_88.x,_88.y,_8f,this.glyphOffsetArray.length-_8f,_90,_89,_8a,(_88.segment),_83?_83[0]:0,_83?_83[1]:0,_84[0],_84[1],_87,(false),0);_81.programConfigurations.populatePaintArrays(_81.layoutVertexArray.length,_86,_86.index,{});};_49.prototype._addCollisionDebugVertex=function _addCollisionDebugVertex(_94,_95,_96,_97,_98,_99){_95.emplaceBack(0,0);return _94.emplaceBack(_96.x,_96.y,_97,_98,Math.round(_99.x),Math.round(_99.y));};_49.prototype.addCollisionDebugVertices=function addCollisionDebugVertices(x1,y1,x2,y2,_9a,_9b,_9c,_9d){var _9e=_9a.segments.prepareSegment(4,_9a.layoutVertexArray,_9a.indexArray);var _9f=_9e.vertexLength;var _a0=_9a.layoutVertexArray;var _a1=_9a.collisionVertexArray;var _a2=_9c.anchorX;var _a3=_9c.anchorY;this._addCollisionDebugVertex(_a0,_a1,_9b,_a2,_a3,new pointGeometry(x1,y1));this._addCollisionDebugVertex(_a0,_a1,_9b,_a2,_a3,new pointGeometry(x2,y1));this._addCollisionDebugVertex(_a0,_a1,_9b,_a2,_a3,new pointGeometry(x2,y2));this._addCollisionDebugVertex(_a0,_a1,_9b,_a2,_a3,new pointGeometry(x1,y2));_9e.vertexLength+=4;if(_9d){var _a4=(_9a.indexArray);_a4.emplaceBack(_9f,_9f+1,_9f+2);_a4.emplaceBack(_9f,_9f+2,_9f+3);_9e.primitiveLength+=2;}else{var _a5=(_9a.indexArray);_a5.emplaceBack(_9f,_9f+1);_a5.emplaceBack(_9f+1,_9f+2);_a5.emplaceBack(_9f+2,_9f+3);_a5.emplaceBack(_9f+3,_9f);_9e.primitiveLength+=4;}};_49.prototype.addDebugCollisionBoxes=function addDebugCollisionBoxes(_a6,_a7,_a8){for(var b=_a6;b<_a7;b++){var box=(this.collisionBoxArray.get(b));var x1=box.x1;var y1=box.y1;var x2=box.x2;var y2=box.y2;var _a9=box.radius>0;this.addCollisionDebugVertices(x1,y1,x2,y2,_a9?this.collisionCircle:this.collisionBox,box.anchorPoint,_a8,_a9);}};_49.prototype.generateCollisionDebugBuffers=function generateCollisionDebugBuffers(){for(var i=0;i<this.symbolInstances.length;i++){var _aa=this.symbolInstances.get(i);this.addDebugCollisionBoxes(_aa.textBoxStartIndex,_aa.textBoxEndIndex,_aa);this.addDebugCollisionBoxes(_aa.iconBoxStartIndex,_aa.iconBoxEndIndex,_aa);}};_49.prototype._deserializeCollisionBoxesForSymbol=function _deserializeCollisionBoxesForSymbol(_ab,_ac,_ad,_ae,_af){var _b0={};for(var k=_ac;k<_ad;k++){var box=(_ab.get(k));if(box.radius===0){_b0.textBox={x1:box.x1,y1:box.y1,x2:box.x2,y2:box.y2,anchorPointX:box.anchorPointX,anchorPointY:box.anchorPointY};_b0.textFeatureIndex=box.featureIndex;break;}else{if(!_b0.textCircles){_b0.textCircles=[];_b0.textFeatureIndex=box.featureIndex;}var _b1=1;_b0.textCircles.push(box.anchorPointX,box.anchorPointY,box.radius,box.signedDistanceFromAnchor,_b1);}}for(var k$1=_ae;k$1<_af;k$1++){var _b2=(_ab.get(k$1));if(_b2.radius===0){_b0.iconBox={x1:_b2.x1,y1:_b2.y1,x2:_b2.x2,y2:_b2.y2,anchorPointX:_b2.anchorPointX,anchorPointY:_b2.anchorPointY};_b0.iconFeatureIndex=_b2.featureIndex;break;}}return _b0;};_49.prototype.deserializeCollisionBoxes=function deserializeCollisionBoxes(_b3){this.collisionArrays=[];for(var i=0;i<this.symbolInstances.length;i++){var _b4=this.symbolInstances.get(i);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(_b3,_b4.textBoxStartIndex,_b4.textBoxEndIndex,_b4.iconBoxStartIndex,_b4.iconBoxEndIndex));}};_49.prototype.hasTextData=function hasTextData(){return this.text.segments.get().length>0;};_49.prototype.hasIconData=function hasIconData(){return this.icon.segments.get().length>0;};_49.prototype.hasCollisionBoxData=function hasCollisionBoxData(){return this.collisionBox.segments.get().length>0;};_49.prototype.hasCollisionCircleData=function hasCollisionCircleData(){return this.collisionCircle.segments.get().length>0;};_49.prototype.addIndicesForPlacedTextSymbol=function addIndicesForPlacedTextSymbol(_b5){var _b6=this.text.placedSymbolArray.get(_b5);var _b7=_b6.vertexStartIndex+_b6.numGlyphs*4;for(var _b8=_b6.vertexStartIndex;_b8<_b7;_b8+=4){this.text.indexArray.emplaceBack(_b8,_b8+1,_b8+2);this.text.indexArray.emplaceBack(_b8+1,_b8+2,_b8+3);}};_49.prototype.getSortedSymbolIndexes=function getSortedSymbolIndexes(_b9){if(this.sortedAngle===_b9&&this.symbolInstanceIndexes!==undefined){return this.symbolInstanceIndexes;}var sin=Math.sin(_b9);var cos=Math.cos(_b9);var _ba=[];var _bb=[];var _bc=[];for(var i=0;i<this.symbolInstances.length;++i){_bc.push(i);var _bd=this.symbolInstances.get(i);_ba.push(Math.round(sin*_bd.anchorX+cos*_bd.anchorY)|0);_bb.push(_bd.featureIndex);}_bc.sort(function(_be,_bf){return (_ba[_be]-_ba[_bf])||(_bb[_bf]-_bb[_be]);});return _bc;};_49.prototype.sortFeatures=function sortFeatures(_c0){var _c1=this;if(!this.sortFeaturesByY){return;}if(this.sortedAngle===_c0){return;}if(this.text.segments.get().length>1||this.icon.segments.get().length>1){return;}this.symbolInstanceIndexes=this.getSortedSymbolIndexes(_c0);this.sortedAngle=_c0;this.text.indexArray.clear();this.icon.indexArray.clear();this.featureSortOrder=[];for(var i$1=0,_c2=this.symbolInstanceIndexes;i$1<_c2.length;i$1+=1){var i=_c2[i$1];var _c3=this.symbolInstances.get(i);this.featureSortOrder.push(_c3.featureIndex);[_c3.rightJustifiedTextSymbolIndex,_c3.centerJustifiedTextSymbolIndex,_c3.leftJustifiedTextSymbolIndex].forEach(function(_c4,i,_c5){if(_c4>=0&&_c5.indexOf(_c4)===i){_c1.addIndicesForPlacedTextSymbol(_c4);}});if(_c3.verticalPlacedTextSymbolIndex>=0){this.addIndicesForPlacedTextSymbol(_c3.verticalPlacedTextSymbolIndex);}var _c6=this.icon.placedSymbolArray.get(i);if(_c6.numGlyphs){var _c7=_c6.vertexStartIndex;this.icon.indexArray.emplaceBack(_c7,_c7+1,_c7+2);this.icon.indexArray.emplaceBack(_c7+1,_c7+2,_c7+3);}}if(this.text.indexBuffer){this.text.indexBuffer.updateData(this.text.indexArray);}if(this.icon.indexBuffer){this.icon.indexBuffer.updateData(this.icon.indexArray);}};_49.MAX_GLYPHS=65535;_49.addDynamicAttributes=_2e;_4.register("SymbolBucket",_49,{omit:["layers","collisionBoxArray","features","compareText"]});return _49;});