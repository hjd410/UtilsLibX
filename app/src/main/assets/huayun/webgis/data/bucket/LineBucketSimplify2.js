//>>built
define("com/huayun/webgis/data/bucket/LineBucketSimplify2",["../ArrayType","../../gl/SegmentVector"],function(_1,_2){var _3=63;var _4=15;var _5=1/2;var _6=Math.pow(2,_4-1)/_5;var _7=Math.cos(180/2*(Math.PI/180));function _8(_9,_a,_b,_c,up,_d,_e){_9.emplaceBack(_a.x,_a.y,Math.round(_3*_b.x)+128,Math.round(_3*_b.y)+128,((_d===0?0:(_d<0?-1:1))+1)|(((_e*_5)&63)<<2),(_e*_5)>>6,_c?1:0,up?1:0);};var _f=function _f(_10){this.layoutVertexArray=new _1.StructArrayLayout6f2ib28();this.indexArray=new _1.StructArrayLayout3ui6();this.segments=new _2();};_f.prototype.addFeature=function addFeature(_11,_12,cap,_13,_14){for(var i=0;i<_11.length;i+=1){var _15=_11[i];this.addLine(_15,_12,cap,_13,_14);}};_f.prototype.upload=function upload(_16){if(!this.uploaded){this.layoutVertexBuffer=_16.createVertexBuffer(this.layoutVertexArray,[{name:"a_pos",type:"Float32",components:2,offset:0},{name:"a_data",type:"Float32",components:4,offset:8},{name:"a_normal",type:"Int16",components:2,offset:24}]);this.indexBuffer=_16.createIndexBuffer(this.indexArray);}this.uploaded=true;};_f.prototype.destroy=function destroy(){if(!this.layoutVertexBuffer){return;}this.layoutVertexBuffer.destroy();this.indexBuffer.destroy();this.segments.destroy();};_f.prototype.addLine=function addLine(_17,_18,cap,_19,_1a){var _1b=null;var len=_17.length;while(len>=2&&_17[len-1].equals(_17[len-2])){_17.splice(len-1);len--;}var _1c=0;while(_1c<len-1&&_17[_1c].equals(_17[_1c+1])){_1c++;}if(_18==="bevel"){_19=1.05;}var _1d=240;var _1e=_17[_1c];var _1f=this.segments.prepareSegment(len*10,this.layoutVertexArray,this.indexArray);this.distance=0;var _20=cap,_21=cap;var _22=true;var _23;var _24=((undefined));var _25=((undefined));var _26=((undefined));var _27=((undefined));var _28;var _29;this.e1=this.e2=this.e3=-1;_19=100;for(var i=_1c;i<len;i++){_25=_17[i+1];if(_27){_26=_27;}if(_23){_24=_23;}_23=_17[i];_27=_25?_25.sub(_23)._unit()._perp():_26;_26=_26||_27;if(!_26){return;}var _2a=_26.add(_27);if(_2a.x!==0||_2a.y!==0){_2a._unit();}var _2b=_2a.x*_27.x+_2a.y*_27.y;var _2c=_2b!==0?1/_2b:Infinity;var _2d=false;var _2e=_24&&_25;var _2f=_2e?_18:_25?_20:_21;if(_2e&&_2f==="round"){if(_2c<_1a){_2f="miter";}else{if(_2c<=2){_2f="fakeround";}}}if(_2f==="miter"&&_2c>_19){_2f="bevel";}if(_2f==="bevel"){if(_2c>2){_2f="flipbevel";}if(_2c<_19){_2f="miter";}}if(_24){this.distance+=_23.dist(_24);}if(_2f==="miter"){_2a._mult(_2c);this.addCurrentVertex(_23,this.distance,_2a,0,0,false,_1f,_1b);}else{if(_2f==="flipbevel"){if(_2c>100){_2a=_27.clone().mult(-1);}else{var _30=_26.x*_27.y-_26.y*_27.x>0?-1:1;var _31=_2c*_26.add(_27).mag()/_26.sub(_27).mag();_2a._perp()._mult(_31*_30);}this.addCurrentVertex(_23,this.distance,_2a,0,0,false,_1f,_1b);this.addCurrentVertex(_23,this.distance,_2a.mult(-1),0,0,false,_1f,_1b);}else{if(_2f==="bevel"||_2f==="fakeround"){var _32=(_26.x*_27.y-_26.y*_27.x)>0;var _33=-Math.sqrt(_2c*_2c-1);if(_32){_29=0;_28=_33;}else{_28=0;_29=_33;}if(!_22){this.addCurrentVertex(_23,this.distance,_26,_28,_29,false,_1f,_1b);}if(_2f==="fakeround"){var n=Math.floor((0.5-(_2b-0.5))*8);var _34=(void 0);for(var m=0;m<n;m++){_34=_27.mult((m+1)/(n+1))._add(_26)._unit();this.addPieSliceVertex(_23,this.distance,_34,_32,_1f,_1b);}this.addPieSliceVertex(_23,this.distance,_2a,_32,_1f,_1b);for(var k=n-1;k>=0;k--){_34=_26.mult((k+1)/(n+1))._add(_27)._unit();this.addPieSliceVertex(_23,this.distance,_34,_32,_1f,_1b);}}if(_25){this.addCurrentVertex(_23,this.distance,_27,-_28,-_29,false,_1f,_1b);}}else{if(_2f==="butt"){if(!_22){this.addCurrentVertex(_23,this.distance,_26,0,0,false,_1f,_1b);}if(_25){this.addCurrentVertex(_23,this.distance,_27,0,0,false,_1f,_1b);}}else{if(_2f==="square"){if(!_22){this.addCurrentVertex(_23,this.distance,_26,1,1,false,_1f,_1b);this.e1=this.e2=-1;}if(_25){this.addCurrentVertex(_23,this.distance,_27,-1,-1,false,_1f,_1b);}}else{if(_2f==="round"){if(!_22){this.addCurrentVertex(_23,this.distance,_26,0,0,false,_1f,_1b);this.addCurrentVertex(_23,this.distance,_26,1,1,true,_1f,_1b);this.e1=this.e2=-1;}if(_25){this.addCurrentVertex(_23,this.distance,_27,-1,-1,true,_1f,_1b);this.addCurrentVertex(_23,this.distance,_27,0,0,false,_1f,_1b);}}}}}}}if(_2d&&i<len-1){var _35=_23.dist(_25);if(_35>2*_1d){var _36=_23.add(_25.sub(_23)._mult(_1d/_35)._round());this.distance+=_36.dist(_23);this.addCurrentVertex(_36,this.distance,_27.mult(1),0,0,false,_1f,_1b);_23=_36;}}_22=false;}};_f.prototype.addCurrentVertex=function addCurrentVertex(_37,_38,_39,_3a,_3b,_3c,_3d,_3e){var _3f;var _40=this.layoutVertexArray;var _41=this.indexArray;_3f=_39.clone();if(_3a){_3f._sub(_39.perp()._mult(_3a));}_8(_40,_37,_3f,_3c,false,_3a,_38);this.e3=_3d.vertexLength++;if(this.e1>=0&&this.e2>=0){_41.emplaceBack(this.e1,this.e2,this.e3);_3d.primitiveLength++;}this.e1=this.e2;this.e2=this.e3;_3f=_39.mult(-1);if(_3b){_3f._sub(_39.perp()._mult(_3b));}_8(_40,_37,_3f,_3c,true,-_3b,_38);this.e3=_3d.vertexLength++;if(this.e1>=0&&this.e2>=0){_41.emplaceBack(this.e1,this.e2,this.e3);_3d.primitiveLength++;}this.e1=this.e2;this.e2=this.e3;if(_38>_6/2&&!_3e){this.distance=0;this.addCurrentVertex(_37,this.distance,_39,_3a,_3b,_3c,_3d);}};_f.prototype.addPieSliceVertex=function addPieSliceVertex(_42,_43,_44,_45,_46){_44=_44.mult(_45?-1:1);var _47=this.layoutVertexArray;var _48=this.indexArray;_8(_47,_42,_44,false,_45,0,_43);this.e3=_46.vertexLength++;if(this.e1>=0&&this.e2>=0){_48.emplaceBack(this.e1,this.e2,this.e3);_46.primitiveLength++;}if(_45){this.e2=this.e3;}else{this.e1=this.e3;}};return _f;});