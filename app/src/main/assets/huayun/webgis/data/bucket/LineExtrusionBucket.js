//>>built
define("com/huayun/webgis/data/bucket/LineExtrusionBucket",["../ArrayType","../../gl/SegmentVector","../../utils/earcut","../../gl/programConfig","../../gl/members","../../gl/dataTransfer","com/huayun/webgis/layers/support/EvaluationParameters","../../utils/Constant","../../utils/utils"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9){var _a=["Unknown","Point","LineString","Polygon"];function _b(_c,x,y,_d){_c.emplaceBack(x,y,_d);};var _e=function _e(_f){this.zoom=_f.zoom;this.overscaling=_f.overscaling;this.layers=_f.layers;this.layerIds=this.layers.map(function(_10){return _10.id;});this.index=_f.index;this.hasPattern=false;this.layoutVertexArray=new _1.StructArrayLayout3i6();this.indexArray=new _1.StructArrayLayout2ui4();this.programConfigurations=new _4.ProgramConfigurationSet(_5.members$4,_f.layers,_f.zoom);this.segments=new _2();this.start=0;this.subIndex=0;this.stateDependentLayerIds=this.layers.filter(function(l){return l.isStateDependent();}).map(function(l){return l.id;});};_e.prototype.populate=function populate(_11,_12){this.features=[];this.hasPattern=false;this.start=0;this.subIndex=0;for(var i=0,_13=_11;i<_13.length;i+=1){var ref=_13[i];var _14=ref.feature;var _15=ref.index;var _16=ref.sourceLayerIndex;if(!this.layers[0]._featureFilter(new _7(this.zoom),_14)){continue;}var _17=_9.loadGeometry(_14);var _18={sourceLayerIndex:_16,index:_15,geometry:_17,properties:_14.properties,type:_14.type,patterns:{}};if(typeof _14.id!=="undefined"){_18.id=_14.id;}this.addFeature(_18,_17,_15,{});_12.featureIndex.insert(_14,_17,_15,_16,this.index,true);}};_e.prototype.addFeatures=function addFeatures(_19,_1a){this.start=0;this.subIndex=0;for(var i=0,_1b=this.features;i<_1b.length;i+=1){var _1c=_1b[i];var _1d=_1c.geometry;this.addFeature(_1c,_1d,_1c.index,_1a);}};_e.prototype.update=function update(_1e,_1f,_20){if(!this.stateDependentLayers.length){return;}this.programConfigurations.updatePaintArrays(_1e,_1f,this.stateDependentLayers,_20);};_e.prototype.isEmpty=function isEmpty(){return this.layoutVertexArray.length===0;};_e.prototype.uploadPending=function uploadPending(){return !this.uploaded||this.programConfigurations.needsUpload;};_e.prototype.upload=function upload(_21){if(!this.uploaded){this.layoutVertexBuffer=_21.createVertexBuffer(this.layoutVertexArray,_5.members$4);this.indexBuffer=_21.createIndexBuffer(this.indexArray);}this.programConfigurations.upload(_21);this.uploaded=true;};_e.prototype.destroy=function destroy(){if(!this.layoutVertexBuffer){return;}this.layoutVertexBuffer.destroy();this.indexBuffer.destroy();this.programConfigurations.destroy();this.segments.destroy();};_e.prototype.addFeature=function addFeature(_22,_23,_24,_25){for(var i$4=0,_26=_9.classifyRings(_23,_8.layout.EARCUT_MAX_RINGS);i$4<_26.length;i$4+=1){var _27=_26[i$4];var _28=0;for(var i$1=0,_29=_27;i$1<_29.length;i$1+=1){var _2a=_29[i$1];_28+=_2a.length;}var _2b=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray);this.start=this.subIndex;for(var i$2=0,_2c=_27;i$2<_2c.length;i$2+=1){var _2d=_2c[i$2];if(_2d.length===0){continue;}if(_9.isEntirelyOutside(_2d)){continue;}for(var p=0;p<_2d.length-1;p++){var p1=_2d[p];_b(this.layoutVertexArray,p1.x,p1.y,-1);_b(this.layoutVertexArray,p1.x,p1.y,1);if(!(p1.x===8256||p1.y===8256||p1.x===-64||p1.y===-64)){this.indexArray.emplaceBack(this.subIndex,this.subIndex+1);_2b.vertexLength+=2;_2b.primitiveLength+=1;}if(p>0){var p2=_2d[p-1];if(!((p1.x===p2.x&&(p1.x===8256||p1.x<-10))||(p1.y===p2.y&&(p1.y===8256||p1.y<-10)))){this.indexArray.emplaceBack(this.subIndex-2,this.subIndex);this.indexArray.emplaceBack(this.subIndex-1,this.subIndex+1);_2b.vertexLength+=4;_2b.primitiveLength+=2;}}this.subIndex+=2;}p1=_2d[p];p2=_2d[0];if(!((p1.x===p2.x&&(p1.x===8256||p1.x<-10))||(p1.y===p2.y&&(p1.y===8256||p1.y<-10)))){this.indexArray.emplaceBack(this.subIndex-2,this.start);this.indexArray.emplaceBack(this.subIndex-1,this.start+1);_2b.vertexLength+=4;_2b.primitiveLength+=2;}}if(_2b.vertexLength+_28>_2.MAX_VERTEX_ARRAY_LENGTH){_2b=this.segments.prepareSegment(_28,this.layoutVertexArray,this.indexArray);}}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,_22,_24,_25);};_6.register("LineExtrusionBucket",_e,{omit:["layers","features"]});return _e;});