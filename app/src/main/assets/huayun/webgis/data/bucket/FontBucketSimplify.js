//>>built
define("com/huayun/webgis/data/bucket/FontBucketSimplify",["../ArrayType","../../gl/SegmentVector","../../geometry/Anchor","../../geometry/Point2D","../../gl/TaggedString"],function(_1,_2,_3,_4,_5){var _6=-31;var _7=96;var _8=0;var _9={horizontal:1,vertical:2,horizontalOnly:3};function _a(_b,_c,_d,ox,oy,tx,ty){_b.emplaceBack(_c,_d,Math.round(ox*32),Math.round(oy*32),tx,ty);};function _e(_f,_10,end,_11,_12){if(!_11&&!_12){return;}var _13=_f[end];if(_13.metrics===null){return;}var _14=_13.metrics.advance*_13.scale;var _15=(_f[end].x+_14)*_11;for(var j=_10;j<=end;j++){_f[j].x-=_15;_f[j].y+=_12;}};function _16(_17,_18,_19,_1a,_1b,_1c,_1d,_1e,_1f){var _20=(_18-_19)*_1b;var _21=0;if(_1c!==_1d){_21=-_1e*_1a-_6;}else{_21=(-_1a*_1f+0.5)*_1d;}for(var i$1=0,_22=_17;i$1<_22.length;i$1+=1){var _23=_22[i$1];for(var i=0,_24=_23.positionedGlyphs;i<_24.length;i+=1){var _25=_24[i];_25.x+=_20;_25.y+=_21;}}};function _26(_27,_28,_29,_2a,_2b,_2c){var x=0;var y=_6;var _2d=0;var _2e=0;var _2f=0.5;var _30=0;for(var i$1=0,_31=_2a;i$1<_31.length;i$1+=1){var _32=_31[i$1];var _33=1;var _34=0;var _35={positionedGlyphs:[],lineOffset:0};_27.positionedLines[_30]=_35;var _36=_35.positionedGlyphs;var _37=0;if(!_32.length()){y+=_2b;++_30;continue;}for(var i=0;i<_32.length();i++){var _38=_32.getSection(i);var _39=_32.getSectionIndex(i);var _3a=_32.getCharCode(i);var _3b=0;var _3c=null;var _3d=null;var _3e=null;var _3f=false;var _40=_29[_38.fontStack];var _41=_40&&_40[_3a];if(_41&&_41.rect){_3d=_41.rect;_3c=_41.metrics;}_3b=(_33-_38.scale)*_7;_36.push({glyph:_3a,imageName:_3e,x:x,y:y+_3b,vertical:_3f,scale:_38.scale,fontStack:_38.fontStack,sectionIndex:_39,metrics:_3c,rect:_3d});if(_3c===null){continue;}x+=_3c.advance*_38.scale+_2c;}if(_36.length!==0){var _42=x-_2c;_2d=Math.max(_42,_2d);_e(_36,0,_36.length-1,_2f,_37);}x=0;var _43=_2b*_33+_37;_35.lineOffset=Math.max(_37,_34);y+=_43;_2e=Math.max(_43,_2e);++_30;}var _44=y-_6;var _45=0.5;var _46=0.5;_16(_27.positionedLines,_2f,_45,_46,_2d,_2e,_2b,_44,_2a.length);_27.top+=-_46*_44;_27.bottom=_27.top+_44;_27.left+=-_45*_2d;_27.right=_27.left+_2d;};function _47(_48,_49,_4a,_4b,_4c,_4d,_4e,_4f){var _50=_48.split(/[(\r\n)\r\n]+/);var _51=[];for(var i=0,len=_50.length;i<len;i++){var _52=_50[i];_51[_51.length]=_5.fromFeature({sections:[{fontStack:_49,scale:null,text:_52}]},_49);}var _53=[];var _54={positionedLines:_53,text:_48,top:_4f[1],bottom:_4f[1],left:_4f[0],right:_4f[0],writingMode:_4e,iconsInText:false,verticalizable:false,lineCount:_51.length};_26(_54,_4a,_4b,_51,_4c,_4d);return _54;};function _55(_56,_57,_58){var _59=[];for(var i$1=0,_5a=_57.positionedLines;i$1<_5a.length;i$1+=1){var _5b=_5a[i$1];for(var i=0,_5c=_5b.positionedGlyphs;i<_5c.length;i+=1){var _5d=_5c[i];if(!_5d.rect){continue;}var _5e=_5d.rect||{};var _5f=0;var _60=_8+_5f;var _61=1;var _62=0;var _63=_5d.metrics.advance*_5d.scale/2;var _64=[_5d.x+_63+_58[0],_5d.y+_58[1]];var x1=(_5d.metrics.left-_60)*_5d.scale-_63+_64[0];var y1=(-_5d.metrics.top-_60)*_5d.scale+_64[1];var x2=x1+_5e.w*_5d.scale/_61;var y2=y1+_5e.h*_5d.scale/_61;var tl=new _4(x1,y1);var tr=new _4(x2,y1);var bl=new _4(x1,y2);var br=new _4(x2,y2);_59.push({tl:tl,tr:tr,bl:bl,br:br,tex:_5e,isSDF:true});}}return _59;};var _65=function _65(){this.layoutVertexArray=new _1.StructArrayLayout2f4ib16();this.indexArray=new _1.StructArrayLayout3ui6();this.segments=new _2();};_65.prototype.destroy=function destroy(){if(!this.layoutVertexBuffer){return;}this.layoutVertexBuffer.destroy();this.indexBuffer.destroy();this.segments.destroy();};_65.prototype.addFeature=function(_66,_67,_68,_69,_6a,_6b){var _6c=96;var _6d={horizontal:{},vertical:undefined};var _6e=0.96;var _6f="center";_6b=_6b.map(function(t){return t*96;});var _70=_47(_67,_68,_69,_6a,_6c,_6e,_9.horizontal,_6b);if(_70){_6d.horizontal[_6f]=_70;}for(var i=0;i<_66.length;i++){var _71=_66[i];for(var j=0;j<_71.length;j++){var _72=_71[i];var _73=new _3(_72.x,_72.y,0);var _74=_6d.horizontal.center;var _75=_55(_73,_74,_6b);this.addSymbols(_75,_73);}}};_65.prototype.addSymbols=function addSymbols(_76,_77){var _78=this.indexArray;var _79=this.layoutVertexArray;var _7a=this.segments.prepareSegment(4*_76.length,this.layoutVertexArray,this.indexArray);for(var i=0,_7b=_76;i<_7b.length;i+=1){var _7c=_7b[i];var tl=_7c.tl,tr=_7c.tr,bl=_7c.bl,br=_7c.br,tex=_7c.tex;var _7d=_7a.vertexLength;_a(_79,_77.x,_77.y,tl.x,tl.y,tex.x,tex.y);_a(_79,_77.x,_77.y,tr.x,tr.y,tex.x+tex.w,tex.y);_a(_79,_77.x,_77.y,bl.x,bl.y,tex.x,tex.y+tex.h);_a(_79,_77.x,_77.y,br.x,br.y,tex.x+tex.w,tex.y+tex.h);_78.emplaceBack(_7d,_7d+1,_7d+2);_78.emplaceBack(_7d+1,_7d+2,_7d+3);_7a.vertexLength+=4;_7a.primitiveLength+=2;}};_65.prototype.upload=function upload(_7e){this.layoutVertexBuffer=_7e.createVertexBuffer(this.layoutVertexArray,[{name:"a_pos",type:"Float32",components:2,offset:0},{name:"a_data",type:"Int16",components:4,offset:8}]);this.indexBuffer=_7e.createIndexBuffer(this.indexArray);};return _65;});