//>>built
define("com/huayun/webgis/data/bucket/CircleBucket",["../ArrayType","../../gl/SegmentVector","../../gl/programConfig","../../gl/members","../../gl/dataTransfer","com/huayun/webgis/layers/support/EvaluationParameters","../../utils/utils","../../utils/Constant"],function(_1,_2,_3,_4,_5,_6,_7,_8){function _9(_a,x,y,_b,_c){_a.emplaceBack((x*2)+((_b+1)/2),(y*2)+((_c+1)/2));};var _d=function _d(_e){this.zoom=_e.zoom;this.overscaling=_e.overscaling;this.layers=_e.layers;this.layerIds=this.layers.map(function(_f){return _f.id;});this.index=_e.index;this.hasPattern=false;this.layoutVertexArray=new _1.StructArrayLayout2i4();this.indexArray=new _1.StructArrayLayout3ui6();this.segments=new _2();this.programConfigurations=new _3.ProgramConfigurationSet(_4.members,_e.layers,_e.zoom);this.stateDependentLayerIds=this.layers.filter(function(l){return l.isStateDependent();}).map(function(l){return l.id;});};_d.prototype.populate=function populate(_10,_11){for(var i=0,_12=_10;i<_12.length;i+=1){var ref=_12[i];var _13=ref.feature;var _14=ref.index;var _15=ref.sourceLayerIndex;if(this.layers[0]._featureFilter(new _6(this.zoom),_13)){var _16=_7.loadGeometry(_13);this.addFeature(_13,_16,_14);_11.featureIndex.insert(_13,_16,_14,_15,this.index);}}};_d.prototype.update=function update(_17,_18,_19){if(!this.stateDependentLayers.length){return;}this.programConfigurations.updatePaintArrays(_17,_18,this.stateDependentLayers,_19);};_d.prototype.isEmpty=function isEmpty(){return this.layoutVertexArray.length===0;};_d.prototype.uploadPending=function uploadPending(){return !this.uploaded||this.programConfigurations.needsUpload;};_d.prototype.upload=function upload(_1a){if(!this.uploaded){this.layoutVertexBuffer=_1a.createVertexBuffer(this.layoutVertexArray,_4.members);this.indexBuffer=_1a.createIndexBuffer(this.indexArray);}this.programConfigurations.upload(_1a);this.uploaded=true;};_d.prototype.destroy=function destroy(){if(!this.layoutVertexBuffer){return;}this.layoutVertexBuffer.destroy();this.indexBuffer.destroy();this.programConfigurations.destroy();this.segments.destroy();};_d.prototype.addFeature=function addFeature(_1b,_1c,_1d){var _1e=_8.layout.EXTENT;for(var i$1=0,_1f=_1c;i$1<_1f.length;i$1+=1){var _20=_1f[i$1];for(var i=0,_21=_20;i<_21.length;i+=1){var _22=_21[i];var x=_22.x;var y=_22.y;if(x<0||x>=_1e||y<0||y>=_1e){continue;}var _23=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray);var _24=_23.vertexLength;_9(this.layoutVertexArray,x,y,-1,-1);_9(this.layoutVertexArray,x,y,1,-1);_9(this.layoutVertexArray,x,y,1,1);_9(this.layoutVertexArray,x,y,-1,1);this.indexArray.emplaceBack(_24,_24+1,_24+2);this.indexArray.emplaceBack(_24,_24+3,_24+2);_23.vertexLength+=4;_23.primitiveLength+=2;}}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,_1b,_1d,{});};_5.register("CircleBucket",_d,{omit:["layers"]});return _d;});