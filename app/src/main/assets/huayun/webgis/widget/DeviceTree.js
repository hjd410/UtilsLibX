//>>built
require({cache:{"url:com/huayun/webgis/templates/deviceTree.html":"<div class=\"device-tree-panel\">\r\n    <button data-dojo-attach-event=\"onclick: clear\"></button>\r\n    <div class=\"device-tree-content\">\r\n        <div data-dojo-attach-point =\"deviceTreeNode\"></div>\r\n    </div>\r\n</div>"}});define("com/huayun/webgis/widget/DeviceTree",["dojo/_base/declare","dojo/dom-class","dojo/dom-style","dojo/_base/array","dojo/request","dijit/registry","com/huayun/facades/ConfigFacade","dojo/data/ItemFileWriteStore","dojo/store/Observable","dijit/tree/ForestStoreModel","dijit/Tree","dijit/Menu","dijit/MenuItem","dojo/topic","./MapModuleX","../Feature","../Graphic","../geometry/Point","../geometry/Polyline","../geometry/Multipoint","../geometry/Polygon","../symbols/PointSymbol","../symbols/LineSymbol","../symbols/PolygonSymbol","../utils/wktUtil","./LocatingController","dojo/text!../templates/deviceTree.html"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a,_1b){return _1("com.huayun.webgis.widget.DeviceTree",[_f],{map:null,view:null,localTool:null,templateString:_1b,name:"设备树",vdc_url:"http://vdc-server.test.cloud.zj.sgcc.com.cn/",pdc_url:"http://pdc-server.test.cloud.zj.sgcc.com.cn/",data_url:"http://pdc-server.test.cloud.zj.sgcc.com.cn/deviceService",width:"400px",height:"800px",model:null,store:null,parentNode:null,deviceTreeConfigData:null,rootData:{name:"浙江省电力公司",id:"8a812897493378a001495677ad086663",type:0,buttonList:null,iconClassName:"unit",parentNode:null,children:[]},configFacade:null,buttonArray:null,constructor:function(){this.configFacade=new _7();},postCreate:function(){this.inherited(arguments);_3.set(this.domNode,"pointer-events","all");},_assembleDataHandle:function(_1c){var _1d=this,_1e=_1c.data,_1f=this.parentNode,_20=_1c.configInfo;_4.forEach(_1e,function(_21){_21.id=_21[_20.key];_21.name=_21[_20.label];_21.type=_20.index;_21.buttonList=_20.buttonList;_21.iconClassName=_20.iconClassName;_21.parentNode=_1f;_21.children=[];var _22={parent:_1f,attribute:"children"};_1d.store.newItem(_21,_22);});},clear:function(){_e.publish("clearLocate");},_getTreeDataHandle:function(_23){var _24=this;_4.forEach(_23,function(_25){var url=_25.url;_24.configFacade.getDepartment(url+"&access_token=YH6fXTGYH4DIumSNOii+IzvIeZSrvghHn/FxVfevu92cu0Gzb4yB4MnKjTxLwYh7SELU8C15v07+mXROfZQYDBSzyeoavyabrZ1L+BJwLu0=",function(_26){if(_26.resultState=="0000"){var _27=_26.data;if(_27.length!=0){var _28={configInfo:_25,data:_27};_24._assembleDataHandle(_28);}}},function(err){});});},_addFileHandle:function(_29){var _2a=this.parentNode,_2b=this,_2c=[];_4.forEach(_29,function(_2d,_2e){_2c.push(_2d);_2d.ID=_2a["ID"];_2d.id=_2a["ID"]+_2d.className+_2e;_2d.type=_2d.index;_2d.parentNode=_2a;_2d.childIconClass=_2d.childIconClass;_2d.children=[];var _2f={parent:_2a,attribute:"children"};_2b.store.newItem(_2d,_2f);});},_getNextConfigs:function(){var _30=[],_31=this.parentNode["type"][0];var _32=this.deviceTreeConfigData.configuration.items;_4.forEach(_32,function(_33){var _34=_33.parent;if(_34.indexOf(_31)>-1){_30.push(_33);}});if(_30.length!=0){var _35=this.pdc_url,_36=this.vdc_url;_4.forEach(_30,function(_37){if(_37.serviceName=="featureService"||_37.serviceName=="dataService"){_37["url"]=_36+_37["serviceAddress"];}if(_37.serviceName=="deviceService"){_37["url"]=_35+_37["serviceAddress"];}});var _38=[],_39=this.parentNode,_3a=[];_4.forEach(_30,function(_3b){var _3c=Object.assign({},_3b),url=_3c.url;var _3d=url.match(/{(.*?)}/g);if(_3d!=null){_4.forEach(_3d,function(_3e){var _3f=_3e.replace(/{|}/g,"");url=url.replace(_3e,_39[_3f]);_3c.url=url;});}if(_3c.isFile){_3a.push(_3c);}_38.push(_3c);});if(_3a.length>0){this._addFileHandle(_3a);}else{this._getTreeDataHandle(_38);}}},_getTreeDataByFile:function(url){var _40=this.parentNode,_41=this;this.configFacade.getDepartment(url+"&access_token=YH6fXTGYH4DIumSNOii+IzvIeZSrvghHn/FxVfevu92cu0Gzb4yB4MnKjTxLwYh7SELU8C15v07+mXROfZQYDBSzyeoavyabrZ1L+BJwLu0=",function(_42){if(_42.resultState=="0000"){var _43=_42.data;if(_43.length!=0){_4.forEach(_43,function(_44){_44.id=_44[_40.key];_44.name=_44[_40.label];_44.type=_40.index;_44.iconClassName=_40.childIconClass;_44.parentNode=_40;_44.buttonList=_40.buttonList;_44.children=[];var _45={parent:_40,attribute:"children"};_41.store.newItem(_44,_45);});}}},function(err){});},_getNextLevelData:function(){if(this.parentNode.isFile){var url=this.parentNode.url[0];this._getTreeDataByFile(url);}else{this._getNextConfigs();}},postCreate:function(){this.inherited(arguments);var _46=this;var _47={identifier:"id",label:"name",items:[this.rootData]};this.store=new _8({data:_47});var _48=new _a({store:_46.store,query:{type:"0"},rootId:"root",rootLabel:"Continents",childrenAttrs:["children"],mayHaveChildren:function(_49){}});var _4a=new _b({id:["tree"],model:_48,showRoot:false,persist:true,autoExpand:true,onClick:function(_4b){_46.parentNode=_4b;if(!_4b.children.length){_46._getNextLevelData();}},getIconClass:function(_4c){return _4c.iconClassName;},_createTreeNode:function(_4d){var _4e=new _b._TreeNode(_4d);if(!_4d.isExpandable){var _4f=_4e.item.buttonList;var _50=_4e.item.isFile;if(_4f[0]!=null&&!_50){var _51=_4f[0].className;_2.add(_4e.rowNode,_51);}}return _4e;}},_46.deviceTreeNode);_4a.startup();_e.subscribe("deviceTreeRightMenuClickHandle",function(evt){/!*接收事件信息*!/;var _52=evt.objectInformation,url=this.data_url;if(_52.CLASS_NAME){url+="/"+_52.CLASS_NAME[0]+"/"+_52.id;}else{url+="/Substation/"+_52.id;}_5.get(url+"?RUN_STATUS="+_52.RUN_STATUS[0]+"&depart="+_52.DEPART[0]+"&access_token=YH6fXTGYH4DIumSNOii+IzvIeZSrvghHn/FxVfevu92cu0Gzb4yB4MnKjTxLwYh7SELU8C15v07+mXROfZQYDBSzyeoavyabrZ1L+BJwLu0=",{handleAs:"json"}).then(function(_53){this._drawGraphicHandle(_19.parse2Geometry(_53.data[0].SHAPE));}.bind(this),function(err){});}.bind(this));},_drawGraphicHandle:function(_54){var _55=_54,_56=_55.type,_57=this.map.findLayerById("drawLayer");if(_56==="point"){this.view.setCenter([_55.x,_55.y]);}else{this.view.setCenter([_55.path[0][0].x,_55.path[0][0].y]);}var _58=new _16({color:"#FFFF00",radious:5,strokeColor:"#0000FF",strokeWidth:1});var _59=new _17({color:"#ff2f39",width:3});var _5a=new _18({color:"#0FF",opacity:0.5});switch(_56){case "point":var _5b=new _12(_55.x,_55.y);this.addgraphic(_57,_5b,_58);break;case "multipoint":var _5c=_55.points.map(function(_5d){return new _12(_5d.x,_5d.y);});var _5e=new _14(_5c);this.addgraphic(_57,_5e,_58);break;case "line":var _5f=_55.path.map(function(_60){return _60.map(function(p){return new _12(p.x,p.y);});});var _61=new _13(_5f);this.addgraphic(_57,_61,_59);break;default:var _62=_55.rings.map(function(_63){return _63.map(function(p){return new _12(p.x,p.y);});});var _64=new _15(_62);this.addgraphic(_57,_64,_5a);}},addgraphic:function(_65,_66,_67){var _68=new _10({attributes:null,geometry:_66});var _69=new _11({feature:_68,symbol:_67});_65.addGraphic(_69);this.view.threeRender();},_mountMenuHandle:function(){var _6a=this.buttonArray;_4.forEach(_6a,function(_6b){var _6c=_6b.className,_6d=_6b.list;var _6e=new _c({style:"display: none;",targetNodeIds:["tree"],selector:"."+_6c});_4.forEach(_6d,function(_6f){var _70=_6f.right_label;var _71=new _d({label:"<div>"+_70+"</div>",onClick:function(_72){var _73=_72.target.innerText;var _74=_6.byNode(this.getParent().currentTarget.parentNode).item;var _75={menuName:_73,objectInformation:_74,vdc_url:this.vdc_url,pdc_url:this.pdc_url};_e.publish("deviceTreeRightMenuClickHandle",_75);}});_6e.addChild(_71);_6e.startup();}.bind(this));});},_getButtonListHandle:function(){var _76=this.deviceTreeConfigData.configuration.items,_77=this,obj={};this.buttonArray=[];_4.forEach(_76,function(_78){if(_78.buttonList!=null){var _79=_78.buttonList;if(!obj[_79.className]){_77.buttonArray.push(_79);obj[_79.className]=true;}}});this._mountMenuHandle();},doInit:function(){this.deviceTreeConfigData=this.get("configData");this.map=this.get("map");this.view=this.get("view");this._getButtonListHandle();}});});