//>>built
require({cache:{"url:com/huayun/webgis/templates/deviceTree.html":"<div class=\"device-tree-panel\">\r\n    <button data-dojo-attach-event=\"onclick: clear\"></button>\r\n    <div class=\"device-tree-content\">\r\n        <div data-dojo-attach-point =\"deviceTreeNode\"></div>\r\n    </div>\r\n</div>"}});define("com/huayun/webgis/widget/DeviceTreeOld",["dojo/_base/declare","dojo/dom-class","dojo/_base/array","dijit/registry","com/huayun/facades/ConfigFacade","dojo/data/ItemFileWriteStore","dojo/store/Observable","dijit/tree/ForestStoreModel","dijit/Tree","dijit/Menu","dijit/MenuItem","dojo/topic","com/huayun/webgis/geometry/Point","../geometry/Extent","../geometry/Polyline","../Feature","../Graphic","../symbols/ImageSymbol","com/huayun/webgis/symbols/LineSymbol","./MapModuleX","./LocatingController","dojo/text!../templates/deviceTree.html"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16){return _1("com.huayun.webgis.widget.DeviceTreeOld",[_14],{map:null,localTool:null,templateString:_16,name:"设备树",vdc_url:"http://vdc.prod.cloud.zj.sgcc.com.cn/",pdc_url:"http://pdc.prod.cloud.zj.sgcc.com.cn/",width:"400px",height:"800px",model:null,store:null,parentNode:null,deviceTreeConfigData:null,rootData:{name:"浙江省电力公司",id:"8a812897493378a001495677ad086663",type:0,buttonList:null,iconClassName:"unit",parentNode:null,children:[]},configFacade:null,buttonArray:null,constructor:function(){this.configFacade=new _5();},_assembleDataHandle:function(_17){var _18=this,_19=_17.data,_1a=this.parentNode,_1b=_17.configInfo;_3.forEach(_19,function(_1c){_1c.id=_1c[_1b.key];_1c.name=_1c[_1b.label];_1c.type=_1b.index;_1c.buttonList=_1b.buttonList;_1c.iconClassName=_1b.iconClassName;_1c.parentNode=_1a;_1c.children=[];var _1d={parent:_1a,attribute:"children"};_18.store.newItem(_1c,_1d);});},_getTreeDataHandle:function(_1e){var _1f=this;_3.forEach(_1e,function(_20){var url=_20.url;_1f.configFacade.getDepartment(url,function(_21){if(_21.resultState=="0000"){var _22=_21.data;if(_22.length!=0){var _23={configInfo:_20,data:_22};_1f._assembleDataHandle(_23);}}},function(err){});});},_addFileHandle:function(_24){var _25=this.parentNode,_26=this,_27=[];_3.forEach(_24,function(_28,_29){_27.push(_28);_28.ID=_25["ID"];_28.id=_25["ID"]+_28.className+_29;_28.type=_28.index;_28.parentNode=_25;_28.childIconClass=_28.childIconClass;_28.children=[];var _2a={parent:_25,attribute:"children"};_26.store.newItem(_28,_2a);});},_getNextConfigs:function(){var _2b=[],_2c=this.parentNode["type"][0];var _2d=this.deviceTreeConfigData.configuration.items;_3.forEach(_2d,function(_2e){var _2f=_2e.parent;if(_2f.indexOf(_2c)>-1){_2b.push(_2e);}});if(_2b.length!=0){var _30=this.pdc_url,_31=this.vdc_url;_3.forEach(_2b,function(_32){if(_32.serviceName=="featureService"||_32.serviceName=="dataService"){_32["url"]=_31+_32["serviceAddress"];}if(_32.serviceName=="deviceService"){_32["url"]=_30+_32["serviceAddress"];}});var _33=[],_34=this.parentNode,_35=[];_3.forEach(_2b,function(_36){var _37=Object.assign({},_36),url=_37.url;var _38=url.match(/{(.*?)}/g);if(_38!=null){_3.forEach(_38,function(_39){var _3a=_39.replace(/{|}/g,"");url=url.replace(_39,_34[_3a]);_37.url=url;});}if(_37.isFile){_35.push(_37);}_33.push(_37);});if(_35.length>0){this._addFileHandle(_35);}else{this._getTreeDataHandle(_33);}}},_getTreeDataByFile:function(url){var _3b=this.parentNode,_3c=this;this.configFacade.getDepartment(url,function(_3d){if(_3d.resultState=="0000"){var _3e=_3d.data;if(_3e.length!=0){_3.forEach(_3e,function(_3f){_3f.id=_3f[_3b.key];_3f.name=_3f[_3b.label];_3f.type=_3b.index;_3f.iconClassName=_3b.childIconClass;_3f.parentNode=_3b;_3f.buttonList=_3b.buttonList;_3f.children=[];var _40={parent:_3b,attribute:"children"};_3c.store.newItem(_3f,_40);});}}},function(err){});},_getNextLevelData:function(){if(this.parentNode.isFile){var url=this.parentNode.url[0];this._getTreeDataByFile(url);}else{this._getNextConfigs();}},postCreate:function(){this.inherited(arguments);var _41=this;var _42={identifier:"id",label:"name",items:[this.rootData]};this.store=new _6({data:_42});var _43=new _8({store:_41.store,query:{type:"0"},rootId:"root",rootLabel:"Continents",childrenAttrs:["children"],mayHaveChildren:function(_44){}});var _45=new _9({id:["tree"],model:_43,showRoot:false,persist:true,autoExpand:true,onClick:function(_46){_41.parentNode=_46;if(!_46.children.length){_41._getNextLevelData();}},getIconClass:function(_47){return _47.iconClassName;},_createTreeNode:function(_48){var _49=new _9._TreeNode(_48);if(!_48.isExpandable){var _4a=_49.item.buttonList;var _4b=_49.item.isFile;if(_4a[0]!=null&&!_4b){var _4c=_4a[0].className;_2.add(_49.rowNode,_4c);}}return _49;}},_41.deviceTreeNode);_45.startup();},_mountMenuHandle:function(){var _4d=this.buttonArray;var _4e=this;_3.forEach(_4d,function(_4f){var _50=_4f.className,_51=_4f.list;var _52=new _a({style:"display: none;",targetNodeIds:["tree"],selector:"."+_50});_3.forEach(_51,function(_53){var _54=_53.right_label;var _55=new _b({label:"<div>"+_54+"</div>",onClick:function(_56){var _57=_56.target.innerText;var _58=_4.byNode(this.getParent().currentTarget.parentNode).item;var _59={menuName:_57,objectInformation:_58};var _5a=_58["CLASS_ID"]?_58["CLASS_ID"][0]:_58["STATION_CLASS_ID"][0];var _5b=_4e.modelClass[_5a].table;_4e.configFacade.getGeometry(_4e.vdc_url+"featureService/"+_5b+"/"+_58.id[0],function(_5c){_4e._graphicLayer.clear();var _5d=_5c.data[0].SHAPE;if(_5d.startsWith("POINT")){_4e.locatePoint(_4e.geometry2geoJson(_5d));}else{if(_5d.startsWith("MULTILINESTRING")){_4e.locateMultiLines(_5d);}}});}});_52.addChild(_55);_52.startup();});});},_getButtonListHandle:function(){var _5e=this.deviceTreeConfigData.configuration.items,_5f=this,obj={};this.buttonArray=[];_3.forEach(_5e,function(_60){if(_60.buttonList!=null){var _61=_60.buttonList;if(!obj[_61.className]){_5f.buttonArray.push(_61);obj[_61.className]=true;}}});this._mountMenuHandle();},doInit:function(){this.deviceTreeConfigData=this.get("configData");this.map=this.get("map");this.view=this.get("view");this.maxLevel=this.view.maxLevel;this._graphicLayer=this.map.findLayerById("drawLayer");this._getButtonListHandle();this.dotSymbol=new _12({url:"../dojo/com/huayun/webgis/css/images/red.png",width:21,height:33,fixedSize:true});this._lineSymbol=new _13({color:"#FF0000",width:1,});this.modelClass={};var _62=this.deviceTreeConfigData.configuration.items;this.configFacade.getModelClass(_62,function(_63){var _64=_63.data,_65;for(var i=0;i<_64.length;i++){_65=_64[i];this.modelClass[_65["CLASS_ID"]]={"name":_65["CLASS_NAME"],"table":_65["G_TABLE_NAME"]};}}.bind(this));},geometry2geoJson:function(_66){var _67={};var _66=_66.toLocaleUpperCase();if(_66.startsWith("POINT")){_67["type"]="POINT";var _68=_66.indexOf("(");var _69=_66.indexOf(")");var _6a=_66.slice(_68+1,_69);var _6b=_6a.split(" ");_67["coordinates"]=_6b;}else{if(_66.startsWith("MULTIPOINT")){_67["type"]="MULTIPOINT";var _6c=_66.indexOf("(");var _6d=_66.indexOf(")");var _6e=_66.slice(_6c+1,_6d);var _6f=_6e.split(",");var _70=[];_6f.forEach(function(_71){_70.push(_71.split(" "));});_67["coordinates"]=_70;}else{if(_66.startsWith("LINESTRING")){_67["type"]="LINESTRING";var _6c=_66.indexOf("(");var _6d=_66.indexOf(")");var _72=_66.slice(_6c+1,_6d);var _73=_72.split(",");var _74=[];_73.forEach(function(_75){_74.push(_75.split(" "));});_67["coordinates"]=_74;}else{if(_66.startsWith("MULTILINESTRING")){}else{if(_66.startsWith("POLYGON")){_67["type"]="POLYGON";var _68=_66.indexOf("(");var _69=_66.indexOf(")");var str=_66.substring(_68+1,_66.length-1);var arr=[];var _76=str.split(",");_76.forEach(function(_77){arr.push(_77.split(" "));});_67["coordinates"]=arr;}}}}}return _67;},locatePoint:function(_78){var _79={x:Number(_78.coordinates[0]),y:Number(_78.coordinates[1])};var _7a=new _d(_79.x,_79.y,0.1);var _7b=new _10({geometry:_7a});var _7c=new _11({feature:_7b,symbol:this.dotSymbol});this._graphicLayer.addGraphic(_7c);this.view.centerAt(_79.x,_79.y);},locateMultiLines:function(_7d){if(_7d.indexOf("EMPTY")>-1){alert("没有数据!");}else{var str=_7d.substring(17,_7d.length-2);var _7e=str.split("),(");var _7f,_80;var _81=[],xy,p,x,y,_82=[];var _83,_84=0,_85,_86=0;for(var i=0,ii=_7e.length;i<ii;i++){var _87=_7e[i].split(",");_81=[];for(var j=0,jj=_87.length;j<jj;j++){_80=_87[j];xy=_80.split(" ");x=Number(xy[0]);y=Number(xy[1]);if(!_83||x<_83){_83=x;}else{if(x>_84){_84=x;}}if(!_85||y<_85){_85=y;}else{if(y>_86){_86=y;}}_81.push({x:x,y:y});}_82.push(_81);}var _88=new _e(_83,_85,_84,_86);this.view.setExtent(_88);for(i=0,ii=_82.length;i<ii;i++){var _89=new _f();_89.setPath([_82[i]]);var _8a=new _10({geometry:_89});var _8b=new _11({feature:_8a,symbol:this._lineSymbol});this._graphicLayer.addGraphic(_8b);}this.view.threeRender();}},addLine:function(_8c,_8d){var _8e=new _f();_8e.setPath([[_8c,_8d]]);var _8f=new _10({geometry:_8e});var _90=new _11({feature:_8f,symbol:this._lineSymbol});this._graphicLayer.addGraphic(_90);},clear:function(){this._graphicLayer.clear();}});});