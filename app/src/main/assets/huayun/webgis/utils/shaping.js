//>>built
define("com/huayun/webgis/utils/shaping",["exports","./verticalizePunctuation","./rtlTextPlugin","./scriptDetection","./Constant"],function(_1,_2,_3,_4,_5){var _6={horizontal:1,vertical:2,horizontalOnly:3};var _7={};_7[9]=true;_7[10]=true;_7[11]=true;_7[12]=true;_7[13]=true;_7[32]=true;var _8={};_8[10]=true;_8[32]=true;_8[38]=true;_8[40]=true;_8[41]=true;_8[43]=true;_8[45]=true;_8[47]=true;_8[173]=true;_8[183]=true;_8[8203]=true;_8[8208]=true;_8[8211]=true;_8[8231]=true;var _9=function _9(){this.text="";this.sectionIndex=[];this.sections=[];};_9.fromFeature=function(_a,_b){var _c=new _9();for(var i=0;i<_a.sections.length;i++){var _d=_a.sections[i];_c.sections.push({scale:_d.scale||1,fontStack:_d.fontStack||_b});_c.text+=_d.text;for(var j=0;j<_d.text.length;j++){_c.sectionIndex.push(i);}}return _c;};_9.prototype.length=function(){return this.text.length;};_9.prototype.getSection=function(_e){return this.sections[this.sectionIndex[_e]];};_9.prototype.getCharCode=function(_f){return this.text.charCodeAt(_f);};_9.prototype.verticalizePunctuation=function(){this.text=_2(this.text);};_9.prototype.trim=function trim(){var _10=0;for(var i=0;i<this.text.length&&_7[this.text.charCodeAt(i)];i++){_10++;}var _11=this.text.length;for(var i$1=this.text.length-1;i$1>=0&&i$1>=_10&&_7[this.text.charCodeAt(i$1)];i$1--){_11--;}this.text=this.text.substring(_10,_11);this.sectionIndex=this.sectionIndex.slice(_10,_11);};_9.prototype.substring=function substring(_12,end){var _13=new _9();_13.text=this.text.substring(_12,end);_13.sectionIndex=this.sectionIndex.slice(_12,end);_13.sections=this.sections;return _13;};_9.prototype.toString=function toString(){return this.text;};_9.prototype.getMaxScale=function getMaxScale(){var _14=this;return this.sectionIndex.reduce(function(max,_15){return Math.max(max,_14.sections[_15].scale);},0);};function _16(_17,_18,_19,_1a){var _1b=0;for(var _1c=0;_1c<_17.length();_1c++){var _1d=_17.getSection(_1c);var _1e=_1a[_1d.fontStack];var _1f=_1e&&_1e[_17.getCharCode(_1c)];if(!_1f){continue;}_1b+=_1f.metrics.advance*_1d.scale+_18;}var _20=Math.max(1,Math.ceil(_1b/_19));return _1b/_20;};function _21(_22,_23,_24,_25){var _26=Math.pow(_22-_23,2);if(_25){if(_22<_23){return _26/2;}else{return _26*2;}}return _26+Math.abs(_24)*_24;};function _27(_28,_29,_2a,_2b,_2c,_2d){var _2e=null;var _2f=_21(_29,_2a,_2c,_2d);for(var i=0,_30=_2b;i<_30.length;i+=1){var _31=_30[i];var _32=_29-_31.x;var _33=_21(_32,_2a,_2c,_2d)+_31.badness;if(_33<=_2f){_2e=_31;_2f=_33;}}return {index:_28,x:_29,priorBreak:_2e,badness:_2f};};function _34(_35){if(!_35){return [];}return _34(_35.priorBreak).concat(_35.index);};function _36(_37,_38,_39){var _3a=0;if(_37===10){_3a-=10000;}if(_39){_3a+=150;}if(_37===40||_37===65288){_3a+=50;}if(_38===41||_38===65289){_3a+=50;}return _3a;};function _3b(_3c,_3d,_3e,_3f){if(!_3e){return [];}if(!_3c){return [];}var _40=[];var _41=_16(_3c,_3d,_3e,_3f);var _42=_3c.text.indexOf("â€‹")>=0;var _43=0;for(var i=0;i<_3c.length();i++){var _44=_3c.getSection(i);var _45=_3c.getCharCode(i);var _46=_3f[_44.fontStack];var _47=_46&&_46[_45];if(_47&&!_7[_45]){_43+=_47.metrics.advance*_44.scale+_3d;}if(i<_3c.length()-1){var _48=_4.charAllowsIdeographicBreaking(_45);if(_8[_45]||_48){_40.push(_27(i+1,_43,_41,_40,_36(_45,_3c.getCharCode(i+1),_48&&_42),false));}}}return _34(_27(_3c.length(),_43,_41,_40,0,true));};function _49(_4a,_4b){var _4c=[];var _4d=_4a.text;var _4e=0;for(var i=0,_4f=_4b;i<_4f.length;i+=1){var _50=_4f[i];_4c.push(_4a.substring(_4e,_50));_4e=_50;}if(_4e<_4d.length){_4c.push(_4a.substring(_4e,_4d.length));}return _4c;};function _51(_52,_53,_54,end,_55){if(!_55){return;}var _56=_52[end];var _57=_53[_56.fontStack];var _58=_57&&_57[_56.glyph];if(_58){var _59=_58.metrics.advance*_56.scale;var _5a=(_52[end].x+_59)*_55;for(var j=_54;j<=end;j++){_52[j].x-=_5a;}}};function _5b(_5c){var _5d=0.5,_5e=0.5;switch(_5c){case "right":case "top-right":case "bottom-right":_5d=1;break;case "left":case "top-left":case "bottom-left":_5d=0;break;}switch(_5c){case "bottom":case "bottom-right":case "bottom-left":_5e=1;break;case "top":case "top-right":case "top-left":_5e=0;break;}return {horizontalAlign:_5d,verticalAlign:_5e};};function _5f(_60,_61,_62,_63,_64,_65,_66){var _67=(_61-_62)*_64;var _68=(-_63*_66+0.5)*_65;for(var j=0;j<_60.length;j++){_60[j].x+=_67;_60[j].y+=_68;}};function _69(_6a,_6b,_6c,_6d,_6e,_6f,_70,_71){var _72=-17;var x=0;var y=_72;var _73=0;var _74=_6a.positionedGlyphs;var _75=_6f==="right"?1:_6f==="left"?0:0.5;for(var i$1=0,_76=_6c;i$1<_76.length;i$1+=1){var _77=_76[i$1];_77.trim();var _78=_77.getMaxScale();if(!_77.length()){y+=_6d;continue;}var _79=_74.length;for(var i=0;i<_77.length();i++){var _7a=_77.getSection(i);var _7b=_77.getCharCode(i);var _7c=(_78-_7a.scale)*24;var _7d=_6b[_7a.fontStack];var _7e=_7d&&_7d[_7b];if(!_7e){continue;}if(!_4.charHasUprightVerticalOrientation(_7b)||_70===_6.horizontal){_74.push({glyph:_7b,x:x,y:y+_7c,vertical:false,scale:_7a.scale,fontStack:_7a.fontStack});x+=_7e.metrics.advance*_7a.scale+_71;}else{_74.push({glyph:_7b,x:x,y:_7c,vertical:true,scale:_7a.scale,fontStack:_7a.fontStack});x+=_5.ONE_EM*_7a.scale+_71;}}if(_74.length!==_79){var _7f=x-_71;_73=Math.max(_7f,_73);_51(_74,_6b,_79,_74.length-1,_75);}x=0;y+=_6d*_78;}var ref=_5b(_6e);var _80=ref.horizontalAlign;var _81=ref.verticalAlign;_5f(_74,_75,_80,_81,_73,_6d,_6c.length);var _82=y-_72;_6a.top+=-_81*_82;_6a.bottom=_6a.top+_82;_6a.left+=-_80*_73;_6a.right=_6a.left+_73;};function _83(_84,_85,_86,_87,_88,_89,_8a,_8b,_8c,_8d){var _8e=_9.fromFeature(_84,_86);if(_8d===_6.vertical){_8e.verticalizePunctuation();}var _8f;var _90=_3.processBidirectionalText;var _91=_3.processStyledBidirectionalText;if(_90&&_8e.sections.length===1){_8f=[];var _92=_90(_8e.toString(),_3b(_8e,_8b,_87,_85));for(var i$1=0,_93=_92;i$1<_93.length;i$1+=1){var _94=_93[i$1];var _95=new _9();_95.text=_94;_95.sections=_8e.sections;for(var i=0;i<_94.length;i++){_95.sectionIndex.push(0);}_8f.push(_95);}}else{if(_91){_8f=[];var _96=_91(_8e.text,_8e.sectionIndex,_3b(_8e,_8b,_87,_85));for(var i$2=0,_97=_96;i$2<_97.length;i$2+=1){var _98=_97[i$2];var _99=new _9();_99.text=_98[0];_99.sectionIndex=_98[1];_99.sections=_8e.sections;_8f.push(_99);}}else{_8f=_49(_8e,_3b(_8e,_8b,_87,_85));}}var _9a=[];var _9b={positionedGlyphs:_9a,text:_8e.toString(),top:_8c[1],bottom:_8c[1],left:_8c[0],right:_8c[0],writingMode:_8d,lineCount:_8f.length};_69(_9b,_85,_8f,_88,_89,_8a,_8d,_8b);if(!_9a.length){return false;}return _9b;};function _9c(_9d,_9e,_9f){var ref=_5b(_9f);var _a0=ref.horizontalAlign;var _a1=ref.verticalAlign;var dx=_9e[0];var dy=_9e[1];var x1=dx-_9d.displaySize[0]*_a0;var x2=x1+_9d.displaySize[0];var y1=dy-_9d.displaySize[1]*_a1;var y2=y1+_9d.displaySize[1];return {image:_9d,top:y1,bottom:y2,left:x1,right:x2};};_1.WritingMode=_6;_1.shapeText=_83;_1.shapeIcon=_9c;});