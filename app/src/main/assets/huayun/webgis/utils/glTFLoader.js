//>>built
define("com/huayun/webgis/utils/glTFLoader",["exports","./Resource","./utils","custom/gl-matrix-min"],function(_1,_2,_3,_4){function _5(_6){var _7=_6.children;var _8={children:[]};for(var i=0;i<_7.length;i++){var _9=_7[i];_8.children.push({drawMode:_9.drawMode,geometry:_9.geometry,material:_9.material,name:_9.name});}return _8;};var _a;var _b=/^data:(.*?)(;base64)?,(.*)$/;var _c={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",MSFT_TEXTURE_DDS:"MSFT_texture_dds"};var _d={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};var _e={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex",};var _f={"SCALAR":1,"VEC2":2,"VEC3":3,"VEC4":4,"MAT2":4,"MAT3":9,"MAT4":16};var _10={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};var _11={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123};function _12(url,_13,_14){if(!_14&&typeof _14!=="function"){_14=function(){};}_2.loadJson(url,function(_15,_16){if(_15){_14(_15);}else{if(_16.asset===undefined||_16.asset.version[0]<2){_14(new Error("Unsupported asset. glTF versions >=2.0 are supported"));return;}var _17={};if(_16.extensionsUsed){}var _18=new _19(_16,_17,{});_18.parse(_13,_14);}});};function _1a(_1b,_1c){if(_1c.extras!==undefined){if(typeof _1c.extras==="object"){Object.assign(_1b.userData,_1c.extras);}else{}}};function _19(_1d,_1e,_1f){this.json=_1d||{};this.extensions=_1e||{};this.options=_1f||{};this.cache={};this.primitiveCache={};};_19.prototype.parse=function(_20,_21){var _22=this;var _23=this.json;var _24=this.extensions;this.cache={};this.markDefs();Promise.all([this.getDependencies("scene"),this.getDependencies("animation"),this.getDependencies("camera")]).then(function(_25){var _26={scene:_25[0][_23.scene||0],scenes:_25[0],animations:_25[1],cameras:_25[2],asset:_23.asset,parser:_22,userData:{}};_20(_26);});};_19.prototype.markDefs=function(){var _27=this.json;var _28=_27.nodes||[];var _29=_27.skins||[];var _2a=_27.meshes||[];var _2b={};var _2c={};for(var _2d=0,_2e=_29.length;_2d<_2e;_2d++){var _2f=_29[_2d].joints;for(var i=0,il=_2f.length;i<il;i++){_28[_2f[i]].isBone=true;}}for(var _30=0,_31=_28.length;_30<_31;_30++){var _32=_28[_30];if(_32.mesh!==undefined){if(_2b[_32.mesh]===undefined){_2b[_32.mesh]=_2c[_32.mesh]=0;}_2b[_32.mesh]++;if(_32.skin!==undefined){_2a[_32.mesh].isSkinnedMesh=true;}}}_27.meshReferences=_2b;_27.meshUses=_2c;};_19.prototype.getDependencies=function(_33){var _34=this.cache[_33];if(!_34){var _35=this;var _36=this.json[_33+(_33==="mesh"?"es":"s")]||[];_34=Promise.all(_36.map(function(def,_37){return _35.getDependency(_33,_37);}));this.cache[_33]=_34;}return _34;};_19.prototype.getDependency=function(_38,_39){var _3a=_38+":"+_39;var _3b=this.cache[_3a];if(!_3b){switch(_38){case "scene":_3b=this.loadScene(_39);break;case "node":_3b=this.loadNode(_39);break;case "mesh":_3b=this.loadMesh(_39);break;case "accessor":_3b=this.loadAccessor(_39);break;case "bufferView":_3b=this.loadBufferView(_39);break;case "buffer":_3b=this.loadBuffer(_39);break;case "material":_3b=this.loadMaterial(_39);break;case "camera":_3b=this.loadCamera(_39);break;case "animation":_3b=this.loadAnimation(_39);break;}this.cache[_3a]=_3b;}return _3b;};function _3c(_3d,_3e,_3f,_40){var _41=_3f.nodes[_3d];return _40.getDependency("node",_3d).then(function(_42){if(_41.skin===undefined){return _42;}var _43;return _40.getDependency("skin",_41.skin).then(function(_44){_43=_44;var _45=[];for(var i=0,il=_43.joints.length;i<il;i++){_45.push(_40.getDependency("node",_43.joints[i]));}return Promise.all(_45);}).then(function(_46){var _47=_42.isGroup===true?_42.children:[_42];for(var i=0,il=_47.length;i<il;i++){var _48=_47[i];var _49=[];var _4a=[];for(var j=0,jl=_46.length;j<jl;j++){var _4b=_46[j];if(_4b){_49.push(_4b);var mat=new THREE.Matrix4();if(_43.inverseBindMatrices!==undefined){mat.fromArray(_43.inverseBindMatrices.array,j*16);}_4a.push(mat);}else{}}_48.bind(new THREE.Skeleton(_49,_4a),_48.matrixWorld);}return _42;});}).then(function(_4c){if(!_3e.children){_3e.children=[];}_3e.children.push(_4c);var _4d=[];if(_41.children){var _4e=_41.children;for(var i=0,il=_4e.length;i<il;i++){var _4f=_4e[i];_4d.push(_3c(_4f,_4c,_3f,_40));}}return Promise.all(_4d);});};_19.prototype.loadScene=function(_50){var _51=this.json;var _52=this.extensions;var _53=this.json.scenes[_50];var _54=this;var _55={};if(_53.name!==undefined){_55.name=_53.name;}_1a(_55,_53);if(_53.extensions){addUnknownExtensionsToUserData(_52,_55,_53);}var _56=_53.nodes||[];var _57=[];for(var i=0,il=_56.length;i<il;i++){_57.push(_3c(_56[i],_55,_51,_54));}return Promise.all(_57).then(function(){return _55;});};_19.prototype.loadNode=function(_58){var _59=this.json;var _5a=this.extensions;var _5b=this;var _5c=_59.meshReferences;var _5d=_59.meshUses;var _5e=_59.nodes[_58];var _5f;if(_5e.isBone===true){}else{if(_5e.mesh!==undefined){_5f=_5b.getDependency("mesh",_5e.mesh).then(function(_60){var _61;if(_5c[_5e.mesh]>1){var _62=_5d[_5e.mesh]++;_61=_5(_60);_61.name+="_instance_"+_62;_61.onBeforeRender=_60.onBeforeRender;for(var i=0,il=_61.children.length;i<il;i++){_61.children[i].name+="_instance_"+_62;_61.children[i].onBeforeRender=_60.children[i].onBeforeRender;}}else{_61=_60;}if(_5e.weights!==undefined){_61.traverse(function(o){if(!o.isMesh){return;}for(var i=0,il=_5e.weights.length;i<il;i++){o.morphTargetInfluences[i]=_5e.weights[i];}});}return _61;});}else{if(_5e.camera!==undefined){_5f=_5b.getDependency("camera",_5e.camera);}else{if(_5e.extensions&&_5e.extensions[_c.KHR_LIGHTS_PUNCTUAL]&&_5e.extensions[_c.KHR_LIGHTS_PUNCTUAL].light!==undefined){}else{_5f=Promise.resolve({});}}}}return _5f.then(function(_63){if(_5e.name!==undefined){_63.name=_5e.name;}_1a(_63,_5e);if(_5e.extensions){addUnknownExtensionsToUserData(_5a,_63,_5e);}if(_5e.matrix!==undefined){_63.matrix=_4.mat4.clone(_5e.matrix);}else{}return _63;});};function _64(){return {color:16777215,emissive:0,metalness:1,roughness:1,transparent:false,depthTest:true,side:1};};_19.prototype.loadMesh=function(_65){var _66=this;var _67=this.json;var _68=_67.meshes[_65];var _69=_68.primitives;var _6a=[];for(var i=0,il=_69.length;i<il;i++){var _6b=_69[i].material===undefined?_64():this.getDependency("material",_69[i].material);_6a.push(_6b);}return Promise.all(_6a).then(function(_6c){return _66.loadGeometries(_69).then(function(_6d){var _6e=[];for(var i=0,il=_6d.length;i<il;i++){var _6f=_6d[i];var _70=_69[i];var _71;var _72=_6c[i];if(_70.mode===_11.TRIANGLES||_70.mode===_11.TRIANGLE_STRIP||_70.mode===_11.TRIANGLE_FAN||_70.mode===undefined){_71=_68.isSkinnedMesh===true?{geometry:_6f,material:_72}:{geometry:_6f,material:_72};if(_71.isSkinnedMesh===true){_71.normalizeSkinWeights();}if(_70.mode===_11.TRIANGLE_STRIP){_71.drawMode="TriangleStrip";}else{if(_70.mode===_11.TRIANGLE_FAN){_71.drawMode="TriangleFan";}else{_71.drawMode="TRIANGLES";}}}else{if(_70.mode===_11.LINES){_71={geometry:_6f,material:_72,drawMode:"Lines"};}else{if(_70.mode===_11.LINE_STRIP){_71={geometry:_6f,material:_72,drawMode:"LineStrip"};}else{if(_70.mode===_11.LINE_LOOP){_71={geometry:_6f,material:_72,drawMode:"LineLoop"};}else{if(_70.mode===_11.POINTS){_71={geometry:_6f,material:_72,drawMode:"Points"};}else{throw new Error("Primitive mode unsupported: "+_70.mode);}}}}}if(_71.geometry.morphAttributes&&Object.keys(_71.geometry.morphAttributes).length>0){updateMorphTargets(_71,_68);}_71.name=_68.name||("mesh_"+_65);if(_6d.length>1){_71.name+="_"+i;}_1a(_71,_68);_66.assignFinalMaterial(_71);_6e.push(_71);}if(_6e.length===1){return {children:_6e};}var _73={children:[]};for(var i=0,il=_6e.length;i<il;i++){_73.children.push(_6e[i]);}return _73;});});};_19.prototype.assignFinalMaterial=function(_74){var _75=_74.geometry;var _76=_74.material;var _77=this.extensions;var _78=_75.attributes.tangent!==undefined;var _79=_75.attributes.color!==undefined;var _7a=_75.attributes.normal===undefined;var _7b=_74.isSkinnedMesh===true;var _7c=_75.morphAttributes&&Object.keys(_75.morphAttributes).length>0;var _7d=_7c&&_75.morphAttributes&&_75.morphAttributes.normal!==undefined;if(_74.isPoints){}else{if(_74.isLine){}}if(_78||_79||_7a||_7b||_7c){var _7e="ClonedMaterial:"+_76.uuid+":";if(_76.isGLTFSpecularGlossinessMaterial){_7e+="specular-glossiness:";}if(_7b){_7e+="skinning:";}if(_78){_7e+="vertex-tangents:";}if(_79){_7e+="vertex-colors:";}if(_7a){_7e+="flat-shading:";}if(_7c){_7e+="morph-targets:";}if(_7d){_7e+="morph-normals:";}var _7f=this.cache[_7e];if(!_7f){_7f=_76.isGLTFSpecularGlossinessMaterial?_77[_c.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].cloneMaterial(_76):_76.clone();if(_7b){_7f.skinning=true;}if(_78){_7f.vertexTangents=true;}if(_79){_7f.vertexColors=THREE.VertexColors;}if(_7a){_7f.flatShading=true;}if(_7c){_7f.morphTargets=true;}if(_7d){_7f.morphNormals=true;}this.cache[_7e]=_7f;}_76=_7f;}if(_76.aoMap&&_75.attributes.uv2===undefined&&_75.attributes.uv!==undefined){}if(_76.isGLTFSpecularGlossinessMaterial){_74.onBeforeRender=_77[_c.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].refreshUniforms;}_74.material=_76;};_19.prototype.loadMaterial=function(_80){var _81=this;var _82=this.json;var _83=this.extensions;var _84=_82.materials[_80];var _85;var _86={};var _87=_84.extensions||{};var _88=[];if(_87[_c.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){}else{if(_87[_c.KHR_MATERIALS_UNLIT]){}else{var _89=_84.pbrMetallicRoughness||{};_86.color=[1,1,1];_86.opacity=1;if(Array.isArray(_89.baseColorFactor)){var _8a=_89.baseColorFactor;_86.color=_8a.slice(0,3);_86.opacity=_8a[3];}if(_89.baseColorTexture!==undefined){}_86.metalness=_89.metallicFactor!==undefined?_89.metallicFactor:1;_86.roughness=_89.roughnessFactor!==undefined?_89.roughnessFactor:1;if(_89.metallicRoughnessTexture!==undefined){}}}if(_84.doubleSided===true){_86.side=2;}var _8b=_84.alphaMode||_d.OPAQUE;if(_8b===_d.BLEND){_86.transparent=true;}else{_86.transparent=false;if(_8b===_d.MASK){_86.alphaTest=_84.alphaCutoff!==undefined?_84.alphaCutoff:0.5;}}if(_84.normalTexture!==undefined){}if(_84.occlusionTexture!==undefined){}if(_84.emissiveFactor!==undefined){_86.emissive=_84.emissiveFactor;}if(_84.emissiveTexture!==undefined){}return Promise.all(_88).then(function(){return _86;});};function _8c(_8d){var _8e=_8d.extensions&&_8d.extensions[_c.KHR_DRACO_MESH_COMPRESSION];var _8f;if(_8e){_8f="draco:"+_8e.bufferView+":"+_8e.indices+":"+_90(_8e.attributes);}else{_8f=_8d.indices+":"+_90(_8d.attributes)+":"+_8d.mode;}return _8f;};function _90(_91){var _92="";var _93=Object.keys(_91).sort();for(var i=0,il=_93.length;i<il;i++){_92+=_93[i]+":"+_91[_93[i]]+";";}return _92;};function _94(_95,_96,_97){var _98=_96.attributes;var _99=[];function _9a(_9b,_9c){return _97.getDependency("accessor",_9b).then(function(_9d){_95.attributes[_9c]=_9d;});};for(var _9e in _98){var _9f=_e[_9e]||_9e.toLowerCase();if(_9f in _95.attributes){continue;}_99.push(_9a(_98[_9e],_9f));}if(_96.indices!==undefined&&!_95.index){var _a0=_97.getDependency("accessor",_96.indices).then(function(_a1){_95.index=_a1;});_99.push(_a0);}_1a(_95,_96);return Promise.all(_99).then(function(){return _96.targets!==undefined?_a2(_95,_96.targets,_97):_95;});};function _a3(_a4){if(_a4.isInterleavedBufferAttribute){var _a5=_a4.count;var _a6=_a4.itemSize;var _a7=_a4.array.slice(0,_a5*_a6);for(var i=0,j=0;i<_a5;++i){_a7[j++]=_a4.getX(i);if(_a6>=2){_a7[j++]=_a4.getY(i);}if(_a6>=3){_a7[j++]=_a4.getZ(i);}if(_a6>=4){_a7[j++]=_a4.getW(i);}}return {array:_a7,itemSize:_a6,count:_a7.length/_a6,dynamic:false,normalized:_a4.normalized===true};}return _a4.clone();};function _a2(_a8,_a9,_aa){var _ab=false;var _ac=false;for(var i=0,il=_a9.length;i<il;i++){var _ad=_a9[i];if(_ad.POSITION!==undefined){_ab=true;}if(_ad.NORMAL!==undefined){_ac=true;}if(_ab&&_ac){break;}}if(!_ab&&!_ac){return Promise.resolve(_a8);}var _ae=[];var _af=[];for(var i=0,il=_a9.length;i<il;i++){var _ad=_a9[i];if(_ab){var _b0=_ad.POSITION!==undefined?_aa.getDependency("accessor",_ad.POSITION):_a8.attributes.position;_ae.push(_b0);}if(_ac){var _b0=_ad.NORMAL!==undefined?_aa.getDependency("accessor",_ad.NORMAL):_a8.attributes.normal;_af.push(_b0);}}return Promise.all([Promise.all(_ae),Promise.all(_af)]).then(function(_b1){var _b2=_b1[0];var _b3=_b1[1];for(var i=0,il=_b2.length;i<il;i++){if(_a8.attributes.position===_b2[i]){continue;}_b2[i]=_a3(_b2[i]);}for(var i=0,il=_b3.length;i<il;i++){if(_a8.attributes.normal===_b3[i]){continue;}_b3[i]=_a3(_b3[i]);}for(var i=0,il=_a9.length;i<il;i++){var _b4=_a9[i];var _b5="morphTarget"+i;if(_ab){if(_b4.POSITION!==undefined){var _b6=_b2[i];_b6.name=_b5;var _b7=_a8.attributes.position;for(var j=0,jl=_b6.count;j<jl;j++){_b6.setXYZ(j,_b6.getX(j)+_b7.getX(j),_b6.getY(j)+_b7.getY(j),_b6.getZ(j)+_b7.getZ(j));}}}if(_ac){if(_b4.NORMAL!==undefined){var _b8=_b3[i];_b8.name=_b5;var _b9=_a8.attributes.normal;for(var j=0,jl=_b8.count;j<jl;j++){_b8.setXYZ(j,_b8.getX(j)+_b9.getX(j),_b8.getY(j)+_b9.getY(j),_b8.getZ(j)+_b9.getZ(j));}}}}if(_ab){_a8.morphAttributes.position=_b2;}if(_ac){_a8.morphAttributes.normal=_b3;}return _a8;});};_19.prototype.loadGeometries=function(_ba){var _bb=this;var _bc=this.extensions;var _bd=this.primitiveCache;var _be=[];for(var i=0,il=_ba.length;i<il;i++){var _bf=_ba[i];var _c0=_8c(_bf);var _c1=_bd[_c0];if(_c1){_be.push(_c1.promise);}else{var _c2;if(_bf.extensions&&_bf.extensions[_c.KHR_DRACO_MESH_COMPRESSION]){}else{_c2=_94({attributes:{},index:null},_bf,_bb);}_bd[_c0]={primitive:_bf,promise:_c2};_be.push(_c2);}}return Promise.all(_be);};_19.prototype.loadAccessor=function(_c3){var _c4=this;var _c5=this.json;var _c6=_c5.accessors[_c3];if(_c6.bufferView===undefined&&_c6.sparse===undefined){return Promise.resolve(null);}var _c7=[];if(_c6.bufferView!==undefined){_c7.push(this.getDependency("bufferView",_c6.bufferView));}else{_c7.push(null);}if(_c6.sparse!==undefined){_c7.push(this.getDependency("bufferView",_c6.sparse.indices.bufferView));_c7.push(this.getDependency("bufferView",_c6.sparse.values.bufferView));}return Promise.all(_c7).then(function(_c8){var _c9=_c8[0];var _ca=_f[_c6.type];var _cb=_10[_c6.componentType];var _cc=_cb.BYTES_PER_ELEMENT;var _cd=_cc*_ca;var _ce=_c6.byteOffset||0;var _cf=_c6.bufferView!==undefined?_c5.bufferViews[_c6.bufferView].byteStride:undefined;var _d0=_c6.normalized===true;var _d1,_d2;if(_cf&&_cf!==_cd){var _d3="InterleavedBuffer:"+_c6.bufferView+":"+_c6.componentType;var ib=_c4.cache[_d3];throw new Error("ib");}else{if(_c9===null){_d1=new _cb(_c6.count*_ca);}else{_d1=new _cb(_c9,_ce,_c6.count*_ca);}_d2={array:_d1,itemSize:_ca,count:_c6.count,dynamic:false,normalized:_d0===true};}if(_c6.sparse!==undefined){var _d4=_f.SCALAR;var _d5=_10[_c6.sparse.indices.componentType];var _d6=_c6.sparse.indices.byteOffset||0;var _d7=_c6.sparse.values.byteOffset||0;var _d8=new _d5(_c8[1],_d6,_c6.sparse.count*_d4);var _d9=new _cb(_c8[2],_d7,_c6.sparse.count*_ca);if(_c9!==null){_d2.setArray(_d2.array.slice());}for(var i=0,il=_d8.length;i<il;i++){var _da=_d8[i];_d2.setX(_da,_d9[i*_ca]);if(_ca>=2){_d2.setY(_da,_d9[i*_ca+1]);}if(_ca>=3){_d2.setZ(_da,_d9[i*_ca+2]);}if(_ca>=4){_d2.setW(_da,_d9[i*_ca+3]);}if(_ca>=5){throw new Error("Unsupported itemSize in sparse BufferAttribute.");}}}return _d2;});};_19.prototype.loadBufferView=function(_db){var _dc=this.json.bufferViews[_db];return this.getDependency("buffer",_dc.buffer).then(function(_dd){var _de=_dc.byteLength||0;var _df=_dc.byteOffset||0;return _dd.slice(_df,_df+_de);});};_19.prototype.loadBuffer=function(_e0){var _e1=this.json.buffers[_e0];if(_e1.type&&_e1.type!=="arraybuffer"){throw new Error(_e1.type+" buffer type is not supported.");}if(_e1.uri===undefined&&_e0===0){return Promise.resolve(this.extensions[_c.KHR_BINARY_GLTF].body);}return new Promise(function(_e2,_e3){var url=_e1.uri;var _e4=url.match(_b);if(_e4){var _e5=_e4[1];var _e6=!!_e4[2];var _e7=_e4[3];_e7=decodeURIComponent(_e7);if(_e6){_e7=atob(_e7);}try{var _e8=new Uint8Array(_e7.length);for(var i=0;i<_e7.length;i++){_e8[i]=_e7.charCodeAt(i);}_e2(_e8.buffer);}catch(e){_e3(new Error("Failed to load buffer \""+_e1.uri+"\"."));}}});};_19.prototype.loadCamera=function(_e9){var _ea;var _eb=this.json.cameras[_e9];var _ec=_eb[_eb.type];if(!_ec){return;}if(_eb.type==="perspective"){var _ed=_4.mat4.perspective(new Float64Array(16),_ec.yfov,_ec.aspectRatio||1,_ec.znear||1,_ec.zfar||2000000);_ea={projectionMatrix:_ed};}else{if(_eb.type==="orthographic"){}}if(_eb.name!==undefined){_ea.name=_eb.name;}_1a(_ea,_eb);return Promise.resolve(_ea);};_19.prototype.loadAnimation=function(_ee){};_1.load=_12;});