//>>built
define("com/huayun/webgis/renderer/ImageRenderer",["custom/gl-matrix-min","./Renderer","../data/bucket/ImageBucketSimplify","../geometry/Point","../gl/mode","../gl/Texture","../gl/programCache"],function(_1,_2,_3,_4,_5,_6,_7){function _8(_9,_a,_b,_c,_d){var m=_1.mat4.create();if(_a){_1.mat4.scale(m,m,[1/_d,1/_d,1]);if(!_b){_1.mat4.rotateZ(m,m,transform.angle);}}else{_1.mat4.multiply(m,_c,_9);}return m;};function _e(_f,_10,_11,_12,_13){if(_10){var m=__chunk_1.clone(_f);__chunk_1.scale(m,m,[_13,_13,1]);if(!_11){__chunk_1.rotateZ(m,m,-transform.angle);}return m;}else{return _12;}};function _14(){};if(_2){_14.__proto__=_2;}_14.prototype=Object.create(_2&&_2.prototype);_14.prototype.constructor=_14;_14.prototype.add=function(_15,_16,_17,_18){debugger;var _19=new _3();var _1a=_16.position||_15.viewpoint.center||[0,0],cx=_1a[0],cy=_1a[1];if(_17.type==="multipoint"){var p=[];for(var i=0;i<_17.points.length;i++){p.push(new _4(_17.points[i].x-cx,_17.points[i].y-cy,0));}_19.addFeature([p],_18.width,_18.height,_18.offset);}else{if(_17.type==="point"){_19.addFeature([[new _4(_17.x-cx,_17.y-cy,0)]],_18.width,_18.height,_18.offset);}}_19.upload(_15.context);_16.buckets.push(_19);_16.position=[cx,cy];};_14.prototype.draw=function(_1b,_1c,_1d,_1e,_1f,_20){if(!_1e.loaded){_1e.used=true;return;}if(_20===undefined){_20=0;}var _21=_1b.context;var gl=_21.gl;var _22;if(_1f){_22=_1f.depthModeForSublayer(0,_5.DepthMode.ReadOnly);}else{_22=new _5.DepthMode(gl.LEQUAL,_5.DepthMode.ReadOnly,[0.9,0.9]);}var _23=_5.StencilMode.disabled;var _24=_5.ColorMode.alphaBlended;var _25=_7.useProgramSimplify(_21,"images",{layoutAttributes:[{name:"a_pos",type:"Float32",components:2,offset:0},{name:"a_data",type:"Int16",components:4,offset:8}]});var _26=_1e.uniforms;var _27=_1c.position;var _28=this.getRealScale(_1e.fixed,_1b.scale,_1e.minScale);var _29=undefined;var _2a=_1b.resolution;if(_1e.markerSize){_28=_28*(_1c.markerScaleFactor||1);_29=_1e.markerSize/_1e.radius;_28=_28*_29;}else{if(_1c.symbol.size&&_1c.symbol.tempW===undefined){_1c.scaleFactor=_1c.scaleFactor||1;_28=_28*_1c.scaleFactor;_29=_1c.symbol.size/_1e.radius;_1c.symbol.tempW=_29;_28=_28*_29;}else{if(_1c.symbol.size&&_1c.symbol.tempW!==undefined){_28=_28*_1c.symbol.tempW;}else{_1c.scaleFactor=_1c.scaleFactor||1;_28=_28*_1c.scaleFactor;}}}if(_1c.rotation){_26.u_radian=_1e.angle+_1c.rotation;}else{_26.u_radian=_1e.angle;}var dx=_1e.dx*_28*_2a,dy=_1e.dy*_28*_2a;var _2b=Math.sin(_26.u_radian),_2c=Math.cos(_26.u_radian);var _2d=dx*_2c-dy*_2b,_2e=dy*_2c+dx*_2b;_26["u_matrix"]=_1b.viewpoint.getMatrixForPoint(_27[0]+_2d,_27[1]+_2e);var _2f=[_1e.width,_1e.height];_26.u_camera_to_center_distance=_1b.viewpoint.cameraToCenterDistance;_26.u_label_plane_matrix=_8(_26["u_matrix"],false,false,_1b.viewpoint.labelPlaneMatrix,1);_26.u_coord_matrix=_e(_26["u_matrix"],false,false,_1b.viewpoint.glCoordMatrix,1);_26.u_texsize=_2f;_21.activeTexture.set(gl.TEXTURE0);var _30=_1e.texture;if(!_30){_30=_1e.texture=new _6(_21,_1e.image,gl.RGBA,{useMipmap:true});}_30.bind(gl.LINEAR,gl.CLAMP_TO_EDGE);_1c["_imageOffset"+_20]={dx:_2d,dy:_2e,size:_2f};var _31=_1c.buckets;var _32=_31[_20];_25.draw(_21,gl.TRIANGLES,_22,_23,_24,_5.CullFaceMode.disabled,_26,_1c.id+"-image"+_20,_32.layoutVertexBuffer,_32.indexBuffer,_32.segments,null);};_14.prototype.drawGlow=function(_33,_34,_35,_36,_37,_38,_39){this.draw(_33,_34,_35,_36,_37,_38,_39);};_14.prototype.calculateExtent=function(_3a,_3b,_3c,_3d,_3e,_3f){if(!_3f){_3f=0;}if(!_3d.loaded){return;}var _40=_3a.resolution;var _41=_3b["_imageOffset"+_3f];var _42=_41.size;var x=_3c.x,y=_3c.y;var dx=_41.dx,dy=_41.dy;x=x+dx;y=y+dy;_3e.push({id:_3b.id,g:_3b,minX:x-_42[0]*_40/2,minY:y-_42[1]*_40/2,maxX:x+_42[0]*_40/2,maxY:y+_42[1]*_40/2});};return _14;});