//>>built
define("com/huayun/webgis/renderer/CylinderRenderer",["../data/ArrayType","../gl/SegmentVector","../gl/mode","../gl/programCache","../gl/Texture"],function(_1,_2,_3,_4,_5){function _6(_7,_8,_9){var _a=_8.position;if(_7.ground&&!_a.posMidified){var _b=Math.min(_7.viewpoint.targetZoom||_7.viewpoint.level,_7.ground.maxLevel);var _c=_7.viewpoint.tileInfo.getResolution(_b);var _d=_7.viewpoint.tileInfo.getColForX(_a.x,_c),_e=_7.viewpoint.tileInfo.getRowForY(_a.y,_c),_f=_d-Math.floor(_d),_10=_e-Math.floor(_e);var _11=_7.ground.sourceCache.getTileByID(_b+"/"+Math.floor(_d)+"/"+Math.floor(_e));if(_11&&_11.fbo){_a.posMidified=true;var gl=_7.context.gl;_7.context.bindFramebuffer.set(_11.fbo.framebuffer);var _12=new Float32Array(4);var c=Math.round(_f*256);var d=Math.round(_10*256);gl.readPixels(c===0?c:c-1,d===0?d:d-1,1,1,gl.RGBA,gl.FLOAT,_12);var min=_11.minimumHeight,_13=_11.maximumHeight-_11.minimumHeight;_a.z=_12[0]*_13+min;}else{_a.z=0;_a.posMidified=false;}}_9["u_matrix"]=_7.viewpoint.getMatrixForPoint(_a.x,_a.y,false,false,_a.z);};function _14(){};_14.prototype.add=function(_15,_16,_17,_18){debugger;var _19=_17.position;var _1a=_17.length,_1b=0,_1c=_17.slices,_1d=Math.PI*2/_1c,_1e=_17.bottomRadius,_1f=_17.topRadius;var _20=_15.context;var _21,_22,i,_23,cos,sin,j;if((_18.topVisible&&_18.topPattern)||(_18.bottomVisible&&_18.bottomPattern)){if(_18.bottomVisible&&_18.bottomPattern){_21=new _1.StructArrayLayout5fb20();_22=new _1.StructArrayLayout3ui6();_21.emplaceBack(0,0,_1b,0.5,0.5);for(i=0;i<_1c;i++){_23=i*_1d;cos=Math.cos(_23);sin=Math.sin(_23);_21.emplaceBack(_1e*cos,_1e*sin,_1b,0.5+0.5*cos,0.5+0.5*sin);}for(i=1;i<=_1c;i++){if(i===_1c){_22.emplaceBack(0,i,1);}else{_22.emplaceBack(0,i,i+1);}}_16.buckets.push({layoutVertexBuffer:_20.createVertexBuffer(_21,[{name:"a_pos",type:"Float32",components:3,offset:0},{name:"a_uv",type:"Float32",components:2,offset:12}]),indexBuffer:_20.createIndexBuffer(_22),segments:_2.simpleSegment(0,0,_1c+1,_1c)});}if(_18.sidePattern){_21=new _1.StructArrayLayout5fb20();_22=new _1.StructArrayLayout3ui6();for(i=0;i<_1c;i++){_23=i*_1d;cos=Math.cos(_23);sin=Math.sin(_23);_21.emplaceBack(_1e*cos,_1e*sin,_1b,i/_1c,0);_21.emplaceBack(_1f*cos,_1f*sin,_1a,i/_1c,1);}for(i=0;i<_1c;i++){j=i*2;if(i===_1c-1){_22.emplaceBack(j,0,j+1);_22.emplaceBack(0,1,j+1);}else{_22.emplaceBack(j,j+2,j+1);_22.emplaceBack(j+2,j+3,j+1);}}_16.buckets.push({layoutVertexBuffer:_20.createVertexBuffer(_21,[{name:"a_pos",type:"Float32",components:3,offset:0},{name:"a_uv",type:"Float32",components:2,offset:12}]),indexBuffer:_20.createIndexBuffer(_22),segments:_2.simpleSegment(0,0,_1c*2,_1c*2)});}if(_18.topVisible&&_18.topPattern){}}else{_21=new _1.StructArrayLayout3f12();_22=new _1.StructArrayLayout3ui6();for(i=0;i<_1c;i++){_23=_23=i*_1d;cos=Math.cos(_23);sin=Math.sin(_23);_21.emplaceBack(_1e*cos,_1e*sin,_1b);_21.emplaceBack(_1f*cos,_1f*sin,_1a);}for(i=1;i<_1c-1;i++){_22.emplaceBack(0,2*i,2*(i+1));}for(i=0;i<_1c;i++){if(i===_1c-1){_22.emplaceBack(i*2,0,1);_22.emplaceBack(i*2,1,i*2+1);}else{_22.emplaceBack(i*2,(i+1)*2,(i+1)*2+1);_22.emplaceBack(i*2,(i+1)*2+1,i*2+1);}}for(i=1;i<_1c-1;i++){_22.emplaceBack(1,2*i+1,2*(i+1)+1);}_16.buckets.push({layoutVertexBuffer:_20.createVertexBuffer(_21,[{name:"a_pos",type:"Float32",components:3,offset:0}]),indexBuffer:_20.createIndexBuffer(_22),segments:_2.simpleSegment(0,0,_1c*2,_1c*2+(_1c-2)*2)});}_16.position=_19;};_14.prototype.draw=function(_24,_25,_26,_27,_28,_29){debugger;if(_29===undefined){_29=0;}var _2a=_24.context;var gl=_2a.gl;var _2b;if(_28){_2b=_28.depthModeForSublayer(0,_3.DepthMode.ReadWrite);}else{_2b=new _3.DepthMode(gl.LEQUAL,_3.DepthMode.ReadWrite,[0.9,0.9]);}var _2c=_3.StencilMode.disabled;var _2d=_3.ColorMode.alphaBlended;if((_27.topVisible&&_27.topPattern)||(_27.bottomVisible&&_27.bottomPattern)){var _2e=_4.useProgramSimplify(_2a,"cylinder",{layoutAttributes:[{name:"a_pos",type:"Float32",components:3,offset:0},{name:"a_uv",type:"Float32",components:2,offset:12}],defines:["#define HAS_PATTERN"]});var _2f=_27.uniforms;var _30=_25.position;_6(_24,_25,_2f);var _31=_25.buckets;var _32,_33;_2a.activeTexture.set(gl.TEXTURE0);if(_27.bottomVisible&&_27.bottomPattern){_32=_27.bottomTexture;_33=_31[0];if(!_32){_32=_27.bottomTexture=new _5(_2a,_27.bottomPattern,gl.RGBA,{useMipmap:true});}_32.bind(gl.LINEAR,gl.CLAMP_TO_EDGE);_2e.draw(_2a,gl.TRIANGLES,_2b,_2c,_2d,_3.CullFaceMode.disabled,_2f,_25.id+"-cylinder-bottom",_33.layoutVertexBuffer,_33.indexBuffer,_33.segments);}_32=_27.sideTexture;_33=_31[1];if(!_32){_32=_27.sideTexture=new _5(_2a,_27.sidePattern,gl.RGBA,{useMipmap:true});}_32.bind(gl.LINEAR,gl.CLAMP_TO_EDGE);_2e.draw(_2a,gl.TRIANGLES,_2b,_2c,_2d,_3.CullFaceMode.disabled,_2f,_25.id+"-cylinder-side",_33.layoutVertexBuffer,_33.indexBuffer,_33.segments);}else{var _2e=_4.useProgramSimplify(_2a,"cylinder",{layoutAttributes:[{name:"a_pos",type:"Float32",components:3,offset:0},{name:"a_uv",type:"Float32",components:2,offset:12}]});var _2f=_27.uniforms;_6(_24,_25,_2f);var _31=_25.buckets;var _33=_31[0];_2e.draw(_2a,gl.TRIANGLES,_2b,_2c,_2d,_3.CullFaceMode.disabled,_2f,_25.id+"-cylinder",_33.layoutVertexBuffer,_33.indexBuffer,_33.segments);}};_14.prototype.calculateExtent=function(){};return _14;});