//>>built
define("com/huayun/webgis/renderer/TextRenderer",["custom/gl-matrix-min","./Renderer","../gl/mode","../gl/Texture","../data/bucket/TextBucketSimplify","../geometry/Point","../gl/programCache","../utils/MathUtils"],function(_1,_2,_3,_4,_5,_6,_7,_8){function _9(_a,_b,_c,_d,_e){var m=_1.mat4.create();if(_b){_1.mat4.scale(m,m,[1/_e,1/_e,1]);if(!_c){_1.mat4.rotateZ(m,m,transform.angle);}}else{_1.mat4.multiply(m,_d,_a);}return m;};function _f(_10,_11,_12,_13,_14){if(_11){var m=__chunk_1.clone(_10);__chunk_1.scale(m,m,[_14,_14,1]);if(!_12){__chunk_1.rotateZ(m,m,-transform.angle);}return m;}else{return _13;}};function _15(){};if(_2){_15.__proto__=_2;}_15.prototype=Object.create(_2&&_2.prototype);_15.prototype.constructor=_15;_15.prototype.add=function(_16,_17,_18,_19){if(typeof _19.text==="undefined"){return;}if(_16.ground){if(_17.base&&!_17.base.posMidified){_17.needAdd=true;return;}}_17.needAdd=false;var p;switch(_18.type){case "point":p=_18;break;case "multipoint":p=this.getMultiPointOfCenter(_18.points);break;case "line":p=this.getLineCenterPoint(_18.path);break;case "polygon":p=_8.calculateCoreOfPolygon(_18.path[0]);break;case "multipolygon":p=_18.getMaxAreaPolygon();p=_8.calculateCoreOfPolygon(p.path[0]);}if(_16.ground&&_17.base&&_17.base.posMidified){if(_17.baseZ){p.z=_17.baseZ+_17.base.z;}else{p.z+=_17.base.z;}_17.base=null;}var _1a=new _5();var _1b=_17.position||_16.viewpoint.center||[0,0],cx=_1b[0],cy=_1b[1];_1a.addFeature([[new _6(p.x-cx,p.y-cy)]],_19.text,_19.font,_19.glyphMap,_19.glyphAtlas.positions,_19.offset);_1a.upload(_16.context);_17.buckets.push(_1a);_17.position=[cx,cy,p.z];_17.initPosition=[cx,cy,p.z];};_15.prototype.getMultiPointOfCenter=function(_1c){return _1c[1];};_15.prototype.getLineCenterPoint=function(_1d){return _8.calculateCenterOfLine(_1d[0]).center;};_15.prototype.draw=function(_1e,_1f,_20,_21,_22,_23){if(typeof _21.text==="undefined"){return;}if(_1f.needAdd||_1f.buckets.length===0){this.add(_1e,_1f,_20,_21);if(_1f.needAdd){return;}}if(_23===undefined){_23=0;}var _24=_1e.context;var gl=_24.gl;var _25;if(_22){_25=_22.depthModeForSublayer(0,_3.DepthMode.ReadWrite);}else{_25=new _3.DepthMode(gl.LEQUAL,_3.DepthMode.ReadWrite,[0.9,0.9]);}var _26=_3.StencilMode.disabled;var _27=_3.ColorMode.alphaBlended;var _28=_7.useProgramSimplify(_24,"text",{layoutAttributes:[{name:"a_pos",type:"Float32",components:2,offset:0},{name:"a_data",type:"Int16",components:4,offset:8}]});var _29=_1f.symbol.uniforms;var _2a=_1f.position;var img=_21.glyphAtlas.image;var _2b=_1f.buckets;var _2c=_2b[_23];var _2d=[img.width,img.height];var m=_1e.viewpoint.getMatrixForPoint(_2a[0],_2a[1],false,false,_2a[2]);_29.u_camera_to_center_distance=_1e.viewpoint.cameraToCenterDistance;_29.u_matrix=m;_29.u_label_plane_matrix=_9(m,false,false,_1e.viewpoint.labelPlaneMatrix,1);_29.u_coord_matrix=_f(m,false,false,_1e.viewpoint.glCoordMatrix,1);_29.u_texsize=_2d;if(_21.markerSize){var _2e=this.getRealScale(_21.fixed,_1e.scale,_21.minScale)*_1f.markerScaleFactor;_29.u_size=this.calculateSize(_21.markerSize*_2e,_21.width,_21.height);}else{if(_1f.symbol.size){_1f.scaleFactor=_1f.scaleFactor||1;var _2f=this.getRealScale(_21.fixed,_1e.scale,_21.minScale)*_1f.scaleFactor;_29.u_size=this.calculateSize(_1f.symbol.size*_2f,_21.width,_21.height);}else{_29.u_size=_21.fontSize*this.getRealScale(_21.fixed,_1e.scale,_21.minScale);}}_24.activeTexture.set(gl.TEXTURE0);var _30=_21.texture;if(!_30){_30=_21.texture=new _4(_24,img,gl.ALPHA);}_30.bind(gl.LINEAR,gl.CLAMP_TO_EDGE);if(_21.hasHalo){_29["u_is_halo"]=1;_28.draw(_24,gl.TRIANGLES,_25,_26,_27,_3.CullFaceMode.disabled,_29,_1f.id+"-text-halo"+_23,_2c.layoutVertexBuffer,_2c.indexBuffer,_2c.segments,null,_1e.viewpoint.level);}_29["u_is_halo"]=0;_28.draw(_24,gl.TRIANGLES,_25,_26,_27,_3.CullFaceMode.disabled,_29,_1f.id+"-text"+_23,_2c.layoutVertexBuffer,_2c.indexBuffer,_2c.segments);};_15.prototype.calculateSize=function(_31,_32,_33){var _34=Math.min(_31/_32,_31/_33);return _34*96;};return _15;});