//>>built
define("com/huayun/webgis/renderer/RectRenderer",["./Renderer","../gl/mode","../data/bucket/RectBucket","../geometry/Point","../gl/programCache","../utils/MathUtils"],function(_1,_2,_3,_4,_5,_6){function _7(){};if(_1){_7.__proto__=_1;}_7.prototype=Object.create(_1&&_1.prototype);_7.prototype.constructor=_7;_7.prototype.add=function(_8,_9,_a,_b){var _c=new _3();var _d=_9.position||_8.viewpoint.center||[0,0],cx=_d[0],cy=_d[1];_c.addFeature([[new _4(_a.x-cx,_a.y-cy,0)]],_b);_c.upload(_8.context);_9.buckets.push(_c);_9.position=[cx,cy];_9.center=_a;};_7.prototype.draw=function(_e,_f,_10,_11,_12,_13){if(_13===undefined){_13=0;}var _14=_e.context;var gl=_14.gl;var _15;if(_12){_15=_12.depthModeForSublayer(0,_2.DepthMode.ReadOnly);}else{_15=new _2.DepthMode(gl.LEQUAL,_2.DepthMode.ReadOnly,[0.9,0.9]);}var _16=_2.StencilMode.disabled;var _17=_2.ColorMode.alphaBlended;var _18=_5.useProgramSimplify(_14,"rect",{layoutAttributes:[{name:"a_pos",type:"Float32",components:2,offset:0},{name:"a_size",type:"Float32",components:4,offset:8}]});var _19=_11.uniforms;var _1a=_f.position;_19["u_camera_to_center_distance"]=_e.viewpoint.cameraToCenterDistance;_19["u_extrude_scale"]=_e.viewpoint.pixelsToGLUnits;var _1b=_f.buckets;var _1c=_1b[_13];var _1d=this.getRealScale(_11.fixed,_e.scale,_11.minScale);var _1e=1;var _1f=_e.resolution;if(_11.markerSize){_1d=_1d*(_f.markerScaleFactor||1);_1e=Math.min(_11.markerSize/_11.widthWithStroke,_11.markerSize/_11.heightWithStroke);_1d=_1d*_1e;}else{if(_f.symbol.size){_f.scaleFactor=_f.scaleFactor||1;_1d=_1d*_f.scaleFactor;_1e=Math.min(_f.symbol.size/_11.widthWithStroke,_f.symbol.size/_11.heightWithStroke);_1d=_1d*_1e;}else{_f.scaleFactor=_f.scaleFactor||1;_1d=_1d*_f.scaleFactor;}}_19["u_size"]=_1d;if(_f.rotation){_19.u_radian=_11.angle+_f.rotation;}else{_19.u_radian=_11.angle;}var dx=_11.dx*_1d*_1f,dy=_11.dy*_1d*_1f;var _20=Math.sin(_19.u_radian),_21=Math.cos(_19.u_radian);var _22=dx*_21-dy*_20,_23=dy*_21+dx*_20;_19["u_matrix"]=_e.viewpoint.getMatrixForPoint(_1a[0]+_22,_1a[1]+_23);if(_11.strokeWidth>0&&_11.stroke[3]!==0){_19["u_color"]=_11.stroke;_19["u_is_stroke"]=1;_18.draw(_14,gl.TRIANGLES,_15,_16,_17,_2.CullFaceMode.disabled,_19,_f.id+"-rect"+_13,_1c.layoutVertexBuffer,_1c.indexBuffer,_1c.segments);}_19["u_is_stroke"]=0;_19["u_color"]=_11.color;_f["_rectOffset"+_13]={dx:_22,dy:_23,size:_11.uniforms.u_size};_18.draw(_14,gl.TRIANGLES,_15,_16,_17,_2.CullFaceMode.disabled,_19,_f.id+"-rect"+_13,_1c.layoutVertexBuffer,_1c.indexBuffer,_1c.segments);};_7.prototype.drawGlow=function(_24,_25,_26,_27,_28,_29){var _2a=_25.glow;if(!_2a){return;}if(_29===undefined){_29=0;}var _2b=_24.context;var gl=_2b.gl;var _2c;if(_28){_2c=_28.depthModeForSublayer(0,_2.DepthMode.ReadOnly);}else{_2c=new _2.DepthMode(gl.LEQUAL,_2.DepthMode.ReadOnly,[0.9,0.9]);}var _2d=_2.StencilMode.disabled;var _2e=_2.ColorMode.alphaBlended;var _2f=_5.useProgramSimplify(_2b,"rect",{layoutAttributes:[{name:"a_pos",type:"Float32",components:2,offset:0},{name:"a_size",type:"Float32",components:4,offset:8}]});var _30=_27.uniforms;var _31=_25.position;_30["u_camera_to_center_distance"]=_24.viewpoint.cameraToCenterDistance;_30["u_extrude_scale"]=_24.viewpoint.pixelsToGLUnits;var _32=_25.buckets;var _33=_32[_29];var _34=this.getRealScale(_27.fixed,_24.scale,_27.minScale);var _35=1;var _36=_24.resolution;if(_27.markerSize){_34=_34*_25.markerScaleFactor;_35=Math.min(_27.markerSize/_27.widthWithStroke,_27.markerSize/_27.heightWithStroke);_34=_34*_35;}else{if(_25.symbol.size){_25.scaleFactor=_25.scaleFactor||1;_34=_34*_25.scaleFactor;_35=Math.min(_25.symbol.size/_27.widthWithStroke,_25.symbol.size/_27.heightWithStroke);_34=_34*_35;}else{_25.scaleFactor=_25.scaleFactor||1;_34=_34*_25.scaleFactor;}}_30["u_size"]=_34;if(_25.rotation){_30.u_radian=_27.angle+_25.rotation;}else{_30.u_radian=_27.angle;}var dx=_27.dx*_34*_36,dy=_27.dy*_34*_36;var _37=Math.sin(_30.u_radian),_38=Math.cos(_30.u_radian);var _39=dx*_38-dy*_37,_3a=dy*_38+dx*_37;var _3b=_2a.color;_30["u_matrix"]=_24.viewpoint.getMatrixForPoint(_31[0]+_39,_31[1]+_3a);if(_27.strokeWidth>0&&_27.stroke[3]!==0){_30["u_color"]=_3b;_30["u_is_stroke"]=1;_2f.draw(_2b,gl.TRIANGLES,_2c,_2d,_2e,_2.CullFaceMode.disabled,_30,_25.id+"-rect"+_29,_33.layoutVertexBuffer,_33.indexBuffer,_33.segments);}_30["u_is_stroke"]=0;_30["u_color"]=_3b;_2f.draw(_2b,gl.TRIANGLES,_2c,_2d,_2e,_2.CullFaceMode.disabled,_30,_25.id+"-rect"+_29,_33.layoutVertexBuffer,_33.indexBuffer,_33.segments);};_7.prototype.calculateExtent=function(_3c,_3d,_3e,_3f,_40,_41){if(!_41){_41=0;}var _42=_3d["_rectOffset"+_41];var _43=_42.size;var x=_3e.x,y=_3e.y;var _44=_3c.resolution;var w,h;if(_3f.strokeWidth>0){w=_3f.widthWithStroke;h=_3f.heightWithStroke;}else{w=_3f.width;h=_3f.height;}var hw=w/2*_43,hh=h/2*_43;var _45;if(_3d.rotation){_45=_3f.angle+_3d.rotation;}else{_45=_3f.angle;}x+=_42.dx;y+=_42.dy;var _46=[{x:hw,y:hh},{x:hw,y:-hh},{x:-hw,y:-hh},{x:-hw,y:hh}];var _47=_6.sizeAfterRotated(_46,_45);_40.push({id:_3d.id,g:_3d,minX:x+_47.xmin*_44,minY:y+_47.ymin*_44,maxX:x+_47.xmax*_44,maxY:y+_47.ymax*_44,type:"rect"});};return _7;});