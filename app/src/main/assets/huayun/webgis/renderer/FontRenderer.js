//>>built
define("com/huayun/webgis/renderer/FontRenderer",["require","exports","./Renderer","../data/bucket/FontBucketSimplify","../geometry/Point","../gl/mode","../gl/Texture",""+"custom/gl-matrix","../gl/programCache","../utils/MathUtils"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){"use strict";function _b(_c,_d,_e,_f,_10){var m=_8.mat4.create();if(_d){_8.mat4.scale(m,m,[1/_10,1/_10,1]);if(!_e){_8.mat4.rotateZ(m,m,0);}}else{_8.mat4.multiply(m,_f,_c);}return m;};function _11(_12,_13,_14,_15,_16){if(_13){var m=_8.mat4.clone(_12);_8.mat4.scale(m,m,[_16,_16,1]);if(!_14){_8.mat4.rotateZ(m,m,-0);}return m;}else{return _15;}};function _17(){};if(_3){_17.__proto__=_3;}_17.prototype=Object.create(_3&&_3.prototype);_17.prototype.constructor=_17;_17.prototype.add=function(_18,_19,_1a,_1b,_1c){if(!_1c){_1c=0;}var _1d=new _4();var _1e=_19.position||_18.viewpoint.center||[0,0],cx=_1e[0],cy=_1e[1];if(_1b.glyphReady){_1d.addFeature([[new _5(_1a.x-cx,_1a.y-cy)]],_1b.text,_1b.fontFamily,_1b.glyphMap,_1b.glyphAtlas.positions,[0,0]);_1d.upload(_18.context);_19.buckets[_1c]=_1d;_19.ready=true;_19.position=[cx,cy];}else{_19.buckets[_1c]=undefined;_1b.finishRequest.push(function(){_1d.addFeature([[new _5(_1a.x-cx,_1a.y-cy)]],_1b.text,_1b.fontFamily,_1b.glyphMap,_1b.glyphAtlas.positions,[0,0]);_1d.upload(_18.context);_19.buckets[_1c]=_1d;_19.ready=true;_19.position=[cx,cy];_18.threeRender();});}};_17.prototype.draw=function(_1f,_20,_21,_22,_23,_24){if(!_22.glyphReady){return;}if(_24===undefined){_24=0;}var _25=_1f.context;var gl=_25.gl;var _26;if(_23){_26=_23.depthModeForSublayer(0,_6.DepthMode.ReadOnly);}else{_26=new _6.DepthMode(gl.LEQUAL,_6.DepthMode.ReadOnly,[0.9,0.9]);}var _27=_6.StencilMode.disabled;var _28=_6.ColorMode.alphaBlended;var _29=_20.buckets[_24];var _2a=_9.useProgramSimplify(_25,"ztText",{layoutAttributes:[{name:"a_pos",type:"Float32",components:2,offset:0},{name:"a_data",type:"Int16",components:4,offset:8}]});var _2b=_22.uniforms;var _2c=_20.position;var img=_22.glyphAtlas.image;var _2d=[img.width,img.height];var _2e=this.getRealScale(_22.fixed,_1f.scale,_22.minScale);var _2f=_1f.resolution;_2b.u_texsize=_2d;if(_22.markerSize){_2e=_2e*(_20.markerScaleFactor||1);_2b.u_size=this.calculateSize(_22.markerSize*_2e,_22.width,_22.height);}else{if(_20.symbol.size){_20.scaleFactor=_20.scaleFactor||1;_2e=_2e*_20.scaleFactor;_2b.u_size=this.calculateSize(_20.symbol.size*_2e,_22.width,_22.height);}else{_20.scaleFactor=_20.scaleFactor||1;_2e=_2e*_20.scaleFactor;_2b.u_size=_22.fontSize*_2e;}}_25.activeTexture.set(gl.TEXTURE0);if(_20.rotation){_2b.u_radian=_22.angle+_20.rotation;}else{_2b.u_radian=_22.angle;}var dx=_22.dx*_2e*_2f,dy=_22.dy*_2e*_2f;var _30=Math.sin(_2b.u_radian),_31=Math.cos(_2b.u_radian);var _32=dx*_31-dy*_30,_33=dy*_31+dx*_30;_20["_fontOffset"+_24]={dx:_32,dy:_33,size:_2b.u_size};var m=_2b["u_matrix"]=_1f.viewpoint.getMatrixForPoint(_2c[0]+_32,_2c[1]+_33);_2b.u_camera_to_center_distance=_1f.viewpoint.cameraToCenterDistance;_2b.u_matrix=m;_2b.u_label_plane_matrix=_b(m,false,false,_1f.viewpoint.labelPlaneMatrix,1);_2b.u_coord_matrix=_11(m,false,false,_1f.viewpoint.glCoordMatrix,1);_2b.u_fill_color=_22.fillColor;var _34=_22.texture;if(!_34){_34=_22.texture=new _7(_25,img,gl.ALPHA);}_34.bind(gl.LINEAR,gl.CLAMP_TO_EDGE);_2a.draw(_25,gl.TRIANGLES,_26,_27,_28,_6.CullFaceMode.disabled,_2b,_20.id+"-font"+_24,_29.layoutVertexBuffer,_29.indexBuffer,_29.segments);};_17.prototype.drawGlow=function(_35,_36,_37,_38,_39,_3a){if(!_38.glyphReady){return;}var _3b=_36.glow;if(!_3b){return;}if(_3a===undefined){_3a=0;}var _3c=_35.context;var gl=_3c.gl;var _3d;if(_39){_3d=_39.depthModeForSublayer(0,_6.DepthMode.ReadOnly);}else{_3d=new _6.DepthMode(gl.LEQUAL,_6.DepthMode.ReadOnly,[0.9,0.9]);}var _3e=_6.StencilMode.disabled;var _3f=_6.ColorMode.alphaBlended;var _40=_36.buckets[_3a];var _41=_9.useProgramSimplify(_3c,"ztText",{layoutAttributes:[{name:"a_pos",type:"Float32",components:2,offset:0},{name:"a_data",type:"Int16",components:4,offset:8}]});var _42=_38.uniforms;var _43=_36.position;var img=_38.glyphAtlas.image;var _44=[img.width,img.height];var _45=this.getRealScale(_38.fixed,_35.scale,_38.minScale);var _46=_35.resolution;_42.u_texsize=_44;if(_38.markerSize){_45=_45*_36.markerScaleFactor;_42.u_size=this.calculateSize(_38.markerSize*_45,_38.width,_38.height);}else{if(_36.symbol.size){_36.scaleFactor=_36.scaleFactor||1;_45=_45*_36.scaleFactor;_42.u_size=this.calculateSize(_36.symbol.size*_45,_38.width,_38.height);}else{_36.scaleFactor=_36.scaleFactor||1;_45=_45*_36.scaleFactor;_42.u_size=_38.fontSize*_45;}}_3c.activeTexture.set(gl.TEXTURE0);if(_36.rotation){_42.u_radian=_38.angle+_36.rotation;}else{_42.u_radian=_38.angle;}var dx=_38.dx*_45*_46,dy=_38.dy*_45*_46;var _47=Math.sin(_42.u_radian),_48=Math.cos(_42.u_radian);var _49=dx*_48-dy*_47,_4a=dy*_48+dx*_47;var m=_42["u_matrix"]=_35.viewpoint.getMatrixForPoint(_43[0]+_49,_43[1]+_4a);_42.u_camera_to_center_distance=_35.viewpoint.cameraToCenterDistance;_42.u_matrix=m;_42.u_label_plane_matrix=_b(m,false,false,_35.viewpoint.labelPlaneMatrix,1);_42.u_coord_matrix=_11(m,false,false,_35.viewpoint.glCoordMatrix,1);var _4b=_3b.color;_42.u_fill_color=_4b;_42.u_halo_color=_4b;var _4c=_38.texture;if(!_4c){_4c=_38.texture=new _7(_3c,img,gl.ALPHA);}_4c.bind(gl.LINEAR,gl.CLAMP_TO_EDGE);_41.draw(_3c,gl.TRIANGLES,_3d,_3e,_3f,_6.CullFaceMode.disabled,_42,_36.id+"-font"+_3a,_40.layoutVertexBuffer,_40.indexBuffer,_40.segments);};_17.prototype.calculateSize=function(_4d,_4e,_4f){var _50=Math.min(_4d/_4e,_4d/_4f);return _50*96;};_17.prototype.calculateExtent=function(_51,_52,_53,_54,_55,_56){if(!_56){_56=0;}var _57=_52["_fontOffset"+_56];if(!_57){return;}var _58=_57.size;var x=_53.x,y=_53.y;var _59=_51.resolution;var w=_54.width,h=_54.height;var hw=_58/96*w/2,hh=_58/96*h/2;var _5a;if(_52.rotation){_5a=_54.angle+_52.rotation;}else{_5a=_54.angle;}x+=_57.dx;y+=_57.dy;var _5b=[{x:hw,y:hh},{x:hw,y:-hh},{x:-hw,y:-hh},{x:-hw,y:hh}];var _5c=_a.sizeAfterRotated(_5b,_5a);_55.push({id:_52.id,g:_52,minX:x+_5c.xmin*_59,minY:y+_5c.ymin*_59,maxX:x+_5c.xmax*_59,maxY:y+_5c.ymax*_59});};return _17;});