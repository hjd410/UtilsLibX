//>>built
define("com/huayun/webgis/gl/MapGridIndex",[],function(){var _1=function _1(_2,_3,_4){var _5=this.boxCells=[];var _6=this.circleCells=[];this.xCellCount=Math.ceil(_2/_4);this.yCellCount=Math.ceil(_3/_4);for(var i=0;i<this.xCellCount*this.yCellCount;i++){_5.push([]);_6.push([]);}this.circleKeys=[];this.boxKeys=[];this.bboxes=[];this.circles=[];this.width=_2;this.height=_3;this.xScale=this.xCellCount/_2;this.yScale=this.yCellCount/_3;this.boxUid=0;this.circleUid=0;};_1.prototype.keysLength=function keysLength(){return this.boxKeys.length+this.circleKeys.length;};_1.prototype.insert=function insert(_7,x1,y1,x2,y2){this._forEachCell(x1,y1,x2,y2,this._insertBoxCell,this.boxUid++);this.boxKeys.push(_7);this.bboxes.push(x1);this.bboxes.push(y1);this.bboxes.push(x2);this.bboxes.push(y2);};_1.prototype.insertCircle=function insertCircle(_8,x,y,_9){this._forEachCell(x-_9,y-_9,x+_9,y+_9,this._insertCircleCell,this.circleUid++);this.circleKeys.push(_8);this.circles.push(x);this.circles.push(y);this.circles.push(_9);};_1.prototype._insertBoxCell=function _insertBoxCell(x1,y1,x2,y2,_a,_b){this.boxCells[_a].push(_b);};_1.prototype._insertCircleCell=function _insertCircleCell(x1,y1,x2,y2,_c,_d){this.circleCells[_c].push(_d);};_1.prototype._query=function _query(x1,y1,x2,y2,_e,_f){if(x2<0||x1>this.width||y2<0||y1>this.height){return _e?false:[];}var _10=[];if(x1<=0&&y1<=0&&this.width<=x2&&this.height<=y2){if(_e){return true;}for(var _11=0;_11<this.boxKeys.length;_11++){_10.push({key:this.boxKeys[_11],x1:this.bboxes[_11*4],y1:this.bboxes[_11*4+1],x2:this.bboxes[_11*4+2],y2:this.bboxes[_11*4+3]});}for(var _12=0;_12<this.circleKeys.length;_12++){var x=this.circles[_12*3];var y=this.circles[_12*3+1];var _13=this.circles[_12*3+2];_10.push({key:this.circleKeys[_12],x1:x-_13,y1:y-_13,x2:x+_13,y2:y+_13});}return _f?_10.filter(_f):_10;}else{var _14={hitTest:_e,seenUids:{box:{},circle:{}}};this._forEachCell(x1,y1,x2,y2,this._queryCell,_10,_14,_f);return _e?_10.length>0:_10;}};_1.prototype._queryCircle=function _queryCircle(x,y,_15,_16,_17){var x1=x-_15;var x2=x+_15;var y1=y-_15;var y2=y+_15;if(x2<0||x1>this.width||y2<0||y1>this.height){return _16?false:[];}var _18=[];var _19={hitTest:_16,circle:{x:x,y:y,radius:_15},seenUids:{box:{},circle:{}}};this._forEachCell(x1,y1,x2,y2,this._queryCellCircle,_18,_19,_17);return _16?_18.length>0:_18;};_1.prototype.query=function query(x1,y1,x2,y2,_1a){return (this._query(x1,y1,x2,y2,false,_1a));};_1.prototype.hitTest=function hitTest(x1,y1,x2,y2,_1b){return (this._query(x1,y1,x2,y2,true,_1b));};_1.prototype.hitTestCircle=function hitTestCircle(x,y,_1c,_1d){return (this._queryCircle(x,y,_1c,true,_1d));};_1.prototype._queryCell=function _queryCell(x1,y1,x2,y2,_1e,_1f,_20,_21){var _22=_20.seenUids;var _23=this.boxCells[_1e];if(_23!==null){var _24=this.bboxes;for(var i=0,_25=_23;i<_25.length;i+=1){var _26=_25[i];if(!_22.box[_26]){_22.box[_26]=true;var _27=_26*4;if((x1<=_24[_27+2])&&(y1<=_24[_27+3])&&(x2>=_24[_27+0])&&(y2>=_24[_27+1])&&(!_21||_21(this.boxKeys[_26]))){if(_20.hitTest){_1f.push(true);return true;}else{_1f.push({key:this.boxKeys[_26],x1:_24[_27],y1:_24[_27+1],x2:_24[_27+2],y2:_24[_27+3]});}}}}}var _28=this.circleCells[_1e];if(_28!==null){var _29=this.circles;for(var i$1=0,_2a=_28;i$1<_2a.length;i$1+=1){var _2b=_2a[i$1];if(!_22.circle[_2b]){_22.circle[_2b]=true;var _2c=_2b*3;if(this._circleAndRectCollide(_29[_2c],_29[_2c+1],_29[_2c+2],x1,y1,x2,y2)&&(!_21||_21(this.circleKeys[_2b]))){if(_20.hitTest){_1f.push(true);return true;}else{var x=_29[_2c];var y=_29[_2c+1];var _2d=_29[_2c+2];_1f.push({key:this.circleKeys[_2b],x1:x-_2d,y1:y-_2d,x2:x+_2d,y2:y+_2d});}}}}}};_1.prototype._queryCellCircle=function _queryCellCircle(x1,y1,x2,y2,_2e,_2f,_30,_31){var _32=_30.circle;var _33=_30.seenUids;var _34=this.boxCells[_2e];if(_34!==null){var _35=this.bboxes;for(var i=0,_36=_34;i<_36.length;i+=1){var _37=_36[i];if(!_33.box[_37]){_33.box[_37]=true;var _38=_37*4;if(this._circleAndRectCollide(_32.x,_32.y,_32.radius,_35[_38+0],_35[_38+1],_35[_38+2],_35[_38+3])&&(!_31||_31(this.boxKeys[_37]))){_2f.push(true);return true;}}}}var _39=this.circleCells[_2e];if(_39!==null){var _3a=this.circles;for(var i$1=0,_3b=_39;i$1<_3b.length;i$1+=1){var _3c=_3b[i$1];if(!_33.circle[_3c]){_33.circle[_3c]=true;var _3d=_3c*3;if(this._circlesCollide(_3a[_3d],_3a[_3d+1],_3a[_3d+2],_32.x,_32.y,_32.radius)&&(!_31||_31(this.circleKeys[_3c]))){_2f.push(true);return true;}}}}};_1.prototype._forEachCell=function _forEachCell(x1,y1,x2,y2,fn,_3e,_3f,_40){var cx1=this._convertToXCellCoord(x1);var cy1=this._convertToYCellCoord(y1);var cx2=this._convertToXCellCoord(x2);var cy2=this._convertToYCellCoord(y2);for(var x=cx1;x<=cx2;x++){for(var y=cy1;y<=cy2;y++){var _41=this.xCellCount*y+x;if(fn.call(this,x1,y1,x2,y2,_41,_3e,_3f,_40)){return;}}}};_1.prototype._convertToXCellCoord=function _convertToXCellCoord(x){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(x*this.xScale)));};_1.prototype._convertToYCellCoord=function _convertToYCellCoord(y){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(y*this.yScale)));};_1.prototype._circlesCollide=function _circlesCollide(x1,y1,r1,x2,y2,r2){var dx=x2-x1;var dy=y2-y1;var _42=r1+r2;return (_42*_42)>(dx*dx+dy*dy);};_1.prototype._circleAndRectCollide=function _circleAndRectCollide(_43,_44,_45,x1,y1,x2,y2){var _46=(x2-x1)/2;var _47=Math.abs(_43-(x1+_46));if(_47>(_46+_45)){return false;}var _48=(y2-y1)/2;var _49=Math.abs(_44-(y1+_48));if(_49>(_48+_45)){return false;}if(_47<=_46||_49<=_48){return true;}var dx=_47-_46;var dy=_49-_48;return (dx*dx+dy*dy<=(_45*_45));};return _1;});