//>>built
define("com/huayun/webgis/gl/GridIndex",[],function(){var _1=3;function _2(_3,n,_4){var _5=this.cells=[];if(_3 instanceof ArrayBuffer){this.arrayBuffer=_3;var _6=new Int32Array(this.arrayBuffer);_3=_6[0];n=_6[1];_4=_6[2];this.d=n+2*_4;for(var k=0;k<this.d*this.d;k++){var _7=_6[_1+k];var _8=_6[_1+k+1];_5.push(_7===_8?null:_6.subarray(_7,_8));}var _9=_6[_1+_5.length];var _a=_6[_1+_5.length+1];this.keys=_6.subarray(_9,_a);this.bboxes=_6.subarray(_a);this.insert=this._insertReadonly;}else{this.d=n+2*_4;for(var i=0;i<this.d*this.d;i++){_5.push([]);}this.keys=[];this.bboxes=[];}this.n=n;this.extent=_3;this.padding=_4;this.scale=n/_3;this.uid=0;var p=(_4/n)*_3;this.min=-p;this.max=_3+p;};_2.prototype.insert=function(_b,x1,y1,x2,y2){this._forEachCell(x1,y1,x2,y2,this._insertCell,this.uid++);this.keys.push(_b);this.bboxes.push(x1);this.bboxes.push(y1);this.bboxes.push(x2);this.bboxes.push(y2);};_2.prototype._insertReadonly=function(){throw "Cannot insert into a GridIndex created from an ArrayBuffer.";};_2.prototype._insertCell=function(x1,y1,x2,y2,_c,_d){this.cells[_c].push(_d);};_2.prototype.query=function(x1,y1,x2,y2,_e){var _f=this.min;var max=this.max;if(x1<=_f&&y1<=_f&&max<=x2&&max<=y2&&!_e){return Array.prototype.slice.call(this.keys);}else{var _10=[];var _11={};this._forEachCell(x1,y1,x2,y2,this._queryCell,_10,_11,_e);return _10;}};_2.prototype._queryCell=function(x1,y1,x2,y2,_12,_13,_14,_15){var _16=this.cells[_12];if(_16!==null){var _17=this.keys;var _18=this.bboxes;for(var u=0;u<_16.length;u++){var uid=_16[u];if(_14[uid]===undefined){var _19=uid*4;if(_15?_15(_18[_19+0],_18[_19+1],_18[_19+2],_18[_19+3]):((x1<=_18[_19+2])&&(y1<=_18[_19+3])&&(x2>=_18[_19+0])&&(y2>=_18[_19+1]))){_14[uid]=true;_13.push(_17[uid]);}else{_14[uid]=false;}}}}};_2.prototype._forEachCell=function(x1,y1,x2,y2,fn,_1a,_1b,_1c){var cx1=this._convertToCellCoord(x1);var cy1=this._convertToCellCoord(y1);var cx2=this._convertToCellCoord(x2);var cy2=this._convertToCellCoord(y2);for(var x=cx1;x<=cx2;x++){for(var y=cy1;y<=cy2;y++){var _1d=this.d*y+x;if(_1c&&!_1c(this._convertFromCellCoord(x),this._convertFromCellCoord(y),this._convertFromCellCoord(x+1),this._convertFromCellCoord(y+1))){continue;}if(fn.call(this,x1,y1,x2,y2,_1d,_1a,_1b,_1c)){return;}}}};_2.prototype._convertFromCellCoord=function(x){return (x-this.padding)/this.scale;};_2.prototype._convertToCellCoord=function(x){return Math.max(0,Math.min(this.d-1,Math.floor(x*this.scale)+this.padding));};_2.prototype.toArrayBuffer=function(){if(this.arrayBuffer){return this.arrayBuffer;}var _1e=this.cells;var _1f=_1+this.cells.length+1+1;var _20=0;for(var i=0;i<this.cells.length;i++){_20+=this.cells[i].length;}var _21=new Int32Array(_1f+_20+this.keys.length+this.bboxes.length);_21[0]=this.extent;_21[1]=this.n;_21[2]=this.padding;var _22=_1f;for(var k=0;k<_1e.length;k++){var _23=_1e[k];_21[_1+k]=_22;_21.set(_23,_22);_22+=_23.length;}_21[_1+_1e.length]=_22;_21.set(this.keys,_22);_22+=this.keys.length;_21[_1+_1e.length+1]=_22;_21.set(this.bboxes,_22);_22+=this.bboxes.length;return _21.buffer;};return _2;});