//>>built
define("com/huayun/webgis/gl/programConfig",["exports","../data/FeaturePositionMap","../layers/support/style/PossiblyEvaluatedPropertyValue","./constantBinder","./dataTransfer","../utils/utils"],function(_1,_2,_3,_4,_5,_6){var _7=function _7(){this.binders={};this.cacheKey="";this._buffers=[];this._featureMap=new _2();this._bufferOffset=0;};_7.createDynamic=function createDynamic(_8,_9,_a){var _b=new _7();var _c=[];for(var _d in _8.paint._values){if(!_a(_d)){continue;}var _e=_8.paint.get(_d);if(!(_e instanceof _3)||!_6.supportsPropertyExpression(_e.property.specification)){continue;}var _f=_6.paintAttributeNames(_d,_8.type);var _10=_e.property.specification.type;var _11=_e.property.useIntegerZoom;var _12=_e.property.specification["property-type"]==="cross-faded"||_e.property.specification["property-type"]==="cross-faded-data-driven";if(_12){if(_e.value.kind==="constant"){_b.binders[_d]=new _4.CrossFadedConstantBinder(_e.value.value,_f,_10);_c.push(("/u_"+_d));}else{var _13=_6.layoutType(_d,_10,"source");_b.binders[_d]=new _4.CrossFadedCompositeBinder(_e.value,_f,_10,_11,_9,_13,_8.id);_c.push(("/a_"+_d));}}else{if(_e.value.kind==="constant"){_b.binders[_d]=new _4.ConstantBinder(_e.value.value,_f,_10);_c.push(("/u_"+_d));}else{if(_e.value.kind==="source"){var _14=_6.layoutType(_d,_10,"source");_b.binders[_d]=new _4.SourceExpressionBinder(_e.value,_f,_10,_14);_c.push(("/a_"+_d));}else{var _15=_6.layoutType(_d,_10,"composite");_b.binders[_d]=new _4.CompositeExpressionBinder(_e.value,_f,_10,_11,_9,_15);_c.push(("/z_"+_d));}}}}_b.cacheKey=_c.sort().join("");return _b;};_7.prototype.populatePaintArrays=function populatePaintArrays(_16,_17,_18,_19){for(var _1a in this.binders){var _1b=this.binders[_1a];_1b.populatePaintArray(_16,_17,_19);}if(_17.id!==undefined){this._featureMap.add(+_17.id,_18,this._bufferOffset,_16);}this._bufferOffset=_16;};_7.prototype.setConstantPatternPositions=function setConstantPatternPositions(_1c,_1d){for(var _1e in this.binders){var _1f=this.binders[_1e];_1f.setConstantPatternPositions(_1c,_1d);}};_7.prototype.updatePaintArrays=function updatePaintArrays(_20,_21,_22,_23){var _24=false;for(var id in _20){var _25=this._featureMap.getPositions(+id);for(var i=0,_26=_25;i<_26.length;i+=1){var pos=_26[i];var _27=_21.feature(pos.index);for(var _28 in this.binders){var _29=this.binders[_28];if(_29 instanceof _4.ConstantBinder||_29 instanceof _4.CrossFadedConstantBinder){continue;}if((_29).expression.isStateDependent===true){var _2a=_22.paint.get(_28);(_29).expression=_2a.value;_29.updatePaintArray(pos.start,pos.end,_27,_20[id],_23);_24=true;}}}}return _24;};_7.prototype.defines=function defines(){var _2b=[];for(var _2c in this.binders){_2b.push.apply(_2b,this.binders[_2c].defines());}return _2b;};_7.prototype.getPaintVertexBuffers=function getPaintVertexBuffers(){return this._buffers;};_7.prototype.getUniforms=function getUniforms(_2d,_2e){var _2f=[];for(var _30 in this.binders){var _31=this.binders[_30];for(var i=0,_32=_31.uniformNames;i<_32.length;i+=1){var _33=_32[i];if(_2e[_33]){var _34=_31.getBinding(_2d,_2e[_33]);_2f.push({name:_33,property:_30,binding:_34});}}}return _2f;};_7.prototype.setUniforms=function setUniforms(_35,_36,_37,_38){for(var i=0,_39=_36;i<_39.length;i+=1){var ref=_39[i];var _3a=ref.name;var _3b=ref.property;var _3c=ref.binding;this.binders[_3b].setUniforms(_35,_3c,_38,_37.get(_3b),_3a);}};_7.prototype.setUniform=function setUniforms(_3d,_3e,_3f,_40){this.binders[_3e].setUniform(_3d,_3f,_40);};_7.prototype.updatePatternPaintBuffers=function updatePatternPaintBuffers(_41){var _42=[];for(var _43 in this.binders){var _44=this.binders[_43];if(_44 instanceof _4.CrossFadedCompositeBinder){var _45=_41.fromScale===2?_44.zoomInPaintVertexBuffer:_44.zoomOutPaintVertexBuffer;if(_45){_42.push(_45);}}else{if((_44 instanceof _4.SourceExpressionBinder||_44 instanceof _4.CompositeExpressionBinder)&&_44.paintVertexBuffer){_42.push(_44.paintVertexBuffer);}}}this._buffers=_42;};_7.prototype.upload=function upload(_46){for(var _47 in this.binders){this.binders[_47].upload(_46);}var _48=[];for(var _49 in this.binders){var _4a=this.binders[_49];if((_4a instanceof _4.SourceExpressionBinder||_4a instanceof _4.CompositeExpressionBinder)&&_4a.paintVertexBuffer){_48.push(_4a.paintVertexBuffer);}}this._buffers=_48;};_7.prototype.destroy=function destroy(){for(var _4b in this.binders){this.binders[_4b].destroy();}};var _4c=function _4c(_4d,_4e,_4f,_50){if(_50===void 0){_50=function(){return true;};}this.programConfigurations={};for(var i=0,_51=_4e;i<_51.length;i+=1){var _52=_51[i];this.programConfigurations[_52.id]=_7.createDynamic(_52,_4f,_50);this.programConfigurations[_52.id].layoutAttributes=_4d;}this.needsUpload=false;};_4c.prototype.populatePaintArrays=function populatePaintArrays(_53,_54,_55,_56){for(var key in this.programConfigurations){this.programConfigurations[key].populatePaintArrays(_53,_54,_55,_56);}this.needsUpload=true;};_4c.prototype.updatePaintArrays=function updatePaintArrays(_57,_58,_59,_5a){for(var i=0,_5b=_59;i<_5b.length;i+=1){var _5c=_5b[i];this.needsUpload=this.programConfigurations[_5c.id].updatePaintArrays(_57,_58,_5c,_5a)||this.needsUpload;}};_4c.prototype.get=function get(_5d){return this.programConfigurations[_5d];};_4c.prototype.upload=function upload(_5e){if(!this.needsUpload){return;}for(var _5f in this.programConfigurations){this.programConfigurations[_5f].upload(_5e);}this.needsUpload=false;};_4c.prototype.destroy=function destroy(){for(var _60 in this.programConfigurations){this.programConfigurations[_60].destroy();}};_1.ProgramConfiguration=_7;_1.ProgramConfigurationSet=_4c;_5.register("FeaturePositionMap",_2);_5.register("ProgramConfiguration",_7,{omit:["_buffers"]});_5.register("ProgramConfigurationSet",_4c);});