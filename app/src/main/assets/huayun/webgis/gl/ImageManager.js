//>>built
define("com/huayun/webgis/gl/ImageManager",["./ImagePosition","./Texture","./potpack","../utils/image"],function(_1,_2,_3,_4){var _5=1;function _6(_7){var _8=_7.userImage;if(_8&&_8.render){var _9=_8.render();if(_9){_7.data.replace(new Uint8Array(_8.data.buffer));return true;}}return false;};function _a(){this.images={};this.updatedImages={};this.callbackDispatchedThisFrame={};this.loaded=false;this.requestors=[];this.patterns={};this.atlasImage=new _4.RGBAImage({width:1,height:1});this.dirty=true;};_a.prototype.isLoaded=function isLoaded(){return this.loaded;};_a.prototype.setLoaded=function setLoaded(_b){if(this.loaded===_b){return;}this.loaded=_b;if(_b){for(var i=0,_c=this.requestors;i<_c.length;i+=1){var _d=_c[i];var _e=_d.ids;var _f=_d.callback;this._notify(_e,_f);}this.requestors=[];}};_a.prototype.getImage=function getImage(id){return this.images[id];};_a.prototype.addImage=function addImage(id,_10){this.images[id]=_10;};_a.prototype.updateImage=function updateImage(id,_11){var _12=this.images[id];_11.version=_12.version+1;this.images[id]=_11;this.updatedImages[id]=true;};_a.prototype.removeImage=function removeImage(id){var _13=this.images[id];delete this.images[id];delete this.patterns[id];if(_13.userImage&&_13.userImage.onRemove){_13.userImage.onRemove();}};_a.prototype.listImages=function listImages(){return Object.keys(this.images);};_a.prototype.getImages=function getImages(ids,_14){var _15=true;if(!this.isLoaded()){for(var i=0,_16=ids;i<_16.length;i+=1){var id=_16[i];if(!this.images[id]){_15=false;}}}if(this.isLoaded()||_15){this._notify(ids,_14);}else{this.requestors.push({ids:ids,callback:_14});}};_a.prototype._notify=function _notify(ids,_17){var _18={};for(var i=0,_19=ids;i<_19.length;i+=1){var id=_19[i];var _1a=this.images[id];if(_1a){_18[id]={data:_1a.data.clone(),pixelRatio:_1a.pixelRatio,sdf:_1a.sdf,version:_1a.version,hasRenderCallback:Boolean(_1a.userImage&&_1a.userImage.render)};}}_17(null,_18);};_a.prototype.getPixelSize=function getPixelSize(){var ref=this.atlasImage;var _1b=ref.width;var _1c=ref.height;return {width:_1b,height:_1c};};_a.prototype.getPattern=function getPattern(id){var _1d=this.patterns[id];var _1e=this.getImage(id);if(!_1e){return null;}if(_1d&&_1d.position.version===_1e.version){return _1d.position;}if(!_1d){var w=_1e.data.width+_5*2;var h=_1e.data.height+_5*2;var bin={w:w,h:h,x:0,y:0};var _1f=new _1(bin,_1e);this.patterns[id]={bin:bin,position:_1f};}else{_1d.position.version=_1e.version;}this._updatePatternAtlas();return this.patterns[id].position;};_a.prototype.bind=function bind(_20){var gl=_20.gl;if(!this.atlasTexture){this.atlasTexture=new _2(_20,this.atlasImage,gl.RGBA);}else{if(this.dirty){this.atlasTexture.update(this.atlasImage);this.dirty=false;}}this.atlasTexture.bind(gl.LINEAR,gl.CLAMP_TO_EDGE);};_a.prototype._updatePatternAtlas=function _updatePatternAtlas(){var _21=[];for(var id in this.patterns){_21.push(this.patterns[id].bin);}var ref=_3(_21);var w=ref.w;var h=ref.h;var dst=this.atlasImage;dst.resize({width:w||1,height:h||1});for(var _22 in this.patterns){var _23=this.patterns[_22];var bin=_23.bin;var x=bin.x+_5;var y=bin.y+_5;var src=this.images[_22].data;var w$1=src.width;var h$1=src.height;_4.RGBAImage.copy(src,dst,{x:0,y:0},{x:x,y:y},{width:w$1,height:h$1});_4.RGBAImage.copy(src,dst,{x:0,y:h$1-1},{x:x,y:y-1},{width:w$1,height:1});_4.RGBAImage.copy(src,dst,{x:0,y:0},{x:x,y:y+h$1},{width:w$1,height:1});_4.RGBAImage.copy(src,dst,{x:w$1-1,y:0},{x:x-1,y:y},{width:1,height:h$1});_4.RGBAImage.copy(src,dst,{x:0,y:0},{x:x+w$1,y:y},{width:1,height:h$1});}this.dirty=true;};_a.prototype.beginFrame=function beginFrame(){this.callbackDispatchedThisFrame={};};_a.prototype.dispatchRenderCallbacks=function dispatchRenderCallbacks(ids){for(var i=0,_24=ids;i<_24.length;i+=1){var id=_24[i];if(this.callbackDispatchedThisFrame[id]){continue;}this.callbackDispatchedThisFrame[id]=true;var _25=this.images[id];var _26=_6(_25);if(_26){this.updateImage(id,_25);}}};return _a;});