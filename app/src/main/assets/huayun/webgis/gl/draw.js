//>>built
define("com/huayun/webgis/gl/draw",["exports","../utils/Color","../utils/Constant","../utils/utils","./mode","../geometry/Point2D","../layers/support/funcUtils","./Texture","custom/gl-matrix-min"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9){var _a=function(_b,_c,_d){return ({"u_matrix":_b,"u_opacity":_c,"u_color":_d});};_1.drawBackground=function(_e,_f,_10,_11){var _12=_10.paint.get("background-color");var _13=_10.paint.get("background-opacity");if(_13===0){return;}var _14=_e.view.context;var gl=_14.gl;var _15=_e.transform;var _16=_e.tileSize;var _17=_10.paint.get("background-pattern");var _18=(!_17&&_12.a===1&&_13===1)?"opaque":"translucent";if(_e.renderPass!==_18){return;}var _19=_5.StencilMode.disabled;var _1a=_e.depthModeForSublayer(0,_18==="opaque"?_5.DepthMode.ReadWrite:_5.DepthMode.ReadOnly);var _1b=_1c(_e.renderPass);var _1d=_e.view.useProgram(_17?"backgroundPattern":"background");var _1e=_10.getCrossfadeParameters();for(var i=0,_1f=_11;i<_1f.length;i+=1){var _20=_1f[i];var _21=_20.posMatrix;var _22=_17?backgroundPatternUniformValues(_21,_13,_e,_17,{tileID:tileID,tileSize:_16},_1e):_a(_21,_13,_12);_1d.draw2(_14,gl.TRIANGLES,_1a,_19,_1b,_5.CullFaceMode.disabled,_22,_10.id,_e.tileExtentBuffer,_e.quadTriangleIndexBuffer,_e.tileExtentSegments);}};var _23=function(_24){return ({"u_matrix":_24});};_1.drawFill=function(_25,_26,_27,_28){var _29=_5.ColorMode.unblended;var _2a=_25.depthModeForSublayer(1,_5.DepthMode.ReadWrite);var gl=_25.view._gl;var _2b,_2c,_2d;var _2e=_25.view.viewpoint.level;var _2f="fill";var _30=gl.TRIANGLES;for(var i=0,_31=_28;i<_31.length;i+=1){var _32=_31[i];var _33=_26.getTile(_32);if(_33){var _34=(_33.getBucket(_27));if(!_34){continue;}var _35=_34.programConfigurations.get(_27.id);var _36=_25.view.useProgram(_2f,_35);_2b=_34.indexBuffer;_2c=_34.segments;_2d=_23(_32.posMatrix);_36.draw2(_25.view.context,_30,_2a,null,_29,_5.CullFaceMode.disabled,_2d,_27.id,_34.layoutVertexBuffer,_2b,_2c,_27.paint,_2e,_35);}}};function _37(_38,_39,z){return _39*(_3.layout.EXTENT/_38.tileSize);};var _3a=function(_3b,_3c,_3d,_3e,_3f,wh){return {"u_matrix":_3e.posMatrix,"u_ratio":1/_37(_3c,1,_3f),"u_device_pixel_ratio":1,"u_units_to_pixels":wh};};var _40=function(_41,_42,_43,_44,_45,wh,_46,_47){var _48=_41.view.lineAtlas;var _49=1/_37(_42,1,_45);var _4a=_43.layout.get("line-cap")==="round";var _4b=_48.getDash(_46.from,_4a);var _4c=_48.getDash(_46.to,_4a);var _4d=_4b.width*_47.fromScale;var _4e=_4c.width*_47.toScale;return {"u_matrix":_44.posMatrix,"u_ratio":1/_37(_42,1,_45),"u_device_pixel_ratio":1,"u_units_to_pixels":wh,"u_patternscale_a":[_49/_4d,-_4b.height/2],"u_patternscale_b":[_49/_4e,-_4c.height/2],"u_sdfgamma":_48.width/(Math.min(_4d,_4e)*256)/2,"u_image":0,"u_tex_y_a":_4b.y,"u_tex_y_b":_4c.y,"u_mix":_47.t};};_1.drawLine=function(_4f,_50,_51,_52){var _53=_51.paint.get("line-opacity").constantOr(1);var _54=_51.paint.get("line-width").constantOr(1);if(_53===0||_54===0){return;}var _55=_4f.depthModeForSublayer(0,_5.DepthMode.ReadOnly);var _56=_5.ColorMode.alphaBlended;var _57=_51.paint.get("line-dasharray");var _58=_51.getCrossfadeParameters();var _59=_4f.view.viewpoint.level;var _5a=_57?"lineSDF":"line";var _5b=_4f.view.context;var gl=_5b.gl;var _5c=true;var wh=[_4f.view.viewpoint.width/2,-_4f.view.viewpoint.height/2];for(var i=0,_5d=_52;i<_5d.length;i+=1){var _5e=_5d[i];var _5f=_50.getTile(_5e);if(_5f){var _60=(_5f.getBucket(_51));if(!_60){continue;}var _61=_60.programConfigurations.get(_51.id);var _62=_4f.view.context.program.get();var _63=_4f.view.useProgram(_5a,_61);var _64=_5c||_63.program!==_62;var _65=_57?_40(_4f,_5f,_51,_5e,_59,wh,_57,_58):_3a(_4f,_5f,_51,_5e,_59,wh);if(_57&&(_64||_4f.view.lineAtlas.dirty)){_5b.activeTexture.set(gl.TEXTURE0);_4f.view.lineAtlas.bind(_5b);}_63.draw2(_5b,gl.TRIANGLES,_55,null,_56,_5.CullFaceMode.disabled,_65,_51.id,_60.layoutVertexBuffer,_60.indexBuffer,_60.segments,_51.paint,_59,_61);_5c=false;}}};var _66={horizontal:1,vertical:2,horizontalOnly:3};function _1c(_67){if(_67==="opaque"){return _5.ColorMode.unblended;}else{return _5.ColorMode.alphaBlended;}};function _68(_69,_6a){var x=_69[0]/_69[3];var y=_69[1]/_69[3];var _6b=(x>=-_6a[0]&&x<=_6a[0]&&y>=-_6a[1]&&y<=_6a[1]);return _6b;};function _6c(out){out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=1;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=1;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out;};var _6d=_9.mat4.create();function _6e(){var out=new Float32Array(9);out[0]=1;out[4]=1;out[8]=1;return out;};function _6f(out,rad){var s=Math.sin(rad),c=Math.cos(rad);out[0]=c;out[1]=s;out[2]=0;out[3]=-s;out[4]=c;out[5]=0;out[6]=0;out[7]=0;out[8]=1;return out;};function _70(out,a,m){var x=a[0],y=a[1],z=a[2];out[0]=x*m[0]+y*m[3]+z*m[6];out[1]=x*m[1]+y*m[4]+z*m[7];out[2]=x*m[2]+y*m[5]+z*m[8];return out;};var _71=function(_72,_73,_74,_75,_76){var _77=[0.12347,-0.56158,0.9959292143521045];var _78=_6e();_6f(_78,-0);_70(_77,_77,_78);var _79={r:1,g:1,b:1,a:1};return {"u_matrix":_72,"u_lightpos":_77,"u_lightintensity":0.3,"u_lightcolor":[_79.r,_79.g,_79.b],"u_vertical_gradient":+_74,"u_opacity":_75,"u_height_image":0,"u_min_height":_76.minimumHeight,"u_delta_height":_76.maximumHeight-_76.minimumHeight};};var _7a=new Float32Array([-Infinity,-Infinity,0,-Infinity,-Infinity,0,-Infinity,-Infinity,0,-Infinity,-Infinity,0]);function _7b(num,_7c){for(var i=0;i<num;i++){var _7d=_7c.length;_7c.resize(_7d+4);_7c.float32.set(_7a,_7d*3);}};function _7e(_7f,_80){var pos=[_7f.x,_7f.y,0,1];_7.xyTransformMat4(pos,pos,_80);var w=pos[3];return {point:new _6(pos[0]/w,pos[1]/w),signedDistanceFromCamera:w};};function _81(_82,_83,_84,_85,_86,_87,_88,_89,_8a){var _8b=_85?_82.textSizeData:_82.iconSizeData;var _8c=_7.evaluateSizeForZoom(_8b,_8a);var _8d=_84.view.viewpoint;var _8e=[256/_8d.width*2+1,256/_8d.height*2+1];var _8f=_85?_82.text.dynamicLayoutVertexArray:_82.icon.dynamicLayoutVertexArray;_8f.clear();var _90=_82.lineVertexArray;var _91=_85?_82.text.placedSymbolArray:_82.icon.placedSymbolArray;var _92=_84.transform.width/_84.transform.height;var _93=false;for(var s=0;s<_91.length;s++){var _94=_91.get(s);if(_94.hidden||_94.writingMode===_66.vertical&&!_93){_7b(_94.numGlyphs,_8f);continue;}_93=false;var _95=[_94.anchorX,_94.anchorY,0,1];_7.transformMat4(_95,_95,_83);if(!_68(_95,_8e)){_7b(_94.numGlyphs,_8f);continue;}var _96=_95[3];var _97=0.5+0.5*(_96/_84.transform.cameraToCenterDistance);var _98=_7.evaluateSizeForFeature(_8b,_8c,_94);var _99=_88?_98*_97:_98/_97;var _9a=new _6(_94.anchorX,_94.anchorY);var _9b=_7e(_9a,_86).point;var _9c={};var _9d=_7.placeGlyphsAlongLine(_94,_99,false,_89,_83,_86,_87,_82.glyphOffsetArray,_90,_8f,_9b,_9a,_9c,_92);_93=_9d.useVertical;if(_9d.notEnoughRoom||_93||(_9d.needsFlipping&&_7.placeGlyphsAlongLine(_94,_99,true,_89,_83,_86,_87,_82.glyphOffsetArray,_90,_8f,_9b,_9a,_9c,_92).notEnoughRoom)){_7b(_94.numGlyphs,_8f);}}if(_85){_82.text.dynamicLayoutVertexBuffer.updateData(_8f);}else{_82.icon.dynamicLayoutVertexBuffer.updateData(_8f);}};function _9e(_9f,_a0,_a1,_a2,_a3,_a4,_a5,_a6,_a7,_a8){var _a9=_9f.text.placedSymbolArray;var _aa=_9f.text.dynamicLayoutVertexArray;_aa.clear();for(var s=0;s<_a9.length;s++){var _ab=_a9.get(s);var _ac=(!_ab.hidden&&_ab.crossTileID)?_a2[_ab.crossTileID]:null;if(!_ac){_7b(_ab.numGlyphs,_aa);}else{var _ad=new __chunk_1.Point(_ab.anchorX,_ab.anchorY);var _ae=_7e(_ad,_a1?_a6:_a5);var _af=0.5+0.5*(_a4.cameraToCenterDistance/_ae.signedDistanceFromCamera);var _b0=_a3.evaluateSizeForFeature(_9f.textSizeData,_a8,_ab)*_af/__chunk_1.ONE_EM;if(_a1){_b0*=_9f.tilePixelRatio/_a7;}var _b1=_ac.width;var _b2=_ac.height;var _b3=_ac.radialOffset;var _b4=_ac.textBoxScale;var _b5=calculateVariableRenderShift(_ac.anchor,_b1,_b2,_b3,_b4,_b0);var _b6=_a1?_7e(_ad.add(_b5),_a5).point:_ae.point.add(_a0?_b5.rotate(-_a4.angle):_b5);for(var g=0;g<_ab.numGlyphs;g++){__chunk_1.addDynamicAttributes(_aa,_b6,0);}}}_9f.text.dynamicLayoutVertexBuffer.updateData(_aa);};var _b7=function(_b8,_b9,_ba,_bb,_bc,_bd,_be,_bf,_c0,_c1){return {"u_is_size_zoom_constant":+(_b8==="constant"||_b8==="source"),"u_is_size_feature_constant":+(_b8==="constant"||_b8==="camera"),"u_size_t":_b9?_b9.uSizeT:0,"u_size":_b9?_b9.uSize:0,"u_camera_to_center_distance":_bc.transform.cameraToCenterDistance,"u_pitch":_bc.transform.pitch/180*Math.PI,"u_rotate_symbol":+_ba,"u_aspect_ratio":_bc.view.viewpoint.width/_bc.view.viewpoint.height,"u_fade_change":1,"u_matrix":_bd,"u_label_plane_matrix":_be,"u_coord_matrix":_bf,"u_is_text":+_c0,"u_pitch_with_map":+_bb,"u_texsize":_c1,"u_texture":0};};var _c2=function(_c3,_c4,_c5,_c6,_c7,_c8,_c9,_ca,_cb,_cc,_cd){return _4.extend(_b7(_c3,_c4,_c5,_c6,_c7,_c8,_c9,_ca,_cb,_cc),{"u_gamma_scale":(_c6?Math.cos(_c7.view.viewpoint.pitch/180*Math.PI)*_c7.view.viewpoint.cameraToCenterDistance:1),"u_device_pixel_ratio":1,"u_is_halo":+_cd});};function _ce(_cf,_d0,_d1,_d2,_d3,_d4,_d5,_d6,_d7,_d8,_d9,_da,_db){var _dc=_cf.view.context;var gl=_dc.gl;var _dd=_d6==="map";var _de=_d7==="map";var _df=_dd&&_d1.layout.get("symbol-placement")!=="point";var _e0=_dd&&!_de&&!_df;var _e1=_cf.depthModeForSublayer(0,_5.DepthMode.ReadOnly);var _e2;var _e3;var _e4=_d1.layout.get("text-variable-anchor");var _e5=[];var _e6=_cf.view.viewpoint.level;var _e7=_cf.view.viewpoint.angle;for(var i$1=0,_e8=_d2;i$1<_e8.length;i$1+=1){var _e9=_e8[i$1];var _ea=_d0.getTile(_e9);if(_ea){var _eb=(_ea.getBucket(_d1));if(!_eb){continue;}var _ec=_d3?_eb.text:_eb.icon;if(!_ec||!_ec.segments.get().length){continue;}var _ed=_ec.programConfigurations.get(_d1.id);var _ee=_d3||_eb.sdfIcons;var _ef=_d3?_eb.textSizeData:_eb.iconSizeData;if(!_e2){_e2=_cf.view.useProgram(_ee?"symbolSDF":"symbolIcon",_ed);_e3=_7.evaluateSizeForZoom(_ef,_e6);}_dc.activeTexture.set(gl.TEXTURE0);var _f0=(void 0);var _f1=(void 0);var _f2=(void 0);if(_d3){_f1=_ea.glyphAtlasTexture;_f2=gl.LINEAR;_f0=_ea.glyphAtlasTexture.size;}else{var _f3=_d1.layout.get("icon-size").constantOr(0)!==1||_eb.iconsNeedLinear;var _f4=_de||false;_f1=_ea.imageAtlasTexture;_f2=_ee||false||false||_f3||_f4?gl.LINEAR:gl.NEAREST;_f0=_ea.imageAtlasTexture.size;}var s=_37(_ea,1,_cf.transform.level);var _f5=_7.getLabelPlaneMatrix(_e9.posMatrix,_de,_dd,_cf.transform,s);var _f6=_7.getGlCoordMatrix(_e9.posMatrix,_de,_dd,_cf.transform,s);if(_df){_81(_eb,_e9.posMatrix,_cf,_d3,_f5,_f6,_de,_d8,_e6);}else{if(_d3&&_e3&&_e4){var _f7=Math.pow(2,tr.zoom-_ea.tileID.overscaledZ);_9e(_eb,_dd,_de,_db,__chunk_1.symbolSize,tr,_f5,_e9.posMatrix,_f7,_e3);}}var _f8=_7.translatePosMatrix(_e9.posMatrix,_ea,_d4,_d5,undefined,_e7,_e6),_f9=(_df||(_d3&&_e4))?_6d:_f5,_fa=_7.translatePosMatrix(_f6,_ea,_d4,_d5,true,_e7,_e6);var _fb=_ee&&_d1.paint.get(_d3?"text-halo-width":"icon-halo-width").constantOr(1)!==0;var _fc=(void 0);if(_ee){_fc=_c2(_ef.kind,_e3,_e0,_de,_cf,_f8,_f9,_fa,_d3,_f0,true);}else{_fc=_b7(_ef.kind,_e3,_e0,_de,_cf,_f8,_f9,_fa,_d3,_f0);}var _fd={program:_e2,buffers:_ec,uniformValues:_fc,atlasTexture:_f1,atlasInterpolation:_f2,isSDF:_ee,hasHalo:_fb};_e5.push({segments:_ec.segments,sortKey:0,state:_fd});}}for(var i$2=0,_fe=_e5;i$2<_fe.length;i$2+=1){var _ff=_fe[i$2];var _100=_ff.state;_100.atlasTexture.bind(_100.atlasInterpolation,gl.CLAMP_TO_EDGE);if(_100.isSDF){var _101=((_100.uniformValues));if(_100.hasHalo){_101["u_is_halo"]=1;_102(_100.buffers,_ff.segments,_d1,_cf,_100.program,_e1,_d9,_da,_101);}_101["u_is_halo"]=0;}_102(_100.buffers,_ff.segments,_d1,_cf,_100.program,_e1,_d9,_da,_100.uniformValues);}};function _102(_103,_104,_105,_106,_107,_108,_109,_10a,_10b){var _10c=_106.view.context;var gl=_10c.gl;_107.draw2(_10c,gl.TRIANGLES,_108,_109,_10a,_5.CullFaceMode.disabled,_10b,_105.id,_103.layoutVertexBuffer,_103.indexBuffer,_104,_105.paint,_106.view.viewpoint.level,_103.programConfigurations.get(_105.id),_103.dynamicLayoutVertexBuffer,_103.opacityVertexBuffer);};_1.drawSymbols=function(_10d,_10e,_10f,_110,_111){if(_10d.renderPass!=="translucent"){return;}var _112=_1c(_10d.renderPass);var _113=_5.StencilMode.disabled;if(_10f.paint.get("icon-opacity").constantOr(1)!==0){_ce(_10d,_10e,_10f,_110,false,_10f.paint.get("icon-translate"),_10f.paint.get("icon-translate-anchor"),_10f.layout.get("icon-rotation-alignment"),_10f.layout.get("icon-pitch-alignment"),_10f.layout.get("icon-keep-upright"),null,_112,_111);}if(_10f.paint.get("text-opacity").constantOr(1)!==0){_ce(_10d,_10e,_10f,_110,true,_10f.paint.get("text-translate"),_10f.paint.get("text-translate-anchor"),_10f.layout.get("text-rotation-alignment"),_10f.layout.get("text-pitch-alignment"),_10f.layout.get("text-keep-upright"),null,_112,_111);}};function _114(_115,_116,_117,_118,_119,_11a,_11b){var _11c=_115.view.context;var gl=_11c.gl;var _11d=_117.paint.get("fill-extrusion-pattern");var _11e=_11d.constantOr((1));var _11f=_117.getCrossfadeParameters();var _120=_117.paint.get("fill-extrusion-opacity");var _121=_115.view.ground.sourceCache;for(var i=0,list=_118;i<list.length;i+=1){var _122=list[i];var tile=_116.getTile(_122);if(!tile.groundTile){tile.groundTile=_121.getTile(_122);}var _123=(tile.getBucket(_117));if(!_123){continue;}var _124=_123.programConfigurations.get(_117.id);var _125=_115.view.useProgram("fillExtrusion",_124);if(!tile.groundTile||!tile.groundTile.heightTexture){continue;}var _126=gl.LINEAR;_11c.activeTexture.set(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,tile.groundTile.heightTexture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,_126);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,_126);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);var _127=_122.posMatrix;var _128=_117.paint.get("fill-extrusion-vertical-gradient");var _129=_71(_127,_115,_128,_120,tile.groundTile);_125.draw2(_11c,_11c.gl.TRIANGLES,_119,_11a,_11b,_5.CullFaceMode.backCCW,_129,_117.id,_123.layoutVertexBuffer,_123.indexBuffer,_123.segments,_117.paint,_115.transform.level,_124);}};_1.drawExtrusion=function(_12a,_12b,_12c,_12d){var _12e=_12c.paint.get("fill-extrusion-opacity");if(_12e===0){return;}if(_12a.renderPass==="translucent"){var _12f=new _5.DepthMode(_12a.view.context.gl.LEQUAL,_5.DepthMode.ReadWrite,_12a.depthRangeFor3D);if(_12e===1&&!_12c.paint.get("fill-extrusion-pattern").constantOr((1))){var _130=_1c();_114(_12a,_12b,_12c,_12d,_12f,_5.StencilMode.disabled,_130);}else{_114(_12a,_12b,_12c,_12d,_12f,_5.StencilMode.disabled,_5.ColorMode.disabled);_114(_12a,_12b,_12c,_12d,_12f,_12a.stencilModeFor3D(),_1c());}}};var _131=function(_132,_133,_134,_135){return {"u_matrix":_132,"u_opacity":_135};};function _136(_137,_138,_139,_13a,_13b,_13c,_13d){var _13e=_137.view.context;var gl=_13e.gl;var _13f=_139.paint.get("fill-extrusion-pattern");var _140=_13f.constantOr((1));var _141=_139.paint.get("fill-extrusion-opacity");for(var i=0,list=_13a;i<list.length;i+=1){var _142=list[i];var tile=_138.getTile(_142);var _143=(tile.getBucket(_139));if(!_143){continue;}var _144=_143.programConfigurations.get(_139.id);var _145=_137.view.useProgram("lineExtrusion",_144);var _146=_142.posMatrix;var _147=_139.paint.get("fill-extrusion-vertical-gradient");var _148=_131(_146,_137,_147,_141);_145.draw(_13e,_13e.gl.LINES,_13b,_13c,_13d,_5.CullFaceMode.backCCW,_148,_139.id,_143.layoutVertexBuffer,_143.indexBuffer,_143.segments,_139.paint,_137.transform.level,_144);}};_1.drawLineExtrusion=function(_149,_14a,_14b,_14c){var _14d=_14b.paint.get("fill-extrusion-opacity");if(_14d===0){return;}if(_149.renderPass==="translucent"){var _14e=new _5.DepthMode(_149.view.context.gl.LEQUAL,_5.DepthMode.ReadWrite,_149.depthRangeFor3D);var _14f=_1c();_136(_149,_14a,_14b,_14c,_14e,_5.StencilMode.disabled,_14f);}};_1.drawClipping=function(_150,_151,_152,_153,_154){var _155=_150.view.context;var gl=_155.gl;var _156=new Matrix4();_156.ortho(0,_150.view.width,_150.view.height,0,0,1);_156.scale(gl.drawingBufferWidth,gl.drawingBufferHeight,0);_150.view.useProgram("clippingMask").draw(_155,gl.TRIANGLES,_5.DepthMode.disabled,_151,_5.ColorMode.disabled,_5.CullFaceMode.disabled,{"u_matrix":_156.elements},"$clipping",_152,_153,_154);};function _157(_158,_159,_15a,fbo){var gl=_158.gl;gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,_159.width/4,_159.height/4,0,gl.RGBA,_158.extTextureHalfFloat?_158.extTextureHalfFloat.HALF_FLOAT_OES:gl.UNSIGNED_BYTE,null);fbo.colorAttachment.set(_15a);if(_158.extTextureHalfFloat&&gl.checkFramebufferStatus(gl.FRAMEBUFFER)!==gl.FRAMEBUFFER_COMPLETE){_158.extTextureHalfFloat=null;fbo.colorAttachment.setDirty();_157(_158,_159,_15a,fbo);}};function _15b(_15c,_15d,_15e){var gl=_15c.gl;_15c.activeTexture.set(gl.TEXTURE1);_15c.viewport.set([0,0,_15d.width/4,_15d.height/4]);var fbo=_15e.heatmapFbo;if(!fbo){var _15f=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,_15f);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);fbo=_15e.heatmapFbo=_15c.createFramebuffer(_15d.width/4,_15d.height/4);_157(_15c,_15d,_15f,fbo);}else{gl.bindTexture(gl.TEXTURE_2D,fbo.colorAttachment.get());_15c.bindFramebuffer.set(fbo.framebuffer);}};var _160=function(_161,tile,zoom,_162){return ({"u_matrix":_161,"u_extrude_scale":_37(tile,1,zoom),"u_intensity":_162});};var _163=function(_164,_165,_166,_167){var _168=_164.view.viewpoint;var _169=_9.mat4.create();_9.mat4.ortho(_169,0,_168.width,_168.height,0,0,1);var gl=_164.view.context.gl;return {"u_matrix":_169,"u_world":[gl.drawingBufferWidth,gl.drawingBufferHeight],"u_image":_166,"u_color_ramp":_167,"u_opacity":_165.paint.get("heatmap-opacity")};};function _16a(_16b,_16c){var _16d=_16b.view.context;var gl=_16d.gl;var fbo=_16c.heatmapFbo;if(!fbo){return;}_16d.activeTexture.set(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,fbo.colorAttachment.get());_16d.activeTexture.set(gl.TEXTURE1);var _16e=_16c.colorRampTexture;if(!_16e){_16e=_16c.colorRampTexture=new _8(_16d,_16c.colorRamp,gl.RGBA);}_16e.bind(gl.LINEAR,gl.CLAMP_TO_EDGE);_16b.view.useProgram("heatmapTexture").draw(_16d,gl.TRIANGLES,_5.DepthMode.disabled,_5.StencilMode.disabled,_5.ColorMode.alphaBlended,_5.CullFaceMode.disabled,_163(_16b,_16c,0,1),_16c.id,_16b.viewportBuffer,_16b.quadTriangleIndexBuffer,_16b.viewportSegments,_16c.paint,_16b.transform.level);};_1.drawHeatmap=function(_16f,_170,_171,_172){if(_171.paint.get("heatmap-opacity")===0){return;}if(_16f.renderPass==="offscreen"){var _173=_16f.view.context;var gl=_173.gl;var _174=_16f.depthModeForSublayer(0,_5.DepthMode.ReadOnly);var _175=_5.StencilMode.disabled;var _176=new _5.ColorMode([gl.ONE,gl.ONE],_2.transparent,[true,true,true,true]);_15b(_173,_16f,_171);_173.clear({color:_2.transparent});for(var i=0;i<_172.length;i++){var _177=_172[i];if(_170.hasRenderableParent(_177)){continue;}var tile=_170.getTile(_177);var _178=(tile.getBucket(_171));if(!_178){continue;}var _179=_178.programConfigurations.get(_171.id);var _17a=_16f.view.useProgram("heatmap",_179);var ref=_16f.transform;var zoom=ref.zoom;_17a.draw(_173,gl.TRIANGLES,_174,_175,_176,_5.CullFaceMode.disabled,_160(_177.posMatrix,tile,zoom,_171.paint.get("heatmap-intensity")),_171.id,_178.layoutVertexBuffer,_178.indexBuffer,_178.segments,_171.paint,_16f.transform.level,_179);}_173.viewport.set([0,0,_16f.width,_16f.height]);}else{if(_16f.renderPass==="translucent"){_16f.view.context.setColorMode(_5.ColorMode.alphaBlended);_16a(_16f,_171);}}};function _17b(tile,_17c,_17d,_17e){var _17f=300;if(_17f>0){var now=_4.now();var _180=(now-tile.timeAdded)/_17f;var _181=_17c?(now-_17c.timeAdded)/_17f:-1;var _182=_17d.getSource();var _183=_17e.coveringZoomLevel({tileSize:_182.tileSize,roundZoom:_182.roundZoom});var _184=!_17c||Math.abs(_17c.tileID.overscaledZ-_183)>Math.abs(tile.tileID.overscaledZ-_183);var _185=(_184&&tile.refreshedUponExpiration)?1:_4.clamp(_184?_180:1-_181,0,1);if(_17c){return {opacity:1,mix:1-_185};}else{return {opacity:_185,mix:0};}}else{return {opacity:1,mix:0};}};var _186=function(_187,_188){var _189=_187.view.viewpoint;var _18a=_187.position;var _18b=_189.getMatrixForPoint(_18a[0],_18a[1],null,true);return {"u_matrix":_18b,"u_image":_188,"u_opacity":_187.opacity};};_1.drawImageLayer=function(_18c){if(!_18c.texture){return;}_18c.view.context.setColorMode(_5.ColorMode.alphaBlended);_18d(_18c);};function _18d(_18e){var _18f=_18e.view.context;var gl=_18f.gl;var _190=_18e.depthModeForSublayer(0,_5.DepthMode.ReadWrite,gl.LESS);var _191=gl.LINEAR;_18f.activeTexture.set(gl.TEXTURE0);_18e.texture.bind(_191,gl.CLAMP_TO_EDGE,gl.LINEAR_MIPMAP_NEAREST);_18e.view.useProgram("image").draw2(_18f,gl.TRIANGLES,_190,_5.StencilMode.disabled,_5.ColorMode.alphaBlended,_5.CullFaceMode.disabled,_186(_18e,0),"image",_18e.viewportBuffer,_18e.quadTriangleIndexBuffer,_18e.viewportSegments,null,_18e.transform.level);};var _192=function(_193,_194,tile,_195){var _196=_193.transform;var _197,_198;if(_195.paint.get("circle-pitch-alignment")==="map"){var _199=_37(tile,1,_196.level);_197=true;_198=[_199,_199];}else{_197=false;_198=_196.pixelsToGLUnits;}return {"u_camera_to_center_distance":_196.cameraToCenterDistance,"u_scale_with_map":+(_195.paint.get("circle-pitch-scale")==="map"),"u_matrix":_194.posMatrix,"u_pitch_with_map":+(_197),"u_device_pixel_ratio":1,"u_extrude_scale":_198};};_1.drawCircles=function(_19a,_19b,_19c,_19d){if(_19a.renderPass!=="translucent"){return;}var _19e=_19c.paint.get("circle-opacity");var _19f=_19c.paint.get("circle-stroke-width");var _1a0=_19c.paint.get("circle-stroke-opacity");if(_19e.constantOr(1)===0&&(_19f.constantOr(1)===0||_1a0.constantOr(1)===0)){return;}var _1a1=_19a.view.context;var gl=_1a1.gl;var _1a2=_19a.depthModeForSublayer(0,_5.DepthMode.ReadOnly);var _1a3=_5.StencilMode.disabled;var _1a4=_1c(_19a.renderPass);for(var i=0;i<_19d.length;i++){var _1a5=_19d[i];var tile=_19b.getTile(_1a5);var _1a6=(tile.getBucket(_19c));if(!_1a6){continue;}var _1a7=_1a6.programConfigurations.get(_19c.id);var _1a8=_19a.view.useProgram("circles",_1a7);_1a8.draw(_1a1,gl.TRIANGLES,_1a2,_1a3,_1a4,_5.CullFaceMode.disabled,_192(_19a,_1a5,tile,_19c),_19c.id,_1a6.layoutVertexBuffer,_1a6.indexBuffer,_1a6.segments,_19c.paint,_19a.transform.level,_1a7);}};});