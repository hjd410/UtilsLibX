//>>built
define("com/huayun/webgis/gl/LineBucketCut",["../data/ArrayType","./SegmentVector"],function(_1,_2){var _3=63;var _4=15;var _5=1/2;var _6=Math.pow(2,_4-1)/_5;var _7=Math.cos(75/2*(Math.PI/180));function _8(_9,_a,_b,_c,up,_d,_e){_9.emplaceBack((_a.x<<1)+(_c?1:0),(_a.y<<1)+(up?1:0),Math.round(_3*_b.x)+128,Math.round(_3*_b.y)+128,((_d===0?0:(_d<0?-1:1))+1)|(((_e*_5)&63)<<2),(_e*_5)>>6);};var _f=function _f(_10){this.layoutVertexArray=new _1.StructArrayLayout2i4ub8();this.indexArray=new _1.StructArrayLayout3ui6();this.segments=new _2();};_f.prototype.addFeature=function addFeature(_11,_12,cap,_13,_14){for(var i=0;i<_11.length;i+=1){var _15=_11[i];this.addLine(_15,_12,cap,_13,_14);}};_f.prototype.addLine=function addLine(_16,_17,cap,_18,_19){var _1a=null;var len=_16.length;while(len>=2&&_16[len-1].equals(_16[len-2])){_16.splice(len-1);len--;}var _1b=0;while(_1b<len-1&&_16[_1b].equals(_16[_1b+1])){_1b++;}if(_17==="bevel"){_18=1.05;}var _1c=240;var _1d=_16[_1b];var _1e=this.segments.prepareSegment(len*10,this.layoutVertexArray,this.indexArray);this.distance=0;var _1f=cap,_20=cap;var _21=true;var _22;var _23=((undefined));var _24=((undefined));var _25=((undefined));var _26=((undefined));var _27;var _28;this.e1=this.e2=this.e3=-1;for(var i=_1b;i<len;i++){_24=_16[i+1];if(_26){_25=_26;}if(_22){_23=_22;}_22=_16[i];_26=_24?_24.sub(_22)._unit()._perp():_25;_25=_25||_26;if(!_25){return;}var _29=_25.add(_26);if(_29.x!==0||_29.y!==0){_29._unit();}var _2a=_29.x*_26.x+_29.y*_26.y;var _2b=_2a!==0?1/_2a:Infinity;var _2c=_2a<_7&&_23&&_24;if(_2c&&i>_1b){var _2d=_22.dist(_23);if(_2d>2*_1c){var _2e=_22.sub(_22.sub(_23)._mult(_1c/_2d)._round());this.distance+=_2e.dist(_23);this.addCurrentVertex(_2e,this.distance,_25.mult(1),0,0,false,_1e,_1a);_23=_2e;}}var _2f=_23&&_24;var _30=_2f?_17:_24?_1f:_20;if(_2f&&_30==="round"){if(_2b<_19){_30="miter";}else{if(_2b<=2){_30="fakeround";}}}if(_30==="miter"&&_2b>_18){_30="bevel";}if(_30==="bevel"){if(_2b>2){_30="flipbevel";}if(_2b<_18){_30="miter";}}if(_23){this.distance+=_22.dist(_23);}if(_30==="miter"){_29._mult(_2b);this.addCurrentVertex(_22,this.distance,_29,0,0,false,_1e,_1a);}else{if(_30==="flipbevel"){if(_2b>100){_29=_26.clone().mult(-1);}else{var _31=_25.x*_26.y-_25.y*_26.x>0?-1:1;var _32=_2b*_25.add(_26).mag()/_25.sub(_26).mag();_29._perp()._mult(_32*_31);}this.addCurrentVertex(_22,this.distance,_29,0,0,false,_1e,_1a);this.addCurrentVertex(_22,this.distance,_29.mult(-1),0,0,false,_1e,_1a);}else{if(_30==="bevel"||_30==="fakeround"){var _33=(_25.x*_26.y-_25.y*_26.x)>0;var _34=-Math.sqrt(_2b*_2b-1);if(_33){_28=0;_27=_34;}else{_27=0;_28=_34;}if(!_21){this.addCurrentVertex(_22,this.distance,_25,_27,_28,false,_1e,_1a);}if(_30==="fakeround"){var n=Math.floor((0.5-(_2a-0.5))*8);var _35=(void 0);for(var m=0;m<n;m++){_35=_26.mult((m+1)/(n+1))._add(_25)._unit();this.addPieSliceVertex(_22,this.distance,_35,_33,_1e,_1a);}this.addPieSliceVertex(_22,this.distance,_29,_33,_1e,_1a);for(var k=n-1;k>=0;k--){_35=_25.mult((k+1)/(n+1))._add(_26)._unit();this.addPieSliceVertex(_22,this.distance,_35,_33,_1e,_1a);}}if(_24){this.addCurrentVertex(_22,this.distance,_26,-_27,-_28,false,_1e,_1a);}}else{if(_30==="butt"){if(!_21){this.addCurrentVertex(_22,this.distance,_25,0,0,false,_1e,_1a);}if(_24){this.addCurrentVertex(_22,this.distance,_26,0,0,false,_1e,_1a);}}else{if(_30==="square"){if(!_21){this.addCurrentVertex(_22,this.distance,_25,1,1,false,_1e,_1a);this.e1=this.e2=-1;}if(_24){this.addCurrentVertex(_22,this.distance,_26,-1,-1,false,_1e,_1a);}}else{if(_30==="round"){if(!_21){this.addCurrentVertex(_22,this.distance,_25,0,0,false,_1e,_1a);this.addCurrentVertex(_22,this.distance,_25,1,1,true,_1e,_1a);this.e1=this.e2=-1;}if(_24){this.addCurrentVertex(_22,this.distance,_26,-1,-1,true,_1e,_1a);this.addCurrentVertex(_22,this.distance,_26,0,0,false,_1e,_1a);}}}}}}}if(_2c&&i<len-1){var _36=_22.dist(_24);if(_36>2*_1c){var _37=_22.add(_24.sub(_22)._mult(_1c/_36)._round());this.distance+=_37.dist(_22);this.addCurrentVertex(_37,this.distance,_26.mult(1),0,0,false,_1e,_1a);_22=_37;}}_21=false;}};_f.prototype.addCurrentVertex=function addCurrentVertex(_38,_39,_3a,_3b,_3c,_3d,_3e,_3f){var _40;var _41=this.layoutVertexArray;var _42=this.indexArray;_40=_3a.clone();if(_3b){_40._sub(_3a.perp()._mult(_3b));}_8(_41,_38,_40,_3d,false,_3b,_39);this.e3=_3e.vertexLength++;if(this.e1>=0&&this.e2>=0){_42.emplaceBack(this.e1,this.e2,this.e3);_3e.primitiveLength++;}this.e1=this.e2;this.e2=this.e3;_40=_3a.mult(-1);if(_3c){_40._sub(_3a.perp()._mult(_3c));}_8(_41,_38,_40,_3d,true,-_3c,_39);this.e3=_3e.vertexLength++;if(this.e1>=0&&this.e2>=0){_42.emplaceBack(this.e1,this.e2,this.e3);_3e.primitiveLength++;}this.e1=this.e2;this.e2=this.e3;if(_39>_6/2&&!_3f){this.distance=0;this.addCurrentVertex(_38,this.distance,_3a,_3b,_3c,_3d,_3e);}};_f.prototype.addPieSliceVertex=function addPieSliceVertex(_43,_44,_45,_46,_47,_48){_45=_45.mult(_46?-1:1);var _49=this.layoutVertexArray;var _4a=this.indexArray;_8(_49,_43,_45,false,_46,0,_44);this.e3=_47.vertexLength++;if(this.e1>=0&&this.e2>=0){_4a.emplaceBack(this.e1,this.e2,this.e3);_47.primitiveLength++;}if(_46){this.e2=this.e3;}else{this.e1=this.e3;}};return _f;});