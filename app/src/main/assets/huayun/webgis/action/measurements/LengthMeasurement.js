//>>built
define("com/huayun/webgis/action/measurements/LengthMeasurement",["dojo/_base/declare","dojo/on","dojo/dom","dojo/query","dojo/topic","dojo/dom-class","dojo/throttle","dojo/dom-construct","dojo/_base/window","../../geometry/Polyline","../../Graphic","../../Feature","../../symbols/LineSymbol","../../symbols/PointSymbol","../../symbols/TextSymbol","../../geometry/Point2D","../ActiveMapAction"],function(_1,on,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10){return _1("com.huayun.webgis.action.draws.LineDraw",[_10],{constructor:function(_11){this.view=_11.view;this.view.selectEnabled=false;this.isActive=true;this.drawLayer=this.view.map.findLayerById("drawLayer");this._mouseClick=null;this._dblMouseClick=null;this._mouseClickMove=null;this._lastPoint=null;this._vertexArr=[];this.cacheLength=0;this._lineGraphicList=[];this._isNew=true;this._preClick=true;this._lineGraphicHash={};this._symbol=new _c({color:"#009688",width:3});this._vertexSymbol=new _d({radius:5,color:"#0000FF",pitchWithMap:false,scaleWithPitch:false});this._currentGraphic=null;var obj=this;_4.subscribe("measurement-delete",function(id){var _12=obj._lineGraphicHash[id];if(_12&&_12.length>0){_12.forEach(function(_13){obj.drawLayer.removeGraphic(_13);});}});_4.subscribe("frameUpdate",function(){this.toLocal();}.bind(this));},active:function(){if(!this.state){this.state=true;this.view.panEnabled=false;this.view.selectEnabled=false;this._mouseClick=on(this.view.domNode,"click",this._onMouseClick.bind(this));this._dblMouseClick=on(this.view.domNode,"dblclick",this._onDoubleMouseClick.bind(this));_5.add(this.view.domNode,"draw-cursor-style");}},_onMouseClick:function(_14){_14.preventDefault();_14.stopPropagation();var geo=this.view.screenToGeometry(_14.x,_14.y);if(!this._mouseClickMove){this._mouseClickMove=on(this.view.domNode,"mousemove",_6(this._onMouseMove.bind(this),20));}if(this._lastPoint===null){this._lineGraphicList=[];this.doAction(geo);}else{if(_14.x!==this._lastPoint.x&&_14.y!==this._lastPoint.y){this.doAction(geo);}}this._lastPoint={x:_14.x,y:_14.y};},_onMouseMove:function(e){var geo=this.view.screenToGeometry(e.x,e.y);this.drawLayer.removeGraphic(this._currentGraphic);var _15=new _9();var _16=new _b({attribute:null,geometry:_15});var _17=new _a({feature:_16,symbol:this._symbol});if(this._preClick){this._vertexArr.push(new _f(geo.x,geo.y));this._preClick=false;}else{this._vertexArr.splice(this._vertexArr.length-1,1,new _f(geo.x,geo.y));}_15.setPath([this._vertexArr]);this._currentGraphic=_17;this.drawLayer.addGraphic(_17);this.drawLayer.layerView.view.threeRender();},_onDoubleMouseClick:function(_18){_18.preventDefault();_18.stopPropagation();this._currentGraphic.rg=this._lineGraphicList;var _19=this._currentGraphic.id;this.showDeleButton(_18,_19);this.invalid();},showDeleButton:function(_1a,_1b){var _1c=this;var _1d=_7.create("div",{className:"graphicClose",style:{width:"8px",height:"8px",position:"absolute",color:"red",border:"2px solid red",display:"block",cursor:"pointer",fontSize:"4px",margin:"0 auto",lineHeight:"8px",backgroundColor:"white"},innerHTML:"×"},document.body);on(_1d,"click",function(e){var _1e=_1c.drawLayer.graphics;var g;for(var i=0,ii=_1e.length;i<ii;i++){g=_1e[i];if(g.id===_1b){break;}}if(g){_1c.drawLayer.removeGraphic(g);var rg=g.rg;rg.forEach(function(_1f){_1c.drawLayer.removeGraphic(_1f);});_7.destroy(this);}});_1d.style.left=_1a.clientX+5+"px";_1d.style.top=_1a.clientY+5+"px";return _1d;},toLocal:function(){var _20=this;var _21=_20.drawLayer.graphics;var _22=[];for(var i=0;i<_21.length;i++){if("rg" in _21[i]){for(var j=_21[i].rg.length-1;j>-1;j--){if(j==_21[i].rg.length-2){_22.push(_21[i].rg[j]);break;}}}}for(var k=_22.length-1;k>-1;k--){var _23=_22[k];var x=_23.feature.geometry.x;var y=_23.feature.geometry.y;var _24=_20.view.geometryToScreen(x,y);_3(".graphicClose")[k].style.left=_24.x+3+"px";_3(".graphicClose")[k].style.top=_24.y+3+"px";}},invalid:function(){if(!this.state){return;}this._endDrawMethod();this.state=false;this.view.panEnabled=true;this.view.selectEnabled=true;if(this._mouseClick!==null){this._mouseClick.remove();this._mouseClick=null;}if(this._dblMouseClick!==null){this._dblMouseClick.remove();this._dblMouseClick=null;}_5.remove(this.view.domNode,"draw-cursor-style");},doAction:function(_25){this._drawVertex(_25);},_drawVertex:function(geo){var _26=new _f(geo.x,geo.y);var _27=new _b({attribute:null,geometry:_26});var _28=new _a({feature:_27,symbol:this._vertexSymbol});this.drawLayer.addGraphic(_28);this._lineGraphicList.push(_28);var len=this._vertexArr.length;this._preClick=true;if(this._isNew){this._vertexArr.push(new _f(_26.x,_26.y));this._addDistanceTip(_26,"起点");this._isNew=false;}else{this._vertexArr.splice(this._vertexArr.length-1,1,new _f(geo.x,geo.y));this.cacheLength+=this._calLineLength(this._vertexArr[len-2],this._vertexArr[len-1]);this._addDistanceTip(_26,this._distanceToTip(this.cacheLength));}this.drawLayer.layerView.view.threeRender();},_addDistanceTip:function(geo,tip){var _29=new _e({text:tip,color:"#009688",size:12,offset:[-24,12]});var _2a=new _b({attribute:null,geometry:new _f(geo.x,geo.y)});var _2b=new _a({feature:_2a,symbol:_29});this.drawLayer.addGraphic(_2b);this._lineGraphicList.push(_2b);},_calLineLength:function(p1,p2){return Math.sqrt((p2.x-p1.x)*(p2.x-p1.x)+(p2.y-p1.y)*(p2.y-p1.y));},_distanceToTip:function(_2c){return _2c<1000?_2c.toFixed(2)+"米":(_2c/1000).toFixed(2)+"千米";},_endDrawMethod:function(){this._lineGraphicHash[this._currentGraphic.id]=this._lineGraphicList;this.cacheLength=0;if(this._mouseClickMove!==null){this._mouseClickMove.remove();this._mouseClickMove=null;}this._vertexArr=[];this._currentGraphic=null;this._lastPoint=null;this._lineGraphicList=null;this._isNew=true;}});});