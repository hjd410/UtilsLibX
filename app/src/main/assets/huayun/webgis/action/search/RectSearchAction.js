//>>built
define("com/huayun/webgis/action/search/RectSearchAction",["dojo/_base/declare","dojo/on","dojo/topic","dojo/dom-class","dojo/dom-construct","../../geometry/Polygon","../../Graphic","../../Feature","../../geometry/Point2D","../../symbols/PolygonSymbol","../../symbols/PointSymbol","../ActiveMapAction"],function(_1,on,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b){return _1("com.huayun.webgis.action.search.RectSearchAction",[_b],{constructor:function(_c){_1.safeMixin(this,_c);this.view=_c.view;this.view.selectEnabled=false;this.state=false;this.power=this.view.map.findLayerById("power");this.drawLayer=this.view.map.findLayerById("drawLayer");this._mouseDown=null;this._mouseMove=null;this._mouseUp=null;this._vertexArr=[];this._symbol=new _9({color:"#8F8FFF",opacity:0.5});this._vertexSymbol=new _a({radius:5,color:"#0000FF"});this._currentGraphic=null;this.startPoint={};this.endPoint={};this._lineGraphicList=[];this._lineGraphicHash={};var _d=this;_2.subscribe("measurement-delete",function(id){var _e=_d._lineGraphicHash[id];if(_e&&_e.length>0){_e.forEach(function(_f){_d.drawLayer.removeGraphic(_f);});}});},active:function(){if(!this.state){this.state=true;this.view.selectEnabled=false;this.view.panEnabled=false;this._mouseDown=on(this.view.container,"mousedown",this._onMouseDown.bind(this));this._mouseUp=on(this.view.container,"mouseup",this._onMouseUp.bind(this));_3.add(this.view.domNode,"draw-cursor-style");}},_onMouseDown:function(_10){_10.preventDefault();_10.stopPropagation();var geo=this.view.screenToGeometry(_10.x,_10.y);this.startPoint.x=geo.x;this.startPoint.y=geo.y;this._lineGraphicList=[];this._drawDotMark(geo);if(!this._mouseMove){this._mouseMove=on(this.view.domNode,"mousemove",this._onMouseMove.bind(this));}},_onMouseMove:function(e){event.preventDefault();event.stopPropagation();if(this.startPoint){this.endPoint=this.view.screenToGeometry(e.x,e.y);this.drawLayer.removeGraphic(this._currentGraphic);this._vertexArr=[];var _11=new _5();var _12=new _7({attribute:null,geometry:_11});var _13=new _6({feature:_12,symbol:this._symbol});this.getOtherPoints();_11.setPath([this._vertexArr]);this._currentGraphic=_13;this.drawLayer.addGraphic(_13);this.drawLayer.layerView.view.threeRender();}},_onMouseUp:function(_14){_14.preventDefault();_14.stopPropagation();this._drawDotMark(this.endPoint);this._currentGraphic.rg=this._lineGraphicList;var _15=this._currentGraphic.id;this.showDeleBtn(_14,_15);var _16=this._currentGraphic.feature.geometry;var _17=this.power.queryFeaturesByGeometry(_16,10);if(_17&&_17.length>0){_2.publish("showRectInfo",_17);}else{_2.publish("closeRectInfo");}this.invalid();},getOtherPoints:function(){var _18={},_19={};_18.x=this.endPoint.x;_18.y=this.startPoint.y;_19.x=this.startPoint.x;_19.y=this.endPoint.y;this._vertexArr.push(new _8(this.startPoint.x,this.startPoint.y));this._vertexArr.push(new _8(_18.x,_18.y));this._vertexArr.push(new _8(this.endPoint.x,this.endPoint.y));this._vertexArr.push(new _8(_19.x,_19.y));this._vertexArr.push(new _8(this.startPoint.x,this.startPoint.y));},showDeleBtn:function(_1a,_1b){var _1c=this;var _1d=_4.create("div",{className:"graphicRectClose",style:{width:"8px",height:"8px",position:"absolute",color:"red",border:"2px solid red",display:"block",cursor:"pointer",textAlign:"center",fontSize:"4px",margin:"0 auto",lineHeight:"5px",backgroundColor:"white"},innerHTML:"x"},document.body);on(_1d,"click",function(e){var _1e=_1c.drawLayer.graphics;var g;for(var i=0,ii=_1e.length;i<ii;i++){g=_1e[i];if(g.id===_1b){break;}}if(g){_1c.drawLayer.removeGraphic(g);var rg=g.rg;rg.forEach(function(_1f){_1c.drawLayer.removeGraphic(_1f);});_4.destroy(this);_2.publish("closeRectInfo");}});_1d.style.left=_1a.clientX+5+"px";_1d.style.top=_1a.clientY+5+"px";return _1d;},invalid:function(){if(!this.state){return;}this._endDrawMethod();this.state=false;this.view.panEnabled=true;this.view.selectEnabled=true;if(this._mouseDown!==null){this._mouseDown.remove();this._mouseDown=null;}if(this._mouseUp!==null){this._mouseUp.remove();this._mouseUp=null;}_3.remove(this.view.domNode,"draw-cursor-style");},_drawDotMark:function(geo){var _20=new _8(geo.x,geo.y);var _21=new _7({attribute:null,geometry:_20});var _22=new _6({feature:_21,symbol:this._vertexSymbol});this.drawLayer.addGraphic(_22);this._lineGraphicList.push(_22);this.drawLayer.layerView.view.threeRender();},_endDrawMethod:function(){this._lineGraphicHash[this._currentGraphic.id]=this.lineGraphicList;if(this._mouseMove!==null){this._mouseMove.remove();this._mouseMove=null;}this._currentGraphic=null;this._lineGraphicList=null;}});});