//>>built
define("com/huayun/webgis/action/search/PolygonSearchAction",["dojo/_base/declare","dojo/on","dojo/topic","dojo/dom-class","dojo/dom-construct","../../geometry/Polygon","../../Graphic","../../Feature","../../geometry/Point2D","../../symbols/PolygonSymbol","../../symbols/PointSymbol","../ActiveMapAction"],function(_1,on,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b){return _1("com.huayun.webgis.action.search.PlygonSearchAction",[_b],{constructor:function(_c){_1.safeMixin(this,_c);this.view=_c.view;this.view.selectEnabled=false;this.state=false;this.power=this.view.map.findLayerById("power");this.drawLayer=this.view.map.findLayerById("drawLayer");this._mouseClick=null;this._dblMouseClick=null;this._mouseClickMove=null;this._lastPoint=null;this._vertexArr=[];this._polygonList=[];this._symbol=new _9({color:"#8F8FFF",opacity:0.5});this._vertexSymbol=new _a({radius:5,color:"#0000FF"});this._currentGraphic=null;this._lineGraphicList=[];this._lineGraphicHash={};var _d=this;_2.subscribe("measurement-delete",function(id){var _e=_d._lineGraphicHash[id];if(_e&&_e.length>0){_e.forEach(function(_f){_d.drawLayer.removeGraphic(_f);});}});},active:function(){if(!this.state){this.state=true;this.view.selectEnabled=false;this.view.panEnabled=false;this._mouseClick=on(this.view.container,"click",this._onMouseClick.bind(this));this._dblMouseClick=on(this.view.container,"dblclick",this._onDoubleMouseClick.bind(this));_3.add(this.view.domNode,"draw-cursor-style");}},_onMouseClick:function(_10){_10.preventDefault();_10.stopPropagation();var geo=this.view.screenToGeometry(_10.x,_10.y);if(!this._mouseMove){this._mouseMove=on(this.view.domNode,"mousemove",this._onMouseMove.bind(this));}if(this._lastPoint===null){this._lineGraphicList=[];this.doAction(geo);}else{if(_10.x!==this._lastPoint.x&&_10.y!==this._lastPoint.y){this.doAction(geo);}}this._lastPoint={x:_10.x,y:_10.y};},_onMouseMove:function(e){var geo=this.view.screenToGeometry(e.x,e.y);this.drawLayer.removeGraphic(this._currentGraphic);var _11=new _5();var _12=new _7({attribute:null,geometry:_11});var _13=new _6({feature:_12,symbol:this._symbol});if(this._preClick){this._vertexArr.push(new _8(geo.x,geo.y));this._preClick=false;}else{this._vertexArr.splice(this._vertexArr.length-1,1,new _8(geo.x,geo.y));}_11.setPath([this._vertexArr]);this._currentGraphic=_13;this.drawLayer.addGraphic(_13);this.drawLayer.layerView.view.threeRender();},_onDoubleMouseClick:function(_14){_14.preventDefault();_14.stopPropagation();this._currentGraphic.rg=this._lineGraphicList;var _15=this._currentGraphic.id;this.showDeleButton(_14,_15);var _16=this._currentGraphic.feature.geometry;var _17=this.power.queryFeaturesByGeometry(_16,10);this.invalid();if(_17&&_17.length>0){_2.publish("showPolyInfo",_17);}else{_2.publish("closeInfo");}},showDeleButton:function(_18,_19){var _1a=this;var _1b=_4.create("div",{className:"graphicPolyClose",style:{width:"8px",height:"8px",position:"absolute",color:"red",border:"2px solid red",display:"block",cursor:"pointer",textAlign:"center",fontSize:"4px",margin:"0 auto",lineHeight:"5px",backgroundColor:"white"},innerHTML:"x"},document.body);on(_1b,"click",function(e){var _1c=_1a.drawLayer.graphics;var g;for(var i=0,ii=_1c.length;i<ii;i++){g=_1c[i];if(g.id===_19){break;}}if(g){_1a.drawLayer.removeGraphic(g);var rg=g.rg;rg.forEach(function(_1d){_1a.drawLayer.removeGraphic(_1d);});_4.destroy(this);_2.publish("closeInfo");}});_1b.style.left=_18.clientX+5+"px";_1b.style.top=_18.clientY+5+"px";return _1b;},invalid:function(){if(!this.state){return;}this._endDrawMethod();this.state=false;this.view.panEnabled=true;this.view.selectEnabled=true;if(this._mouseClick!==null){this._mouseClick.remove();this._mouseClick=null;}if(this._dblMouseClick!==null){this._dblMouseClick.remove();this._dblMouseClick=null;}_3.remove(this.view.domNode,"draw-cursor-style");},doAction:function(_1e){this._drawDotMark(_1e);},_drawDotMark:function(geo){var _1f=new _8(geo.x,geo.y);var _20=new _7({attribute:null,geometry:_1f});var _21=new _6({feature:_20,symbol:this._vertexSymbol});this.drawLayer.addGraphic(_21);this._lineGraphicList.push(_21);var len=this._vertexArr.length;this._preClick=true;if(len<3){this._vertexArr.push(new _8(_1f.x,_1f.y));}else{this._vertexArr.splice(this._vertexArr.length-1,1,new _8(geo.x,geo.y));}this.drawLayer.layerView.view.threeRender();},_endDrawMethod:function(){this._lineGraphicHash[this._currentGraphic.id]=this._lineGraphicList;if(this._mouseClickMove!==null){this._mouseClickMove.remove();this._mouseClickMove=null;}this._vertexArr=[];this._currentGraphic=null;this._lastPoint=null;this._lineGraphicList=null;}});});