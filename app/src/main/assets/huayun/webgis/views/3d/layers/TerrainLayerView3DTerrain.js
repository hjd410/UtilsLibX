//>>built
define("com/huayun/webgis/views/3d/layers/TerrainLayerView3DTerrain",["./LayerView3D","../../../gl/draw/drawTerrain","../../../gl/draw/drawHeightMap","../../../gl/mode","../../../data/ArrayType","../../../gl/members","../../../gl/SegmentVector"],function(_1,_2,_3,_4,_5,_6,_7){var _8=function(_9){_1.call(this,_9);this.view=_9.view;this.visible=_9.visible;this.layer=_9.layer;var _a=new _5.StructArrayLayout3ui6();_a.emplaceBack(0,1,2);_a.emplaceBack(2,1,3);this.quadTriangleIndexBuffer=this.view.context.createIndexBuffer(_a);var _b=8192;var _c=new _5.StructArrayLayout4i8();_c.emplaceBack(0,0,0,0);_c.emplaceBack(_b,0,_b,0);_c.emplaceBack(0,_b,0,_b);_c.emplaceBack(_b,_b,_b,_b);this.rasterBoundsBuffer=this.view.context.createVertexBuffer(_c,_6.rasterBoundsAttributes.members);this.rasterBoundsSegments=_7.simpleSegment(0,0,4,2);};if(_1){_8.__proto__=_1;}_8.prototype=Object.create(_1&&_1.prototype);_8.prototype.constructor=_8;_8.prototype.refresh=function(){this._readyData();this.view.threeRender();};_8.prototype._readyData=function(){this._promises={};if(this.visible){var _d=this.layer.tileInfo,_e=this.view.viewpoint.targetZoom||this.view.viewpoint.level,_f=this.view.viewpoint.center,_10=_d.getResolution(_e);var _11=this.view._bound.map(function(_12){return {x:_d.getColForX(_12.x,_10),y:_d.getRowForY(_12.y,_10)};});var _13=_d.getColRange(_10);var cx=_d.getColForX(_f[0],_10),cy=_d.getRowForY(_f[1],_10);this.layer.sourceCache.updateTile(_e,_11,_13,cx,cy);this._sourcesDirty=true;this.zoomedBounds=_11;this.range=_13;this.cx=cx;this.cy=cy;}};_8.prototype._render=function(){if(this.visible&&this.zoomedBounds){this.view.currentLayer++;var _14=this.view.viewpoint.level;var _15=this.layer.sourceCache;if(this._sourcesDirty){this.layer.sourceCache.update(_14,this.zoomedBounds,this.range,this.cx,this.cy);this._sourcesDirty=false;this._fadeDirty=false;}var _16=_15.getVisibleCoordinates(false,this.transform).slice().reverse();this.renderPass="translucent";debugger;this.renderLayer(this,_15,null,_16);}};_8.prototype.renderLayer=function(_17,_18,_19,_1a,_1b){if(!_1a.length){return;}_2(_17,_18,_19,_1a);};_8.prototype.zoom=function(){if(this.visible){this.view.currentLayer++;var _1c=this.layer.sourceCache;var _1d=_1c.updateTileMatrix(false,this.view.viewpoint).slice().reverse();this.renderPass="translucent";this.renderLayer(this,_1c,null,_1d);}};_8.prototype.depthModeForSublayer=function(n,_1e,_1f){var _20=1-((1+this.view.currentLayer)*this.view.numSublayers+n)*this.view.depthEpsilon;return new _4.DepthMode(_1f||this.view.context.gl.LEQUAL,_1e,[_20,_20]);};_8.prototype.drawHeightMap=function(_21,_22){if(!_22.heightTexture){_3(_21,null,null,_22);}};return _8;});