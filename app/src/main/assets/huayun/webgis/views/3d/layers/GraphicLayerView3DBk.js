//>>built
define("com/huayun/webgis/views/3d/layers/GraphicLayerView3DBk",["dojo/_base/declare","../GraphicsView","./LayerView3D","com/huayun/webgis/gl/mode","com/huayun/webgis/data/ArrayType","com/huayun/webgis/gl/SegmentVector","com/huayun/webgis/gl/glUtils"],function(_1,_2,_3,_4,_5,_6,_7){return _1("com.huayun.webgis.views.3d.layers.GraphicLayerView3DBk",[_3],{constructor:function(_8){_1.safeMixin(this,_8);this.visible=_8.visible;this.renderer=_8.renderer;this.glow=_8.glow;var _9=new _5.StructArrayLayout4i8();_9.emplaceBack(-1,-1,0,0);_9.emplaceBack(1,-1,1,0);_9.emplaceBack(-1,1,0,1);_9.emplaceBack(1,1,1,1);this.viewportBuffer=this.view.context.createVertexBuffer(_9,[{name:"aPos",type:"Int16",components:4,offset:0}]);this.viewportSegments=_6.simpleSegment(0,0,4,2);var _a=new _5.StructArrayLayout3ui6();_a.emplaceBack(0,1,2);_a.emplaceBack(2,1,3);this.quadTriangleIndexBuffer=this.view.context.createIndexBuffer(_a);},_readyData:function(){},_render:function(){if(this.visible){this.view.currentLayer++;var _b=this.layer.graphics;var _c,_d;for(var i=0;i<_b.length;i++){_c=_b[i];if(_c.visible){_d=_c.symbol;this.renderer.draw(this,_c);}}}},bindFramebuffer:function(_e,_f,_10,_11){var fbo=this[_f];if(!fbo||Math.abs((fbo.width-_10))>1||Math.abs(fbo.height-_11)>1){fbo=this[_f]=_7.generateFBO(_e,_10,_11);}_e.bindFramebuffer.set(fbo.framebuffer);},renderBlur:function(_12,_13,_14){var gl=_12.gl;var _15=this.layer.glowRatio;_13=Math.ceil(_13/_15);_14=Math.ceil(_14/_15);this.bindFramebuffer(_12,"blurFBO",_13,_14);_12.activeTexture.set(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,this.renderFBO.colorAttachment.get());gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);_12.viewport.set([0,0,_13,_14]);this.view.useProgramSimplify("gaussianBlur",{"layoutAttributes":{name:"aPos",type:"Int16",components:4,offset:0}}).draw(_12,gl.TRIANGLES,_4.DepthMode.disabled,_4.StencilMode.disabled,_4.ColorMode.alphaBlended,_4.CullFaceMode.disabled,{"uSize":[_13,_14],"uTexture":0,"uHorizontal":0,"u_kernel":[0.5,0.15,0.1,0.05,0.01]},this.id,this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments);this.bindFramebuffer(_12,"blurFBO2",_13,_14);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);gl.bindTexture(gl.TEXTURE_2D,this.blurFBO.colorAttachment.get());this.view.useProgramSimplify("gaussianBlur",{"layoutAttributes":{name:"aPos",type:"Int16",components:4,offset:0}}).draw(_12,gl.TRIANGLES,_4.DepthMode.disabled,_4.StencilMode.disabled,_4.ColorMode.alphaBlended,_4.CullFaceMode.disabled,{"uSize":[_13,_14],"uTexture":0,"uHorizontal":1,"u_kernel":[0.5,0.15,0.1,0.05,0.01]},this.id,this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments);},renderTextureToMap:function(_16){var gl=_16.gl;var fbo=this.blurFBO2;if(!fbo){return;}_16.activeTexture.set(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,fbo.colorAttachment.get());this.view.useProgramSimplify("screen",{"layoutAttributes":{name:"aPos",type:"Int16",components:4,offset:0}}).draw(_16,gl.TRIANGLES,_4.DepthMode.disabled,_4.StencilMode.disabled,_4.ColorMode.alphaBlended,_4.CullFaceMode.disabled,{uTexture:0},this.id,this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments);},refresh:function(){this.view.threeRender();},addGraphic:function(_17){this.renderer.add(this,_17);},zoom:function(){if(this.visible){this._render();}},depthModeForSublayer:function(n,_18,_19){var _1a=1-((1+this.view.currentLayer)*this.view.numSublayers+n)*this.view.depthEpsilon;return new _4.DepthMode(_19||this.view.context.gl.LEQUAL,_18,[_1a,_1a]);},setVisible:function(_1b){this.visible=_1b;this.view.threeRender();}});});