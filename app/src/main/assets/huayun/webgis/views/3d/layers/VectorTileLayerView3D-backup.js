//>>built
define("com/huayun/webgis/views/3d/layers/VectorTileLayerView3D-backup",["dojo/_base/declare","./LayerView3D","com/huayun/webgis/data/ArrayType","com/huayun/webgis/gl/draw","com/huayun/webgis/gl/mode","com/huayun/webgis/layers/support/funcUtils","com/huayun/webgis/layers/support/CrossTileSymbolIndex","com/huayun/webgis/layers/support/PauseablePlacement","com/huayun/webgis/layers/support/EvaluationParameters","com/huayun/webgis/gl/members","com/huayun/webgis/gl/SegmentVector","com/huayun/webgis/utils/Constant","com/huayun/webgis/utils/utils"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d){return _1("com.huayun.webgis.views.3d.layers.VectorTileLayerView3D",[_2],{view:null,constructor:function(_e){_1.safeMixin(this,_e);this.visible=_e.visible;this.draw$1={fill:_4.drawFill,line:_4.drawLine,symbol:_4.drawSymbols,background:_4.drawBackground,"fill-extrusion":_4.drawExtrusion,clipping:_4.drawClipping,heatmap:_4.drawHeatmap};this.crossTileSymbolIndex=new _7();this.nextStencilID=1;var gl=this.view._gl;this.stencilClearMode=new _5.StencilMode({func:gl.ALWAYS,mask:0},0,255,gl.ZERO,gl.ZERO,gl.ZERO);var _f=new _3.StructArrayLayout2i4();_f.emplaceBack(0,0);_f.emplaceBack(1,0);_f.emplaceBack(0,1);_f.emplaceBack(1,1);this.viewportBuffer=this.view.context.createVertexBuffer(_f,_a.posAttributes.members);this.viewportSegments=_b.simpleSegment(0,0,4,2);var _10=new _3.StructArrayLayout3ui6();_10.emplaceBack(0,1,2);_10.emplaceBack(2,1,3);this.quadTriangleIndexBuffer=this.view.context.createIndexBuffer(_10);var _11=new _3.StructArrayLayout2i4();_11.emplaceBack(0,0);_11.emplaceBack(_c.layout.EXTENT,0);_11.emplaceBack(0,_c.layout.EXTENT);_11.emplaceBack(_c.layout.EXTENT,_c.layout.EXTENT);this.tileExtentBuffer=this.view.context.createVertexBuffer(_11,_a.posAttributes.members);this.tileExtentSegments=_b.simpleSegment(0,0,4,2);},refresh:function(){this._readyData();this.view.threeRender();},_readyData:function(){if(this.visible){var _12=this.layer.tileInfo,_13=this.view.viewpoint.targetZoom||this.view.viewpoint.level,_14=this.view.viewpoint.center,_15=_12.getResolution(_13);if(!_12){return;}var _16=this.view._bound.map(function(_17){return {x:_12.getColForX(_17.x,_15),y:_12.getRowForY(_17.y,_15)};});var _18=_12.getColRange(_15);var cx=_12.getColForX(_14[0],_15),cy=_12.getRowForY(_14[1],_15);var _19=this.layer._layers;var _1a=new _9(_13,{now:_6.now(),fadeDuration:500,zoomHistory:this.view.zoomHistory,transition:{delay:0,duration:500}});for(var i=0,_1b=this.layer._order;i<_1b.length;i++){var _1c=_19[_1b[i]];_1c.recalculate(_1a);}var _1d=this.layer.sourceCaches;for(var id in _1d){this.tileIDs=_1d[id].updateTile(_13,_16,_18,cx,cy);}this._sourcesDirty=true;this.zoomedBounds=_16;this.range=_18;this.cx=cx;this.cy=cy;}},_render:function(){this._renderVector();},_renderVector:function(){if(this.visible){var _1e=this.layer.sourceCaches;var _1f=this.view.viewpoint.targetZoom||this.view.viewpoint.level;if(this._sourcesDirty){for(var id in _1e){this.tileIDs=_1e[id].update(_1f,this.zoomedBounds,this.range,this.cx,this.cy);}}var _20=this.layer._order;var _21={};var _22={};var _23={};for(var _24 in _1e){var _25=_1e[_24];_21[_24]=_25.getVisibleCoordinates(false,this.transform);_22[_24]=_21[_24].slice().reverse();_23[_24]=_25.getVisibleCoordinates(true,this.transform).reverse();}this._placementDirty=this._updatePlacement(0);for(var id in _1e){var _26=_1e[id];_26.prepare(this.view.context);}var _1f=this.transform.level;this.renderPass="opaque";for(this.currentLayer=_20.length-1;this.currentLayer>=0;this.currentLayer--){var _27=this.layer._layers[_20[this.currentLayer]];if(_27.type!=="fill"&&_27.type!="background"){continue;}var _28=_1e[_27.source];var _29=_21[_27.source];this.renderLayer(this,_28,_27,_29,_1f);}this.renderPass="translucent";for(this.currentLayer=0;this.currentLayer<_20.length;this.currentLayer++){var _2a=this.layer._layers[_20[this.currentLayer]];if(_2a.type==="fill"||_2a.type==="background"){continue;}var _2b=_1e[_2a.source];var _2c=(_2a.type==="symbol"?_23:_22)[_2a.source];this.renderLayer(this,_2b,_2a,_2c,_1f);}}},zoom:function(){if(this.visible){this.transform=this.view.viewpoint;var _2d=this.layer._order;var _2e={};var _2f={};var _30={};var _31=this.layer.sourceCaches;for(var _32 in _31){var _33=_31[_32];_2e[_32]=_33.updateTileMatrix(false,this.transform);_2f[_32]=_2e[_32].slice().reverse();_30[_32]=_33.updateTileMatrix(true,this.transform).reverse();}for(var id in _31){var _34=_31[id];this.tileIDs=_34.currentCoords;}this.depthRangeFor3D=[0,1-((_2d.length+2)*0.000213623046875)];this.renderPass="opaque";var _35=this.view.viewpoint.zoom;for(this.currentLayer=_2d.length-1;this.currentLayer>=0;this.currentLayer--){var _36=this.layer._layers[_2d[this.currentLayer]];if(_36.type!=="fill"&&_36.type!="background"){continue;}var _37=_31[_36.source];var _38=_2e[_36.source];this.renderLayer(this,_37,_36,_38,_35);}this.renderPass="translucent";for(this.currentLayer=0;this.currentLayer<_2d.length;this.currentLayer++){var _39=this.layer._layers[_2d[this.currentLayer]];if(_39.type==="fill"||_39.type==="background"){continue;}var _3a=_31[_39.source];var _3b=(_39.type==="symbol"?_30:_2f)[_39.source];this.renderLayer(this,_3a,_39,_3b,_35);}this.view.context.setDefault();}},renderLayer:function(_3c,_3d,_3e,_3f,_40){if(_3e.isHidden(_40)){return;}if(!_3f.length){return;}this.id=_3e.id;this.draw$1[_3e.type](_3c,_3d,_3e,_3f);},_updatePlacement:function(_41){var _42=false;var _43=false;var _44={};for(var i=0,_45=this.layer._order;i<_45.length;i+=1){var _46=_45[i];var _47=this.layer._layers[_46];if(_47.type!=="symbol"){continue;}var _48=_47.source;if(!_44[_48]){var _49=this.layer.sourceCaches[_48];_44[_48]=_49.getRenderableIds(true).map(function(id){return _49.getTileByID(id);}).sort(function(a,b){return (b.tileID.overscaledZ-a.tileID.overscaledZ)||(a.tileID.isLessThan(b.tileID)?-1:1);});}var _4a=this.crossTileSymbolIndex.addLayer(_47,_44[_48]);_42=_42||_4a;}this.crossTileSymbolIndex.pruneUnusedLayers(this.layer._order);var _4b=this._layerOrderChanged||_41===0;if(_4b){this.pauseablePlacement=new _8(this.transform,this.layer._order,_4b,false,_41,true,this.placement);this._layerOrderChanged=false;}if(this.pauseablePlacement.isDone()){this.placement.setStale();}else{this.pauseablePlacement.continuePlacement(this.layer._order,this.layer._layers,_44);if(this.pauseablePlacement.isDone()){this.placement=this.pauseablePlacement.commit(_6.now());_43=true;}if(_42){this.pauseablePlacement.placement.setStale();}}if(_43||_42){for(var i$1=0,_4c=this.layer._order;i$1<_4c.length;i$1+=1){var _4d=_4c[i$1];var _4e=this.layer._layers[_4d];if(_4e.type!=="symbol"){continue;}this.placement.updateLayerOpacities(_4e,_44[_4e.source]);}}var _4f=!this.pauseablePlacement.isDone()||this.placement.hasTransitions(_6.now());return _4f;},_zoomPlacement:function(_50,_51){var _52=false;var _53=false;var _54={};for(var i=0,_55=this.layer._order;i<_55.length;i+=1){var _56=_55[i];var _57=this.layer._layers[_56];if(_57.type!=="symbol"){continue;}var _58=_57.source;if(!_54[_58]){var _59=this.layer.sourceCaches[_58];_54[_58]=_59.zoomRenderableIds(true).map(function(id){return _59.getTileByID(id);}).filter(function(_5a){return _5a.tileID.overscaledZ===_51;}).sort(function(a,b){return (b.tileID.overscaledZ-a.tileID.overscaledZ)||(a.tileID.isLessThan(b.tileID)?-1:1);});}var _5b=this.crossTileSymbolIndex.addLayer(_57,_54[_58]);_52=_52||_5b;}this.crossTileSymbolIndex.pruneUnusedLayers(this.layer._order);var _5c=this._layerOrderChanged||_50===0;if(_5c){this.pauseablePlacement=new _8(this.transform,this.layer._order,_5c,false,_50,true,this.placement);this._layerOrderChanged=false;}if(this.pauseablePlacement.isDone()){this.placement.setStale();}else{this.pauseablePlacement.continuePlacement(this.layer._order,this.layer._layers,_54);if(this.pauseablePlacement.isDone()){this.placement=this.pauseablePlacement.commit(_6.now());_53=true;}if(_52){this.pauseablePlacement.placement.setStale();}}if(_53||_52){for(var i$1=0,_5d=this.layer._order;i$1<_5d.length;i$1+=1){var _5e=_5d[i$1];var _5f=this.layer._layers[_5e];if(_5f.type!=="symbol"){continue;}this.placement.updateLayerOpacities(_5f,_54[_5f.source]);}}var _60=!this.pauseablePlacement.isDone()||this.placement.hasTransitions(_6.now());return _60;},_renderTileClippingMasks:function(_61,_62){if(this.currentStencilSource===_61.source||!_61.isTileClipped()||!_62||!_62.length){return;}this.currentStencilSource=_61.source;var _63=this.view.context;var gl=_63.gl;if(this.nextStencilID+_62.length>256){this.clearStencil();}_63.setColorMode(_5.ColorMode.disabled);_63.setDepthMode(_5.DepthMode.disabled);var _64=this.view.useProgram("clippingMask");this._tileClippingMaskIDs={};for(var i=0,_65=_62;i<_65.length;i+=1){var _66=_65[i];var id=this._tileClippingMaskIDs[_66.key]=this.nextStencilID++;_64.draw(_63,gl.TRIANGLES,_5.DepthMode.disabled,new _5.StencilMode({func:gl.ALWAYS,mask:0},id,255,gl.KEEP,gl.KEEP,gl.REPLACE),_5.ColorMode.disabled,_5.CullFaceMode.disabled,{"u_matrix":_66.posMatrix},"$clipping",this.tileExtentBuffer,this.quadTriangleIndexBuffer,this.tileExtentSegments);}},depthModeForSublayer:function(n,_67,_68){var _69=0.9985984898265599/2+0.5;return new _5.DepthMode(_68||this.view.context.gl.LEQUAL,_67,[_69,_69]);},clearStencil:function(){var _6a=this.view.context;var gl=_6a.gl;this.nextStencilID=1;this.currentStencilSource=undefined;var _6b=glMatrix.mat4.create();glMatrix.mat4.ortho(_6b,0,this.transform.width,this.transform.height,0,0,1);glMatrix.mat4.scale(_6b,_6b,[gl.drawingBufferWidth,gl.drawingBufferHeight,0]);this.view.useProgram("clippingMask").draw(_6a,gl.TRIANGLES,_5.DepthMode.disabled,this.stencilClearMode,_5.ColorMode.disabled,_5.CullFaceMode.disabled,{"u_matrix":_6b},"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments);},stencilModeForClipping:function(_6c){var gl=this.view.context.gl;return new _5.StencilMode({func:gl.EQUAL,mask:255},this._tileClippingMaskIDs[_6c.key],0,gl.KEEP,gl.KEEP,gl.REPLACE);},stencilModeFor3D:function(){if(this.nextStencilID+1>256){this.clearStencil();}var id=1;var gl=this.view.context.gl;return new _5.StencilMode({func:gl.NOTEQUAL,mask:255},id,255,gl.KEEP,gl.KEEP,gl.REPLACE);},zoomEnd:function(_6d){return;this.transform=this.view.viewpoint;this._placementDirty=this._updatePlacement(0);var _6e=this.layer._order;var _6f={};var _70={};var _71={};var _72=this.layer.sourceCaches;this.scale=_6d;for(var _73 in _72){var _74=_72[_73];_6f[_73]=_74.updateTileMatrix(false,this.transform,_6d);_70[_73]=_6f[_73].slice().reverse();_71[_73]=_74.updateTileMatrix(true,this.transform,_6d).reverse();}for(var id in _72){var _75=_72[id];_75.prepare(this.view.context);this.tileIDs=_75.currentCoords;}this.renderPass="opaque";for(this.currentLayer=_6e.length-1;this.currentLayer>=0;this.currentLayer--){var _76=this.layer._layers[_6e[this.currentLayer]];if(_76.type!=="fill"&&_76.type!="background"){continue;}var _77=_72[_76.source];var _78=_6f[_76.source];this.renderLayer(this,_77,_76,_78,this.view.level);}this.renderPass="translucent";for(this.currentLayer=0;this.currentLayer<_6e.length;this.currentLayer++){var _79=this.layer._layers[_6e[this.currentLayer]];if(_79.type==="fill"||_79.type==="background"){continue;}var _7a=_72[_79.source];var _7b=(_79.type==="symbol"?_71:_70)[_79.source];this.renderLayer(this,_7a,_79,_7b,this.view.level);}this._sourcesDirty=true;this.view.context.setDefault();},queryRenderedFeatures:function(_7c){var _7d={};var _7e=[];if(this.placement){_7e.push(this.queryRenderedSymbols(this.layer._layers,this.layer.sourceCaches,_7c,{},this.placement.collisionIndex,this.placement.retainedQueryData));}return _7e;},queryRenderedSymbols:function(_7f,_80,_81,_82,_83,_84){var _85={};var _86=_83.queryRenderedSymbols(_81);var _87=[];for(var i=0,_88=Object.keys(_86).map(Number);i<_88.length;i+=1){var _89=_88[i];_87.push(_84[_89]);}_87.sort(_d.sortTilesIn);var _8a=function(){var _8b=_8c[i$2];var _8d=_8b.featureIndex.lookupSymbolFeatures(_86[_8b.bucketInstanceId],_8b.bucketIndex,_8b.sourceLayerIndex,_82.filter,_82.layers,_7f);for(var _8e in _8d){var _8f=_85[_8e]=_85[_8e]||[];var _90=_8d[_8e];_90.sort(function(a,b){var _91=_8b.featureSortOrder;if(_91){var _92=_91.indexOf(a.featureIndex);var _93=_91.indexOf(b.featureIndex);return _93-_92;}else{return b.featureIndex-a.featureIndex;}});for(var i$1=0,_94=_90;i$1<_94.length;i$1+=1){var _95=_94[i$1];_8f.push(_95);}}};for(var i$2=0,_8c=_87;i$2<_8c.length;i$2+=1){_8a();}var _96=function(_97){_85[_97].forEach(function(_98){var _99=_98.feature;var _9a=_7f[_97];var _9b=_80[_9a.source];var _9c=_9b.getFeatureState(_99.layer["source-layer"],_99.id);_99.source=_99.layer.source;if(_99.layer["source-layer"]){_99.sourceLayer=_99.layer["source-layer"];}_99.state=_9c;});};for(var _9d in _85){_96(_9d);}return _85;},mergeRenderedFeatureLayers:function(_9e){var _9f={};var _a0={};for(var i$1=0,_a1=_9e;i$1<_a1.length;i$1+=1){var _a2=_a1[i$1];var _a3=_a2.queryResults;var _a4=_a2.wrappedTileID;var _a5=_a0[_a4]=_a0[_a4]||{};for(var _a6 in _a3){var _a7=_a3[_a6];var _a8=_a5[_a6]=_a5[_a6]||{};var _a9=_9f[_a6]=_9f[_a6]||[];for(var i=0,_aa=_a7;i<_aa.length;i+=1){var _ab=_aa[i];if(!_a8[_ab.featureIndex]){_a8[_ab.featureIndex]=true;_a9.push(_ab);}}}}return _9f;},queryFeatures:function(_ac,_ad,_ae,_af,_b0){var _b1=this.view.viewpoint.targetZoom||this.view.viewpoint.zoom;var _b2=_b0.maxPitchScaleFactor();var _b3=_ac.tilesIn(_ae,_b2,false,this.view.resolution,_b1);var _b4=[];for(var i=0,_b5=_b3;i<_b5.length;i+=1){var _b6=_b5[i];_b4.push({wrappedTileID:_b6.tileID.wrapped().key,queryResults:_b6.tile.queryRenderedFeatures(_ad,_ac._state,_b6.queryGeometry,_b6.cameraQueryGeometry,_b6.scale,_af,_b0,_b2,_d.getPixelPosMatrix(_ac.transform,_b6.tileID))});}var _b7=this.mergeRenderedFeatureLayers(_b4);for(var _b8 in _b7){_b7[_b8].forEach(function(_b9){var _ba=_b9.feature;var _bb=_ac.getFeatureState(_ba.layer["source-layer"],_ba.id);_ba.source=_ba.layer.source;if(_ba.layer["source-layer"]){_ba.sourceLayer=_ba.layer["source-layer"];}_ba.state=_bb;});}return _b7;},intersectPoi:function(_bc){return this.intersectRenderedSymbols(this.layer._layers,this.layer.sourceCaches,_bc,{},this.placement.collisionIndex,this.placement.retainedQueryData);},intersectRenderedSymbols:function(_bd,_be,_bf,_c0,_c1,_c2){var _c3=_c1.queryRenderedSymbols(_bf);return Object.keys(_c3).length>0;}});});