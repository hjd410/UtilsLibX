//>>built
define("com/huayun/webgis/views/3d/layers/ModelPowerLayerView",["./LayerView3D","../../../utils/extendClazz","../../../ModelGraphic","../../../geometry/Point","../../../gl/mode","../../../geometry/Extent","../../../geometry/Polyline","../../../symbols/LineSymbol","../../../symbols/TextSymbol","../../../Feature","../../../Graphic",],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b){function _c(_d){_1.call(this,_d);this.visible=_d.visible;this.id=_d.id;this.layer=_d.layer;this.view=_d.view;this.modelGraphics=[];this.extent=new _6(0,0,0,0);this.lineGraphics={};this.textGraphics={};this.handledSubstation={};this.lineSymbol=new _8({width:3,color:window.lineColor||"#F00"});this.current={};};_2(_c,_1);_c.prototype.refresh=function(){this._readyData();this.view.threeRender();};_c.prototype._readyData=function(){};_c.prototype.addModel=function(_e){_e.add(this.view);};_c.prototype._render=function(){var _f=this.layer.minLevel,_10=this.layer.maxLevel,_11=this.layer.fallbackLevel;var _12=this.visible;var _13=false;var _14=this.view.viewpoint.targetZoom||this.view.viewpoint.level;if(_f&&_14<_f){_12=false;}if(_10&&_14>=_10){_12=false;}if(_11&&_14<_11){_13=true;}if(_12&&this.layer.kdbush){var _15=this;this.depthRangeFor3D=[0,1-((1+this.view.currentLayer)*this.view.numSublayers)*this.view.depthEpsilon];var _16=this.view.getExtent();if(_16&&!this.extent.equals(_16)){this.extent=_16;this.current={};this.modelGraphics=[];this.substationGraphics=[];var _17=this.layer.kdbush.range(_16.xmin,_16.ymin,_16.xmax,_16.ymax).sort(function(a,b){return a-b;});for(var i=0;i<_17.length;i++){var _18=_15.layer.points[_17[i]];if(_18.type==="tower"){_15.current[_18.id]=true;this.modelGraphics.push(_18);}else{this.substationGraphics.push(_18);}}for(i=0;i<Math.min(1,this.modelGraphics.length);i++){this.addModel(this.modelGraphics[i]);}}var _19=[];var _1a=[];this.substationGraphics.forEach(function(sub){sub.useFallback=true;if(_15.handledSubstation.hasOwnProperty(sub.id)){_1a.push(_15.handledSubstation[sub.id]);}else{var ef=new _a({geometry:sub.shape,attributes:{}});var eg=new _b({feature:ef,symbol:_15.layer.substationSymbol});eg.base=sub.position;_15.layer.substationLayer.renderer.add(_15.view,eg,eg.feature.geometry,eg.symbol);_15.handledSubstation[sub.id]=eg;_1a.push(eg);}if(_14>=_15.layer.textLayer.minLevel){var _1b=sub.NAME;if(_15.textGraphics.hasOwnProperty(_1b)){_19.push(_15.textGraphics[_1b]);}else{var _1c=new _9({color:window.substationTextColor||"#0FF",text:_1b,size:12,font:"微软雅黑",offset:[0,0]});var _1d=sub.position.clone();_1d.z+=40;var f=new _a({geometry:_1d,attributes:{}});var g=new _b({feature:f,symbol:_1c});g.base=sub.position;_15.layer.textLayer.renderer.add(_15.view,g,g.feature.geometry,g.symbol);_15.textGraphics[_1b]=g;_19.push(g);}}});this.layer.substationLayer.graphics=_1a;this.modelGraphics.forEach(function(_1e){_1e.useFallback=_13;_1e.render(_15,_15.layer.fallbackSymbol);if(_14>=_15.layer.textLayer.minLevel){var _1f=_1e.acTower;for(var id in _1f){var _20=_15.layer.lineID2Name[id]+_1e.NAME;if(_15.textGraphics.hasOwnProperty(_20)){_19.push(_15.textGraphics[_20]);}else{var _21=new _9({color:window.textColor||"#FF0",text:_1e.NAME,size:12,font:"微软雅黑",offset:[0,0]});var _22=_1f[id].clone();_22.z+=40;var f=new _a({geometry:_22,attributes:{}});var g=new _b({feature:f,symbol:_21});g.base=_1e.position;_15.layer.textLayer.renderer.add(_15.view,g,g.feature.geometry,g.symbol);_15.textGraphics[_20]=g;_19.push(g);}}}});var len=this.modelGraphics.length;var lg=[];if(_14>=this.layer.lineLayer.minLevel){for(var j=0;j<len;j++){var m=this.modelGraphics[j];for(var s=0;s<m.next.length;s++){var nx=m.next[s];if(nx.posMidified){var _23=nx.acTower;for(var t in _23){if(m.acTower.hasOwnProperty(t)){var _24=m.id+"-"+nx.id+t;if(this.lineGraphics.hasOwnProperty(_24)){lg.push(this.lineGraphics[_24]);}else{var p1=m.acTower[t].clone();p1.z+=30;p1.base=m.position;var p2=nx.acTower[t].clone();p2.z+=30;p2.base=nx.position;var _25=new _7([[p1,p2]]);var _26=new _a({geometry:_25,attributes:{}});var g=new _b({feature:_26,symbol:this.lineSymbol});this.lineGraphics[_24]=g;lg.push(g);this.layer.lineLayer.renderer.add(this.view,g,g.feature.geometry,g.symbol);}}}}}for(s=0;s<m.prev.length;s++){var nx=m.prev[s];if(nx.posMidified&&!this.current.hasOwnProperty(nx.id)){var _23=nx.acTower;for(var t in _23){if(m.acTower.hasOwnProperty(t)){var _24=nx.id+"-"+m.id+t;if(this.lineGraphics.hasOwnProperty(_24)){lg.push(this.lineGraphics[_24]);}else{var p1=nx.acTower[t].clone();p1.z+=30;p1.base=nx.position;var p2=m.acTower[t].clone();p2.z+=30;p2.base=m.position;var _25=new _7([[p1,p2]]);var _26=new _a({geometry:_25,attributes:{}});var g=new _b({feature:_26,symbol:this.lineSymbol});this.lineGraphics[_24]=g;lg.push(g);this.layer.lineLayer.renderer.add(this.view,g,g.feature.geometry,g.symbol);}}}}}}}this.layer.lineLayer.graphics=lg;this.layer.textLayer.graphics=_19;}};_c.prototype.zoom=function(){this._render();};_c.prototype.colorModeForRenderPass=function(){return _5.ColorMode.alphaBlended;};_c.prototype.depthModeForSublayer=function(n,_27,_28){return new _5.DepthMode(_28||this.view.context.gl.LEQUAL,_27,this.view.depthRangeFor3D);};return _c;});