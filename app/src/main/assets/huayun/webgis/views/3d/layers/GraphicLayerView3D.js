//>>built
define("com/huayun/webgis/views/3d/layers/GraphicLayerView3D",["dojo/_base/declare","./LayerView3D","com/huayun/webgis/gl/mode","com/huayun/webgis/data/ArrayType","com/huayun/webgis/gl/SegmentVector","com/huayun/webgis/gl/glUtils"],function(_1,_2,_3,_4,_5,_6){return _1("com.huayun.webgis.views.3d.layers.GraphicLayerView3D",[_2],{constructor:function(_7){_1.safeMixin(this,_7);this.visible=_7.visible;this.renderer=_7.renderer;this.glow=_7.glow;var _8=new _4.StructArrayLayout4i8();_8.emplaceBack(-1,-1,0,0);_8.emplaceBack(1,-1,1,0);_8.emplaceBack(-1,1,0,1);_8.emplaceBack(1,1,1,1);this.viewportBuffer=this.view.context.createVertexBuffer(_8,[{name:"aPos",type:"Int16",components:4,offset:0}]);this.viewportSegments=_5.simpleSegment(0,0,4,2);var _9=new _4.StructArrayLayout3ui6();_9.emplaceBack(0,1,2);_9.emplaceBack(2,1,3);this.quadTriangleIndexBuffer=this.view.context.createIndexBuffer(_9);},_readyData:function(){},_render:function(){var _a=this.view.viewpoint.targetZoom||this.view.viewpoint.level;var _b=true;if(this.layer.minLevel&&_a<this.layer.minLevel){_b=false;}if(this.layer.maxLevel&&_a>=this.layer.maxLevel){_b=false;}if(this.visible&&_b){this.view.currentLayer++;this.depthRangeFor3D=[0,1-((1+this.view.currentLayer)*this.view.numSublayers)*this.view.depthEpsilon];var _c=this.layer.graphics;var _d,_e;var _f=[];for(var i=0;i<_c.length;i++){_d=_c[i];if(_d.glow&&_d.visible&&_d.symbol){_f.push(_d);}}try{if(_f.length>0){var _10=this.view.context;var _11=this.view.width,_12=this.view.height;this.bindFramebuffer(_10,"renderFBO",_11,_12);var gl=_10.gl;gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);for(i=0;i<_f.length;i++){_d=_f[i];_e=_d.symbol;this.renderer.drawGlow(this.view,_d,_d.feature.geometry,_e,this);}this.renderBlur(_10,_11,_12);_10.bindFramebuffer.set(null);_10.viewport.set([0,0,_11,_12]);this.renderTextureToMap(_10);for(i=0;i<_c.length;i++){_d=_c[i];_e=_d.symbol;if(_d.visible&&_e){this.renderer.draw(this.view,_d,_d.feature.geometry,_e,this);if(_d.addHook){_d.addHook(_d,this);_d.addHook=null;}}}}else{for(i=0;i<_c.length;i++){_d=_c[i];_e=_d.symbol;if(_d.visible&&_e){this.renderer.draw(this.view,_d,_d.feature.geometry,_e,this);if(_d.addHook){_d.addHook(_d,this);_d.addHook=null;}}}}}catch(e){}}},bindFramebuffer:function(_13,_14,_15,_16){var fbo=this[_14];if(!fbo||Math.abs((fbo.width-_15))>1||Math.abs(fbo.height-_16)>1){fbo=this[_14]=_6.generateFBO(_13,_15,_16);}_13.bindFramebuffer.set(fbo.framebuffer);},renderBlur:function(_17,_18,_19){var gl=_17.gl;var _1a=this.layer.glowRatio;_18=Math.ceil(_18/_1a);_19=Math.ceil(_19/_1a);this.bindFramebuffer(_17,"blurFBO",_18,_19);_17.activeTexture.set(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,this.renderFBO.colorAttachment.get());gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);_17.viewport.set([0,0,_18,_19]);this.view.useProgramSimplify("gaussianBlur",{"layoutAttributes":{name:"aPos",type:"Int16",components:4,offset:0}}).draw(_17,gl.TRIANGLES,_3.DepthMode.disabled,_3.StencilMode.disabled,_3.ColorMode.alphaBlended,_3.CullFaceMode.disabled,{"uSize":[_18,_19],"uTexture":0,"uHorizontal":0,"u_kernel":[0.8,0.15,0.1,0.05,0.01]},this.id,this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments);this.bindFramebuffer(_17,"blurFBO2",_18,_19);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);gl.bindTexture(gl.TEXTURE_2D,this.blurFBO.colorAttachment.get());this.view.useProgramSimplify("gaussianBlur",{"layoutAttributes":{name:"aPos",type:"Int16",components:4,offset:0}}).draw(_17,gl.TRIANGLES,_3.DepthMode.disabled,_3.StencilMode.disabled,_3.ColorMode.alphaBlended,_3.CullFaceMode.disabled,{"uSize":[_18,_19],"uTexture":0,"uHorizontal":1,"u_kernel":[0.8,0.15,0.1,0.05,0.01]},this.id,this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments);},renderTextureToMap:function(_1b){var gl=_1b.gl;var fbo=this.blurFBO2;if(!fbo){return;}_1b.activeTexture.set(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,fbo.colorAttachment.get());this.view.useProgramSimplify("screen",{"layoutAttributes":{name:"aPos",type:"Int16",components:4,offset:0}}).draw(_1b,gl.TRIANGLES,_3.DepthMode.disabled,_3.StencilMode.disabled,_3.ColorMode.alphaBlended,_3.CullFaceMode.disabled,{uTexture:0},this.id,this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments);},refresh:function(){this.view.threeRender();},addGraphic:function(_1c){if(!_1c.position){_1c.position=this.view.viewpoint.center;}if(_1c.symbol){_1c.added=true;this.renderer.add(this.view,_1c,_1c.feature.geometry,_1c.symbol);_1c.addHook=function(g,_1d){var _1e=[];_1d.renderer.calculateExtent(_1d.view,g,g.feature.geometry,g.symbol,_1e);_1d.view.insertItems(_1e);};}},zoom:function(){if(this.visible){this._render();}},depthModeForSublayer:function(n,_1f,_20){return new _3.DepthMode(this.view.context.gl.LEQUAL,_1f,this.view.depthRangeFor3D);},setVisible:function(_21){this.visible=_21;this.view.threeRender();}});});