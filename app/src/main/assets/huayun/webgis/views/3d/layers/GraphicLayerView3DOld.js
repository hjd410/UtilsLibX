//>>built
define("com/huayun/webgis/views/3d/layers/GraphicLayerView3DOld",["dojo/_base/declare","../GraphicsView","./LayerView3D","com/huayun/webgis/gl/mode","com/huayun/webgis/data/ArrayType","com/huayun/webgis/gl/SegmentVector","com/huayun/webgis/gl/glUtils"],function(_1,_2,_3,_4,_5,_6,_7){return _1("com.huayun.webgis.views.3d.layers.GraphicLayerView3DOld",[_3],{constructor:function(_8){_1.safeMixin(this,_8);this.visible=_8.visible;this.glow=_8.glow;var _9=new _5.StructArrayLayout4i8();_9.emplaceBack(-1,-1,0,0);_9.emplaceBack(1,-1,1,0);_9.emplaceBack(-1,1,0,1);_9.emplaceBack(1,1,1,1);this.viewportBuffer=this.view.context.createVertexBuffer(_9,[{name:"aPos",type:"Int16",components:4,offset:0}]);this.viewportSegments=_6.simpleSegment(0,0,4,2);var _a=new _5.StructArrayLayout3ui6();_a.emplaceBack(0,1,2);_a.emplaceBack(2,1,3);this.quadTriangleIndexBuffer=this.view.context.createIndexBuffer(_a);},_readyData:function(){},_render:function(){if(this.visible){this.view.currentLayer++;var _b=this.layer.graphics;var _c,_d;var _e=[];for(var i=0;i<_b.length;i++){_c=_b[i];if(_c.glow&&_c.visible){_e.push(_c);}}if(_e.length>0){var _f=this.view.context;var _10=this.view.width,_11=this.view.height;this.bindFramebuffer(_f,"renderFBO",_10,_11);var gl=_f.gl;gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);for(i=0;i<_e.length;i++){_c=_b[i];_d=_c.symbol;_c.renderer.draw[_d.type](this,_c,_c.glow);}this.renderBlur(_f,_10,_11);_f.bindFramebuffer.set(null);_f.viewport.set([0,0,_10,_11]);this.renderTextureToMap(_f);for(i=0;i<_b.length;i++){_c=_b[i];if(_c.visible){_d=_c.symbol;_c.renderer.draw[_d.type](this,_c);}}}else{for(i=0;i<_b.length;i++){_c=_b[i];if(_c.visible){_d=_c.symbol;_c.renderer.draw[_d.type](this,_c);}}}}},bindFramebuffer:function(_12,_13,_14,_15){var fbo=this[_13];if(!fbo||Math.abs((fbo.width-_14))>1||Math.abs(fbo.height-_15)>1){fbo=this[_13]=_7.generateFBO(_12,_14,_15);}_12.bindFramebuffer.set(fbo.framebuffer);},renderBlur:function(_16,_17,_18){var gl=_16.gl;var _19=this.layer.glowRatio;_17=Math.ceil(_17/_19);_18=Math.ceil(_18/_19);this.bindFramebuffer(_16,"blurFBO",_17,_18);_16.activeTexture.set(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,this.renderFBO.colorAttachment.get());gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);_16.viewport.set([0,0,_17,_18]);this.view.useProgramSimplify("gaussianBlur",{"layoutAttributes":{name:"aPos",type:"Int16",components:4,offset:0}}).draw(_16,gl.TRIANGLES,_4.DepthMode.disabled,_4.StencilMode.disabled,_4.ColorMode.alphaBlended,_4.CullFaceMode.disabled,{"uSize":[_17,_18],"uTexture":0,"uHorizontal":0,"u_kernel":[0.5,0.15,0.1,0.05,0.01]},this.id,this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments);this.bindFramebuffer(_16,"blurFBO2",_17,_18);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);gl.bindTexture(gl.TEXTURE_2D,this.blurFBO.colorAttachment.get());this.view.useProgramSimplify("gaussianBlur",{"layoutAttributes":{name:"aPos",type:"Int16",components:4,offset:0}}).draw(_16,gl.TRIANGLES,_4.DepthMode.disabled,_4.StencilMode.disabled,_4.ColorMode.alphaBlended,_4.CullFaceMode.disabled,{"uSize":[_17,_18],"uTexture":0,"uHorizontal":1,"u_kernel":[0.5,0.15,0.1,0.05,0.01]},this.id,this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments);},renderTextureToMap:function(_1a){var gl=_1a.gl;var fbo=this.blurFBO2;if(!fbo){return;}_1a.activeTexture.set(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,fbo.colorAttachment.get());this.view.useProgramSimplify("screen",{"layoutAttributes":{name:"aPos",type:"Int16",components:4,offset:0}}).draw(_1a,gl.TRIANGLES,_4.DepthMode.disabled,_4.StencilMode.disabled,_4.ColorMode.alphaBlended,_4.CullFaceMode.disabled,{uTexture:0},this.id,this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments);},refresh:function(){this.view.threeRender();},addGraphic:function(_1b){var _1c=_1b.symbol.type;if(!_1b.renderer){_1b.renderer=_2;}_1b.renderer.add[_1c](_1b,this.view,this.layer);},zoom:function(){if(this.visible){this._render();}},depthModeForSublayer:function(n,_1d,_1e){var _1f=1-((1+this.view.currentLayer)*this.view.numSublayers+n)*this.view.depthEpsilon;return new _4.DepthMode(_1e||this.view.context.gl.LEQUAL,_1d,[_1f,_1f]);},setVisible:function(_20){this.visible=_20;this.view.threeRender();}});});