//>>built
define("com/huayun/webgis/views/3d/layers/TileLayerView3D",["./LayerView3D","../../../utils/utils","../../../utils/extendClazz","../../../gl/draw/drawRaster","../../../gl/mode","../../../data/ArrayType","../../../utils/Constant","../../../gl/members","../../../gl/SegmentVector"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9){function _a(_b){_1.call(this,_b);this.visible=_b.visible;this.id=_b.id;this.layer=_b.layer;this.view=_b.view;this._tileTextures={};this._sourcesDirty=true;this._fadeDirty=true;var _c=new _6.StructArrayLayout3ui6();_c.emplaceBack(0,1,2);_c.emplaceBack(2,1,3);this.quadTriangleIndexBuffer=this.view.context.createIndexBuffer(_c);var _d=_7.layout.EXTENT;var _e=new _6.StructArrayLayout4i8();_e.emplaceBack(0,0,0,0);_e.emplaceBack(_d,0,_d,0);_e.emplaceBack(0,_d,0,_d);_e.emplaceBack(_d,_d,_d,_d);this.rasterBoundsBuffer=this.view.context.createVertexBuffer(_e,_8.rasterBoundsAttributes.members);this.rasterBoundsSegments=_9.simpleSegment(0,0,4,2);};_3(_a,_1);_a.prototype.refresh=function(){this._readyData();this.view.threeRender();};_a.prototype._readyData=function(){if(this.visible){var _f=this.layer.tileInfo,_10=this.layer.maxLevel?Math.min(this.view.viewpoint.targetZoom||this.view.viewpoint.level,this.layer.maxLevel):this.view.viewpoint.targetZoom||this.view.viewpoint.level,_11=this.view.viewpoint.center,_12=_f.getResolution(_10);var _13=this.view._bound.map(function(_14){return {x:_f.getColForX(_14.x,_12),y:_f.getRowForY(_14.y,_12)};});var _15=_f.getColRange(_12);var cx=_f.getColForX(_11[0],_12),cy=_f.getRowForY(_11[1],_12);this.layer.sourceCache.updateTile(_10,_13,_15,cx,cy);this._sourcesDirty=true;this.zoomedBounds=_13;this.range=_15;this.cx=cx;this.cy=cy;}};_a.prototype._render=function(){if(this.visible&&this.zoomedBounds){this.view.currentLayer++;var _16=this.layer.maxLevel?Math.min(this.view.viewpoint.level,this.layer.maxLevel):this.view.viewpoint.level;if(this._sourcesDirty){this.layer.sourceCache.update(_16,this.zoomedBounds,this.range,this.cx,this.cy);this._sourcesDirty=false;this._fadeDirty=false;}this.renderPass="translucent";var _17=this.layer.sourceCache.getVisibleCoordinates(false,this.transform).slice().reverse();this.renderLayer(this,this.layer.sourceCache,null,_17);}};_a.prototype.renderLayer=function(_18,_19,_1a,_1b,_1c){if(!_1b.length){return;}_4(_18,_19,_1a,_1b);};_a.prototype.setVisible=function(_1d){this.visible=_1d;if(_1d){this.refresh();}else{this.view.threeRender();}};_a.prototype.zoom=function(){if(this.visible){this.transform=this.view.viewpoint;this.renderPass="translucent";var _1e=this.layer.sourceCache.updateTileMatrix(false,this.transform).slice().reverse();this.renderLayer(this,this.layer.sourceCache,null,_1e);}};_a.prototype.depthModeForSublayer=function(n,_1f,_20){var _21=1-((1+this.view.currentLayer)*this.view.numSublayers+n)*this.view.depthEpsilon;return new _5.DepthMode(_20||this.view.context.gl.LEQUAL,_1f,[_21,_21]);};_a.prototype.getTileTexture=function getTileTexture(_22){var _23=this._tileTextures[_22];return _23&&_23.length>0?_23.pop():null;};_a.prototype.saveTileTexture=function(_24){var _25=this._tileTextures[_24.size[0]];if(!_25){this._tileTextures[_24.size[0]]=[_24];}else{_25.push(_24);}};return _a;});