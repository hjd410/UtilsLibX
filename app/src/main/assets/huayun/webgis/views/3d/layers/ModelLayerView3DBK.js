//>>built
define("com/huayun/webgis/views/3d/layers/ModelLayerView3DBK",["dojo/_base/declare","./LayerView3D","../../../gl/mode"],function(_1,_2,_3){return _1("com.huayun.webgis.views.3d.layers.ModelLayerView3D",[_2],{constructor:function(_4){this.camera=new THREE.Camera();this.scene=new THREE.Scene();this.visible=_4.visible;this.layer=_4.layer;this.id=_4.id;var _5=_4.lights;_5.forEach(function(_6){this.scene.add(_6);}.bind(this));this._loader=this.layer.loader;this.view=_4.view;this.renderer=new THREE.WebGLRenderer({canvas:this.view._canvas,context:this.view._gl,antialias:true});this.renderer.autoClear=false;this.renderingMode="3d";},addModel:function(_7,_8){this._loader.load(_7.url,function(m){_8(_7,m);}.bind(this));},refresh:function(){this._readyData();this.view.threeRender();},_readyData:function(){},_render:function(){if(this.visible&&this.view._load){var _9=this.view.context;this.view.setCustomLayerDefaults();_9.setColorMode(this.colorModeForRenderPass());_9.setStencilMode(_3.StencilMode.disabled);this.view.currentLayer++;this.depthRangeFor3D=[0,1-((1+this.view.currentLayer)*this.view.numSublayers)*this.view.depthEpsilon];var _a=new _3.DepthMode(_9.gl.LEQUAL,_3.DepthMode.ReadWrite,this.depthRangeFor3D);_9.setDepthMode(_a);this.doRender(_9.gl);_9.setDirty();this.view.setBaseState();}},colorModeForRenderPass:function(){return _3.ColorMode.alphaBlended;},depthModeForSublayer:function(n,_b,_c){var _d=1-((1+this.view.currentLayer)*this.view.numSublayers+n)*this.view.depthEpsilon;return new _3.DepthMode(_c||this.view.context.gl.LEQUAL,_b,[_d,_d]);},doRender:function(gl){var _e=this.view.center;var _f=this.transform.getMatrixForModel(_e.x,_e.y);var r=this.view.viewpoint.tileInfo.getResolution(this.view.level);this.camera.projectionMatrix=new THREE.Matrix4().fromArray(_f);for(var i=0;i<this.layer.models.length;i++){var _10=this.layer.models[i];if(_10.loaded){var obj=_10.obj;if(_10.keepCenter){obj.position.set(0,0,_10.position.z/r);}else{obj.position.set((_10.position.x-_e.x)/r,(_10.position.y-_e.y)/r,_10.position.z/r);}obj.scale.set(_10.scale.x/r,_10.scale.y/r,_10.scale.z/r);var _11=_10.rotate;obj.rotation.set(_11.x,_11.y,_11.z,"XYZ");}}this.renderer.state.reset();this.renderer.render(this.scene,this.camera);},zoom:function(){this._render();}});});