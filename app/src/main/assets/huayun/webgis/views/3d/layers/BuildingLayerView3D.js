//>>built
define("com/huayun/webgis/views/3d/layers/BuildingLayerView3D",["dojo/_base/declare","./LayerView3D","com/huayun/webgis/layers/support/Tile","com/huayun/webgis/layers/support/TileHandler","com/huayun/webgis/layers/support/tileCover2"],function(_1,_2,_3,_4,_5){return _1("com.huayun.webgis.views.3d.layers.BuildingLayerView3D",[_2],{_group:null,view:null,constructor:function(_6){_1.safeMixin(this,_6);this._group=new THREE.Group();this._group.visible=_6.visible;this.visible=_6.visible;this.tileIndex={};this.extrudeSettings={depth:50,bevelEnabled:false,bevelSegments:1,steps:1,bevelSize:1,bevelThickness:1,curveSegments:1};this.material=new THREE.MeshLambertMaterial({color:14540253,transparent:false,opacity:1});this._currentIndex={};},refresh:function(){if(this.visible){this._readyData();this._render();}},_readyData:function(){var _7=this.view.level;if(_7>this.layer.maxLevel||_7<this.layer.minLevel){if(this._group.visible){this._group.visible=false;this.view.threeRender();}}else{if(this.visible){this._group.visible=true;var _8=this.view._tileInfo,_9=this.view.extent,_a=_8.size,_b=this.view.center,_c=this.view.resolution,rs=_c*_a;var _d=this.view._bound.map(function(_e){return {x:_8.getColForX(_e.x,_c),y:_8.getRowForY(_e.y,_c)};});var t=_5.tileCover(_7,_d,_8.getColRange(_c));var _f,_10=[],_11;this._currentIndex={};var i=0;for(_f in t){var _12=t[_f];if(!this.tileIndex.hasOwnProperty(_f)){_11=new _3(_12.x,_12.y,_7);this.tileIndex[_f]=_11;_10.push(_11);}i++;this._currentIndex[_f]=true;}var cx=_8.getColForX(_b.x,_c),cy=_8.getRowForY(_b.y,_c);_10.sort(function(a,b){return Math.sqrt((cx-a.x)*(cx-a.x)+(cy-a.y)*(cy-a.y))-Math.sqrt((cx-b.x)*(cx-b.x)+(cy-b.y)*(cy-b.y));});this._fetchTiles(_10);}else{if(this._group.visible){this._group.visible=false;}}}},_fetchTiles:function(_13){this._loadLength=_13.length;_13.forEach(function(_14){this.tileIndex[_14.z+"/"+_14.x+"/"+_14.y].data=this.layer.fetchTile(_14.z,_14.x,_14.y);}.bind(this));},_render:function(){if(this._group.visible){var obj=this;var _15,_16;for(var i in this.tileIndex){if(!this._currentIndex.hasOwnProperty(i)){var _17=this.tileIndex[i].data;if(_17.isResolved){_17.cancel();}else{this._group.remove(_17);_17.geometry.dispose();this.tileIndex[i].data=null;}delete this.tileIndex[i];}}var _18=this.view.viewpoint.scale;this._group.scale.set(_18,_18,1);for(var id in this.tileIndex){_15=this.tileIndex[id];if(_15.load){}else{(function(_19){_19.data.then(function(_1a){_16=_19.z+"/"+_19.x+"/"+_19.y;if(obj.tileIndex.hasOwnProperty(_16)&&_1a){var _1b=_16.split("/");var _1c=Number(_1b[1]);var _1d=Number(_1b[2]);obj._renderFeatures(_1a,_1c,_1d,_16);}});})(_15);}}this.view.threeRender();}},_renderFeatures:function(_1e,_1f,_20,_21){var pos=this._group.position;var r=this.view.resolution;var _22=this.view._tileInfo.origin;var px=_1f*r*256+_22.x,py=_22.y-_20*r*256,_23=this.view.center,_24=(px-_23.x)/r-pos.x*this.view.initResolution/r,_25=(py-_23.y)/r-256-pos.y*this.view.initResolution/r;var _26,_27,id,h;var _28=this.view.initResolution;var g=new THREE.Geometry();for(var i=0;i<_1e.length;i++){_26=_1e[i].flatCoordinates_;_27=_1e[i].properties_;id=_27.id;h=_27.height;var _29=_26[0]/16,_2a=_26[1]/16,len=_26.length;var _2b=new THREE.Shape();_2b.moveTo(_29,256-_2a);for(var j=2;j<len-2;j=j+2){var _2c=_26[j]/16,_2d=_26[j+1]/16;_2b.lineTo(_2c,256-_2d);}this.extrudeSettings.depth=h/_28*2;var _2e=new THREE.ExtrudeGeometry(_2b,this.extrudeSettings);g.merge(_2e);}var _2f=new THREE.Mesh(g,this.material);_2f.position.set(_24,_25,0.1);this._group.add(_2f);this.tileIndex[_21].data=_2f;this.tileIndex[_21].load=true;this.view.threeRender();},setVisible:function(_30){this.visible=_30;this._group.visible=_30;if(_30){this.refresh();}else{this.view.threeRender();}},zoom:function(_31){}});});