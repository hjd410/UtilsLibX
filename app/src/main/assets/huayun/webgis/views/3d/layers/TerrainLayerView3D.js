//>>built
define("com/huayun/webgis/views/3d/layers/TerrainLayerView3D",["./LayerView3D","../../../gl/draw/drawTifTerrain","../../../gl/draw/drawHeightMap","../../../gl/mode","../../../data/ArrayType","../../../gl/members","../../../gl/SegmentVector","../../../utils/Constant"],function(_1,_2,_3,_4,_5,_6,_7,_8){var _9=function(_a){_1.call(this,_a);this.view=_a.view;this.visible=_a.visible===undefined?true:_a.visible;this.layer=_a.layer;var _b=new _5.StructArrayLayout3ui6();_b.emplaceBack(0,1,2);_b.emplaceBack(2,1,3);this.quadTriangleIndexBuffer=this.view.context.createIndexBuffer(_b);var _c=_8.layout.EXTENT;var _d=new _5.StructArrayLayout3i6();_d.emplaceBack(0,0,0);_d.emplaceBack(1,0,0);_d.emplaceBack(0,1,0);_d.emplaceBack(1,1,0);this.rasterBoundsBuffer=this.view.context.createVertexBuffer(_d,_6.rasterBoundsAttributes.members);this.rasterBoundsSegments=_7.simpleSegment(0,0,4,2);};if(_1){_9.__proto__=_1;}_9.prototype=Object.create(_1&&_1.prototype);_9.prototype.constructor=_9;_9.prototype.refresh=function(){this._readyData();this.view.threeRender();};_9.prototype._readyData=function(){if(this.visible){var _e=this.layer.tileInfo,_f=Math.min(this.view.viewpoint.targetZoom||this.view.viewpoint.level,this.layer.maxLevel),_10=this.view.viewpoint.center,_11=_e.getResolution(_f);var _12=this.view._bound.map(function(_13){return {x:_e.getColForX(_13.x,_11),y:_e.getRowForY(_13.y,_11)};});var _14=_e.getColRange(_11);var cx=_e.getColForX(_10[0],_11),cy=_e.getRowForY(_10[1],_11);this.layer.sourceCache.updateTile(_f,_12,_14,cx,cy);this._sourcesDirty=true;this.zoomedBounds=_12;this.range=_14;this.cx=cx;this.cy=cy;}};_9.prototype._render=function(){if(this.visible&&this.zoomedBounds){var _15=Math.min(this.view.viewpoint.level,this.layer.maxLevel);var _16=this.layer.sourceCache;if(this._sourcesDirty){this.layer.sourceCache.update(_15,this.zoomedBounds,this.range,this.cx,this.cy);this._sourcesDirty=false;this._fadeDirty=false;}var _17=_16.getVisibleCoordinates(false,this.transform).slice().reverse();this.depthRangeFor3D=[0,1-((1+this.view.currentLayer)*this.view.numSublayers)*this.view.depthEpsilon];this.renderPass="translucent";this.renderLayer(this,_16,null,_17);}};_9.prototype.renderLayer=function(_18,_19,_1a,_1b,_1c){if(!_1b.length){return;}_2(_18,_19,_1a,_1b);};_9.prototype.zoom=function(){if(this.visible){var _1d=this.layer.sourceCache;var _1e=_1d.updateTileMatrix(false,this.view.viewpoint).slice().reverse();this.renderPass="translucent";this.depthRangeFor3D=[0,1-((1+this.view.currentLayer)*this.view.numSublayers)*this.view.depthEpsilon];this.renderLayer(this,_1d,null,_1e);}};_9.prototype.depthModeForSublayer=function(n,_1f,_20){if(this.view.level<this.layer.changeLevel){var _21=1-((1+this.view.currentLayer)*this.view.numSublayers+n)*this.view.depthEpsilon;return new _4.DepthMode(_20||this.view.context.gl.LEQUAL,_1f,[_21,_21]);}else{return new _4.DepthMode(_20||this.view.context.gl.LEQUAL,_1f,this.view.depthRangeFor3D);}};_9.prototype.drawHeightMap=function(_22,_23){if(!_23.heightTexture){_3(_22,null,null,_23);}};return _9;});