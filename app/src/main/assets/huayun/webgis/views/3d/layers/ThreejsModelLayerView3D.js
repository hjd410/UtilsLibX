//>>built
define("com/huayun/webgis/views/3d/layers/ThreejsModelLayerView3D",["dojo/_base/declare","./LayerView3D","../../../gl/mode"],function(f,g,e){return f("com.huayun.webgis.views.3d.layers.ModelLayerView3D",[g],{constructor:function(a){this.camera=new THREE.Camera;this.scene=new THREE.Scene;this.visible=a.visible;this.layer=a.layer;this.id=a.id;a.lights.forEach(function(a){this.scene.add(a)}.bind(this));this._loader=this.layer.loader;this.view=a.view;this.renderer=new THREE.WebGLRenderer({canvas:this.view._canvas,
context:this.view._gl,antialias:!0});this.renderer.autoClear=!1;this.renderingMode="3d"},addModel:function(a,c){this._loader.load(a.url,function(d){c(a,d)}.bind(this))},refresh:function(){this._readyData();this.view.threeRender()},_readyData:function(){},_render:function(){if(this.visible&&this.view._load){var a=this.view.context;this.view.setCustomLayerDefaults();a.setColorMode(this.colorModeForRenderPass());a.setStencilMode(e.StencilMode.disabled);this.view.currentLayer++;this.depthRangeFor3D=[0,
1-(1+this.view.currentLayer)*this.view.numSublayers*this.view.depthEpsilon];var c=new e.DepthMode(a.gl.LEQUAL,e.DepthMode.ReadWrite,this.depthRangeFor3D);a.setDepthMode(c);this.doRender(a.gl);a.setDirty();this.view.setBaseState()}},colorModeForRenderPass:function(){return e.ColorMode.alphaBlended},depthModeForSublayer:function(a,c,d){a=1-((1+this.view.currentLayer)*this.view.numSublayers+a)*this.view.depthEpsilon;return new e.DepthMode(d||this.view.context.gl.LEQUAL,c,[a,a])},doRender:function(a){a=
this.view.center;var c=this.transform.getMatrixForModel(a.x,a.y),d=this.view.viewpoint.tileInfo.getResolution(this.view.level);this.camera.projectionMatrix=(new THREE.Matrix4).fromArray(c);for(c=0;c<this.layer.models.length;c++){var b=this.layer.models[c];if(b.loaded){var e=b.obj;b.keepCenter?e.position.set(0,0,b.position.z/d):e.position.set((b.position.x-a.x)/d,(b.position.y-a.y)/d,b.position.z/d);e.scale.set(b.scale.x/d,b.scale.y/d,b.scale.z/d);b=b.rotate;e.rotation.set(b.x,b.y,b.z,"XYZ")}}this.renderer.state.reset();
this.renderer.render(this.scene,this.camera)},zoom:function(){this._render()}})});