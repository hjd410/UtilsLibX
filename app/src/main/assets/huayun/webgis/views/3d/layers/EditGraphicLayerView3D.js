//>>built
define("com/huayun/webgis/views/3d/layers/EditGraphicLayerView3D",["dojo/_base/declare","./LayerView3D","com/huayun/webgis/gl/mode","com/huayun/webgis/data/ArrayType","com/huayun/webgis/gl/SegmentVector","com/huayun/webgis/gl/glUtils"],function(_1,_2,_3,_4,_5,_6){return _1("com.huayun.webgis.views.3d.layers.EditGraphicLayerView3D",[_2],{constructor:function(_7){_1.safeMixin(this,_7);this.visible=_7.visible;this.renderer=_7.renderer;this.glow=_7.glow;var _8=new _4.StructArrayLayout4i8();_8.emplaceBack(-1,-1,0,0);_8.emplaceBack(1,-1,1,0);_8.emplaceBack(-1,1,0,1);_8.emplaceBack(1,1,1,1);this.viewportBuffer=this.view.context.createVertexBuffer(_8,[{name:"aPos",type:"Int16",components:4,offset:0}]);this.viewportSegments=_5.simpleSegment(0,0,4,2);var _9=new _4.StructArrayLayout3ui6();_9.emplaceBack(0,1,2);_9.emplaceBack(2,1,3);this.quadTriangleIndexBuffer=this.view.context.createIndexBuffer(_9);},_readyData:function(){},_render:function(){if(this.visible){this.view.currentLayer++;var _a=this.layer.graphics;var _b,_c;for(var i=0;i<_a.length;i++){_b=_a[i];if(_b.visible){_c=_b.symbol;if(_c){this.renderer.draw(this,_b,_b.feature.geometry,_c);}}}}},bindFramebuffer:function(_d,_e,_f,_10){var fbo=this[_e];if(!fbo||Math.abs((fbo.width-_f))>1||Math.abs(fbo.height-_10)>1){fbo=this[_e]=_6.generateFBO(_d,_f,_10);}_d.bindFramebuffer.set(fbo.framebuffer);},renderBlur:function(_11,_12,_13){var gl=_11.gl;var _14=this.layer.glowRatio;_12=Math.ceil(_12/_14);_13=Math.ceil(_13/_14);this.bindFramebuffer(_11,"blurFBO",_12,_13);_11.activeTexture.set(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,this.renderFBO.colorAttachment.get());gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);_11.viewport.set([0,0,_12,_13]);this.view.useProgramSimplify("gaussianBlur",{"layoutAttributes":{name:"aPos",type:"Int16",components:4,offset:0}}).draw(_11,gl.TRIANGLES,_3.DepthMode.disabled,_3.StencilMode.disabled,_3.ColorMode.alphaBlended,_3.CullFaceMode.disabled,{"uSize":[_12,_13],"uTexture":0,"uHorizontal":0,"u_kernel":[0.5,0.15,0.1,0.05,0.01]},this.id,this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments);this.bindFramebuffer(_11,"blurFBO2",_12,_13);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);gl.bindTexture(gl.TEXTURE_2D,this.blurFBO.colorAttachment.get());this.view.useProgramSimplify("gaussianBlur",{"layoutAttributes":{name:"aPos",type:"Int16",components:4,offset:0}}).draw(_11,gl.TRIANGLES,_3.DepthMode.disabled,_3.StencilMode.disabled,_3.ColorMode.alphaBlended,_3.CullFaceMode.disabled,{"uSize":[_12,_13],"uTexture":0,"uHorizontal":1,"u_kernel":[0.5,0.15,0.1,0.05,0.01]},this.id,this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments);},renderTextureToMap:function(_15){var gl=_15.gl;var fbo=this.blurFBO2;if(!fbo){return;}_15.activeTexture.set(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,fbo.colorAttachment.get());this.view.useProgramSimplify("screen",{"layoutAttributes":{name:"aPos",type:"Int16",components:4,offset:0}}).draw(_15,gl.TRIANGLES,_3.DepthMode.disabled,_3.StencilMode.disabled,_3.ColorMode.alphaBlended,_3.CullFaceMode.disabled,{uTexture:0},this.id,this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments);},refresh:function(){this.view.threeRender();},addGraphic:function(_16){if(!_16.position){_16.position=this.view.viewpoint.center;}if(_16.symbol){_16.added=true;this.renderer.add(this,_16,_16.feature.geometry,_16.symbol);}},zoom:function(){if(this.visible){this._render();}},depthModeForSublayer:function(n,_17,_18){var _19=1-((1+this.view.currentLayer)*this.view.numSublayers+n)*this.view.depthEpsilon;return new _3.DepthMode(_18||this.view.context.gl.LEQUAL,_17,[_19,_19]);},setVisible:function(_1a){this.visible=_1a;this.view.threeRender();}});});