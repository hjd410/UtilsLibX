//>>built
define("com/huayun/webgis/views/3d/layers/VectorTileLayerView3D",["./LayerView3D","../../../utils/utils","../../../utils/Constant","../../../layers/support/EvaluationParameters","../../../layers/support/CrossTileSymbolIndex","../../../layers/support/PauseablePlacement","../../../gl/draw","../../../gl/mode","../../../gl/SegmentVector","../../../gl/members","../../../data/ArrayType"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b){var _c=function(_d){_1.call(this,_d);this.view=_d.view;this.visible=_d.visible;this.layer=_d.layer;this.crossTileSymbolIndex=new _5();this.draw$1={fill:drawType.drawFill,line:drawType.drawLine,symbol:drawType.drawSymbols,background:drawType.drawBackground};var _e=new _b.StructArrayLayout2i4();_e.emplaceBack(0,0);_e.emplaceBack(1,0);_e.emplaceBack(0,1);_e.emplaceBack(1,1);this.viewportBuffer=this.view.context.createVertexBuffer(_e,_a.posAttributes.members);this.viewportSegments=_9.simpleSegment(0,0,4,2);var _f=new _b.StructArrayLayout3ui6();_f.emplaceBack(0,1,2);_f.emplaceBack(2,1,3);this.quadTriangleIndexBuffer=this.view.context.createIndexBuffer(_f);var _10=new _b.StructArrayLayout2i4();_10.emplaceBack(0,0);_10.emplaceBack(_3.layout.EXTENT,0);_10.emplaceBack(0,_3.layout.EXTENT);_10.emplaceBack(_3.layout.EXTENT,_3.layout.EXTENT);this.tileExtentBuffer=this.view.context.createVertexBuffer(_10,_a.posAttributes.members);this.tileExtentSegments=_9.simpleSegment(0,0,4,2);};if(_1){_c.__proto__=_1;}_c.prototype=Object.create(_1&&_1.prototype);_c.prototype.constructor=_c;_c.prototype.refresh=function(){this._readyData();this.view.threeRender();};_c.prototype._readyData=function(){if(this.visible){var _11=this.layer.tileInfo,_12=this.view.viewpoint.level,_13=this.view.viewpoint.center,_14=_11.getResolution(_12);if(!_11){return;}var _15=this.view._bound.map(function(_16){return {x:_11.getColForX(_16.x,_14),y:_11.getRowForY(_16.y,_14)};});var _17=_11.getColRange(_14);var cx=_11.getColForX(_13[0],_14),cy=_11.getRowForY(_13[1],_14);var _18=this.layer._layers;var _19=new _4(_12,{now:_2.now(),fadeDuration:500,zoomHistory:this.view.zoomHistory,transition:{delay:0,duration:500}});for(var i=0,_1a=this.layer._order;i<_1a.length;i++){var _1b=_18[_1a[i]];_1b.recalculate(_19);}this.tileIDs=this.layer.sourceCache.updateTile(_12,_15,_17,cx,cy);this._sourcesDirty=true;this.zoomedBounds=_15;this.range=_17;this.cx=cx;this.cy=cy;}};_c.prototype._render=function(){if(this.visible){var _1c=this.view.viewpoint.level;var _1d=this.layer.sourceCache;if(this._sourcesDirty){this.tileIDs=_1d.update(_1c,this.zoomedBounds,this.range,this.cx,this.cy);}var _1e=this.layer._order;var _1f=_1d.getVisibleCoordinates(false,this.transform);var _20=_1f.slice().reverse();var _21=_1d.getVisibleCoordinates(true,this.transform).reverse();this._placementDirty=this._updatePlacement(0);_1d.prepare(this.view.context);this.renderPass="opaque";for(this.currentLayer=_1e.length-1;this.currentLayer>=0;this.currentLayer--){var _22=this.layer._layers[_1e[this.currentLayer]];if(_22.type!=="fill"&&_22.type!=="background"){continue;}this._renderLayer(this,_1d,_22,_1f,_1c);}this.renderPass="translucent";for(this.currentLayer=0;this.currentLayer<_1e.length;this.currentLayer++){var _23=this.layer._layers[_1e[this.currentLayer]];if(_23.type==="fill"||_23.type==="background"){continue;}var _24=_23.type==="symbol"?_21:_20;this._renderLayer(this,_1d,_23,_24,_1c);}this.view.currentLayer+=_1e.length;}};_c.prototype._renderLayer=function(_25,_26,_27,_28,_29){if(_27.isHidden(_29)){return;}if(!_28.length){return;}this.draw$1[_27.type](_25,_26,_27,_28);};_c.prototype._updatePlacement=function(_2a){var _2b=false;var _2c=false;var _2d={};for(var i=0,_2e=this.layer._order;i<_2e.length;i+=1){var _2f=_2e[i];var _30=this.layer._layers[_2f];if(_30.type!=="symbol"){continue;}var _31=_30.source;if(!_2d[_31]){var _32=this.layer.sourceCache;_2d[_31]=_32.getRenderableIds(true).map(function(id){return _32.getTileByID(id);}).sort(function(a,b){return (b.tileID.overscaledZ-a.tileID.overscaledZ)||(a.tileID.isLessThan(b.tileID)?-1:1);});}var _33=this.crossTileSymbolIndex.addLayer(_30,_2d[_31]);_2b=_2b||_33;}this.crossTileSymbolIndex.pruneUnusedLayers(this.layer._order);var _34=this._layerOrderChanged||_2a===0;if(_34){this.pauseablePlacement=new _6(this.transform,this.layer._order,_34,false,_2a,true,this.placement);this._layerOrderChanged=false;}if(this.pauseablePlacement.isDone()){this.placement.setStale();}else{this.pauseablePlacement.continuePlacement(this.layer._order,this.layer._layers,_2d);if(this.pauseablePlacement.isDone()){this.placement=this.pauseablePlacement.commit(_2.now());_2c=true;}if(_2b){this.pauseablePlacement.placement.setStale();}}if(_2c||_2b){for(var i$1=0,_35=this.layer._order;i$1<_35.length;i$1+=1){var _36=_35[i$1];var _37=this.layer._layers[_36];if(_37.type!=="symbol"){continue;}this.placement.updateLayerOpacities(_37,_2d[_37.source]);}}return !this.pauseablePlacement.isDone()||this.placement.hasTransitions(_2.now());};_c.prototype.depthModeForSublayer=function(n,_38,_39){var _3a=1-((1+this.view.currentLayer+this.currentLayer)*this.view.numSublayers+n)*this.view.depthEpsilon;return new _8.DepthMode(_39||this.view.context.gl.LEQUAL,_38,[_3a,_3a]);};_c.prototype.zoom=function(){if(this.visible){this.transform=this.view.viewpoint;var _3b=this.layer._order;var _3c=this.layer.sourceCache;var _3d=this.view.viewpoint.zoom;var _3e=_3c.updateTileMatrix(false,this.transform);var _3f=_3e.slice().reverse();var _40=_3c.updateTileMatrix(true,this.transform).reverse();this.tileIDs=_3c.currentCoords;this.renderPass="opaque";for(this.currentLayer=_3b.length-1;this.currentLayer>=0;this.currentLayer--){var _41=this.layer._layers[_3b[this.currentLayer]];if(_41.type!=="fill"&&_41.type!=="background"){continue;}this._renderLayer(this,_3c,_41,_3e,_3d);}this.renderPass="translucent";for(this.currentLayer=0;this.currentLayer<_3b.length;this.currentLayer++){var _42=this.layer._layers[_3b[this.currentLayer]];if(_42.type==="fill"||_42.type==="background"){continue;}var _43=_42.type==="symbol"?_40:_3f;this._renderLayer(this,_3c,_42,_43,_3d);}this.view.currentLayer+=_3b.length;}};return _c;});