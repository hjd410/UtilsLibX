//>>built
define("com/huayun/webgis/views/3d/layers/VelocityLayerView3D",["./LayerView3D","../../../gl/draw","../../../gl/Texture","../../../gl/SegmentVector","../../../geometry/Extent","com/huayun/webgis/data/ArrayType","com/huayun/webgis/utils/Constant"],function(_1,_2,_3,_4,_5,_6,_7){var _8=function(_9){_1.call(this,_9);this.id=_9.id===undefined?"velocity":_9.id;this.opacity=_9.opacity===undefined?1:_9.opacity;this.visible=_9.visible===undefined?true:_9.visible;this.layer=_9.layer;this.view=_9.view;this._vscale=0.005;this.NULL_WIND_VECTOR=[NaN,NaN,null];this._defaultColorScale=["rgb(36,104, 180)","rgb(60,157, 194)","rgb(128,205,193 )","rgb(151,218,168 )","rgb(198,231,181)","rgb(238,247,217)","rgb(255,238,159)","rgb(252,217,125)","rgb(255,182,100)","rgb(252,150,75)","rgb(250,112,52)","rgb(245,64,32)","rgb(237,45,28)","rgb(220,24,32)","rgb(180,0,35)"];this._colorScale=_9.colorScale||this._defaultColorScale;this._grid=[];this.MIN_VELOCITY_INTENSITY=_9.minVeclocity||0;this.MAX_VELOCITY_INTENSITY=_9.maxVeclocity||10;this.PARTICLE_MULTIPLIER=1/300;this.MAX_PARTICLE_AGE=_9.particleAge||90;this.PARTICLE_LINE_WIDTH=_9.lineWidth||1;this._canvas=document.createElement("canvas");this._canvas.id="velocity";this._canvas.width=this.view.width;this._canvas.height=this.view.height;this._ctx=this._canvas.getContext("2d");this.colorStyles=this.windIntensityColorScale(this.MIN_VELOCITY_INTENSITY,this.MAX_VELOCITY_INTENSITY);this.buckets=this.colorStyles.map(function(){return [];});this.extent=new _5(0,0,0,0);var _a=this.NULL_WIND_VECTOR;function _b(x,y,_c){var _d=_c[Math.round(x)];return _d&&_d[Math.round(y)]||_a;};_b.randomize=function(o,_e,_f){var x,y;var _10=0;do{x=Math.round(Math.floor(Math.random()*_e.width)+_e.x);y=Math.round(Math.floor(Math.random()*_e.height)+_e.y);}while(_b.call(this,x,y,_f)[2]===null&&_10++<30);o.x=x;o.y=y;return o;};this.field=_b;this.FRAME_RATE=15;this.FRAME_TIME=1000/this.FRAME_RATE;var _11=new _6.StructArrayLayout3ui6();_11.emplaceBack(0,1,2);_11.emplaceBack(2,1,3);this.quadTriangleIndexBuffer=this.view.context.createIndexBuffer(_11);this.viewportSegments=_4.simpleSegment(0,0,4,2);var obj=this;this.intervalFlag=setInterval(function(){obj.repaint();},this.FRAME_TIME);};if(_1){_8.__proto__=_1;}_8.prototype=Object.create(_1&&_1.prototype);_8.prototype.constructor=_8;_8.prototype.setVisible=function(_12){this.visible=_12;if(_12){var obj=this;this.extent=new _5(0,0,0,0);this.intervalFlag=setInterval(function(){obj.repaint();},this.FRAME_TIME);}else{this.stop();}this.view.threeRender();};_8.prototype._interpolateColumn=function(x,y,_13,_14,_15,_16){var _17=[];for(;y<=_13;y+=2){var _18=this._invert(x,y,_16);if(_18){var lo=_18[0],la=_18[1];if(isFinite(lo)){var _19=this.layer.interpolateGrid.interpolate.call(this.layer,lo,la);if(_19){_19=this._distort(_14,lo,la,x,y,_15,_19,_16);_17[y+1]=_17[y]=_19;}}}}return _17;};_8.prototype._distort=function(_1a,lo,la,x,y,_1b,_1c,_1d){var u=_1c[0]*_1b;var v=_1c[1]*_1b;var d=this._distortion(_1a,lo,la,x,y,_1d);_1c[0]=d[0]*u+d[2]*v;_1c[1]=d[1]*u+d[3]*v;return _1c;};_8.prototype._distortion=function(_1e,λ,φ,x,y,_1f){var H=this.view.resolution;var hλ=λ<0?H:-H;var hφ=φ<0?H:-H;var pλ=this._getProject(φ,λ+hλ,_1f);var pφ=this._getProject(φ+hφ,λ,_1f);return [(pλ[0]-x)/hλ,(pλ[1]-y)/hλ,(pφ[0]-x)/hφ,(pφ[1]-y)/hφ];};_8.prototype._getProject=function(lat,lon,_20){var _21=_20.south;var _22=_20.north;var _23=_20.width/(_20.east-_20.west);var _24=_20.height/(_22-_21);var y=lat;var x=(lon-_20.west)*_23;y=(_22-y)*_24;return [x,y];};_8.prototype._invert=function(x,y,_25){var r=this.view.resolution;var lon=_25.west+x*r,lat=_25.north-y*r;return [lon,lat];};_8.prototype.refresh=function(){this._readyData();this.view.threeRender();};_8.prototype._readyData=function(){};_8.prototype._render=function(){if(this.visible&&this.layer.data){var _26=this.view.extent;var _27=this.view.viewpoint.level;var _28=this.view.context;var gl=_28.gl;if(!this.extent.equals(_26)){this.extent=_26;var _29=this.view.width,_2a=this.view.height;var _2b=_26.minx,_2c=_26.miny,_2d=_26.maxx,_2e=_26.maxy;var _2f={south:_2c,north:_2e,east:_2d,west:_2b,width:_29,height:_2a};var _30=[0,0];var _31=[_29,_2a];var x=Math.round(_30[0]);var y=Math.max(Math.floor(_30[1],0),0);var _32=Math.min(Math.ceil(_31[0],_29),_29-1);var _33=Math.min(Math.ceil(_31[1],_2a),_2a-1);var _34={x:x,y:y,xMax:_29,yMax:_33,width:_29,height:_2a};this.bounds=_34;var _35={};var _36=(_2f.south-_2f.north)*(_2f.west-_2f.east);var _37=this._vscale*Math.pow(_36,0.4);var _38=[];while(x<_32){_38[x+1]=_38[x]=this._interpolateColumn(x,y,_33,_35,_37,_2f);x+=2;}this.columns=_38;var _39=Math.round(_34.width*_34.height*this.PARTICLE_MULTIPLIER);var _3a="rgba(0, 0, 0, 0.97)";var _3b=[];for(var i=0;i<_39;i++){_3b.push(this.field.randomize.call(this,{age:Math.floor(Math.random()*this.MAX_PARTICLE_AGE)},_34,_38));}this.particles=_3b;this._ctx.lineWidth=this.PARTICLE_LINE_WIDTH;this._ctx.fillStyle=_3a;this._ctx.globalAlpha=0.6;this._drawCanvas(_34,_38,this.buckets,this.particles);if(this.texture){this.texture.update(this._canvas,{useMipmap:true});}else{this.texture=new _3(_28,this._canvas,gl.RGBA,{useMipmap:true});this.texture.bind(gl.LINEAR,gl.CLAMP_TO_EDGE,gl.LINEAR_MIPMAP_NEAREST);if(_28.extTextureFilterAnisotropic){gl.texParameterf(gl.TEXTURE_2D,_28.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,_28.extTextureFilterAnisotropicMax);}}}this.texture.zoom=_27;this._drawLayer();}};_8.prototype.repaint=function(){if(!this.particles){return;}this._drawCanvas(this.bounds,this.columns,this.buckets,this.particles);this.texture.update(this._canvas,{useMipmap:true});this.view.threeRender();};_8.prototype.windIntensityColorScale=function(min,max){this._colorScale.indexFor=function(m){return Math.max(0,Math.min(this._colorScale.length-1,Math.round((m-min)/(max-min)*(this._colorScale.length-1))));}.bind(this);return this._colorScale;};_8.prototype._drawCanvas=function(_3c,_3d,_3e,_3f){_3e.forEach(function(_40){_40.length=0;});_3f.forEach(function(_41){if(_41.age>this.MAX_PARTICLE_AGE){this.field.randomize.call(this,_41,_3c,_3d).age=0;}var x=_41.x;var y=_41.y;var v=this.field.call(this,x,y,_3d);var m=v[2];if(m===null){_41.age=this.MAX_PARTICLE_AGE;}else{var xt=x+v[0];var yt=y+v[1];if(this.field.call(this,xt,yt,_3d)[2]!==null){_41.xt=xt;_41.yt=yt;_3e[this.colorStyles.indexFor(m)].push(_41);}else{_41.xt=xt;_41.yt=yt;}}_41.age+=1;}.bind(this));var _42="lighter";this._ctx.globalCompositeOperation="destination-in";this._ctx.fillRect(_3c.x,_3c.y,_3c.width,_3c.height);this._ctx.globalCompositeOperation=_42;this._ctx.globalAlpha=0.9;_3e.forEach(function(_43,i){if(_43.length>0){this._ctx.beginPath();this._ctx.strokeStyle=this.colorStyles[i];_43.forEach(function(_44){this._ctx.moveTo(_44.x,_44.y);this._ctx.lineTo(_44.xt,_44.yt);_44.x=_44.xt;_44.y=_44.yt;}.bind(this));this._ctx.stroke();}}.bind(this));};_8.prototype._drawLayer=function(){this.view.currentLayer++;var _45=this.view.getExtent(),_46=this.view.viewpoint.center;this.position=_46;var _47=_7.layout.EXTENT;var _48=new _6.StructArrayLayout4f16();_48.emplaceBack(_45.minx-_46[0],_46[1]-_45.maxy,0,0);_48.emplaceBack(_45.maxx-_46[0],_46[1]-_45.maxy,_47,0);_48.emplaceBack(_45.minx-_46[0],_46[1]-_45.miny,0,_47);_48.emplaceBack(_45.maxx-_46[0],_46[1]-_45.miny,_47,_47);this.viewportBuffer=this.view.context.createVertexBuffer(_48,[{name:"a_pos",type:"Float32",components:2,offset:0},{name:"a_texture_pos",type:"Float32",components:2,offset:8}]);_2.drawImageLayer(this);};_8.prototype.zoom=function(){if(this.visible){_2.drawImageLayer(this);}};_8.prototype.stop=function(){this.columns=[];if(this.intervalFlag){clearInterval(this.intervalFlag);}};return _8;});