//>>built
define("com/huayun/webgis/views/SceneViewBack",["dojo/_base/declare","dojo/topic","dojo/on","../Viewpoint","../geometry/Extent","../geometry/Point","../geometry/MapPoint","../views/View","../handler/PanHandler","com/huayun/webgis/gl/Context","com/huayun/webgis/layers/support/ZoomHistory","com/huayun/webgis/gl/VertexFragShader","com/huayun/webgis/gl/programConfig","com/huayun/webgis/gl/Program","../utils/utils","../utils/Color","../utils/TaskQueue","com/huayun/webgis/gl/LineAtlas"],function(_1,_2,on,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11){return _1("com.huayun.webgis.views.SceneView",[_7],{width:0,height:0,resolution:0,level:0,maxLevel:0,viewpoint:null,allLayerViews:[],extent:null,container:null,map:null,panEnabled:true,zoomEnabled:true,rotateEnabled:true,resizeEnabled:true,_load:false,_offsetLeft:0,_offsetTop:0,constructor:function(_12){this.container=_12.container;this.map=_12.map;this.allLayerViews=[];this._offsetLeft=this.container.getBoundingClientRect().left;this._offsetTop=this.container.getBoundingClientRect().top;this._extentDirty=true;this._clearBit=0|16384|256|1024;var _13=_12.pitch?_12.pitch:_12.is3DVision?50:0,_14=_12.angle?_12.angle:0;this.width=this.container.clientWidth;this.height=this.container.clientHeight;this.viewpoint=new _3(this.width,this.height,_13,_14,this);this._setupContainer(this.width,this.height);this._setupContext();this.zoomHistory=new _a();this.panEnabled=true;this.zoomEnabled=true;this.rotateEnabled=true;this.selectEnabled=true;this.resizeEnabled=true;this.emptyProgramConfiguration=new _c.ProgramConfiguration();this.lineAtlas=new _11(256,512);this.nochanging=true;var pan=new _8(this);this._handleAddedLayer();this._handleTopic();this._handleEvent();},_setupContainer:function(_15,_16){this.domNode=document.createElement("div");this.domNode.classList.add("webgis-root");var _17=document.createElement("canvas");_17.width=_15;_17.height=_16;this._canvas=_17;this._canvas.setAttribute("tabindex","0");this._canvas.setAttribute("aria-label","Map");this.domNode.appendChild(_17);this.container.appendChild(this.domNode);},_setupContext:function(){var _18={alpha:true,antialias:false,depth:true,failIfMajorPerformanceCaveat:false,preserveDrawingBuffer:false,stencil:true};this._gl=this._canvas.getContext("webgl",_18)||this._canvas.getContext("experimental-webgl",_18);this.context=new _9(this._gl);},_handleAddedLayer:function(){if(this.map.allLayers.length>0){var _19=this.map.allLayers[0].tileInfo;if(_19){this.viewpoint.setTileInfo(_19);this._load=true;}this.map.allLayers.forEach(function(_1a){this.allLayerViews.push(_1a.createLayerView(this));}.bind(this));}},_handleTopic:function(){_2.subscribe("addLayer",function(_1b){if(this.allLayerViews.length===0&&_1b[0].tileInfo){this.viewpoint.setTileInfo(_1b[0].tileInfo);this._load=true;}for(var i=0;i<_1b.length;i++){if(!_1b[i].maxLevel){_1b[i].maxLevel=this.maxLevel;}this.allLayerViews.push(_1b[i].createLayerView(this));}}.bind(this));_2.subscribe("tileInfoComplete",function(){var _1c=this.map.allLayers[0].tileInfo;if(!this.viewpoint.tileInfo&&_1c){this.viewpoint.setTileInfo(_1c);this._load=true;var _1d=_1c.lods;if(!this.maxLevel){this.maxLevel=_1d[_1d.length-1].level;}if(this.center){this.setCenter(this.center);}_2.publish("mapLoadComplete");}else{if(this._load&&this.center){this.setCenter(this.center);}}}.bind(this));_2.subscribe("threeRender",function(){this.threeRender();}.bind(this));},_handleEvent:function(){},setExtent:function(_1e){var _1f=_1e.getCenter();this.extent=_1e;if(!this.initCenter){this.initCenter=_1f;this.center=_1f;}if(!this._calResolution(_1e)&&!this.resolution){return;}this.setCenter(_1f);},getExtent:function(){if(this._extentDirty){var _20=this._bound;var _21=Math.min(_20[0].x,_20[1].x,_20[2].x,_20[3].x),_22=Math.max(_20[0].x,_20[1].x,_20[2].x,_20[3].x),_23=Math.min(_20[0].y,_20[1].y,_20[2].y,_20[3].y),_24=Math.max(_20[0].y,_20[1].y,_20[2].y,_20[3].y);this.extent=new _4(_21,_23,_22,_24);this._extentDirty=false;return this.extent;}else{return this.extent;}},setCenter:function(_25){if(!this.level&&!this._calLevel()){this.center=_25;return;}this.center=_25;this.refresh();},mapMove:function(_26,_27){if(this.panEnabled){var _28=-this.viewpoint.angle/180*Math.PI,_29=Math.sin(_28),_2a=Math.cos(_28);var _2b=_26*_2a-_27*_29,_2c=_26*_29+_27*_2a;var _2d=this.resolution*_2b,_2e=this.resolution*_2c;this.center.x-=_2d;this.center.y+=_2e;this.viewpoint.calcMatrix(this.center.x,this.center.y,this.resolution);this.threeRender();}},stopMove:function(){if(this.panEnabled){this.setCenter(this.center);}},_mouseRotate:function(_2f){if(this.rotateEnabled){var _30=_2f/1080*180;this.viewpoint.angle=(this.viewpoint.angle-_30)%360;this.viewpoint.updateBaseMatrix(this.center.x,this.center.y,this.resolution);this.threeRender();_2.publish("mapRotateAngle",this.viewpoint.angle);}},_stopMouseRotate:function(){if(this.rotateEnabled){this.setCenter(this.center);}},_mouseSwitchDip:function(_31){if(this.rotateEnabled){this.viewpoint.updatePitch(-_31/20,this.center.x,this.center.y,this.resolution);this.threeRender();}},_stopSwitch:function(){this.setCenter(this.center);},_calResolution:function(_32){var _33=_32.getWidth(),_34=_32.getHeight(),_35=this.viewpoint.width,_36=this.viewpoint.height;if(this._tileInfo&&this._tileInfo.lods.length>0){this.resolution=this._findNestZoom(Math.max(_33/_35,_34/_36));return true;}else{this.resolution=Math.max(_33/_35,_34/_36);return false;}},_calLevel:function(){if(this._tileInfo&&this._tileInfo.lods.length>0){this.resolution=this._findNestZoom(this.resolution);return true;}else{return false;}},_onClick:function(e){if(this.selectEnabled){}},_zoomMap:function(e){e.preventDefault();e.stopPropagation();if(e.wheelDelta>0){this.zoomInWheel(e.clientX-this._offsetLeft,e.clientY-this._offsetTop);}else{if(e.wheelDelta<0){this.zoomOutWheel(e.clientX-this._offsetLeft,e.clientY-this._offsetTop);}}},zoomInWheel:function(x,y){if(this.zoomEnabled&&this.viewpoint.zoom<this.maxLevel){this.zoomEnabled=false;setTimeout(function(){this.viewpoint.zoom=this.viewpoint.targetZoom;this.resolution=this.targetResolution;this.zoomEnabled=true;}.bind(this),400);this.viewpoint.startZoom=this.viewpoint.zoom;this.viewpoint.targetZoom=this.viewpoint.zoom+1;this.targetResolution=this._tileInfo.lods[this.viewpoint.targetZoom].resolution;var _37=this.screenToGeometry(x,y);this.deltaX=0;this.deltaY=0;this.viewpoint.readyMatrix(this.center.x+this.deltaX/2,this.center.y+this.deltaY/2,this.targetResolution);this._bound=this.viewpoint.calcBounds(this.targetResolution);this._extentDirty=true;this._handleZoomWheel(true);}},zoomOutWheel:function(x,y){if(this.zoomEnabled&&this.viewpoint.zoom>1){this.zoomEnabled=false;setTimeout(function(){this.viewpoint.zoom=this.viewpoint.targetZoom;this.resolution=this.targetResolution;this.zoomEnabled=true;}.bind(this),400);this.viewpoint.startZoom=this.viewpoint.zoom;this.viewpoint.targetZoom=this.viewpoint.zoom-1;this.targetResolution=this._tileInfo.lods[this.viewpoint.targetZoom].resolution;var _38=this.screenToGeometry(x,y);this.deltaX=0;this.deltaY=0;this.viewpoint.readyMatrix(this.center.x-this.deltaX,this.center.y-this.deltaY,this.targetResolution);this._bound=this.viewpoint.calcBounds(this.targetResolution);this._extentDirty=true;this._handleZoomWheel(false);}},_handleZoomWheel:function(_39){this.allLayerViews.forEach(function(_3a){_3a._readyData();});this.nochanging=false;if(_39){this._zoomWheelAnimateIn(null);}else{this._zoomWheelAnimateOut(null);}},_zoomWheelAnimateOut:function(_3b){if(!_3b){_3b=performance.now();}var _3c=performance.now()-_3b;if(_3c>=300){this.viewpoint.zoom=this.viewpoint.targetZoom;this.resolution=this.targetResolution;window.cancelAnimationFrame(this._animateRaf);this.nochanging=true;_2.publish("zoomEnd",this.resolution);this.center.x=this.center.x-this.deltaX;this.center.y=this.center.y-this.deltaY;this.viewpoint.updateCamera(this.center.x,this.center.y,this.resolution);this.threeRender();}else{var _3d=_3c/300;var _3e=Math.pow(2,-_3d);this.viewpoint.zoom=this.viewpoint.startZoom-_3d;var _3f=this._tileInfo.getResolution(this.viewpoint.zoom);this.resolution=_3f;_3e=1/_3e-1;this.viewpoint.updateCamera(this.center.x-this.deltaX*_3e,this.center.y-this.deltaY*_3e,_3f);this.animate(Math.pow(2,-_3d));this._animateRaf=window.requestAnimationFrame(this._zoomWheelAnimateOut.bind(this,_3b));}},_zoomWheelAnimateIn:function(_40){if(!_40){_40=performance.now();}var _41=performance.now()-_40;if(_41>=300){this.viewpoint.zoom=this.viewpoint.targetZoom;this.resolution=this.targetResolution;window.cancelAnimationFrame(this._animateRaf);this.nochanging=true;_2.publish("zoomEnd",this.resolution);this.center.x=this.center.x+this.deltaX/2;this.center.y=this.center.y+this.deltaY/2;this.viewpoint.updateCamera(this.center.x,this.center.y,this.resolution);this.threeRender();}else{var _42=_41/300;var _43=Math.pow(2,_42);this.viewpoint.zoom=this.viewpoint.startZoom+_42;var _44=this._tileInfo.getResolution(this.viewpoint.zoom);this.resolution=_44;_43=1-1/_43;this.viewpoint.updateCamera(this.center.x+this.deltaX*_43,this.center.y+this.deltaY*_43,_44);this.animate(Math.pow(2,_42));this._animateRaf=window.requestAnimationFrame(this._zoomWheelAnimateIn.bind(this,_40));}},zoomIn:function(){if(this.zoomEnabled&&this.viewpoint.zoom<this.maxLevel){this.zoomEnabled=false;setTimeout(function(){this.viewpoint.zoom=this.viewpoint.targetZoom;this.resolution=this.targetResolution;this.zoomEnabled=true;}.bind(this),400);this.viewpoint.startZoom=this.viewpoint.zoom;this.viewpoint.targetZoom=this.viewpoint.zoom+1;this.targetResolution=this._tileInfo.lods[this.viewpoint.targetZoom].resolution;this._state="zoomIn";this.setCenter(this.center);_2.publish("changeLevel",{level:this.viewpoint.targetZoom});}},getZoom:function(){return this.viewpoint.zoom;},getBearing:function(){return this.viewpoint.angle;},getPitch:function(){return this.viewpoint._pitch;},zoomOut:function(_45,_46){if(this.zoomEnabled&&this.viewpoint.zoom>1){this.zoomEnabled=false;setTimeout(function(){this.viewpoint.zoom=this.viewpoint.targetZoom;this.resolution=this.targetResolution;this.zoomEnabled=true;}.bind(this),400);this.viewpoint.startZoom=this.viewpoint.zoom;this.viewpoint.targetZoom=this.viewpoint.zoom-1;this.targetResolution=this._tileInfo.lods[this.viewpoint.targetZoom].resolution;this._state="zoomOut";this.setCenter(this.center);_2.publish("changeLevel",{level:this.viewpoint.targetZoom});}},_handleZoom:function(_47){this.allLayerViews.forEach(function(_48){_48._readyData();});this.nochanging=false;if(_47){this._zoomAnimateIn(null,1);}else{this._zoomAnimateOut(null,1);}},_zoomAnimateIn:function(_49){if(!_49){_49=performance.now();}var _4a=performance.now()-_49;if(_4a>=300){this.viewpoint.zoom=this.viewpoint.targetZoom;this.resolution=this.targetResolution;window.cancelAnimationFrame(this._animateRaf);this.nochanging=true;_2.publish("zoomEnd",this.resolution);this.viewpoint.updateCamera(this.center.x,this.center.y,this.resolution);this.threeRender();}else{var _4b=_4a/300;this.viewpoint.zoom=this.viewpoint.startZoom+_4b;var _4c=this._tileInfo.getResolution(this.viewpoint.zoom);this.resolution=_4c;this.viewpoint.updateCamera(this.center.x,this.center.y,_4c);this.animate(Math.pow(2,_4b));this._animateRaf=window.requestAnimationFrame(this._zoomAnimateIn.bind(this,_49));}},_zoomAnimateOut:function(_4d,_4e){if(!_4d){_4d=performance.now();}var _4f=performance.now()-_4d;if(_4f>=300){this.viewpoint.zoom=this.viewpoint.targetZoom;this.resolution=this.targetResolution;window.cancelAnimationFrame(this._animateRaf);this.nochanging=true;_2.publish("zoomEnd",this.resolution);this.viewpoint.updateCamera(this.center.x,this.center.y,this.resolution);this.threeRender();}else{var _50=_4f/300;this.viewpoint.zoom=this.viewpoint.startZoom-_50;var _51=this._tileInfo.getResolution(this.viewpoint.zoom);this.resolution=_51;this.viewpoint.updateCamera(this.center.x,this.center.y,_51);this.animate(Math.pow(2,-_50));this._animateRaf=window.requestAnimationFrame(this._zoomAnimateOut.bind(this,_4d,(1+_4f/300)));}},zoomTo:function(_52,_53,_54){return this.easeTo(_e.extend({zoom:_52},_53),_54);},_renderFrameCallback:function(_55){var t=Math.min((_e.now()-_55._easeStart)/_55._easeOptions.duration,1);_55._onEaseFrame(_55._easeOptions.easing(t));if(t<1){_55._easeFrameId=_55._requestRenderFrame(_55._renderFrameCallback);}else{_55.stop();}},_ease:function(_56,_57,_58){if(_58.animate===false||_58.duration===0){_56(1);_57();}else{this._easeStart=_e.now();this._easeOptions=_58;this._onEaseFrame=_56;this._onEaseEnd=_57;this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback);}},_requestRenderFrame:function(_59){this.threeRender();return this._renderTaskQueue.add(_59);},easeTo:function(_5a,_5b){var _5c=this;this.stop();_5a=_e.extend({offset:[0,0],duration:500,easing:_e.ease},_5a);if(_5a.animate===false){_5a.duration=0;}var tr=this.viewpoint,_5d=this.getZoom(),_5e=this.getBearing(),_5f=this.getPitch(),_60="zoom" in _5a?+_5a.zoom:_5d,_61="bearing" in _5a?this._normalizeBearing(_5a.bearing,_5e):_5e,_62="pitch" in _5a?+_5a.pitch:_5f;var _63=tr.zoomScale(_60-_5d);var _64,_65;if(_5a.around){_64=__chunk_1.LngLat.convert(_5a.around);_65=tr.locationPoint(_64);}this._zooming=(_60!==_5d);this._rotating=(_5e!==_61);this._pitching=(_62!==_5f);clearTimeout(this._easeEndTimeoutID);this._ease(function(k){if(_5c._zooming){tr.zoom=_e.number(_5d,_60,k);}if(_5c._rotating){tr.bearing=_e.number(_5e,_61,k);}if(_5c._pitching){tr.pitch=_e.number(_5f,_62,k);}if(_64){tr.setLocationAtPoint(_64,_65);}else{var _66=tr.zoomScale(tr.zoom-_5d);var _67=_60>_5d?Math.min(2,_63):Math.max(0.5,_63);var _68=Math.pow(_67,1-k);tr.setLocationAtPoint(this.center,this._tileInfo.getResolution(tr.zoom));}this.threeRender();},function(){if(_5a.delayEndEvents){_5c._easeEndTimeoutID=setTimeout(function(){return _5c._afterEase(_5b);},_5a.delayEndEvents);}else{_5c._afterEase(_5b);}},_5a);return this;},stop:function(){if(this._easeFrameId){this._cancelRenderFrame(this._easeFrameId);delete this._easeFrameId;delete this._onEaseFrame;}if(this._onEaseEnd){var _69=this._onEaseEnd;delete this._onEaseEnd;_69.call(this);}return this;},_cancelRenderFrame:function(id){this._renderTaskQueue.remove(id);},_afterEase:function(_6a){var _6b=this._zooming;var _6c=this._rotating;var _6d=this._pitching;this._moving=false;this._zooming=false;this._rotating=false;this._pitching=false;},threeRender:function(){if(!this._renderRaf&&this.nochanging){this._renderRaf=requestAnimationFrame(function(){this._renderRaf=null;this._gl.clear(this._clearBit);this.context.setDefault();this.allLayerViews.forEach(function(_6e){if(!_6e.is3D){_6e._render();}});this.context.setDefault();this._renderer.state.reset();this._gl.enable(this._gl.BLEND);this._renderer.render(this._scene,this._camera);this.allLayerViews.forEach(function(_6f){if(_6f.is3D){_6f._render();}});if(this.allLayerViews[0]._fadeDirty){this.allLayerViews[0]._fadeDirty=false;this.threeRender();}}.bind(this));}},animate:function(){if(!this._renderRaf){this._renderRaf=requestAnimationFrame(function(){this._renderRaf=null;this._gl.clear(this._clearBit);this.context.setDefault();this.allLayerViews.forEach(function(_70){if(!_70.is3D){_70.zoom();}});this._renderer.state.reset();this._gl.enable(this._gl.BLEND);this._renderer.render(this._scene,this._camera);this.allLayerViews.forEach(function(_71){if(_71.is3D){_71.zoom();}});}.bind(this));}},getTileTexture:function getTileTexture(_72){var _73=this._tileTextures[_72];return _73&&_73.length>0?_73.pop():null;},saveTileTexture:function(_74){var _75=this._tileTextures[_74.size[0]];if(!_75){this._tileTextures[_74.size[0]]=[_74];}else{_75.push(_74);}},rotateMap:function(_76){if(this.rotateEnabled){this.viewpoint.oldAngle=this.viewpoint.angle;this.viewpoint.angle=(this.viewpoint.angle+_76)%360;this.viewpoint.deltaAngle=_76;_2.publish("mapRotateAngle",this.viewpoint.angle);this._state="rotate";this.setCenter(this.center);}},_handleRotate:function(){this.allLayerViews.forEach(function(_77){_77._readyData();});this.nochanging=false;this._rotateAnimation(null,this.viewpoint.deltaAngle,0);},_rotateAnimation:function(_78,rad,d){if(!_78){_78=performance.now();}var _79=performance.now()-_78;if(_79>=500){this.viewpoint.angle=this.viewpoint.oldAngle+rad;this.viewpoint.updateBaseMatrix(this.center.x/this.resolution,this.center.y/this.resolution);window.cancelAnimationFrame(this._animateRaf);this.nochanging=true;this.allLayerViews.forEach(function(_7a){_7a._render();});}else{this.viewpoint.angle=this.viewpoint.oldAngle+rad*_79/500;this.viewpoint.updateBaseMatrix(this.center.x/this.resolution,this.center.y/this.resolution);this.animate(1);this._animateRaf=window.requestAnimationFrame(this._rotateAnimation.bind(this,_78,rad,_79));}},setDimensions:function(d){if(d===2&&this.is3DVision){this.viewpoint.oldPitch=this.viewpoint._pitch;this.viewpoint._pitch=0;this.viewpoint.deltaPitch=this.viewpoint._pitch-this.viewpoint.oldPitch;this.is3DVision=false;this._state="switch2D";this.allLayerViews.forEach(function(_7b){_7b.resize();});this.setCenter(this.center);_2.publish("mapSwitchDimension",2);}else{if(d===3&&!this.is3DVision){this.viewpoint.oldPitch=this.viewpoint._pitch;this.viewpoint._pitch=60;this.viewpoint.deltaPitch=this.viewpoint._pitch-this.viewpoint.oldPitch;this.is3DVision=true;this._state="switch3D";this.allLayerViews.forEach(function(_7c){_7c.resize();});this.setCenter(this.center);_2.publish("mapSwitchDimension",3);}}},_handleSwitch2D:function(){this.allLayerViews.forEach(function(_7d){_7d._readyData();});this.nochanging=false;this._switchAnimation(null,this.viewpoint.deltaPitch);},_handleSwitch3D:function(){this.allLayerViews.forEach(function(_7e){_7e._readyData();});this.nochanging=false;this._switchAnimation(null,this.viewpoint.deltaPitch);},_switchAnimation:function(_7f,rad){if(!_7f){_7f=performance.now();}var _80=performance.now()-_7f;if(_80>=500){this.viewpoint._pitch=this.viewpoint.oldPitch+rad;this.viewpoint.updateBaseMatrix(this.center.x/this.resolution,this.center.y/this.resolution);window.cancelAnimationFrame(this._animateRaf);this.nochanging=true;this.allLayerViews.forEach(function(_81){_81._render();});}else{this.viewpoint._pitch=this.viewpoint.oldPitch+rad*_80/500;this.viewpoint.updateBaseMatrix(this.center.x/this.resolution,this.center.y/this.resolution);this.animate(1);this._animateRaf=window.requestAnimationFrame(this._switchAnimation.bind(this,_7f,rad));}},refresh:function(){if(this._load){this.zoomHistory.update(this.level,_e.now());switch(this._state){case "zoomIn":this.viewpoint.readyMatrix(this.center.x,this.center.y,this.targetResolution);this._bound=this.viewpoint.calcBounds(this.targetResolution);this._extentDirty=true;this._handleZoom(true);this._state="default";break;case "zoomOut":this.viewpoint.readyMatrix(this.center.x,this.center.y,this.targetResolution);this._bound=this.viewpoint.calcBounds(this.targetResolution);this._extentDirty=true;this._handleZoom(false);this._state="default";break;case "rotate":this.viewpoint.updateBaseMatrix(this.center.x,this.center.y,this.resolution);this._bound=this.viewpoint.calcBounds(this.resolution);this._extentDirty=true;this._handleRotate();this._state="default";break;case "switch2D":this.viewpoint.updateBaseMatrix(this.center.x/this.resolution,this.center.y/this.resolution);this._bound=this.viewpoint.calcBounds(this.resolution);this._extentDirty=true;this.viewpoint.zoom=this.level;this._handleSwitch2D();this._state="default";break;case "switch3D":this.viewpoint.updateBaseMatrix(this.center.x/this.resolution,this.center.y/this.resolution);this._bound=this.viewpoint.calcBounds(this.resolution);this._extentDirty=true;this.viewpoint.zoom=this.level;this._handleSwitch3D();this._state="default";break;default:this.viewpoint.calcMatrix(this.center.x,this.center.y,this.resolution);this._bound=this.viewpoint.calcBounds(this.resolution);this._extentDirty=true;this.allLayerViews.forEach(function(_82){_82.refresh();});}}},_onResize:function(e){if(this.resizeEnabled){var _83=this.container.clientWidth,_84=this.container.clientHeight;_84=_84%2===0?_84:_84+1;this.resizeEnabled=false;setTimeout(function(){this.resizeEnabled=true;}.bind(this),100);this._containerWidth=_83;this._containerHeight=_84;this._camera.aspect=_83/_84;var fov=this._angle/180*Math.PI;var _85=this._angle;var _86=0.5/Math.tan(fov/2)*_84;this._distance=_86;this._camera.position.set(0,-_86*Math.sin(this.slope/180*Math.PI),_86*Math.cos(this.slope/180*Math.PI));this.halfUpHeight=_86*Math.sin(fov/2)/Math.sin((180-_85/2-this.slope-90)/180*Math.PI);this.halfDownHeight=_86*Math.sin(fov/2)/Math.sin((180-_85/2-(90-this.slope))/180*Math.PI);this.halfUpWidth=this.halfUpHeight*_83/_84;this.halfDownWidth=this.halfDownHeight*_83/_84;this.width=this.halfUpWidth+this.halfDownWidth;this.height=this.halfUpHeight+this.halfDownHeight;this._camera.updateProjectionMatrix();this._renderer.setSize(_83,_84);this.setExtent(null,this.center);}},selectObj:function(x,y){var _87=this._containerWidth,_88=this._containerHeight;this._mousePoint.x=((x-this._offsetLeft)/_87)*2-1;this._mousePoint.y=-((y-this._offsetTop)/_88)*2+1;this._raycaster.setFromCamera(this._mousePoint,this._camera);var _89={};var _8a=this.allLayerViews;for(var i=0,ii=_8a.length;i<ii;i++){var _8b=this._raycaster.intersectObject(_8a[i]._group,true);if(_8b.length>0){_89[_8a[i].id]=_8b;}}return _89;},_onMouseMove:function(e){if(this.selectEnabled){var x=e.clientX,y=e.clientY,_8c=this._containerWidth,_8d=this._containerHeight;this._mousePoint.x=((x-this._offsetLeft)/_8c)*2-1;this._mousePoint.y=-((y-this._offsetTop)/_8d)*2+1;this._raycaster.setFromCamera(this._mousePoint,this._camera);var _8e=this.findLayerViewById("vector");if(_8e){var _8f=this._raycaster.intersectObject(_8e._group,true);for(var i=_8f.length-1;i>-1;i--){if(_8f[i].object.isSprite){_2.publish("mapMovePOI",_8f[i].object.uuid,x,y);return;}}}_2.publish("mapMovePOI",false,x,y);}},_findNestZoom:function(_90){var _91=this._tileInfo.lods,len=_91.length,_92=0;for(var j=len-1;j>-1;j--){_92=_91[j].resolution/_90;if(_92<1.9&&_92>0.95){this.level=j;this.viewpoint.zoom=j;return _91[j].resolution;}}this.level=len-1;this.viewpoint.zoom=len-1;return _91[len-1].resolution;},_setScale:function(){var _93=Math.pow(2,this._initLevel-this.level);this.viewpoint.scale=isNaN(_93)?1:_93;},_getScale:function(){return this.viewpoint.scale;},findLayerViewById:function(id){for(var i=this.allLayerViews.length-1;i>-1;i--){if(this.allLayerViews[i].id===id){return this.allLayerViews[i];}}},setLevel:function(_94){this.level=_94;if(!this._tileInfo){this._tileInfo=this.map.allLayers[0].tileInfo;}this.resolution=this._tileInfo.lods[_94].resolution;var _95=this.extent.getCenter(),_96=this.width,_97=this.height;var _98=this.resolution*_96*0.5;var _99=this.resolution*_97*0.5;var _9a=_95.x-_98;var _9b=_95.x+_98;var _9c=_95.y-_99;var _9d=_95.y+_99;var _9e=new _4(_9a,_9c,_9b,_9d);this.setExtent(null,_9e.getCenter());},_calExtent:function(_9f,x,y){var rad=-this.viewpoint.rotation/180*Math.PI,_a0=Math.sin(rad),_a1=Math.cos(rad);var _a2=this.halfUpWidth*_a1,_a3=this.halfUpWidth*_a0,_a4=this.halfUpHeight*_a1,_a5=this.halfUpHeight*_a0,_a6=this.halfDownWidth*_a1,_a7=this.halfDownWidth*_a0,_a8=this.halfDownHeight*_a1,_a9=this.halfDownHeight*_a0;var _aa={x:-_a2+_a5,y:_a4+_a3},_ab={x:_a2+_a5,y:_a4-_a3},_ac={x:_a6-_a9,y:-_a8-_a7},_ad={x:-_a6-_a9,y:-_a8+_a7};var _ae=this.resolution;var _af={x:_9f.x+_aa.x*_ae,y:_9f.y+_aa.y*_ae},_b0={x:_9f.x+_ab.x*_ae,y:_9f.y+_ab.y*_ae},_b1={x:_9f.x+_ac.x*_ae,y:_9f.y+_ac.y*_ae},_b2={x:_9f.x+_ad.x*_ae,y:_9f.y+_ad.y*_ae};var _b3=Math.min(_af.x,_b0.x,_b1.x,_b2.x),_b4=Math.max(_af.x,_b0.x,_b1.x,_b2.x),_b5=Math.min(_af.y,_b0.y,_b1.y,_b2.y),_b6=Math.max(_af.y,_b0.y,_b1.y,_b2.y);this.center=_9f;this._bound=[_af,_b0,_b1,_b2];this.extent=new _4(_b3,_b5,_b4,_b6);},resetExtent:function(){var a=this.viewpoint.rotation;_2.publish("mapRotateAngle",0);this._group.rotateZ(a/180*Math.PI);this.viewpoint.rotation=0;var _b7=this._distance;var fov=0.6435011087932844;var _b8=this._angle;if(this.init3D){this.slope=this.maxSlope;this.is3DVision=true;}else{this.slope=0;this.is3DVision=false;}this._camera.position.set(0,-_b7*Math.sin(this.slope/180*Math.PI),_b7*Math.cos(this.slope/180*Math.PI));this._camera.lookAt(0,0,0);this.halfUpHeight=_b7*Math.sin(fov/2)/Math.sin((180-_b8/2-this.slope-90)/180*Math.PI);this.halfDownHeight=_b7*Math.sin(fov/2)/Math.sin((180-_b8/2-(90-this.slope))/180*Math.PI);this.halfUpWidth=this.halfUpHeight*this._ratio;this.halfDownWidth=this.halfDownHeight*this._ratio;this.width=this.halfUpWidth+this.halfDownWidth;this.height=this.halfUpHeight+this.halfDownHeight;this.resolution=this.startResolution;this.level=this.startLevel;this.setExtent(null,new _6(this.initCenter.x,this.initCenter.y,this.initCenter.z));},_screenToScene:function(x,y){var p=this.viewpoint.screenToGeometry(x,y);return new _5(p.x,p.y,0);},_sceneToScreen:function(x,y,z){var _b9=glMatrix.vec4.fromValues(x,y,z,1);glMatrix.vec4.transformMat4(_b9,_b9,this.viewpoint.matrix);var w=_b9[3];return {x:(_b9[0]/w+1)*this.viewpoint.width/2,y:-(_b9[1]/w-1)*this.viewpoint.height/2};},_sceneToGeometry:function(x,y,z){return new _5(x*this.resolution,y*this.resolution,0);},_geometryToScene:function(x,y,z){return new _5(x/this.resolution,y/this.resolution,0);},screenToGeometry:function(x,y){var p=this.viewpoint.screenToGeometry(x,y);return new _5(p.x,p.y,0);},geometryToScreen:function(x,y){var _ba=glMatrix.vec4.fromValues(x,y,0,1);glMatrix.vec4.transformMat4(_ba,_ba,this.viewpoint.matrix);var w=_ba[3];return {x:(_ba[0]/w+1)*this.viewpoint.width/2,y:-(_ba[1]/w-1)*this.viewpoint.height/2};},centerAt:function(x,y){var _bb=new _5(x,y);this.center=_bb;this.setExtent(null,_bb);},useProgram:function(_bc,_bd){if(_bd===void 0){_bd=this.emptyProgramConfiguration;}this.cache=this.cache||{};var key=""+_bc+(_bd.cacheKey||"");if(!this.cache[key]){this.cache[key]=new _d(this.context,_b[_bc],_bd,_b.programUniforms[_bc]);}return this.cache[key];}});});