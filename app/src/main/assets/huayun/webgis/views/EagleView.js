//>>built
define("com/huayun/webgis/views/EagleView",["dojo/topic","dojo/on","./View","../Viewpoint","../geometry/Extent","../geometry/Point","../geometry/MapPoint","../layers/GraphicLayer","../handler/PanHandler","com/huayun/webgis/gl/Context","com/huayun/webgis/layers/support/ZoomHistory","com/huayun/webgis/gl/VertexFragShader","com/huayun/webgis/gl/programConfig","com/huayun/webgis/gl/Program","com/huayun/webgis/gl/ProgramSimplify","../utils/utils","../utils/Color","../utils/TaskQueue","com/huayun/webgis/gl/LineAtlas"],function(_1,on,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12){var _13=function(_14){_2.call(this,_14);this._offsetLeft=this.container.getBoundingClientRect().left;this._offsetTop=this.container.getBoundingClientRect().top;this._clearBit=0|16384|256|1024;this._nochanging=true;this._extentDirty=true;this.numSublayers=_13.maxUnderzooming+_13.maxOverzooming+1;this.depthEpsilon=1/Math.pow(2,16);this.currentLayer=0;this.viewStates=[];this.backViewStates=[];this.viewStatesLength=10;var _15=_14.pitch?_14.pitch:_14.is3DVision?50:0,_16=_14.angle?_14.angle:0,_17=this.container.clientWidth,_18=this.container.clientHeight;this._setupContainer(_17,_18);this._setupContext();this.viewpoint=new _3(_17,_18,_15,_16,_14.maxLevel,_14.minLevel,0,this);this._tileTextures={};this.zoomHistory=new _a();this.panEnabled=true;this.zoomEnabled=true;this.rotateEnabled=true;this.selectEnabled=true;this.resizeEnabled=true;this.emptyProgramConfiguration=new _c.ProgramConfiguration();this.lineAtlas=new _12(256,512);this._handleAddedLayer();this._handleTopic();if(_14.center){if(_14.level){this.setCenter(_14.center,_14.level);}else{if(_14.resolution){this.setCenter(_14.center,null,_14.resolution);}else{throw new Error("通过中心点设置初始状态必须包含层级或分辨率");}}}else{if(_14.extent){this.setExtent(_14.extent);}}this.numSublayers=3+10+1;this.depthEpsilon=1/Math.pow(2,16);};if(_2){_13.__proto__=_2;}_13.prototype=Object.create(_2&&_2.prototype);_13.prototype.constructor=_13;var _19={width:{configurable:true},height:{configurable:true},resolution:{configurable:true},level:{configurable:true},center:{configurable:true},is3DVision:{configurable:true},extent:{configurable:true}};_19.width.get=function(){return this.viewpoint.width;};_19.height.get=function(){return this.viewpoint.height;};_19.resolution.get=function(){return this.viewpoint.resolution;};_19.level.get=function(){return this.viewpoint.level;};_19.center.get=function(){var _1a=this.viewpoint.center;return {x:_1a[0],y:_1a[1],z:0};};_19.is3DVision.get=function(){return this.viewpoint.pitch!==0;};_19.extent.get=function(){if(this._extentDirty){var _1b=this._bound;var _1c=Math.min(_1b[0].x,_1b[1].x,_1b[2].x,_1b[3].x),_1d=Math.max(_1b[0].x,_1b[1].x,_1b[2].x,_1b[3].x),_1e=Math.min(_1b[0].y,_1b[1].y,_1b[2].y,_1b[3].y),_1f=Math.max(_1b[0].y,_1b[1].y,_1b[2].y,_1b[3].y);this._extent=new _4(_1c,_1e,_1d,_1f);this._extentDirty=false;return this._extent;}else{return this._extent;}};_13.prototype._setupContainer=function(_20,_21){this.domNode=document.createElement("div");this.domNode.classList.add("webgis-root");var _22=document.createElement("canvas");_22.width=_20;_22.height=_21;this._canvas=_22;this._canvas.setAttribute("tabindex","0");this._canvas.setAttribute("aria-label","Map");this.domNode.appendChild(_22);this.container.appendChild(this.domNode);};_13.prototype._setupContext=function(){var _23={alpha:true,antialias:false,depth:true,failIfMajorPerformanceCaveat:false,preserveDrawingBuffer:false,stencil:true};this._gl=this._canvas.getContext("webgl",_23)||this._canvas.getContext("experimental-webgl",_23);this.context=new _9(this._gl);};_13.prototype._handleAddedLayer=function(){if(this.map.allLayers.length>0){var _24=this.map.allLayers[0].tileInfo;if(_24){this.viewpoint.setTileInfo(_24);this._load=true;}this.map.allLayers.forEach(function(_25){this.allLayerViews.push(_25.createLayerView(this));}.bind(this));}};_13.prototype._handleTopic=function(){_1.subscribe("addLayer",function(_26,id){if(id!==this.map.id){return;}if(this.allLayerViews.length===0&&_26[0].tileInfo){this.viewpoint.setTileInfo(_26[0].tileInfo);this._load=true;}for(var i=0;i<_26.length;i++){this.allLayerViews.push(_26[i].createLayerView(this));}}.bind(this));};_13.prototype.setTileInfo=function(_27){if(this._load){return;}if(!this.viewpoint.tileInfo&&_27){this.viewpoint.setTileInfo(_27);this._load=true;if(this.viewpoint.level||this.viewpoint.resolution){this.setCenter(this.viewpoint.center,this.viewpoint.level,this.viewpoint.resolution);}}else{this.setCenter(this.center);}};_13.prototype.setCenter=function(_28,_29,_2a){if(_29){this.viewpoint.setLevel(_29);this.viewpoint.setCenter(_28);}else{if(_2a){this.viewpoint.setResolution(_2a,this._load);this.viewpoint.setCenter(_28);}}this.refresh();};_13.prototype.setMapCenter=function(_2b){this.viewpoint.setCenter(_2b);this.refresh();};_13.prototype.setExtent=function(_2c){if(_2c instanceof _4){var _2d=_2c.getCenter();var w=_2c.getWidth(),h=_2c.getHeight(),_2e=this.viewpoint.width,_2f=this.viewpoint.height;this.viewpoint.setCenter([_2d.x,_2d.y]);this.viewpoint.setResolution(Math.max(w/_2e,h/_2f),true);this.refresh();}};_13.prototype.getExtent=function(){if(this._extentDirty){var _30=this._bound;var _31=Math.min(_30[0].x,_30[1].x,_30[2].x,_30[3].x),_32=Math.max(_30[0].x,_30[1].x,_30[2].x,_30[3].x),_33=Math.min(_30[0].y,_30[1].y,_30[2].y,_30[3].y),_34=Math.max(_30[0].y,_30[1].y,_30[2].y,_30[3].y);this._extent=new _4(_31,_33,_32,_34);this._extentDirty=false;return this._extent;}else{return this._extent;}};_13.prototype.setView=function(_35){var _36;if(_35&&this.viewStates.length>1){this.backViewStates.push(this.viewStates.pop());_36=this.viewStates[this.viewStates.length-1];this.viewpoint.setView(_36);this.refresh(true);}else{if(!_35&&this.backViewStates.length>0){this.viewStates.push(this.backViewStates.pop());_36=this.viewStates[this.viewStates.length-1];this.viewpoint.setView(_36);this.refresh(true);}}};_13.prototype.refresh=function(_37){if(!this._load){return;}this.zoomHistory.update(this.viewpoint.level,_f.now());this.viewpoint.calcMatrix(true);this._bound=this.viewpoint.calcBounds();this._extentDirty=true;_1.publish("extentChangeEvent",this);if(!_37){this.handlePushViewState();}this.allLayerViews.forEach(function(_38){_38.refresh();});this.threeRender();};_13.prototype.handlePushViewState=function(){if(this.viewStates.length<this.viewStatesLength){this.viewStates.push({pitch:this.viewpoint.pitch,angle:this.viewpoint.angle,level:this.viewpoint.targetZoom||this.viewpoint.level,center:this.viewpoint.center});}else{this.viewStates.shift();this.viewStates.push({pitch:this.viewpoint.pitch,angle:this.viewpoint.angle,level:this.viewpoint.targetZoom||this.viewpoint.level,center:this.viewpoint.center});}this.backViewStates=[];};_13.prototype.centerAt=function(x,y,_39){if(_39&&_39!==this.viewpoint.level){this.viewpoint.setLevel(_39);}this.viewpoint.setCenter([x,y]);this.viewpoint.calcMatrix(true);this.refresh();};_13.prototype.findLayerViewById=function(id){for(var i=this.allLayerViews.length-1;i>-1;i--){if(this.allLayerViews[i].id===id){return this.allLayerViews[i];}}};_13.prototype.screenToGeometry=function(x,y){x=x-this._offsetLeft;y=y-this._offsetTop;var p=this.viewpoint.screenToGeometry(x,y);return new _5(p.x,p.y,0);};_13.prototype.getTileTexture=function getTileTexture(_3a){var _3b=this._tileTextures[_3a];return _3b&&_3b.length>0?_3b.pop():null;};_13.prototype.saveTileTexture=function(_3c){var _3d=this._tileTextures[_3c.size[0]];if(!_3d){this._tileTextures[_3c.size[0]]=[_3c];}else{_3d.push(_3c);}};_13.prototype.useProgram=function(_3e,_3f){if(_3f===void 0){_3f=this.emptyProgramConfiguration;}this.cache=this.cache||{};var key=""+_3e+(_3f.cacheKey||"");if(!this.cache[key]){this.cache[key]=new _d(this.context,_b[_3e],_3f,_b.programUniforms[_3e]);}return this.cache[key];};_13.prototype.useProgramSimplify=function(_40,_41){this.simplifyCache=this.simplifyCache||{};if(!this.simplifyCache[_40]){this.simplifyCache[_40]=new _e(this.context,_b[_40],_41,_b.programUniforms[_40]);}return this.simplifyCache[_40];};_13.prototype.threeRender=function(){if(!this._renderRaf&&this._nochanging){this._renderRaf=requestAnimationFrame(function(){this._renderRaf=null;this._gl.clear(this._clearBit);this.currentLayer=0;this.depthRangeFor3D=[0,1-((1+2)*this.numSublayers*this.depthEpsilon)];this.context.setDefault();this.allLayerViews.forEach(function(_42){_42._render();});if(this.allLayerViews[0]._fadeDirty){this.allLayerViews[0]._fadeDirty=false;this.threeRender();}}.bind(this));}};Object.defineProperties(_13.prototype,_19);_13.prototype._zoomMap=function(e){if(e.wheelDelta>0){this.zoomInWheel(e.clientX,e.clientY);}else{if(e.wheelDelta<0){this.zoomOutWheel(e.clientX,e.clientY);}}};_13.prototype.zoomInWheel=function(x,y){if(this.zoomEnabled&&this.viewpoint.level<this.viewpoint.maxLevel){this.zoomEnabled=false;setTimeout(function(){this.zoomEnabled=true;}.bind(this),400);this.viewpoint.startZoom=this.viewpoint.level;this.viewpoint.targetZoom=this.viewpoint.level+1;var _43=this.screenToGeometry(x,y);var _44=this.viewpoint.center;this.deltaX=_43.x-_44[0];this.deltaY=_43.y-_44[1];this.viewpoint.readyMatrix(_44[0]+this.deltaX/2,_44[1]+this.deltaY/2,this.viewpoint.targetZoom);this._bound=this.viewpoint.calcBounds();this._extentDirty=true;this._handleZoomWheel(true);}};_13.prototype.zoomOutWheel=function(x,y){if(this.zoomEnabled&&this.viewpoint.level>1){this.zoomEnabled=false;setTimeout(function(){this.zoomEnabled=true;}.bind(this),400);this.viewpoint.startZoom=this.viewpoint.level;this.viewpoint.targetZoom=this.viewpoint.level-1;var _45=this.screenToGeometry(x,y);var _46=this.viewpoint.center;this.deltaX=_45.x-_46[0];this.deltaY=_45.y-_46[1];this.viewpoint.readyMatrix(_46[0]-this.deltaX,_46[1]-this.deltaY,this.viewpoint.targetZoom);this._bound=this.viewpoint.calcBounds();this._extentDirty=true;this._handleZoomWheel(false);}};_13.prototype.zoomIn=function(){if(this.zoomEnabled&&this.viewpoint.level<this.viewpoint.maxLevel){this.zoomEnabled=false;setTimeout(function(){this.zoomEnabled=true;}.bind(this),300);this.viewpoint.startZoom=this.viewpoint.level;this.viewpoint.targetZoom=this.viewpoint.level+1;var _47=this.viewpoint.center;this.viewpoint.readyMatrix(_47[0],_47[1],this.viewpoint.targetZoom);this._bound=this.viewpoint.calcBounds();this._extentDirty=true;this._handleZoom(true);}};_13.prototype.zoomOut=function(){if(this.zoomEnabled&&this.viewpoint.level>1){this.zoomEnabled=false;setTimeout(function(){this.zoomEnabled=true;}.bind(this),300);this.viewpoint.startZoom=this.viewpoint.level;this.viewpoint.targetZoom=this.viewpoint.level-1;var _48=this.viewpoint.center;this.viewpoint.readyMatrix(_48[0],_48[1],this.viewpoint.targetZoom);this._bound=this.viewpoint.calcBounds();this._extentDirty=true;this._handleZoom(false);}};_13.prototype._handleZoom=function(_49){this.allLayerViews.forEach(function(_4a){_4a._readyData();});this._nochanging=false;if(_49){this._zoomAnimateIn(null,1);}else{this._zoomAnimateOut(null,1);}};_13.prototype._handleZoomWheel=function(_4b){this.allLayerViews.forEach(function(_4c){_4c._readyData();});this._nochanging=false;if(_4b){this._zoomWheelAnimateIn(null);}else{this._zoomWheelAnimateOut(null);}};_13.prototype._zoomWheelAnimateOut=function(_4d){if(!_4d){_4d=performance.now();}var _4e=performance.now()-_4d;var _4f=this.viewpoint.center;if(_4e>=300){window.cancelAnimationFrame(this._animateRaf);this._nochanging=true;this.viewpoint.setCenter([_4f[0]-this.deltaX,_4f[1]-this.deltaY]);this.viewpoint.setLevel(this.viewpoint.targetZoom);this.viewpoint.calcMatrix(true);this.handlePushViewState();this._renderRaf=null;this.threeRender();}else{var _50=_4e/300;var _51=1/Math.pow(2,-_50)-1;this.viewpoint.updateMatrix(_4f[0]-this.deltaX*_51,_4f[1]-this.deltaY*_51,this.viewpoint.startZoom-_50);this.animate();this._animateRaf=window.requestAnimationFrame(this._zoomWheelAnimateOut.bind(this,_4d));}};_13.prototype._zoomAnimateOut=function(_52){if(!_52){_52=performance.now();}var _53=performance.now()-_52;var _54=this.viewpoint.center;if(_53>=300){window.cancelAnimationFrame(this._animateRaf);this._nochanging=true;this.viewpoint.setCenter([_54[0],_54[1]]);this.viewpoint.setLevel(this.viewpoint.targetZoom);this.viewpoint.calcMatrix(true);this.handlePushViewState();this._renderRaf=null;this.threeRender();}else{var _55=_53/300;this.viewpoint.updateMatrix(_54[0],_54[1],this.viewpoint.startZoom-_55);this.animate();this._animateRaf=window.requestAnimationFrame(this._zoomAnimateOut.bind(this,_52));}};_13.prototype._zoomWheelAnimateIn=function(_56){if(!_56){_56=performance.now();}var _57=performance.now()-_56;var _58=this.viewpoint.center;if(_57>=300){window.cancelAnimationFrame(this._animateRaf);this._nochanging=true;this.viewpoint.setCenter([_58[0]+this.deltaX/2,_58[1]+this.deltaY/2]);this.viewpoint.setLevel(this.viewpoint.targetZoom);this.viewpoint.calcMatrix(true);this._renderRaf=null;this.handlePushViewState();this.threeRender();}else{var _59=_57/300;var _5a=1-1/Math.pow(2,_59);this.viewpoint.updateMatrix(_58[0]+this.deltaX*_5a,_58[1]+this.deltaY*_5a,this.viewpoint.startZoom+_59);this.animate();this._animateRaf=window.requestAnimationFrame(this._zoomWheelAnimateIn.bind(this,_56));}};_13.prototype._zoomAnimateIn=function(_5b){if(!_5b){_5b=performance.now();}var _5c=performance.now()-_5b;var _5d=this.viewpoint.center;if(_5c>=300){window.cancelAnimationFrame(this._animateRaf);this._nochanging=true;this.viewpoint.setCenter([_5d[0],_5d[1]]);this.viewpoint.setLevel(this.viewpoint.targetZoom);this.viewpoint.calcMatrix(true);this._renderRaf=null;this.handlePushViewState();this.threeRender();}else{var _5e=_5c/300;this.viewpoint.updateMatrix(_5d[0],_5d[1],this.viewpoint.startZoom+_5e);this.animate();this._animateRaf=window.requestAnimationFrame(this._zoomAnimateIn.bind(this,_5b));}};_13.prototype.mapMove=function(_5f,_60){if(this.panEnabled){var _61=-this.viewpoint.angle/180*Math.PI,_62=Math.sin(_61),_63=Math.cos(_61),_64=this.viewpoint.resolution,_65=this.viewpoint.center;var _66=_5f*_63-_60*_62,_67=_5f*_62+_60*_63;var _68=_64*_66,_69=_64*_67;this.viewpoint.setCenter([_65[0]-_68,_65[1]+_69]);this.viewpoint.calcMatrix(true);this.threeRender();}};_13.prototype.stopMove=function(){if(this.panEnabled){this.refresh(true);}};_13.prototype.pan=function(x,y){if(this.panEnabled){var _6a=-this.viewpoint.angle/180*Math.PI,_6b=Math.sin(_6a),_6c=Math.cos(_6a),_6d=this.viewpoint.center;var _6e=x*_6c-y*_6b,_6f=x*_6b+y*_6c;this.viewpoint.setCenter([_6d[0]-_6e,_6d[1]+_6f]);this.viewpoint.calcMatrix(true);this.refresh(false);}};_13.prototype._mouseRotate=function(_70){if(this.rotateEnabled){var _71=_70/1080*180;this.viewpoint.angle=(this.viewpoint.angle-_71)%360;this.viewpoint.updateBaseMatrix();this.threeRender();}};_13.prototype._stopMouseRotate=function(){if(this.rotateEnabled){this.refresh(true);}};_13.prototype.rotateMap=function(_72){if(this.rotateEnabled){this.viewpoint.oldAngle=this.viewpoint.angle;this.viewpoint.angle=(this.viewpoint.angle+_72)%360;this.viewpoint.deltaAngle=_72;this.viewpoint.updateBaseMatrix();this._bound=this.viewpoint.calcBounds();this._extentDirty=true;this._handleRotate();}};_13.prototype._handleRotate=function(){this.allLayerViews.forEach(function(_73){_73._readyData();});this._nochanging=false;this._rotateAnimation(null,this.viewpoint.deltaAngle,0);};_13.prototype._rotateAnimation=function(_74,rad,d){if(!_74){_74=performance.now();}var _75=performance.now()-_74;var _76=this.viewpoint.center;if(_75>=500){window.cancelAnimationFrame(this._animateRaf);this._nochanging=true;this.viewpoint.angle=this.viewpoint.oldAngle+rad;this.viewpoint.updateBaseMatrix();this.handlePushViewState();this.threeRender();}else{this.viewpoint.angle=this.viewpoint.oldAngle+rad*_75/500;this.viewpoint.updateBaseMatrix();this.animate();this._animateRaf=window.requestAnimationFrame(this._rotateAnimation.bind(this,_74,rad,_75));}};_13.prototype._mouseSwitchDip=function(_77){if(this.rotateEnabled){this.viewpoint.updatePitch(-_77/20);this.threeRender();}};_13.prototype._stopSwitch=function(){if(this.rotateEnabled){this.refresh(true);}};_13.prototype.setDimensions=function(d){if(d===2&&this.viewpoint.pitch!==0){this.viewpoint.oldPitch=this.viewpoint.pitch;this.viewpoint.pitch=0;this.viewpoint.deltaPitch=this.viewpoint.pitch-this.viewpoint.oldPitch;this.viewpoint.updateBaseMatrix();this._bound=this.viewpoint.calcBounds();this._extentDirty=true;this._handleSwitch2D();}else{if(d===3&&this.viewpoint.pitch!==50){this.viewpoint.oldPitch=this.viewpoint.pitch;this.viewpoint.pitch=50;this.viewpoint.deltaPitch=this.viewpoint.pitch-this.viewpoint.oldPitch;this.viewpoint.updateBaseMatrix();this._bound=this.viewpoint.calcBounds();this._extentDirty=true;this._handleSwitch3D();}}};_13.prototype._handleSwitch2D=function(){this.allLayerViews.forEach(function(_78){_78._readyData();});this._nochanging=false;this._switchAnimation(null,this.viewpoint.deltaPitch);};_13.prototype._handleSwitch3D=function(){this.allLayerViews.forEach(function(_79){_79._readyData();});this._nochanging=false;this._switchAnimation(null,this.viewpoint.deltaPitch);};_13.prototype._switchAnimation=function(_7a,rad){if(!_7a){_7a=performance.now();}var _7b=performance.now()-_7a;if(_7b>=500){window.cancelAnimationFrame(this._animateRaf);this._nochanging=true;this.viewpoint.pitch=this.viewpoint.oldPitch+rad;this.viewpoint.updateBaseMatrix();this.handlePushViewState();this.threeRender();}else{this.viewpoint.pitch=this.viewpoint.oldPitch+rad*_7b/500;this.viewpoint.updateBaseMatrix();this.animate();this._animateRaf=window.requestAnimationFrame(this._switchAnimation.bind(this,_7a,rad));}};_13.prototype.animate=function(){if(!this._renderRaf){this._renderRaf=requestAnimationFrame(function(){this._renderRaf=null;this._gl.clear(this._clearBit);this.currentLayer=0;this.context.setDefault();this.allLayerViews.forEach(function(_7c){_7c.zoom();});}.bind(this));}};_13.prototype.setCustomLayerDefaults=function(){this.context.unbindVAO();this.context.cullFace.setDefault();this.context.activeTexture.setDefault();this.context.pixelStoreUnpack.setDefault();this.context.pixelStoreUnpackPremultiplyAlpha.setDefault();this.context.pixelStoreUnpackFlipY.setDefault();};_13.prototype.setBaseState=function setBaseState(){var gl=this.context.gl;this.context.cullFace.set(false);this.context.viewport.set([0,0,this.width,this.height]);this.context.blendEquation.set(gl.FUNC_ADD);};_13.prototype.queryFeaturesByGeometry=function(_7d,_7e){_7e=_7e;var _7f=this.map.allLayers;var _80={};_7f.forEach(function(_81){if(_81.selectEnabled){if(_81 instanceof _7){_81.createIndex();}_80[_81.id]=_81.queryFeaturesByGeometry(_7d,8);}});return _80;};_13.prototype.addTask=function(_82){this._renderRaf=requestAnimationFrame(function(){this._renderRaf=null;this._gl.clear(this._clearBit);this.currentLayer=0;this.depthRangeFor3D=[0,1-((1+2)*this.numSublayers*this.depthEpsilon)];this.context.setDefault();this.allLayerViews.forEach(function(_83){_83._render();});if(this.allLayerViews[0]._fadeDirty){this.allLayerViews[0]._fadeDirty=false;this.threeRender();}else{_82();}}.bind(this));};_13.prototype.calcBounds=function(_84,_85,_86,_87){return this.viewpoint.calcBound(_84,_85,_86,_87);};_13.maxOverzooming=10;_13.maxUnderzooming=3;return _13;});