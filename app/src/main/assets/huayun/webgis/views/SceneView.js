//>>built
define("com/huayun/webgis/views/SceneView","dojo/topic dojo/on dojo/DeferredList dojo/promise/Promise dojo/dom-construct ./View ../Viewpoint ../geometry/Extent ../geometry/Point ../geometry/Polygon ../geometry/MapPoint ../layers/GraphicLayer ../handler/PanHandler ../handler/TouchHandler com/huayun/webgis/gl/Context com/huayun/webgis/layers/support/ZoomHistory com/huayun/webgis/gl/VertexFragShader com/huayun/webgis/gl/programConfig com/huayun/webgis/gl/Program com/huayun/webgis/gl/ProgramSimplify ../utils/utils ../utils/Color ../utils/TaskQueue com/huayun/webgis/gl/LineAtlas ../data/GraphicsIndex ../data/queryIntersects ../gl/draw/drawBackground ../utils/Resource ../gl/Texture ../utils/animation".split(" "),
function(f,u,v,w,A,p,B,q,n,l,P,Q,C,D,E,F,r,G,H,I,x,y,J,K,L,t,M,N,O,z){var c=function(a){p.call(this,a);this._offsetLeft=this.container.getBoundingClientRect().left;this._offsetTop=this.container.getBoundingClientRect().top;this._clearBit=17664;this._extentDirty=this._nochanging=!0;this.backgroundColor=y.parse(a.backgroundColor||"#FFFFFF");this.numSublayers=c.maxUnderzooming+c.maxOverzooming+1;this.depthEpsilon=1/Math.pow(2,16);this.currentLayer=0;this.viewStates=[];this.backViewStates=[];this.viewStatesLength=
10;this._initState=null;this.antialias=!!a.antialias;this.zooming=!1;var b=a.pitch?a.pitch:a.is3DVision?50:0,d=a.angle?a.angle:0,e=this.container.clientWidth,k=this.container.clientHeight,g=a.maxPitch||50;this._setupContainer(e,k);this._setupContext();this.viewpoint=new B(e,k,b,d,a.maxLevel,a.minLevel,g,this);this._tileTextures={};this.zoomHistory=new F;this.zoomEnabled=this.panEnabled=!0;this.rotateEnabled=void 0===a.rotateEnabled?!0:a.rotateEnabled;this.resizeEnabled=this.selectEnabled=!0;this.emptyProgramConfiguration=
new G.ProgramConfiguration;this.lineAtlas=new K(256,512);this._offsetLeft=this.container.getBoundingClientRect().left;this._offsetTop=this.container.getBoundingClientRect().top;this.graphicsIndex=new L;new C(this);new D(this);this._handleEvent();if(a.center)if(a.level)this.setCenter(a.center,a.level);else if(a.resolution)this.setCenter(a.center,null,a.resolution);else throw Error("\u901a\u8fc7\u4e2d\u5fc3\u70b9\u8bbe\u7f6e\u521d\u59cb\u72b6\u6001\u5fc5\u987b\u5305\u542b\u5c42\u7ea7\u6216\u5206\u8fa8\u7387");
else a.extent&&this.setExtent(a.extent);this.numSublayers=14;this.depthEpsilon=1/Math.pow(2,16);var h=this;a.backgroundImage&&N.loadImage(a.backgroundImage,function(a,b){if(b){a=h.context;var d=a.gl;h._backgroundTexture=new O(a,b,d.RGBA,{useMipmap:!0});h._backgroundTexture.bind(d.LINEAR,d.CLAMP_TO_EDGE,d.LINEAR_MIPMAP_NEAREST);a.extTextureFilterAnisotropic&&d.texParameterf(d.TEXTURE_2D,a.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,a.extTextureFilterAnisotropicMax);h.threeRender()}});this.zoomEnd=
[];this._renderTaskQueue=new J;this._handleAddedLayer()};p&&(c.__proto__=p);c.prototype=Object.create(p&&p.prototype);c.prototype.constructor=c;l={width:{configurable:!0},height:{configurable:!0},resolution:{configurable:!0},level:{configurable:!0},center:{configurable:!0},is3DVision:{configurable:!0},extent:{configurable:!0},nearestResolution:{configurable:!0},scale:{configurable:!0}};l.width.get=function(){return this.viewpoint.width};l.height.get=function(){return this.viewpoint.height};l.resolution.get=
function(){return this.viewpoint.resolution};l.scale.get=function(){return.0254000508001016/(96*this.resolution)};l.level.get=function(){return this.viewpoint.level};l.center.get=function(){var a=this.viewpoint.center;return new n(a[0],a[1],0)};l.is3DVision.get=function(){return 0!==this.viewpoint.pitch};l.extent.get=function(){if(this._extentDirty){var a=this._bound;return this._bound?(this._extent=new q(Math.min(a[0].x,a[1].x,a[2].x,a[3].x),Math.min(a[0].y,a[1].y,a[2].y,a[3].y),Math.max(a[0].x,
a[1].x,a[2].x,a[3].x),Math.max(a[0].y,a[1].y,a[2].y,a[3].y)),this._extentDirty=!1,this._extent):null}return this._extent};c.prototype._setupContainer=function(a,b){this.domNode=document.createElement("div");this.domNode.classList.add("webgis-root");var d=document.createElement("canvas");d.width=a;d.height=b;this._canvas=d;this._canvas.setAttribute("tabindex","0");this._canvas.setAttribute("aria-label","Map");this.domNode.appendChild(d);this.container.appendChild(this.domNode)};c.prototype._setupContext=
function(){var a={alpha:!0,antialias:this.antialias,depth:!0,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,stencil:!0};this._gl=this._canvas.getContext("webgl",a)||this._canvas.getContext("experimental-webgl",a);this.context=new E(this._gl)};c.prototype._handleAddedLayer=function(){if(0<this.map.allLayers.length){var a=this.map.allLayers[0].type;if(!a||0>a.indexOf("Tile"))this._load=!0;else if(a=this.map.allLayers[0].tileInfo)this.viewpoint.setTileInfo(a),this._load=!0;this.map.allLayers.forEach(function(a){this.allLayerViews.push(a.createLayerView(this))}.bind(this))}};
c.prototype.setTileInfo=function(){var a=this,b=this.map.allLayers[0].tileInfo;b&&(this.viewpoint.tileInfo?setTimeout(function(){a.setCenter(a.center)},0):(this.viewpoint.setTileInfo(b),this._load=!0,(this.viewpoint.level||this.viewpoint.resolution)&&this.setCenter(this.viewpoint.center,this.viewpoint.level,this.viewpoint.resolution),f.publish("mapLoadComplete")))};c.prototype._handleEvent=function(){this.map.on("addLayers",function(a,b,d){var e=this.map.allLayers[0].type;if(!e||0>e.indexOf("Tile"))this._load=
!0;else if(e=this.map.allLayers[0].tileInfo)this.viewpoint.setTileInfo(e),this._load=!0;for(e=0;e<a.length;e++)b?this.allLayerViews.splice(d,0,a[e].createLayerView(this)):this.allLayerViews.push(a[e].createLayerView(this))}.bind(this));this.map.on("removeLayers",function(a){for(var b=0;b<a.length;b++)for(var d=a[b],e=this.allLayerViews.length-1;-1<e;e--)if(this.allLayerViews[e].id===d){debugger;this.allLayerViews[e].beforeRemove(this);this.allLayerViews.splice(e,1);break}}.bind(this));u(this.domNode,
"mousewheel",this._zoomMap.bind(this));u(window,"resize",this._onResize.bind(this))};c.prototype._onResize=function(){if(this.resizeEnabled){var a=this.container.clientWidth,b=this.container.clientHeight;a&&b&&(this.resizeEnabled=!1,setTimeout(function(){this.resizeEnabled=!0}.bind(this),100),this._canvas.width=a,this._canvas.height=b,this._canvas.style.width=a+"px",this._canvas.style.height=b+"px",this.context.viewport.set([0,0,this._canvas.width,this._canvas.height]),this.viewpoint.resize(a,b),
this._offsetLeft=this.container.getBoundingClientRect().left,this._offsetTop=this.container.getBoundingClientRect().top,this.allLayerViews.forEach(function(a){a.resize()}),this.refresh())}};c.prototype.expand=function(a){var b=this.width/2*a*this.resolution;a=this.height/2*a*this.resolution;b=new q(this.center.x-b,this.center.y-a,this.center.x+b,this.center.y+a);this.setExtent(b)};c.prototype.setCenter=function(a,b,d){if(b){var e=this.viewpoint.level;this.viewpoint.setLevel(b);this.viewpoint.setCenter(a);
a=this.viewpoint.level;e!==a&&f.publish("changeLevel",{level:this.viewpoint.level})}else d?(e=this.viewpoint.level,this.viewpoint.setResolution(d,this._load),this.viewpoint.setCenter(a),a=this.viewpoint.level,e!==a&&f.publish("changeLevel",{level:this.viewpoint.level})):this.viewpoint.setCenter(a);this.refresh()};c.prototype.setExtent=function(a,b){if(a instanceof q){var d=a.getCenter(),e=a.getWidth();a=a.getHeight();var c=this.viewpoint.width,g=this.viewpoint.height,h=this.viewpoint.level;this.viewpoint.setCenter([d.x,
d.y]);this.viewpoint.setResolution(Math.max(e/c,a/g),!0);this._extentDirty=!0;h!==this.viewpoint.level&&f.publish("changeLevel",{level:this.viewpoint.level});this.refresh(!1,b)}};c.prototype.getExtent=function(){if(this._extentDirty){var a=this._bound;return this._bound?(this._extent=new q(Math.min(a[0].x,a[1].x,a[2].x,a[3].x),Math.min(a[0].y,a[1].y,a[2].y,a[3].y),Math.max(a[0].x,a[1].x,a[2].x,a[3].x),Math.max(a[0].y,a[1].y,a[2].y,a[3].y)),this._extentDirty=!1,this._extent):null}return this._extent};
c.prototype.setView=function(a){a instanceof Object?(a.level!==this.level&&f.publish("changeLevel",{level:a.level}),this.viewpoint.setView(a),this.refresh(!0)):a&&1<this.viewStates.length?(this.backViewStates.push(this.viewStates.pop()),a=this.viewStates[this.viewStates.length-1],this.viewpoint.setView(a),this.refresh(!0)):!a&&0<this.backViewStates.length&&(this.viewStates.push(this.backViewStates.pop()),a=this.viewStates[this.viewStates.length-1],this.viewpoint.setView(a),this.refresh(!0))};c.prototype.refresh=
function(a,b){if(this._load){if(this.viewpoint.matrixDirty){var d=this.container.clientWidth,e=this.container.clientHeight;if(0===d||0===e)return;this.viewpoint.resize(d,e);this.viewpoint.matrixDirty=!1}this.zoomHistory.update(this.viewpoint.level,x.now());this.viewpoint.calcMatrix(!0);this._bound=this.viewpoint.calcBounds();this._extentDirty=!0;f.publish("extentChangeEvent",this);this._initState||(this._initState={level:this.viewpoint.level,center:[this.viewpoint.center[0],this.viewpoint.center[1]],
pitch:this.viewpoint.pitch,angle:this.viewpoint.angle});a||this.handlePushViewState();this.allLayerViews.forEach(function(a){a.refresh(b)});this.threeRender()}};c.prototype.handlePushViewState=function(){this.viewStates.length<this.viewStatesLength||this.viewStates.shift();this.viewStates.push({pitch:this.viewpoint.pitch,angle:this.viewpoint.angle,level:this.viewpoint.targetZoom||this.viewpoint.level,center:this.viewpoint.center});this.backViewStates=[]};c.prototype.centerAt=function(a,b,d){d&&d!==
this.viewpoint.level&&this.viewpoint.setLevel(d);this.viewpoint.setCenter([a,b]);this.refresh()};c.prototype.setLevel=function(a){this.viewpoint.setLevel(a);this.viewpoint.calcMatrix(!0);this.refresh()};c.prototype.findLayerViewById=function(a){for(var b=this.allLayerViews.length-1;-1<b;b--)if(this.allLayerViews[b].id===a)return this.allLayerViews[b]};c.prototype.screenToGeometry=function(a,b){a-=this._offsetLeft;b-=this._offsetTop;a=this.viewpoint.screenToGeometry(a,b);return new n(a.x,a.y,0)};c.prototype.geometryToScreen=
function(a,b){var d=0;if(this.ground&&this.ground.visible){var e=Math.min(this.viewpoint.targetZoom||this.viewpoint.level,this.ground.maxLevel),c=this.viewpoint.tileInfo.getResolution(e),g=this.viewpoint.tileInfo.getColForX(a,c),h=this.viewpoint.tileInfo.getRowForY(b,c),f=g-Math.floor(g),c=h-Math.floor(h);(e=this.ground.sourceCache.getTileByID(e+"/"+Math.floor(g)+"/"+Math.floor(h)))&&e.fbo&&(d=this.context.gl,this.context.bindFramebuffer.set(e.fbo.framebuffer),g=new Float32Array(4),f=Math.round(256*
f),c=Math.round(256*c),d.readPixels(0===f?f:f-1,0===c?c:c-1,1,1,d.RGBA,d.FLOAT,g),d=g[0]*(e.maximumHeight-e.minimumHeight)+e.minimumHeight)}b=this.viewpoint.geometryToScreen(a,b,d);a=b.x+this._offsetLeft;b=b.y+this._offsetTop;return new n(a,b)};c.prototype.getTileTexture=function(a){return(a=this._tileTextures[a])&&0<a.length?a.pop():null};c.prototype.saveTileTexture=function(a){var b=this._tileTextures[a.size[0]];b?b.push(a):this._tileTextures[a.size[0]]=[a]};c.prototype.useProgram=function(a,b,
d){void 0===b&&(b=this.emptyProgramConfiguration);this.cache=this.cache||{};var e=""+a+(b.cacheKey||"");this.cache[e]||(this.cache[e]=new H(this.context,r[a],b,r.programUniforms[a],d));return this.cache[e]};c.prototype.useProgramSimplify=function(a,b){this.simplifyCache=this.simplifyCache||{};this.simplifyCache[a]||(this.simplifyCache[a]=new I(this.context,r[a],b,r.programUniforms[a]));return this.simplifyCache[a]};c.prototype._drawBackgroundImage=function(){this._backgroundTexture&&this.viewpoint.rasterBoundsBuffer&&
M(this)};Object.defineProperties(c.prototype,l);c.prototype._zoomMap=function(a){0<a.wheelDelta?this.zoomInWheel(a.clientX,a.clientY):0>a.wheelDelta&&this.zoomOutWheel(a.clientX,a.clientY)};c.prototype.zoomInWheel=function(a,b){this.zoomEnabled&&!this.zooming&&(null!==this.viewpoint.level&&this.viewpoint.level<this.viewpoint.maxLevel?(this.zoomEnabled=!1,setTimeout(function(){this.zoomEnabled=!0}.bind(this),400),this.viewpoint.startZoom=this.viewpoint.level,this.viewpoint.targetZoom=this.viewpoint.level+
1,this.viewpoint.level=this.viewpoint.targetZoom,a=this.screenToGeometry(a,b),b=this.viewpoint.center,this.deltaX=a.x-b[0],this.deltaY=a.y-b[1],this.viewpoint.readyMatrix(b[0]+this.deltaX/2,b[1]+this.deltaY/2,this.viewpoint.targetZoom),this._bound=this.viewpoint.calcBounds(),this._extentDirty=!0,f.publish("changeLevel",{level:this.viewpoint.targetZoom}),f.publish("extentChangeEvent",this),this._handleZoomWheel(!0)):null===this.viewpoint.level&&(this.zoomEnabled=!1,this.graphicsIndex.clear(),setTimeout(function(){this.zoomEnabled=
!0}.bind(this),400),this.viewpoint.targetResolution=this.viewpoint.resolution,a=this.screenToGeometry(a,b),b=this.viewpoint.center,this.deltaX=a.x-b[0],this.deltaY=a.y-b[1],this.viewpoint.readyMatrix(b[0]+this.deltaX/2,b[1]+this.deltaY/2,null,null,this.viewpoint.resolution/2),this._bound=this.viewpoint.calcBounds(),this._extentDirty=!0,f.publish("extentChangeEvent",this),this._handleZoomWheel(!0)))};c.prototype.zoomOutWheel=function(a,b){this.zoomEnabled&&!this.zooming&&(null!==this.viewpoint.level&&
this.viewpoint.level>this.viewpoint.minLevel?(this.zoomEnabled=!1,setTimeout(function(){this.zoomEnabled=!0}.bind(this),400),this.viewpoint.startZoom=this.viewpoint.level,this.viewpoint.targetZoom=this.viewpoint.level-1,this.viewpoint.level=this.viewpoint.targetZoom,a=this.screenToGeometry(a,b),b=this.viewpoint.center,this.deltaX=a.x-b[0],this.deltaY=a.y-b[1],this.viewpoint.readyMatrix(b[0]-this.deltaX,b[1]-this.deltaY,this.viewpoint.targetZoom),this._bound=this.viewpoint.calcBounds(),this._extentDirty=
!0,f.publish("changeLevel",{level:this.viewpoint.targetZoom}),f.publish("extentChangeEvent",this),this._handleZoomWheel(!1)):null===this.viewpoint.level&&(this.zoomEnabled=!1,this.graphicsIndex.clear(),setTimeout(function(){this.zoomEnabled=!0}.bind(this),400),this.viewpoint.targetResolution=this.viewpoint.resolution,a=this.screenToGeometry(a,b),b=this.viewpoint.center,this.deltaX=a.x-b[0],this.deltaY=a.y-b[1],this.viewpoint.readyMatrix(b[0]+this.deltaX/2,b[1]+this.deltaY/2,null,null,2*this.viewpoint.resolution),
this._bound=this.viewpoint.calcBounds(),this._extentDirty=!0,f.publish("extentChangeEvent",this),this._handleZoomWheel(!1)))};c.prototype.zoomIn=function(){if(this.zoomEnabled&&!this.zooming&&this.viewpoint.level<this.viewpoint.maxLevel){this.zoomEnabled=!1;setTimeout(function(){this.zoomEnabled=!0}.bind(this),300);this.viewpoint.startZoom=this.viewpoint.level;this.viewpoint.targetZoom=this.viewpoint.level+1;this.viewpoint.level=this.viewpoint.targetZoom;var a=this.viewpoint.center;this.viewpoint.readyMatrix(a[0],
a[1],this.viewpoint.targetZoom);this._bound=this.viewpoint.calcBounds();this._extentDirty=!0;f.publish("extentChangeEvent",this);f.publish("changeLevel",{level:this.viewpoint.targetZoom});this._handleZoom(!0)}};c.prototype.zoomOut=function(){if(this.zoomEnabled&&!this.zooming&&this.viewpoint.level>this.viewpoint.minLevel){this.zoomEnabled=!1;setTimeout(function(){this.zoomEnabled=!0}.bind(this),300);this.viewpoint.startZoom=this.viewpoint.level;this.viewpoint.targetZoom=this.viewpoint.level-1;this.viewpoint.level=
this.viewpoint.targetZoom;var a=this.viewpoint.center;this.viewpoint.readyMatrix(a[0],a[1],this.viewpoint.targetZoom);this._bound=this.viewpoint.calcBounds();this._extentDirty=!0;f.publish("changeLevel",{level:this.viewpoint.targetZoom});f.publish("extentChangeEvent",this);this._handleZoom(!1)}};c.prototype._handleZoom=function(a){this.allLayerViews.forEach(function(a){a._readyData()});this._nochanging=!1;this.zooming=!0;a?this._zoomAnimateIn(null,1):this._zoomAnimateOut(null,1)};c.prototype._handleZoomWheel=
function(a){this.allLayerViews.forEach(function(a){a._readyData()});this._nochanging=!1;this.zooming=!0;a?this._zoomWheelAnimateIn(null,null!==this.viewpoint.level):this._zoomWheelAnimateOut(null,null!==this.viewpoint.level)};c.prototype._zoomWheelAnimateOut=function(a,b){a||(a=performance.now());var d=performance.now()-a,e=this.viewpoint.center;if(300<=d)window.cancelAnimationFrame(this._animateRaf),this._nochanging=!0,this.zooming=!1,this.viewpoint.setCenter([e[0]-this.deltaX,e[1]-this.deltaY]),
b?(this.viewpoint.setLevel(this.viewpoint.targetZoom),this.viewpoint.targetZoom=null):(this.viewpoint.resolution=2*this.viewpoint.targetResolution,this.viewpoint.targetResolution=null),this.viewpoint.calcMatrix(!0),this.handlePushViewState(),this._renderRaf=null,this.callHooks("zoomEnd"),this.threeRender();else{var d=d/300,c;b?(c=1/Math.pow(2,-d)-1,this.viewpoint.updateMatrix(e[0]-this.deltaX*c,e[1]-this.deltaY*c,this.viewpoint.startZoom-d)):(c=d,this.viewpoint.resolution=this.viewpoint.targetResolution*
(1+d),this.viewpoint.updateMatrix(e[0]-this.deltaX*c,e[1]-this.deltaY*c,null,this.viewpoint.resolution));this.animate();this._animateRaf=window.requestAnimationFrame(this._zoomWheelAnimateOut.bind(this,a,b))}};c.prototype._zoomAnimateOut=function(a){a||(a=performance.now());var b=performance.now()-a,d=this.viewpoint.center;300<=b?(window.cancelAnimationFrame(this._animateRaf),this._nochanging=!0,this.zooming=!1,this.viewpoint.setCenter([d[0],d[1]]),this.viewpoint.setLevel(this.viewpoint.targetZoom),
this.viewpoint.calcMatrix(!0),this.viewpoint.targetZoom=null,this.handlePushViewState(),this._renderRaf=null,this.callHooks("zoomEnd"),this.threeRender()):(this.viewpoint.updateMatrix(d[0],d[1],this.viewpoint.startZoom-b/300),this.animate(),this._animateRaf=window.requestAnimationFrame(this._zoomAnimateOut.bind(this,a)))};c.prototype._zoomWheelAnimateIn=function(a,b){a||(a=performance.now());var d=performance.now()-a,e=this.viewpoint.center;if(300<=d)window.cancelAnimationFrame(this._animateRaf),
this._nochanging=!0,this.zooming=!1,this.viewpoint.setCenter([e[0]+this.deltaX/2,e[1]+this.deltaY/2]),b?(this.viewpoint.setLevel(this.viewpoint.targetZoom),this.viewpoint.targetZoom=null):(this.viewpoint.resolution=this.viewpoint.targetResolution/2,this.viewpoint.targetResolution=null),this.viewpoint.calcMatrix(!0),this._renderRaf=null,this.callHooks("zoomEnd"),this.handlePushViewState(),this.threeRender();else{var d=d/300,c;b?(c=1-1/Math.pow(2,d),this.viewpoint.updateMatrix(e[0]+this.deltaX*c,e[1]+
this.deltaY*c,this.viewpoint.startZoom+d)):(c=1-1/(1+d),this.viewpoint.resolution=this.viewpoint.targetResolution/(1+d),this.viewpoint.updateMatrix(e[0]+this.deltaX*c,e[1]+this.deltaY*c,null,this.viewpoint.resolution));this.animate();this._animateRaf=window.requestAnimationFrame(this._zoomWheelAnimateIn.bind(this,a,b))}};c.prototype._zoomAnimateIn=function(a){a||(a=performance.now());var b=performance.now()-a,d=this.viewpoint.center;300<=b?(window.cancelAnimationFrame(this._animateRaf),this._nochanging=
!0,this.zooming=!1,this.viewpoint.setCenter([d[0],d[1]]),this.viewpoint.setLevel(this.viewpoint.targetZoom),this.viewpoint.calcMatrix(!0),this._renderRaf=null,this.viewpoint.targetZoom=null,this.handlePushViewState(),this.callHooks("zoomEnd"),this.threeRender()):(this.viewpoint.updateMatrix(d[0],d[1],this.viewpoint.startZoom+b/300),this.animate(),this._animateRaf=window.requestAnimationFrame(this._zoomAnimateIn.bind(this,a)))};c.prototype.zoomInAnimate=function(a,b,d){this.viewpoint.startZoom=this.viewpoint.level;
this.viewpoint.targetZoom=a;this.viewpoint.level=this.viewpoint.targetZoom;this.domNode.style.pointerEvents="none";a=this.viewpoint.center;this.viewpoint.readyMatrix(a[0],a[1],this.viewpoint.targetZoom);this._bound=this.viewpoint.calcBounds();this._extentDirty=!0;f.publish("extentChangeEvent",this);f.publish("changeLevel",{level:this.viewpoint.targetZoom});this._handleZoomAnimate(!0,this.viewpoint.targetZoom-this.viewpoint.startZoom,b,d)};c.prototype.zoomOutAnimate=function(a,b,d){this.viewpoint.startZoom=
this.viewpoint.level;this.viewpoint.targetZoom=a;this.viewpoint.level=this.viewpoint.targetZoom;this.domNode.style.pointerEvents="none";a=this.viewpoint.center;this.viewpoint.readyMatrix(a[0],a[1],this.viewpoint.targetZoom);this._bound=this.viewpoint.calcBounds();this._extentDirty=!0;f.publish("extentChangeEvent",this);f.publish("changeLevel",{level:this.viewpoint.targetZoom});this._handleZoomAnimate(!1,this.viewpoint.targetZoom-this.viewpoint.startZoom,b,d)};c.prototype._handleZoomAnimate=function(a,
b,d,c){this.allLayerViews.forEach(function(a){a._readyData()});this._nochanging=!1;a?this._handleZoomAnimateIn(null,b,d,c):this._handleZoomAnimateOut(null,b,d,c)};c.prototype._handleZoomAnimateIn=function(a,b,d,c){a||(a=performance.now());var e=performance.now()-a,g=this.viewpoint.center;e>=d?(window.cancelAnimationFrame(this._animateRaf),this.domNode.style.pointerEvents="all",this._nochanging=!0,this.viewpoint.setCenter([g[0],g[1]]),this.viewpoint.setLevel(this.viewpoint.targetZoom),this.viewpoint.calcMatrix(!0),
this.viewpoint.targetZoom=null,this.handlePushViewState(),this._renderRaf=null,this.callHooks("zoomEnd"),this.threeRender(),c()):(e/=d,this.viewpoint.updateMatrix(g[0],g[1],this.viewpoint.startZoom+b*e*e*e),this.animate(),this._animateRaf=window.requestAnimationFrame(this._handleZoomAnimateIn.bind(this,a,b,d,c)))};c.prototype._handleZoomAnimateOut=function(a,b,d,c){a||(a=performance.now());var e=performance.now()-a,g=this.viewpoint.center;e>=d?(window.cancelAnimationFrame(this._animateRaf),this.domNode.style.pointerEvents=
"all",this._nochanging=!0,this.viewpoint.setCenter([g[0],g[1]]),this.viewpoint.setLevel(this.viewpoint.targetZoom),this.viewpoint.calcMatrix(!0),this.viewpoint.targetZoom=null,this.handlePushViewState(),this._renderRaf=null,this.callHooks("zoomEnd"),this.threeRender(),c()):(e/=d,this.viewpoint.updateMatrix(g[0],g[1],this.viewpoint.startZoom+e*e*e*b),this.animate(),this._animateRaf=window.requestAnimationFrame(this._handleZoomAnimateOut.bind(this,a,b,d,c)))};c.prototype.mapMove=function(a,b){if(this.panEnabled&&
!this.zooming){var d=-this.viewpoint.angle/180*Math.PI,c=Math.sin(d),d=Math.cos(d),k=this.viewpoint.resolution,g=this.viewpoint.center;this.viewpoint.setCenter([g[0]-k*(a*d-b*c),g[1]+k*(a*c+b*d)]);this.viewpoint.calcMatrix(!0);this.threeRender()}};c.prototype.stopMove=function(){this.panEnabled&&!this.zooming&&this.refresh(!0)};c.prototype.pan=function(a,b){if(!(0===a&&0===b||this.zooming)){var d=this.viewpoint.center;this.viewpoint.setCenter([d[0]+a,d[1]+b]);this.viewpoint.calcMatrix(!0);this.zoomHistory.update(this.viewpoint.level,
x.now());this.viewpoint.calcMatrix(!0);this._bound=this.viewpoint.calcBounds();this._extentDirty=!0;this.allLayerViews.forEach(function(a){a.refresh()});this.threeRender()}};c.prototype._mouseRotate=function(a){this.rotateEnabled&&!this.zooming&&(this.viewpoint.angle=(this.viewpoint.angle-a/1080*180)%360,this.viewpoint.updateBaseMatrix(),this.threeRender(),f.publish("mapRotateAngle",this.viewpoint.angle))};c.prototype._stopMouseRotate=function(){this.rotateEnabled&&!this.zooming&&this.refresh(!0)};
c.prototype.rotateMap=function(a){this.rotateEnabled&&!this.zooming&&(this.viewpoint.oldAngle=this.viewpoint.angle,this.viewpoint.angle=(this.viewpoint.angle+a)%360,this.viewpoint.deltaAngle=a,f.publish("mapRotateAngle",this.viewpoint.angle),this.viewpoint.updateBaseMatrix(),this._bound=this.viewpoint.calcBounds(),this._extentDirty=!0,this._handleRotate())};c.prototype._handleRotate=function(){this.allLayerViews.forEach(function(a){a._readyData()});this._nochanging=!1;this._rotateAnimation(null,this.viewpoint.deltaAngle,
0)};c.prototype._rotateAnimation=function(a,b,d){a||(a=performance.now());d=performance.now()-a;300<=d?(this._rotateRaf&&window.cancelAnimationFrame(this._rotateRaf),this._nochanging=!0,this.viewpoint.angle=this.viewpoint.oldAngle+b,this.viewpoint.updateBaseMatrix(),this.handlePushViewState(),this.threeRender()):(this.viewpoint.angle=this.viewpoint.oldAngle+b*d/300,this.viewpoint.updateBaseMatrix(),this.animate(),this._rotateRaf=window.requestAnimationFrame(this._rotateAnimation.bind(this,a,b,d)))};
c.prototype._mouseSwitchDip=function(a){this.rotateEnabled&&!this.zooming&&(this.viewpoint.updatePitch(-a/20),this.threeRender())};c.prototype._stopSwitch=function(){this.rotateEnabled&&!this.zooming&&this.refresh(!0)};c.prototype.setDimensions=function(a){2===a&&0!==this.viewpoint.pitch?(this.viewpoint.oldPitch=this.viewpoint.pitch,this.viewpoint.pitch=0,this.viewpoint.deltaPitch=this.viewpoint.pitch-this.viewpoint.oldPitch,f.publish("mapSwitchDimension",2),this.viewpoint.updateBaseMatrix(),this._bound=
this.viewpoint.calcBounds(),this._extentDirty=!0,this._handleSwitch2D()):3===a&&50!==this.viewpoint.pitch&&(this.viewpoint.oldPitch=this.viewpoint.pitch,this.viewpoint.pitch=50,this.viewpoint.deltaPitch=this.viewpoint.pitch-this.viewpoint.oldPitch,f.publish("mapSwitchDimension",3),this.viewpoint.updateBaseMatrix(),this._bound=this.viewpoint.calcBounds(),this._extentDirty=!0,this._handleSwitch3D())};c.prototype._handleSwitch2D=function(){this.allLayerViews.forEach(function(a){a._readyData()});this._nochanging=
!1;this._switchAnimation(null,this.viewpoint.deltaPitch)};c.prototype._handleSwitch3D=function(){this.allLayerViews.forEach(function(a){a._readyData()});this._nochanging=!1;this._switchAnimation(null,this.viewpoint.deltaPitch)};c.prototype._switchAnimation=function(a,b){a||(a=performance.now());var d=performance.now()-a;500<=d?(window.cancelAnimationFrame(this._animateRaf),this._nochanging=!0,this.viewpoint.pitch=this.viewpoint.oldPitch+b,this.viewpoint.updateBaseMatrix(),this.handlePushViewState(),
this.threeRender()):(this.viewpoint.pitch=this.viewpoint.oldPitch+b*d/500,this.viewpoint.updateBaseMatrix(),this.animate(),this._animateRaf=window.requestAnimationFrame(this._switchAnimation.bind(this,a,b)))};c.prototype.animate=function(){this._renderRaf||(this._renderRaf=requestAnimationFrame(function(){this._renderRaf=null;this._gl.clearColor(this.backgroundColor.r,this.backgroundColor.g,this.backgroundColor.b,this.backgroundColor.a);this._gl.clear(this._clearBit);this.currentLayer=0;this.context.setDefault();
this._drawBackgroundImage();this.allLayerViews.forEach(function(a){a.zoom()})}.bind(this)))};c.prototype.setCustomLayerDefaults=function(){this.context.unbindVAO();this.context.cullFace.setDefault();this.context.activeTexture.setDefault();this.context.pixelStoreUnpack.setDefault();this.context.pixelStoreUnpackPremultiplyAlpha.setDefault();this.context.pixelStoreUnpackFlipY.setDefault()};c.prototype.setBaseState=function(){var a=this.context.gl;this.context.cullFace.set(!1);this.context.viewport.set([0,
0,this.width,this.height]);this.context.blendEquation.set(a.FUNC_ADD)};c.prototype.queryFeaturesByGeometry=function(a,b,d){var c=[],k={},g=[];this.map.allLayers.forEach(function(d){if(d.selectEnabled){var e=d.queryFeaturesByGeometry(a,b);e instanceof w?(c.push(e),g.push(d.id)):k[d.id]=e}});0<c.length?(new v(c)).then(function(a){a.forEach(function(a,b){a[0]&&(k[g[b]]=a[1].results)});d&&d(k)}):d&&d(k)};c.prototype.queryRenderFeaturesByGeometry=function(a,b,d){var c=[],k={},g=[];this.map.allLayers.forEach(function(d){if(d.selectEnabled){var e=
d.queryRenderFeaturesByGeometry(a,b);e instanceof w?(c.push(e),g.push(d.id)):k[d.id]=e}});0<c.length?(new v(c)).then(function(a){a.forEach(function(a,b){a[0]&&(k[g[b]]=a[1].results)});d&&d(k)}):d&&d(k)};c.prototype.addTask=function(a){this._renderRaf=requestAnimationFrame(function(){this._renderRaf=null;this._gl.clear(this._clearBit);this.currentLayer=0;this.depthRangeFor3D=[0,1-3*this.numSublayers*this.depthEpsilon];this.context.setDefault();this.allLayerViews.forEach(function(a){a._render()});this.allLayerViews[0]._fadeDirty?
(this.allLayerViews[0]._fadeDirty=!1,this.threeRender()):a()}.bind(this))};c.prototype.resetExtent=function(){this._initState&&(this.viewpoint.setView(this._initState),this.refresh(!0))};c.prototype.calcBounds=function(a,b,d,c){return this.viewpoint.calcBound(a,b,d,c)};c.prototype.callHooks=function(a){this[a].forEach(function(a){a()})};c.prototype.loadItem=function(a){this.graphicsIndex.load(a)};c.prototype.insertItems=function(a){for(var b=0,d=a.length;b<d;b++)this.graphicsIndex.insert(a[b])};c.prototype.switchPitch=
function(a){this.viewpoint.oldPitch=this.viewpoint.pitch;this.viewpoint.pitch=a;this.viewpoint.deltaPitch=this.viewpoint.pitch-this.viewpoint.oldPitch;0<a?f.publish("mapSwitchDimension",3):f.publish("mapSwitchDimension",2);this.viewpoint.updateBaseMatrix();this._bound=this.viewpoint.calcBounds();this._extentDirty=!0;this._handleSwitch3D()};c.prototype.queryGraphicsByGeometry=function(a,b){switch(a.type){case "point":a=[a]}var d={};b=this.graphicsIndex.query(a,b||0,this.resolution);for(var c=[],k=
0,g=b.length;k<g;k++){var h=b[k];if(h.g.selectEnabled)if(h.hasOwnProperty("symbol")){var f=h.g,m=f.feature.geometry;if("multipolygon"===m.type)for(var m=m.polygons,l=0;l<m.length;l++){if(t[h.symbol.type](a,m[l],h.symbol,this.resolution,f.feature.geometry.radius,this.viewpoint)){d.hasOwnProperty(h.id)||(c.push(h.g),d[h.id]=!0);break}}else t[h.symbol.type](a,h.g.feature.geometry,h.symbol,this.resolution,f.feature.geometry.radius,this.viewpoint)&&!d.hasOwnProperty(h.id)&&(c.push(h.g),d[h.id]=!0)}else d.hasOwnProperty(h.id)||
(c.push(h.g),d[h.id]=!0)}return c};c.prototype.queryGraphicByDevId=function(a){for(var b,d=0,c=this.allLayerViews;d<c.length;d++)if(0<c[d].layer.graphics.length&&"labelLayer"!==c[d].graphicsLayerView.id)for(var f=0,g=c[d].layer.graphics;f<g.length;f++)g[f].feature.attributes.forEach(function(d){"dev_id"===d.name&&d.value===a&&(b=g[f])});return void 0!==b?b:null};c.prototype.queryGraphicSizeByPoint=function(a,b){a=this.graphicsIndex.query([a],0,this.resolution);var d=Infinity,c=Infinity,f=-Infinity,
g=-Infinity;b=!b;for(var h=0,l=a.length;h<l;h++){var m=a[h];m.symbol&&b||(m.minX<d&&(d=m.minX),m.minY<c&&(c=m.minY),m.maxX>f&&(f=m.maxX),m.maxY>g&&(g=m.maxY))}return{xmin:d,ymin:c,xmax:f,ymax:g,width:Math.abs(f-d),height:Math.abs(g-c)}};c.prototype.checkExtentState=function(a,b,d,c,f){void 0===f&&(f=!0);var e=this.graphicsIndex.checkExtentState(a,b,d,c);a=[new n(a,c),new n(d,c),new n(d,b),new n(a,b)];b=0;for(d=e.length;b<d;b++)if(c=e[b],c.hasOwnProperty("symbol")){var h=c.g;if(f&&t.line(a,h.feature.geometry,
c.symbol,this.resolution,h.feature.geometry.radius,this.viewpoint))return!0}else return!0;return!1};c.prototype.clear=function(){this.graphicsIndex.clear();this.map.clear();this.allLayerViews=[];this.threeRender()};c.prototype.setBackgroundColor=function(a){this.backgroundColor=y.parse(a);this.threeRender()};c.prototype.destroy=function(){this.graphicsIndex.clear();this.map.clear();this.allLayerViews=[];A.destroy(this.domNode)};c.prototype.requestRenderFrame=function(a){return this._renderTaskQueue.add(a)};
c.prototype.cancelRenderFrame=function(a){this._renderTaskQueue.remove(a)};c.prototype.setMaxPitch=function(a,b){this.viewpoint.maxPitch=a;b&&this.refresh()};c.prototype.threeRender=function(){this._renderRaf||!this._nochanging||this.viewpoint.matrixDirty||(this._renderRaf=requestAnimationFrame(function(){this._renderRaf=null;this._nochanging&&(this._renderTaskQueue.run(this),this._gl.clearColor(this.backgroundColor.r,this.backgroundColor.g,this.backgroundColor.b,this.backgroundColor.a),this._gl.clear(this._clearBit),
this.context.setDefault(),this._drawBackgroundImage(),this.currentLayer=0,this.depthRangeFor3D=[0,1-3*this.numSublayers*this.depthEpsilon],this.allLayerViews.forEach(function(a){a._render()}),0<this.allLayerViews.length&&this.allLayerViews[0]._fadeDirty&&(this.allLayerViews[0]._fadeDirty=!1,this.threeRender()))}.bind(this)))};c.prototype.destroy=function(){this.map=null;this.container.removeChild(this.domNode);this.allLayerViews=[]};c.prototype.flyTo=function(a,b){if(!this.zooming){this.viewpoint.readyMatrix(a.x,
a.y,this.viewpoint.level);this._bound=this.viewpoint.calcBounds();this._extentDirty=!0;this.viewpoint.targetZoom=this.viewpoint.level;this.viewpoint.startZoom=this.viewpoint.level;this.allLayerViews.forEach(function(a){a._readyData()});this.domNode.style.pointerEvents="none";this._nochanging=!1;var d=this.viewpoint.center;this._flyToAnimation(null,{duration:b,dx:(a.x-d[0])/2,dy:(a.y-d[1])/2})}};c.prototype._flyToAnimation=function(a,b){a||(a=performance.now());var d=performance.now()-a,c=this.viewpoint.center;
d>b.duration?(window.cancelAnimationFrame(this._animateRaf),this._nochanging=!0,this.viewpoint.setCenter([c[0]+b.dx,c[1]+b.dy]),this.viewpoint.setLevel(this.viewpoint.targetZoom-3),this.viewpoint.calcMatrix(!0),this.viewpoint.startZoom-=3,this._renderRaf=null,this.threeRender(),setTimeout(function(){this._ToAnimation(null,b)}.bind(this),0)):(d/=b.duration,d=z.polyIn(d),this.viewpoint.updateMatrix(c[0]+b.dx*d,c[1]+b.dy*d,this.viewpoint.startZoom-3*d),this.animate(),this._animateRaf=window.requestAnimationFrame(this._flyToAnimation.bind(this,
a,b)))};c.prototype._ToAnimation=function(a,b){a||(a=performance.now());var d=performance.now()-a,c=this.viewpoint.center;d>b.duration?(this.viewpoint.setCenter([c[0]+b.dx,c[1]+b.dy]),this.viewpoint.setLevel(this.viewpoint.targetZoom),this.viewpoint.targetZoom=null,this.viewpoint.calcMatrix(!0),this._renderRaf=null,this.domNode.style.pointerEvents="all",this.threeRender()):(d/=b.duration,d=z.polyOut(d),this.viewpoint.updateMatrix(c[0]+b.dx*d,c[1]+b.dy*d,this.viewpoint.startZoom+3*d),this.animate(),
this._animateRaf=window.requestAnimationFrame(this._ToAnimation.bind(this,a,b)))};c.maxOverzooming=10;c.maxUnderzooming=3;return c});