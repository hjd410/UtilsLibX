//>>built
define("com/huayun/webgis/views/MapViewBackup",["dojo/_base/declare","com/huayun/webgis/views/View"],function(_1,_2){return _1("com.huayun.webgis.views.MapView",[_2],{width:0,height:0,initExtent:0,resolution:0,viewpoint:null,panEnabled:true,zoomEnabled:true,rotateEnabled:true,allLayerViews:[],_renderer:null,_camera:null,_scene:null,_group:null,initZ:1,_initLevel:12,extent:null,level:0,maxLevel:0,_tileInfo:null,center:null,_load:false,_offsetLeft:0,_offsetTop:0,_screenPoint:null,constructor:function(_3){this.container=_3.container;this.map=_3.map;this.is3DVision=_3.is3DVision;this._animateRaf=null;var _4=this.container.clientWidth,_5=this.container.clientHeight;this._containerWidth=_4;this._containerHeight=_5;this.panEnabled=true;this.zoomEnabled=true;this.rotateEnabled=true;this.selectEnabled=true;this.allLayerViews=[];this._renderer=null;this._camera=null;this._scene=null;this._group=null;this.maxSlope=48;this.domNode=document.createElement("div");this.domNode.className="webgis-root";var _6=document.createElement("canvas");_6.width=_4;_6.height=_5;this._gl=_6.getContext("webgl",{antialias:true,alpha:true,preserveDrawingBuffer:true});this.domNode.appendChild(_6);this.container.appendChild(this.domNode);this._initWebGL(_4,_5);this._offsetLeft=this.container.getBoundingClientRect().left;this._offsetTop=this.container.getBoundingClientRect().top;this.allLayerViews=[];this.viewpoint=new Viewpoint();this.viewpoint.camera=this._camera;var _7=new PanHandler(this);this._handleAddedLayer();this._handleTopic();this._handleEvent();},_initWebGL:function(_8,_9){_9=_9%2===0?_9:_9+1;this._renderer=new THREE.WebGLRenderer({precision:"mediump",context:this._gl});this._renderer.setSize(_8,_9);this._renderer.setClearColor(new THREE.Color(15658734),1);this._renderer.setPixelRatio(window.devicePixelRatio?window.devicePixelRatio:1);var _a=0.6435011087932844;var _b=_a*180/Math.PI;this._angle=_b;var _c=0.5/Math.tan(_a/2)*_9;this._distance=_c;this._camera=new THREE.PerspectiveCamera(_b,_8/_9,1,10000);this.initZ=_c;if(this.is3DVision){this.slope=this.maxSlope;}else{this.slope=0;}this._camera.position.set(0,-_c*Math.sin(this.slope/180*Math.PI),_c*Math.cos(this.slope/180*Math.PI));this.halfUpHeight=_c*Math.sin(_a/2)/Math.sin((180-_b/2-this.slope-90)/180*Math.PI);this.halfDownHeight=_c*Math.sin(_a/2)/Math.sin((180-_b/2-(90-this.slope))/180*Math.PI);this.halfUpWidth=this.halfUpHeight*_8/_9;this.halfDownWidth=this.halfDownHeight*_8/_9;this.width=this.halfUpWidth+this.halfDownWidth;this.height=this.halfUpHeight+this.halfDownHeight;this._camera.lookAt(new THREE.Vector3(0,0,0));this._scene=new THREE.Scene();this._scene.background=new THREE.Color(15658734);this._group=new THREE.Group();this._scene.add(this._group);var _d=new THREE.DirectionalLight(6710886);_d.position.set(100000000,100000000,100000000);this._scene.add(_d);var _e=new THREE.AmbientLight(15658734);this._scene.add(_e);this._screenPoint=new THREE.Vector3();this._mousePoint=new THREE.Vector2();this._raycaster=new THREE.Raycaster();this.textureloader=new THREE.TextureLoader().setCrossOrigin("*");this.threeRender();},_handleAddedLayer:function(){if(this.map.allLayers.length>0){this._tileInfo=this.map.allLayers[0].tileInfo;this._load=true;this.map.allLayers.forEach(function(_f){this.allLayerViews.push(_f.createLayerView(this));}.bind(this));}},_handleTopic:function(){topic.subscribe("addLayer",function(_10){for(var i=0;i<_10.length;i++){if(!_10[i].maxLevel){_10[i].maxLevel=this.maxLevel;}this.allLayerViews.push(_10[i].createLayerView(this));}}.bind(this));topic.subscribe("tileInfoComplete",function(){if(!this._tileInfo){this._tileInfo=this.map.allLayers[0].tileInfo;var _11=this._tileInfo.lods;this.maxLevel=_11[_11.length-1].level;for(var i=0;i<this.map.allLayers.length;i++){var _12=this.map.allLayers[i];if(!_12.maxLevel){_12.maxLevel=this.maxLevel;}}this.initResolution=_11[this._initLevel].resolution;this._load=true;this.setExtent(this.extent);topic.publish("mapLoadComplete");}}.bind(this));topic.subscribe("threeRender",function(){this.threeRender();}.bind(this));},_handleEvent:function(){on(this.domNode,"mousewheel",this._zoomMap.bind(this));on(this.container,"click",this._onClick.bind(this));on(this.container,"mousemove",this._onMouseMove.bind(this));},_onClick:function(e){if(this.selectEnabled){var x=e.clientX,y=e.clientY,_13=this._containerWidth,_14=this._containerHeight;this._mousePoint.x=((x-this._offsetLeft)/_13)*2-1;this._mousePoint.y=-((y-this._offsetTop)/_14)*2+1;this._raycaster.setFromCamera(this._mousePoint,this._camera);var _15={};var _16=this.allLayerViews;for(var i=0,ii=_16.length;i<ii;i++){var _17=this._raycaster.intersectObject(_16[i]._group,true);if(_17.length>0){_15[_16[i].id]=_17;}}topic.publish("mapOnClick",_15,x,y);}},selectObj:function(x,y){var _18=this._containerWidth,_19=this._containerHeight;this._mousePoint.x=((x-this._offsetLeft)/_18)*2-1;this._mousePoint.y=-((y-this._offsetTop)/_19)*2+1;this._raycaster.setFromCamera(this._mousePoint,this._camera);var _1a={};var _1b=this.allLayerViews;for(var i=0,ii=_1b.length;i<ii;i++){var _1c=this._raycaster.intersectObject(_1b[i]._group,true);if(_1c.length>0){_1a[_1b[i].id]=_1c;}}return _1a;},_onMouseMove:function(e){if(this.selectEnabled){var x=e.clientX,y=e.clientY,_1d=this._containerWidth,_1e=this._containerHeight;this._mousePoint.x=((x-this._offsetLeft)/_1d)*2-1;this._mousePoint.y=-((y-this._offsetTop)/_1e)*2+1;this._raycaster.setFromCamera(this._mousePoint,this._camera);var _1f=this.findLayerViewById("vector");if(_1f){var _20=this._raycaster.intersectObject(_1f._group,true);for(var i=_20.length-1;i>-1;i--){if(_20[i].object.isSprite){topic.publish("mapMovePOI",_20[i].object.uuid,x,y);return;}}}topic.publish("mapMovePOI",false,x,y);}},_findNestZoom:function(_21){var _22=this._tileInfo.lods,len=_22.length,_23=0;for(var j=len-1;j>-1;j--){_23=_22[j].resolution/_21;if(_23<1.9&&_23>0.95){this.level=j;return _22[j].resolution;}}this.level=len-1;return _22[len-1].resolution;},refresh:function(){if(this._load){this._setScale();switch(this._state){case "zoomIn":this._handleZoom(true);this._state="default";break;case "zoomOut":this._handleZoom(false);this._state="default";break;case "rotate":this._handleRotate();this._state="default";break;case "switch2D":this._handleSwitch2D();this._state="default";break;case "switch3D":this._handleSwitch3D();this._state="default";break;default:var _24=1/this.viewpoint.scale;this._group.scale.set(_24,_24,_24);this.allLayerViews.forEach(function(_25){_25.refresh();});}}},_setScale:function(){var _26=Math.pow(2,this._initLevel-this.level);this.viewpoint.scale=isNaN(_26)?1:_26;},_getScale:function(){return this.viewpoint.scale;},findLayerViewById:function(id){for(var i=this.allLayerViews.length-1;i>-1;i--){if(this.allLayerViews[i].id===id){return this.allLayerViews[i];}}},setExtent:function(_27,_28){if(_27){if(!this.resolution){this.center=_27.getCenter();this._calResolution(_27);}if(this.resolution){this._calResolution(_27);this._calExtent(_27.getCenter());topic.publish("extentChangeEvent",this.extent);this.refresh();}else{this.extent=_27;}}else{this._calExtent(_28);topic.publish("extentChangeEvent",this.extent);this.refresh();}},setLevel:function(_29){this.level=_29;if(!this._tileInfo){this._tileInfo=this.map.allLayers[0].tileInfo;}this.resolution=this._tileInfo.lods[_29].resolution;var _2a=this.extent.getCenter(),_2b=this.width,_2c=this.height;var _2d=this.resolution*_2b*0.5;var _2e=this.resolution*_2c*0.5;var _2f=_2a.x-_2d;var _30=_2a.x+_2d;var _31=_2a.y-_2e;var _32=_2a.y+_2e;var _33=new Extent(_2f,_31,_30,_32);this._calExtent(_33.getCenter());topic.publish("extentChangeEvent",this.extent);},_calResolution:function(_34){var _35=_34.getWidth(),_36=_34.getHeight(),_37=this.halfUpWidth,_38=this.halfUpHeight;if(this._tileInfo&&this._tileInfo.lods.length>0){this.resolution=this._findNestZoom(Math.max(_35/_37,_36/_38));}},_calExtent:function(_39,x,y){var rad=-this.viewpoint.rotation/180*Math.PI,_3a=Math.sin(rad),_3b=Math.cos(rad);var _3c=this.halfUpWidth*_3b,_3d=this.halfUpWidth*_3a,_3e=this.halfUpHeight*_3b,_3f=this.halfUpHeight*_3a,_40=this.halfDownWidth*_3b,_41=this.halfDownWidth*_3a,_42=this.halfDownHeight*_3b,_43=this.halfDownHeight*_3a;var _44={x:-_3c+_3f,y:_3e+_3d},_45={x:_3c+_3f,y:_3e-_3d},_46={x:_40-_43,y:-_42-_41},_47={x:-_40-_43,y:-_42+_41};var _48=this.resolution;var _49={x:_39.x+_44.x*_48,y:_39.y+_44.y*_48},_4a={x:_39.x+_45.x*_48,y:_39.y+_45.y*_48},_4b={x:_39.x+_46.x*_48,y:_39.y+_46.y*_48},_4c={x:_39.x+_47.x*_48,y:_39.y+_47.y*_48};var _4d=Math.min(_49.x,_4a.x,_4b.x,_4c.x),_4e=Math.max(_49.x,_4a.x,_4b.x,_4c.x),_4f=Math.min(_49.y,_4a.y,_4b.y,_4c.y),_50=Math.max(_49.y,_4a.y,_4b.y,_4c.y);this.center=_39;this._bound=[_49,_4a,_4b,_4c];this.extent=new Extent(_4d,_4f,_4e,_50);},resetExtent:function(){},_zoomMap:function(e){e.preventDefault();e.stopPropagation();if(e.wheelDelta>0){this.zoomIn();}else{if(e.wheelDelta<0){this.zoomOut();}}},zoomIn:function(){if(this.zoomEnabled&&this.level<this.maxLevel){this.zoomEnabled=false;setTimeout(function(){this.zoomEnabled=true;}.bind(this),600);this.level+=1;this.resolution=this._tileInfo.lods[this.level].resolution;this._state="zoomIn";this.setExtent(null,this.center);topic.publish("changeLevel",{level:this.level});}},zoomOut:function(){if(this.zoomEnabled&&this.level>1){this.zoomEnabled=false;setTimeout(function(){this.zoomEnabled=true;}.bind(this),600);this.level-=1;this.resolution=this._tileInfo.lods[this.level].resolution;this._state="zoomOut";this.setExtent(null,this.center);topic.publish("changeLevel",{level:this.level});}},_handleZoom:function(_51){this.allLayerViews.forEach(function(_52){_52._readyData();});if(_51){this._zoomAnimateIn(null,1);}else{this._zoomAnimateOut(null,1);}},_zoomAnimateIn:function(_53,_54){if(!_53){_53=performance.now();}var _55=performance.now()-_53;if(_55>=500){this._group.scale.multiplyScalar(2/_54);window.cancelAnimationFrame(this._animateRaf);this.allLayerViews.forEach(function(_56){_56._render();});}else{this._group.scale.multiplyScalar((1+_55/500)/_54);this.threeRender();this._animateRaf=window.requestAnimationFrame(this._zoomAnimateIn.bind(this,_53,(1+_55/500)));}},_zoomAnimateOut:function(_57,_58){if(!_57){_57=performance.now();}var _59=performance.now()-_57;if(_59>=500){this._group.scale.divideScalar(2/_58);window.cancelAnimationFrame(this._animateRaf);this.allLayerViews.forEach(function(_5a){_5a._render();});}else{this._group.scale.divideScalar((1+_59/500)/_58);this.threeRender();this._animateRaf=window.requestAnimationFrame(this._zoomAnimateOut.bind(this,_57,(1+_59/500)));}},mapMove:function(_5b,_5c){if(this.panEnabled){var _5d=-this.viewpoint.rotation/180*Math.PI,_5e=Math.sin(_5d),_5f=Math.cos(_5d);var _60=_5b*_5f-_5c*_5e,_61=_5b*_5e+_5c*_5f;var ra=this.resolution/this.initResolution,_62=this.resolution*_60,_63=this.resolution*_61;this.center.x-=_62;this.center.y+=_63;this.allLayerViews.forEach(function(_64){_64._group.position.x+=_60*ra;_64._group.position.y-=_61*ra;});this.threeRender();}},stopMove:function(){if(this.panEnabled){this.setExtent(null,this.center);}},_mouseSwitchDip:function(_65){if(this.rotateEnabled){var _66=this.slope;var _67=this._distance;var _68=-_65/1080*this.maxSlope;if(_66+_68>this.maxSlope){this.slope=this.maxSlope;}else{if(_66+_68<0){this.slope=0;}else{this.slope+=_68;}}this._camera.position.set(0,-_67*Math.sin(this.slope/180*Math.PI),_67*Math.cos(this.slope/180*Math.PI));this._camera.lookAt(0,0,0);this.threeRender();}},_stopSwitch:function(){var w,h;var r=this._scene.rotation.x;var _69=this.container.clientWidth,_6a=this.container.clientHeight;var _6b=this._distance;var _6c=this._angle;var fov=_6c/180*Math.PI;var _6d=this.slope;this.halfUpHeight=_6b*Math.sin(fov/2)/Math.sin((180-_6c/2-_6d-90)/180*Math.PI);this.halfDownHeight=_6b*Math.sin(fov/2)/Math.sin((180-_6c/2-(90-_6d))/180*Math.PI);this.halfUpWidth=this.halfUpHeight*_69/_6a;this.halfDownWidth=this.halfDownHeight*_69/_6a;this.allLayerViews.forEach(function(_6e){_6e.resize();});if(this.slope<0.05){this.is3DVision=false;topic.publish("mapSwitchDimension",2);}else{this.is3DVision=true;topic.publish("mapSwitchDimension",3);}this.setExtent(null,this.center);},setDimensions:function(d){var _6f=this.container.clientWidth,_70=this.container.clientHeight;var _71=this._distance;var _72=this._angle;var fov=_72/180*Math.PI;var _73=0;if(d===2&&this.is3DVision){_73=0;this.halfUpHeight=_71*Math.sin(fov/2)/Math.sin((180-_72/2-_73-90)/180*Math.PI);this.halfDownHeight=_71*Math.sin(fov/2)/Math.sin((180-_72/2-(90-_73))/180*Math.PI);this.halfUpWidth=this.halfUpHeight*_6f/_70;this.halfDownWidth=this.halfDownHeight*_6f/_70;this.is3DVision=false;this._state="switch2D";this.allLayerViews.forEach(function(_74){_74.resize();});this.setExtent(null,this.center);topic.publish("mapSwitchDimension",2);}else{if(d===3&&!this.is3DVision){_73=this.maxSlope;this.halfUpHeight=_71*Math.sin(fov/2)/Math.sin((180-_72/2-_73-90)/180*Math.PI);this.halfDownHeight=_71*Math.sin(fov/2)/Math.sin((180-_72/2-(90-_73))/180*Math.PI);this.halfUpWidth=this.halfUpHeight*_6f/_70;this.halfDownWidth=this.halfDownHeight*_6f/_70;this.is3DVision=true;this._state="switch3D";this.allLayerViews.forEach(function(_75){_75.resize();});this.setExtent(null,this.center);topic.publish("mapSwitchDimension",3);}}},_handleSwitch2D:function(){var _76=this.slope;var d=this._distance;this.allLayerViews.forEach(function(_77){_77._readyData();});this._switchAnimation(null,0,-_76/500,d);},_handleSwitch3D:function(){var _78=this.slope;var d=this._distance;this.allLayerViews.forEach(function(_79){_79._readyData();});this._switchAnimation(null,0,(this.maxSlope-_78)/500,d);},_switchAnimation:function(_7a,_7b,_7c,_7d){if(!_7a){_7a=performance.now();}var _7e=performance.now()-_7a;if(_7e>=500){this.slope+=(500-_7b)*_7c;this._camera.position.set(0,-_7d*Math.sin(this.slope/180*Math.PI),_7d*Math.cos(this.slope/180*Math.PI));this._camera.lookAt(0,0,0);window.cancelAnimationFrame(this._animateRaf);this.allLayerViews.forEach(function(_7f){_7f._render();});}else{this.slope+=_7c*(_7e-_7b);this._camera.position.set(0,-_7d*Math.sin(this.slope/180*Math.PI),_7d*Math.cos(this.slope/180*Math.PI));this._camera.lookAt(0,0,0);this.threeRender();this._animateRaf=window.requestAnimationFrame(this._switchAnimation.bind(this,_7a,_7e,_7c,_7d));}},_mouseRotate:function(_80){if(this.rotateEnabled){var _81=_80/1080*180;this.viewpoint.rotation=(this.viewpoint.rotation-_81)%360;this._group.rotateZ(_81/180*Math.PI);topic.publish("mapRotateAngle",this.viewpoint.rotation);this.threeRender();}},_stopMouseRotate:function(){if(this.rotateEnabled){this.setExtent(null,this.center);}},rotateMap:function(_82){if(this.rotateEnabled){this.viewpoint.rotation=(this.viewpoint.rotation+_82)%360;this.viewpoint.rotateAngle=_82;this._state="rotate";this.setExtent(null,this.center);topic.publish("mapRotateAngle",this.viewpoint.rotation);}},_handleRotate:function(){this.allLayerViews.forEach(function(_83){_83._readyData();});this._rotateAnimation(null,this.viewpoint.rotateAngle/180*Math.PI,0);},_rotateAnimation:function(_84,rad,d){if(!_84){_84=performance.now();}var _85=performance.now()-_84;if(_85>=500){this._group.rotateZ(-rad*(500-d)/500);window.cancelAnimationFrame(this._animateRaf);this.allLayerViews.forEach(function(_86){_86._render();});}else{this._group.rotateZ(-rad*(_85-d)/500);this.threeRender();this._animateRaf=window.requestAnimationFrame(this._rotateAnimation.bind(this,_84,rad,_85));}},_screenToScene:function(x,y){var _87=this._containerWidth,_88=this._containerHeight;x=((x-this._offsetLeft)/_87)*2-1;y=-((y-this._offsetTop)/_88)*2+1;this._screenPoint.set(x,y,0.5);var pos=new THREE.Vector3();var _89=this._camera;this._screenPoint.unproject(_89);this._screenPoint.sub(_89.position).normalize();var dis=-_89.position.z/this._screenPoint.z;pos.copy(_89.position).add(this._screenPoint.multiplyScalar(dis));pos.z=0;pos.multiplyScalar(this.viewpoint.scale);return pos;},_sceneToScreen:function(x,y,z){var _8a=new THREE.Vector3(x,y,z);_8a.project(this._camera);_8a.x=(_8a.x+1)*this.width/2;_8a.y=-(_8a.y-1)*this.height/2;_8a.z=0;return _8a;},_sceneToGeometry:function(x,y,z){var _8b=this.center;return new Point(x*this.initResolution+_8b.x,y*this.initResolution+_8b.y,0);},_geometryToScene:function(x,y,z){var _8c=this.center;return new Point((x-_8c.x)/this.initResolution,(y-_8c.y)/this.initResolution,0);},screenToGeometry:function(x,y){},geometryToScreen:function(x,y){var pos=this._geometryToScene(x,y,0);return this._sceneToScreen(pos.x,pos.y,pos.z);},centerAt:function(x,y){var _8d=new Point(x,y);this.center=_8d;this.setExtent(null,_8d);},threeRender:function(){this._renderer.render(this._scene,this._camera);}});});