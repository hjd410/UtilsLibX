//>>built
define("com/huayun/webgis/symbols/support/glyphManager","require exports dojo/request ../../gl/TinySDF ../../utils/image ../../data/Pbf".split(" "),function(t,r,u,v,q,w){function x(a,c,b){1===a?c.id=b.readVarint():2===a?c.bitmap=b.readBytes():3===a?c.width=b.readVarint():4===a?c.height=b.readVarint():5===a?c.left=b.readSVarint():6===a?c.top=b.readSVarint():7===a&&(c.advance=b.readVarint())}function y(a,c,b){if(3===a){a=b.readMessage(x,{});b=a.width;var g=a.height,m=a.left,h=a.top,d=a.advance;c.push({id:a.id,
bitmap:new q.AlphaImage({width:b+6,height:g+6},a.bitmap),metrics:{width:b,height:g,left:m,top:h,advance:d}})}}function z(a,c,b){1===a&&b.readMessage(y,c)}function A(a,c,b){c*=256;var g=c+255;a="font/{fontstack}/{range}.pbf".replace("{fontstack}",a).replace("{range}",c+"-"+g);u(t.toUrl(a),{handleAs:"arraybuffer"}).then(function(a){var c={},d=0;for(a=(new w(a)).readFields(z,[]);d<a.length;d+=1){var e=a[d];c[e.id]=e}b(null,c)}).catch(function(a){b(a)})}var n={};r.getGlyphs=function(a){var c={},b;for(b in a){c[b]=
{};for(var g=0,m=a[b];g<m.length;g++){var h=m[g],d=n[b];d||(d=n[b]={glyphs:{}});var e=d.glyphs[h];if(!e){var e=d,k=b,d=h,l;var p=k,f=p.split(" ");l=1===f.length?{fontWeight:"400",fontFamily:p}:2===f.length?{fontWeight:f[0],fontFamily:f[1]}:void 0;p=l.fontFamily;f=e.tinySDF;f||(f=l.fontWeight,/bold/i.test(k)?f="900":/medium/i.test(k)?f="500":/light/i.test(k)&&(f="200"),f=e.tinySDF=new v(24,1,8,.25,p,f));e=String.fromCharCode(d);e=255>d?{id:d,bitmap:new q.AlphaImage({width:26,height:26},f.draw(e)),
metrics:{width:24,height:24,left:0,top:-8,advance:f.measureText(e).width}}:{id:d,bitmap:new q.AlphaImage({width:26,height:26},f.draw(e)),metrics:{width:24,height:24,left:0,top:-8,advance:24}}}c[b][h]=e}}return c};r.getGlyphsFromPbf=function(a,c){for(var b in a)for(var g=0,m=a[b];g<m.length;g++){var h=m[g],d=n[b];d||(d=n[b]={glyphs:{},requests:{}});var e=d.glyphs[h];if(e)c(null,{stack:b,id:h,glyph:e});else{var k=Math.floor(h/256),l=d.requests[k];l||(l=d.requests[k]=[],A(b,k,function(a,b){if(b)for(var c in b)d.glyphs[+c]=
b[+c];c=0;for(var e=l;c<e.length;c+=1)(0,e[c])(a,b);delete d.requests[k]}));l.push(function(a,d){a?c(a):d&&c(null,{stack:b,id:h,glyph:d[h]||null})})}}}});