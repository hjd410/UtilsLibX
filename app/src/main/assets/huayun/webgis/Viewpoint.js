//>>built
define("com/huayun/webgis/Viewpoint",["dojo/topic","./utils/utils","./utils/Constant","custom/gl-matrix-min","./data/ArrayType","./gl/SegmentVector"],function(_1,_2,_3,_4,_5,_6){var _7=52;var _8=function(_9,_a,_b,_c,_d,_e,_f,_10){this.width=_9;this.height=_a;this.angle=_c;this.pitch=_b;this.center=[0,0];this.level=null;this.maxLevel=_d||15;this.minLevel=_e||1;this.resolution=0;this.tileInfo=null;this.scale=1;this._fov=0.6435011087932844;this._posMatrixCache={};this.pixelsToGLUnits=[2/_9,-2/_a];this._tilePixelRatio=0.0625;this.view=_10;this.oldAngle=_c;this.maxPitch=_f;if(_9===0||_a===0){this.matrixDirty=true;}this.cameraToCenterDistance=0.5/Math.tan(this._fov/2)*_a;var _11=this._fov/2,_12=Math.PI/180,_13=Math.PI/2+_b*_12,_14=Math.sin(_11)*this.cameraToCenterDistance/Math.sin(Math.PI-_13-_11),_15=Math.cos(Math.PI/2-_b*_12)*_14+this.cameraToCenterDistance;var _16=10000;this._projectionMatrix=_4.mat4.perspective(new Float64Array(16),this._fov,_9/_a,1,_16);var m=_4.mat4.create();_4.mat4.translate(m,m,[0,0,-this.cameraToCenterDistance]);_4.mat4.rotateX(m,m,-this.pitch*_12);_4.mat4.rotateZ(m,m,-this.angle*_12);this._baseMatrix=m;m=_4.mat4.create();_4.mat4.scale(m,m,[_9/2,-_a/2,1]);_4.mat4.translate(m,m,[1,-1,0]);this.labelPlaneMatrix=m;m=_4.mat4.create();_4.mat4.scale(m,m,[1,-1,1]);_4.mat4.translate(m,m,[-1,-1,0]);_4.mat4.scale(m,m,[2/_9,2/_a,1]);this.glCoordMatrix=m;this.frogHeight=0;var _17=new _5.StructArrayLayout3ui6();_17.emplaceBack(0,1,2);_17.emplaceBack(2,1,3);this.quadTriangleIndexBuffer=_10.context.createIndexBuffer(_17);this.rasterBoundsSegments=_6.simpleSegment(0,0,4,2);};var _18={zoom:{configurable:true}};_18.zoom.get=function(){return this.level;};_18.zoom.set=function(_19){return this.level=_19;};_8.prototype.resize=function(_1a,_1b){this.width=_1a;this.height=_1b;var _1c=this.pitch;this.pixelsToGLUnits=[2/_1a,-2/_1b];this.cameraToCenterDistance=0.5/Math.tan(this._fov/2)*_1b;var _1d=this._fov/2,_1e=Math.PI/180,_1f=Math.PI/2+_1c*_1e,_20=Math.sin(_1d)*this.cameraToCenterDistance/Math.sin(Math.PI-_1f-_1d),_21=Math.cos(Math.PI/2-_1c*_1e)*_20+this.cameraToCenterDistance;var _22=10000;this._projectionMatrix=_4.mat4.perspective(new Float64Array(16),this._fov,_1a/_1b,1,_22);var m=_4.mat4.create();_4.mat4.translate(m,m,[0,0,-this.cameraToCenterDistance]);_4.mat4.rotateX(m,m,-this.pitch*_1e);_4.mat4.rotateZ(m,m,-this.angle*_1e);this._baseMatrix=m;m=_4.mat4.create();_4.mat4.scale(m,m,[_1a/2,-_1b/2,1]);_4.mat4.translate(m,m,[1,-1,0]);this.labelPlaneMatrix=m;m=_4.mat4.create();_4.mat4.scale(m,m,[1,-1,1]);_4.mat4.translate(m,m,[-1,-1,0]);_4.mat4.scale(m,m,[2/_1a,2/_1b,1]);this.glCoordMatrix=m;};_8.prototype.setTileInfo=function(_23){this.tileInfo=_23;this._tilePixelRatio=_23.size/_3.layout.EXTENT;this.zoomPixelRatio=(_23.size+1)/_3.layout.EXTENT;};_8.prototype.readyMatrix=function(x,y,_24,_25,_26){if(!_26){_26=this.tileInfo.getResolution(_24);}var m=_4.mat4.scale(new Float64Array(16),this._baseMatrix,[1/_26,1/_26,1/_26]);m=_4.mat4.translate(m,m,[-x,-y,0]);this._viewMatrix=_4.mat4.clone(m);this.matrix=_4.mat4.multiply(m,this._projectionMatrix,m);this.pixelMatrix=_4.mat4.multiply(new Float64Array(16),this.labelPlaneMatrix,this.matrix);this.pixelMatrixInverse=_4.mat4.invert(new Float64Array(16),this.pixelMatrix);x=x/_26;y=y/_26;var _27=(this.width%2)/2,_28=(this.height%2)/2,_29=Math.cos(this.angle),_2a=Math.sin(this.angle),dx=x-Math.round(x)+_29*_27+_2a*_28,dy=y-Math.round(y)+_29*_28+_2a*_27;var _2b=new Float64Array(this.matrix);_4.mat4.translate(_2b,_2b,[(dx>0.5?dx-1:dx)*_26,(dy>0.5?dy-1:dy)*_26,0]);this.alignedProjMatrix=_2b;if(_25){this._posMatrixCache={};this._alignedPosMatrixCache={};}};_8.prototype.calcMatrix=function(_2c){var x=this.center[0],y=this.center[1],_2d=this.resolution;var m=_4.mat4.scale(new Float64Array(16),this._baseMatrix,[1/_2d,1/_2d,1/_2d]);m=_4.mat4.translate(m,m,[-x,-y,0]);this._viewMatrix=_4.mat4.clone(m);this.matrix=_4.mat4.multiply(m,this._projectionMatrix,m);this.pixelMatrix=_4.mat4.multiply(new Float64Array(16),this.labelPlaneMatrix,this.matrix);this.pixelMatrixInverse=_4.mat4.invert(new Float64Array(16),this.pixelMatrix);m=_4.mat4.set(new Float32Array(16),1,0,0,0,0,1,0,0,0,0,1,0,x,y,0,1);_4.mat4.multiply(m,this.matrix,m);this.centerMatrix=m;x=x/_2d;y=y/_2d;var _2e=(this.width%2)/2,_2f=(this.height%2)/2,_30=Math.cos(this.angle),_31=Math.sin(this.angle),dx=x-Math.round(x)+_30*_2e+_31*_2f,dy=y-Math.round(y)+_30*_2f+_31*_2e;var _32=new Float64Array(this.matrix);_4.mat4.translate(_32,_32,[(dx>0.5?dx-1:dx)*_2d,(dy>0.5?dy-1:dy)*_2d,0]);this.alignedProjMatrix=_32;if(_2c){this._posMatrixCache={};this._alignedPosMatrixCache={};}_1.publish("frameUpdate");};_8.prototype.setView=function(_33){this.pitch=_33.pitch;this.angle=_33.angle;this.setLevel(_33.level);this.setCenter([_33.center[0],_33.center[1]]);var m=_4.mat4.create();_4.mat4.translate(m,m,[0,0,-this.cameraToCenterDistance]);_4.mat4.rotateX(m,m,-this.pitch/180*Math.PI);_4.mat4.rotateZ(m,m,-this.angle/180*Math.PI);this._baseMatrix=m;};_8.prototype.updateBaseMatrix=function(){var m=_4.mat4.create();_4.mat4.translate(m,m,[0,0,-this.cameraToCenterDistance]);_4.mat4.rotateX(m,m,-this.pitch/180*Math.PI);_4.mat4.rotateZ(m,m,-this.angle/180*Math.PI);this._baseMatrix=m;this.calcMatrix(true);};_8.prototype.updateMatrix=function(x,y,_34,_35){if(_34){this.setLevel(_34);_35=this.resolution;}var m=_4.mat4.scale(new Float64Array(16),this._baseMatrix,[1/_35,1/_35,1/_35]);m=_4.mat4.translate(m,m,[-x,-y,0]);this._viewMatrix=_4.mat4.clone(m);this.matrix=_4.mat4.multiply(m,this._projectionMatrix,m);this.pixelMatrix=_4.mat4.multiply(new Float64Array(16),this.labelPlaneMatrix,this.matrix);this.pixelMatrixInverse=_4.mat4.invert(new Float64Array(16),this.pixelMatrix);x=x/_35;y=y/_35;var _36=(this.width%2)/2,_37=(this.height%2)/2,_38=Math.cos(this.angle),_39=Math.sin(this.angle),dx=x-Math.round(x)+_38*_36+_39*_37,dy=y-Math.round(y)+_38*_37+_39*_36;var _3a=new Float64Array(this.matrix);_4.mat4.translate(_3a,_3a,[(dx>0.5?dx-1:dx)*_35,(dy>0.5?dy-1:dy)*_35,0]);this.alignedProjMatrix=_3a;this._posMatrixCache={};this._alignedPosMatrixCache={};_1.publish("frameUpdate");};_8.prototype.updatePitch=function(_3b){var _3c=this.pitch;this.pitch+=_3b;this.pitch=this.pitch<0?0:this.pitch>this.maxPitch?this.maxPitch:this.pitch;if(_3c===0&&this.pitch>0){_1.publish("mapSwitchDimension",3);}if(_3c>0&&this.pitch===0){_1.publish("mapSwitchDimension",2);}var m=_4.mat4.create();_4.mat4.translate(m,m,[0,0,-this.cameraToCenterDistance]);_4.mat4.rotateX(m,m,-this.pitch/180*Math.PI);_4.mat4.rotateZ(m,m,-this.angle/180*Math.PI);this._baseMatrix=m;this.calcMatrix(true);};_8.prototype.screenToGeometry=function(x,y){var _3d=0;var _3e=[x,y,0,1];var _3f=[x,y,1,1];_4.vec4.transformMat4(_3e,_3e,this.pixelMatrixInverse);_4.vec4.transformMat4(_3f,_3f,this.pixelMatrixInverse);var w0=_3e[3];var w1=_3f[3];var x0=_3e[0]/w0;var x1=_3f[0]/w1;var y0=_3e[1]/w0;var y1=_3f[1]/w1;var z0=_3e[2]/w0;var z1=_3f[2]/w1;var t=z0===z1?0:(_3d-z0)/(z1-z0);return {x:_2.number(x0,x1,t),y:_2.number(y0,y1,t),z:0};};_8.prototype.geometryToScreen=function(x,y){var _40=[x,y,0,1];_4.vec4.transformMat4(_40,_40,this.pixelMatrix);var w=_40[3],a=_40[0]/w,b=_40[1]/w;return {x:Math.round(a),y:Math.round(b)};};_8.prototype.calcBounds=function(){if(this.pitch<_7){this.rasterBoundsBuffer=null;return [this.screenToGeometry(0,0),this.screenToGeometry(this.width,0),this.screenToGeometry(this.width,this.height),this.screenToGeometry(0,this.height)];}else{var _41=_7/this.pitch;var sh=(1-_41)*this.height;_41-=0.2;var _42=new _5.StructArrayLayout4f16();_42.emplaceBack(-1,2*_41-1,0,1);_42.emplaceBack(1,2*_41-1,1,1);_42.emplaceBack(-1,1,0,_41/2);_42.emplaceBack(1,1,1,_41/2);this.rasterBoundsBuffer=this.view.context.createVertexBuffer(_42,[{name:"a_pos",type:"Float32",components:4,offset:0}]);return [this.screenToGeometry(0,sh),this.screenToGeometry(this.width,sh),this.screenToGeometry(this.width,this.height),this.screenToGeometry(0,this.height)];}};_8.prototype.calcBound=function(_43,_44,_45,_46){return [this.screenToGeometry(_43,_45),this.screenToGeometry(_44,_45),this.screenToGeometry(_44,_46),this.screenToGeometry(_43,_46)];};_8.prototype.calculatePosMatrix=function(_47,_48,_49){var _4a=_47.key;var _4b=_49?this._alignedPosMatrixCache:this._posMatrixCache;if(_4b[_4a]){return _4b[_4a];}var _4c=_47.canonical;var _4d=Math.pow(2,this.level-_4c.z);var _4e=this.tileInfo.getResolution(this.level);var x=_48[0],y=_48[1];if(_49){x=Math.round(x/_4e);y=Math.round(y/_4e);x=x*_4e;y=y*_4e;}var _4f=_4.mat4.set(new Float64Array(16),this._tilePixelRatio*_4e,0,0,0,0,-this._tilePixelRatio*_4e,0,0,0,0,1,0,x,y,0,1);_4.mat4.multiply(_4f,_49?this.alignedProjMatrix:this.matrix,_4f);_4.mat4.scale(_4f,_4f,[_4d,_4d,1]);_4b[_4a]=new Float32Array(_4f);return _4b[_4a];};_8.prototype.getMatrixForPoint=function(x,y,_50,_51,z){z=z?z:0;var _52=this.resolution;_51=_51?-1:1;if(_50){x=Math.round(x/_52);y=Math.round(y/_52);x=x*_52;y=y*_52;}var _53=_4.mat4.set(new Float64Array(16),1,0,0,0,0,_51,0,0,0,0,1,0,x,y,z,1);_4.mat4.multiply(_53,_50?this.alignedProjMatrix:this.matrix,_53);_53=new Float32Array(_53);return _53;};_8.prototype.getModelViewMatrix=function(x,y){};_8.prototype.getMatrixForModel=function(x,y,_54,_55){var _56=this.resolution;_55=_55?-1:1;if(_54){x=Math.round(x/_56);y=Math.round(y/_56);x=x*_56;y=y*_56;}var _57=_4.mat4.set(new Float32Array(16),_56,0,0,0,0,_55*_56,0,0,0,0,_56,0,x,y,0,1);_4.mat4.multiply(_57,_54?this.alignedProjMatrix:this.matrix,_57);return _57;};_8.prototype.updatePosMatrix=function(_58,_59,_5a){var _5b=_58.key;var _5c=_5a?this._alignedPosMatrixCache:this._posMatrixCache;if(_5c[_5b]){return _5c[_5b];}var _5d=_58.canonical;var _5e=Math.pow(2,this.level-_5d.z);var _5f=this.tileInfo.getResolution(this.level);var x=_59[0],y=_59[1];if(_5a){x=Math.round(x/_5f);y=Math.round(y/_5f);x=x*_5f;y=y*_5f;}var _60=_4.mat4.set(new Float64Array(16),this.zoomPixelRatio*_5f,0,0,0,0,-this.zoomPixelRatio*_5f,0,0,0,0,1,0,x,y,0,1);_4.mat4.multiply(_60,_5a?this.alignedProjMatrix:this.matrix,_60);_4.mat4.scale(_60,_60,[_5e,_5e,1]);_5c[_5b]=new Float32Array(_60);return _5c[_5b];};_8.prototype.setLevel=function(_61){if(_61<this.minLevel){_61=this.minLevel;}if(_61>this.maxLevel){_61=this.maxLevel;}this.level=_61;if(this.tileInfo){this.resolution=this.tileInfo.getResolution(_61);}};_8.prototype.setResolution=function(_62,_63){if(this.tileInfo){if(_63){var res=this.tileInfo.findNestZoom(_62);this.resolution=res.resolution;this.level=res.level;}else{this.resolution=_62;this.level=this.tileInfo.getLevel(_62);}}else{this.resolution=_62;}};_8.prototype.getResolution=function(_64){return this.tileInfo.getResolution(_64);};_8.prototype.setCenter=function(_65){if(_65 instanceof Array){this.center=_65;}else{if(_65.x&&_65.y){this.center=[_65.x,_65.y];}}};_8.prototype.coveringZoomLevel=function(_66){return (_66.roundZoom?Math.round:Math.floor)(this.level);};_8.prototype.maxPitchScaleFactor=function(){if(!this.pixelMatrixInverse){return 1;}var _67=this.screenToGeometry(0,0);var p=[_67.x,_67.y,0,1];var _68=_4.vec4.transformMat4(p,p,this.pixelMatrix);return _68[3]/this.cameraToCenterDistance;};Object.defineProperties(_8.prototype,_18);return _8;});