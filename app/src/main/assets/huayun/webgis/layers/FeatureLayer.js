//>>built
define("com/huayun/webgis/layers/FeatureLayer",["dojo/_base/declare","dojo/request","./Layer","../views/3d/layers/FeatureLayerView3D","./GraphicLayer","../Feature","../Graphic","../Attribute","../../util/JSONFormatterUtil","../../util/WKTGeometryFormater","../../util/SymbolFactory","../renderer/CompositeLineRenderer","../renderer/CompositeMarkerRenderer","../renderer/CompositeFillRenderer"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e){return (function(){function _f(_10,_11){_3.call(this,_10);this.geoType=_10.geoType;this.id=_10.id;this.currentRule=_10.currentRule;this.rules=_10.rules;this.symbols=[];this.graphicsLayer=new _5();switch(this.geoType){case "line":this.graphicsLayer.glowRatio=1;break;default:this.graphicsLayer.glowRatio=3;}this.graphics=this.graphicsLayer.graphics;this.featureData=[];this.wktGeometryFormatter=new _a();this.symbolFactory=new _b();this.createRenderer();this.loadComplete(_10,_11);this.state=false;this.type="FeatureLayer";this.selectEnabled=true;this.visible=_10.visible;};if(_3){_f.__proto__=_3;}_f.prototype=Object.create(_3&&_3.prototype);_f.prototype.constructor=_f;_f.prototype.addGraphic=function(_12){this.graphicsLayer.addGraphic(_12);};_f.prototype.createLayerView=function(_13){var _14=new _4({visible:this.visible,layer:this,graphicsLayerView:this.graphicsLayer.createLayerView(_13)});this.layerView=_14;_14.transform=_13.viewpoint;return _14;};_f.prototype._createGraphic=function(_15,_16){return new _7({feature:_15,symbol:_16});};_f.prototype._createFeature=function(_17){if(_17===undefined){return null;}var _18=_17["SHAPE"];var geo=this.wktGeometryFormatter.toGeometry(_18);if(!geo){return null;}var _19=new _6({type:geo.type,geometry:geo});var _1a=[];for(var _1b in _17){if(_1b==="SHAPE"){continue;}if(_17.hasOwnProperty(_1b)){var _1c=new _8();_1c.name=_1b.toLowerCase();_1c.value=_17[_1b];_1a[_1a.length]=_1c;}}_19.attributes=_1a;return _19;};_f.prototype.getSymbol=function(_1d){return this.symbolFactory.createSymbol(_1d);};_f.prototype.loadComplete=function(_1e,_1f){var url=_1e.query.url+_1e.dataSource.viewId+"?filter="+_1e.query.filter+"&access_token="+_1e.query.access_token;_2(url,{handleAs:"json"}).then(function(_20){this.featureData=_20.data;var _21=null;this.state=true;this.ruleSymbols=[];var _22=this.rules;for(var i=0;i<_22.length;i++){var _23=_22[i];_23.geoType=this.geoType;_21=this.getSymbol(_23);this.ruleSymbols.push({symbol:_21,minScale:_23.minScale,maxScale:_23.maxScale,label:_23.label,isFixed:_23.isFixed,addratio:_23.addratio});}for(i=0;i<this.featureData.length;i++){var _24=this.featureData[i];var _25=this._createFeature(_24);if(!_25){continue;}_21=null;var _26=this._createGraphic(_25,_21);var _27=_25.attributes;if(this.symbolFactory["_propertyName"]){var _28=this.symbolFactory["_propertyName"].split(",");var _29=[];for(var j=0,len=_28.length;j<len;j++){var _2a=_28[j];for(var k=0,_2b=_27.length;k<_2b;k++){var _2c=_27[k];if(_2c.name&&_2a.toUpperCase()===_2c.name.toUpperCase()&&_2c.value!==""){_29.push(_2c.value);break;}}}if(_29.length>0){_26.propertyValue=_29.toString();}else{_26.propertyValue="DefaultValue";}}this.addGraphic(_26);}this.layerView.scale=0;}.bind(this));};_f.prototype.zoomEnd=function(_2d){var _2e=_2d.scale;var _2f;if(this.ruleSymbols){for(var i=0;i<this.ruleSymbols.length;i++){var _30=this.ruleSymbols[i];if(_2e>=_30.minScale&&_2e<=_30.maxScale){_2f=_30;break;}}}this.currentRule=_2f;this.graphicsLayer.graphics.forEach(function(_31){if(!_31.isChangeSymbol){return;}if(_2f){if(_31.propertyValue){for(var key in _2f.symbol){if(_2f.symbol.hasOwnProperty(key)){var _32=key.split("-");if(_32.length===1){_31.symbol=_2f.symbol[_31.propertyValue]||_2f.symbol["DefaultValue"];break;}else{if(_32.length>1){var _33=Number(_31.propertyValue);if(_33<=Number(_32[0])&&_33>=Number(_32[1])){_31.symbol=_2f.symbol[key];break;}}}}}}else{_31.symbol=_2f.symbol;}}else{_31.symbol=null;}if(_31.symbol&&_31.symbol.props){var _34=_31.symbol.props;var _35=_31.feature.attributes;var len=_35.length;for(var id in _34){var _36=_34[id].fieldName.toUpperCase();for(var j=0;j<len;j++){var _37=_35[j];if(_37.name&&_36===_37.name.toUpperCase()&&_37.value!==""){if(id==="rotation"||id==="markerRotation"){_31[id]=_37.value/180*Math.PI;}else{_31[id]=_37.value;}break;}}}}if(!_31.added&&_31.symbol){this.graphicsLayer.updateGraphic(_31);}}.bind(this));};_f.prototype.createRenderer=function(){switch(this.geoType){case "point":this.graphicsLayer.setRenderer(new _d());break;case "line":this.graphicsLayer.setRenderer(new _c());break;case "polygon":this.graphicsLayer.setRenderer(new _e());break;}};_f.prototype.queryGraphicsByGeometry=function(_38,_39){return this.graphicsLayer.queryFeaturesByGeometry(_38,_39);};_f.prototype.clear=function(){this.graphicsLayer.clear();};return _f;}());});