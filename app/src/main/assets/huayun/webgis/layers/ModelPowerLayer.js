//>>built
define("com/huayun/webgis/layers/ModelPowerLayer",["./Layer","../views/3d/layers/ModelPowerLayerView","../utils/Resource","../Model","../utils/wktUtil","../ModelGraphic","../geometry/Point","../geometry/CylinderGeometry","../geometry/ExtrusionGeometry","custom/kdbush.min"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){var _b=17;var _c=15;var sh=10;var _d=[[[-_b,0]],[[-_b,0],[_b,0]],[[-_b,0],[-_c,sh],[_b,0]],[[-_b,0],[-_c,sh],[_c,sh],[_b,0]]];function _e(a,b){var x1=a[0],y1=a[1],x2=b[0],y2=b[1];var _f=x1*x1+y1*y1;if(_f>0){_f=1/Math.sqrt(_f);}var _10=x2*x2+y2*y2;if(_10>0){_10=1/Math.sqrt(_10);}var _11=(x1*x2+y1*y2)*_f*_10;if(_11>1){return 0;}else{if(_11<-1){return Math.PI;}else{return Math.acos(_11);}}};function _12(a,b){return a[0]*b[1]-a[1]*b[0];};function _13(_14){_1.call(this,_14);this.id=_14.id||"modelPower";this.name="立体电网";this.url=_14.url;this.visible=_14.visible===undefined?true:_14.visible;this.layerView=null;this.filterLayers=_14.filterLayers;this.model=new _4({url:_14.model});this.kdbush=null;var _15=this;this.fallback=_14.fallback;this.fallbackSymbol=_14.fallbackSymbol;this.minLevel=_14.minLevel;this.maxLevel=_14.maxLevel;this.fallbackLevel=_14.fallbackLevel;this.substation=_14.substation;this.substationSymbol=_14.substationSymbol;_8.createGeometry(this.fallback);_3.loadJson(this.url,function(err,_16){if(err){return;}var _17=_16.data;var _18=[];var _19={};var _1a,_1b,_1c,_1d,_1e;var _1f=new _7(0,1);var _20=0;_15.lineID2Name={};for(var i=0,ii=_17.length;i<ii;i++){var _21=_17[i];_15.lineID2Name[_21.ID]=_21.NAME;var _22=_21.PHYSICTOWER;_22.forEach(function(_23){_23.shape=_5.parse2Geometry(_23.SHAPE);});var len=_22.length;var _24=new _7(0,1);var _25=null;var _26;_22.forEach(function(_27,_28){if(_19.hasOwnProperty(_27.ID)){_26=_18[_19[_27.ID]];_26.lines+=","+_21.ID;_26.psize++;}else{var _29=undefined;if(_28!==len-1){_1a=_22[_28+1].shape;if(_1b){_1c=_1b;}if(_1d){_1e=_1d;}_1d=_27.shape;_1b=_1a?_1a.sub(_1d)._unit()._perp():_1c;_1c=_1c||_1b;var _2a=_1c.add(_1b);if(_2a.x!==0||_2a.y!==0){_2a._unit();}var _2b=_2a.x*_24.x+_2a.y*_24.y;var _2c=_2a.x*_24.y-_2a.y*_24.x;if(_2c>0){_29=-Math.acos(_2b);}else{_29=Math.acos(_2b);}}else{_2a=_1f;}_26=new _6({model:_15.model,position:_27.shape,rotateX:Math.PI/2,rotateY:Math.PI/2,rotateZ:_29,scale:[1,1,1],fallback:_15.fallback});_26.id=_27.ID;_26.TOWERNO=_27.TOWERNO;_26.NAME=_27.NAME;_26.psize=1;_26.prev=[];_26.next=[];_26.joinNormal=_2a;_26.lines=_21.ID;_26.actowerName=[];_26.type="tower";_18[_20]=_26;_19[_27.ID]=_20;_20++;}if(_25){var l1=_25.next.length;var l2=_26.prev.length;if(l1===0||(l1>0&&_25.next[l1-1].id!==_26.id)){_25.next.push(_26);}if(l2===0||(l2>0&&_26.prev[l2-1].id!==_25.id)){_26.prev.push(_25);}}_25=_26;});}_17=_16.substation;for(i=0,ii=_17.length;i<ii;i++){var sub=_17[i];sub.shape=_5.parse2Geometry(sub.SHAPE)[0];var _2d=sub.shape.extent.center;_26=new _6({model:_15.model,position:new _7(_2d.x,_2d.y,0),fallback:_15.substation});_26.NAME=sub.NAME;_26.type="substation";_26.shape=new _9({path:sub.shape.path,length:50});_26.id=sub.FID;_18.push(_26);}_15.kdbush=new _a(_18,function(p){return p.position.x;},function(p){return p.position.y;});_15.points=_18;_15.handleParallel();});};if(_1){_13.__proto__=_1;}_13.prototype=Object.create(_1&&_1.prototype);_13.prototype.constructor=_13;_13.prototype.handleParallel=function(){var _2e={};this.points.forEach(function(mp){if(mp.type==="substation"){return;}var _2f=[];mp.acTower={};var _30=_d[mp.psize-1];if(mp.psize>1&&mp.prev.length===mp.psize){var _31=mp.prev;var _32=mp.lines;_32=_32.split(",");for(var m=0;m<mp.psize;m++){var p=_31[m];_2f.push([mp.position.x-p.x,mp.position.y-p.y]);}var np=mp.next[0];var _33=[np.position.x-mp.position.x,np.position.y-mp.position.y];var _34=_2f.map(function(_35,_36){var _37=_e(_33,_35);var _38=_12(_33,_35);if(_38>0){_37=-_37;}return {angle:_37,index:_36};});_34.sort(function(a,b){return b.angle-a.angle;});_2e={};for(var i=0;i<_34.length;i++){var _39=_34[i].index;var _3a=_30[i];_2e[_32[_39]]=_3a;mp.acTower[_32[_39]]=mp.position.add(mp.joinNormal.mult(_3a[0]));mp.acTower[_32[_39]].z=_3a[1];}}else{if(mp.psize>1){for(var lId in _2e){mp.acTower[lId]=mp.position.add(mp.joinNormal.mult(_2e[lId][0]));mp.acTower[lId].z=_2e[lId][1];}}else{mp.acTower[mp.lines]=mp.position.add(mp.joinNormal.mult(_30[0][0]));mp.acTower[mp.lines].z=_30[0][1];}}});};_13.prototype.createLayerView=function(_3b,_3c){var _3d=new _2({width:_3b.width,height:_3b.height,opacity:this.opacity,visible:this.visible,view:_3b,id:this.id,layer:this});this.layerView=_3d;_3d.transform=_3b.viewpoint;for(var id in this.models){this.models[id].load(_3b,function(){_3b.threeRender();});}return _3d;};_13.prototype.fetchData=function(_3e,_3f){var url=this.getUrl(_3e);return _3.loadJson(url,_3f);};_13.prototype.getUrl=function(_40){return this.url+"/identify?layers="+this.filterLayers+"&access_token="+accessToken+"&f=json&geometryType=esriGeometryEnvelope&geometry="+_40.xmin+","+_40.ymin+","+_40.xmax+","+_40.ymax+"&tolerance=0";};return _13;});