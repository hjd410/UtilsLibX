//>>built
define("com/huayun/webgis/layers/VectorTileLayer",["../utils/Resource","./Layer","./support/style/createStyleLayer","./support/SourceCache","./support/LOD","./support/TileInfo","../views/3d/layers/VectorTileLayerView3D","../work/Dispatcher","../gl/GlyphManager","../gl/ImageManager","../gl/ImageAtlas","../utils/image","../utils/Constant","../utils/utils","../geometry/Extent","../geometry/Point"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10){var _11=function(_12){_2.call(this,_12);this.id=_12.id||"vectorLayer";this.url=_12.url;this.name=_12.name||"矢量切片背景图";this.type="Tile";this.dispatcher=new _8(this);this.glyphManager=new _9("sans-serif");this.imageManager=new _a();this.tileInfo=null;this.layerView=null;this._changed=false;this._updatedLayers={};this._removedLayers={};this._updatedSources={};this._updatedPaintProps={};};if(_2){_11.__proto__=_2;}_11.prototype=Object.create(_2&&_2.prototype);_11.prototype.constructor=_11;_11.prototype.createLayerView=function(_13,_14){var _15=new _7({visible:this.visible,view:_13,id:this.id,layer:this});this._loadStyle(_13);this.layerView=_15;_15.transform=_13.viewpoint;return _15;};_11.prototype._loadStyle=function(_16){var obj=this;_1.loadJson(this.url,function(_17,_18){if(_17){obj.visible=false;return;}var _19=null;for(var id in _18.sources){_19=_18.sources[id].url;break;}var _1a=_18.layers,_1b;obj._order=[];obj._layers={};for(var i=0,ii=_1a.length;i<ii;i+=1){_1b=_1a[i];obj._order.push(_1b.id);obj._layers[_1b.id]=_3(_1b);}obj.glyphManager.setURL(_18.glyphs);obj.dispatcher.broadcast("setLayers",obj._serializeLayers(obj._order));_1.loadJson(_19,function(err,_1c){if(err){obj.visible=false;return;}obj._addSource(id,_18.sources[id],{validate:false},_16,_1c.tiles);_1.loadJson(_18.sprite+".json",function(e,_1d){if(e){obj.visible=false;return;}_1.loadImage(_18.sprite+".png",function(er,_1e){if(er){obj.visible=false;return;}obj._initImageManager(_1e,_1d);obj._handleMetaData(_16,_1c);});});});});};_11.prototype.updateStyle=function(_1f){var _20=_1f.layers,_21;this._order=[];this._layers={};for(var i=0,ii=_20.length;i<ii;i+=1){_21=_20[i];this._order.push(_21.id);this._layers[_21.id]=_3(_21);}this.dispatcher.broadcast("setLayers",this._serializeLayers(this._order));};_11.prototype._serializeLayers=function(ids){var _22=[];for(var i=0,_23=ids;i<_23.length;i+=1){var id=_23[i];var _24=this._layers[id];if(_24.type!=="custom"){_22.push(_24.serialize());}}return _22;};_11.prototype._addSource=function(id,_25,_26,_27,url){this.sourceCache=new _4(id,_25,this.dispatcher,_27.width,_27.height,url,this);};_11.prototype._initImageManager=function(_28,_29){var _2a=document.createElement("canvas");var ctx=_2a.getContext("2d");_2a.width=_28.width;_2a.height=_28.height;ctx.drawImage(_28,0,0,_28.width,_28.height);var _2b=ctx.getImageData(0,0,_28.width,_28.height);for(var id in _29){var ref=_29[id],_2c=ref.width,_2d=ref.height,x=ref.x,y=ref.y,sdf=ref.sdf,_2e=ref.pixelRatio;var _2f=new _c.RGBAImage({width:_2c,height:_2d});_c.RGBAImage.copy(_2b,_2f,{x:x,y:y},{x:0,y:0},{width:_2c,height:_2d});this.imageManager.addImage(id,{data:_2f,pixelRatio:_2e,sdf:sdf});}this.imageManager.addImage("default_icon",{data:_2f,pixelRatio:_2e,sdf:sdf});this.imageManager.setLoaded(true);this.imageAatlas=new _b(this.imageManager.images,{});};_11.prototype._handleMetaData=function(_30,_31){var _32=_31.fullExtent;var _33=_31.spatialReference;_32=new _f(Number(_32.xmin),Number(_32.ymin),Number(_32.xmax),Number(_32.ymax),_33);var _34=_31.tileInfo;var _35=_34.rows;var dpi=_34.dpi,_36=_34.origin;_36=new _10(Number(_36.x),Number(_36.y));var _37=[];_31.lods.forEach(function(_38){_37.push(new _5({level:Number(_38.level),scale:Number(_38.scale),resolution:Number(_38.resolution)}));});this.tileInfo=new _6({lods:_37,origin:_36,size:_35});this.tileInfo.dpi=dpi;this.tileInfo.fullExtent=_32;this.layerView.tileSize=_35;this.tileServer=_31.tiles;this.sourceCache.updateTileSize(_35);this.tilePixelRatio=_35/_d.layout.EXTENT;this.layerView._updatePlacement(0);_30.setTileInfo(this.tileInfo);};_11.prototype.getGlyphs=function(_39,_3a,_3b){this.glyphManager.getGlyphs(_3a.stacks,_3b);};_11.prototype.getImages=function(_3c,_3d,_3e){this.imageManager.getImages(_3d.icons,_3e);};_11.prototype.setPaintProperty=function(_3f,_40,_41,_42){if(_42===void 0){_42={};}var _43=this.getLayer(_3f);if(_e.deepEqual(_43.getPaintProperty(_40),_41)){return;}var _44=_43.setPaintProperty(_40,_41,_42);if(_44){this._updateLayer(_43);}this._changed=true;this._updatedPaintProps[_3f]=true;};_11.prototype.getLayer=function(id){return this._layers[id];};_11.prototype.setLayoutProperty=function(_45,_46,_47,_48){if(_48===void 0){_48={};}var _49=this.getLayer(_45);if(_e.deepEqual(_49.getLayoutProperty(_46),_47)){return;}_49.setLayoutProperty(_46,_47,_48);this._updateLayer(_49);};_11.prototype._updateWorkerLayers=function(_4a,_4b){this.dispatcher.broadcast("updateLayers",{layers:this._serializeLayers(_4a),removedIds:_4b});};_11.prototype._resetUpdates=function(){this._changed=false;this._updatedLayers={};this._removedLayers={};this._updatedSources={};this._updatedPaintProps={};};_11.prototype.update=function(_4c){var _4d=this._changed;if(this._changed){var _4e=Object.keys(this._updatedLayers);var _4f=Object.keys(this._removedLayers);if(_4e.length||_4f.length){this._updateWorkerLayers(_4e,_4f);}for(var id in this._updatedSources){var _50=this._updatedSources[id];if(_50==="reload"){this._reloadSource(id);}else{if(_50==="clear"){this._clearSource(id);}}}for(var _51 in this._updatedPaintProps){this._layers[_51].updateTransitions(_4c);}this._resetUpdates();}this.sourceCache.used=false;for(var i=0,_52=this._order;i<_52.length;i+=1){var _53=_52[i];var _54=this._layers[_53];_54.recalculate(_4c);if(!_54.isHidden(_4c.zoom)&&_54.source){this.sourceCache.used=false;}}this.z=_4c.zoom;if(_4d){}};_11.prototype._reloadSource=function(id){this.sourceCache.resume();this.sourceCache.reload();};_11.prototype._clearSource=function(id){this.sourceCache.clearTiles();};_11.prototype._updateLayer=function(_55){this._updatedLayers[_55.id]=true;if(_55.source&&!this._updatedSources[_55.source]){this._updatedSources[_55.source]="reload";this.sourceCache.pause();}this._changed=true;};return _11;});