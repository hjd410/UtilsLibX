//>>built
define("com/huayun/webgis/layers/3d/HeatMapSceneLayer",["dojo/_base/declare","dojo/topic","dojo/request","./VectorTextureSceneLayer"],function(_1,_2,_3,_4){return _1("com.huayun.webgis.layers.3d.HeatMapSceneLayer",[_4],{heatmap:null,heatMapDomId:"map",heatMapData:[],geomKey:"geom",valueKey:"photo_num",group:null,texture:null,map:null,url:null,loadPromise:null,movex:0,movey:0,name:"热力图",layerLv:14,time:"2019-04-20",constructor:function(_5){_1.safeMixin(this,_5);var _6=this;this.group=new THREE.Group();this.div=document.createElement("div");this.div.style.width=this.map.width+"px";this.div.style.height=this.map.height+"px";this.heatmap=h337.create({container:this.div,maxOpacity:1,radius:30,blur:0.95,width:this.map.width,height:this.map.height});this.texture=new THREE.CanvasTexture(this.div.firstChild);var _7=new THREE.PlaneBufferGeometry(_6.map.width,_6.map.height);var _8=new THREE.MeshBasicMaterial({map:_6.texture,transparent:true});_8.depthTest=false;this.plane=new THREE.Mesh(_7,_8);this.plane.position.set(0,0,0.02);this.plane.renderOrder=3;this.group.add(this.plane);this.group.visible=this.visible;},readyData:function(){var _9=this.map.level;if(_9<this.layerLv){if(this.visible){if(!this.group.visible){this.group.visible=true;}this.fetchData();}else{if(this.group.visible){this.group.visible=false;}}}else{this.group.visible=false;}},startRender:function(){if(this.group.visible){var _a=Math.pow(2,this.map.initLevel-this.map.level);this.group.scale.set(_a,_a,1);this.render();}},fetchData:function(){var _b=this.map.extent,_c=this.map.level;var _d=this.url+"?bbox="+_b.minx+","+_b.miny+","+_b.maxx+","+_b.maxy+"&level="+_c+"&time="+this.time;this.loadPromise=_3.get(_d,{handleAs:"json"});},resetHeatMapData:function(_e){var _f=this;var _10=[];var hw=this.map.width/2,hh=this.map.height/2,_11=this.map.extent.getCenter(),cx=_11.x,cy=_11.y,max=0,_12=this.map.resolution;if(_e){var len=_e.length,_13,p,sx,sy,_14;for(var i=0;i<len;i++){_13=_e[i];p=_f.getGeoPointXY(_13[_f.geomKey]);sx=Math.floor((p.x-cx)/_12+hw);sy=Math.floor(hh-(p.y-cy)/_12);_14=parseFloat(_13[_f.valueKey]);max=Math.max(max,_14);_10.push({x:sx,y:sy,value:_14});}}var _15={max:max,data:_10};return _15;},getGeoPointXY:function(_16){var _17={x:0,y:0};if(_16.startsWith("POINT")){var _18=_16.indexOf("(");var _19=_16.indexOf(")");var _1a=_16.slice(_18+1,_19);var _1b=_1a.split(" ");_17.x=_1b[0];_17.y=_1b[1];}return _17;},render:function(){var _1c=this;if(this.loadPromise){this.loadPromise.then(function(res){var _1d=_1c.resetHeatMapData(res["g_yx_measurebox"]);_1c.heatmap.setData(_1d);_1c.heatmap.repaint();this.group.position.x-=this.movex;this.group.position.y+=this.movey;this.movex=0;this.movey=0;this.texture.needsUpdate=true;this.map.layerContainer.threeRender();}.bind(this));}},createTexture:function(_1e){var _1f=new THREE.Texture(_1e);_1f.needsUpdate=true;_1f.wrapS=THREE.RepeatWrapping;_1f.wrapT=THREE.RepeatWrapping;return _1f;}});});