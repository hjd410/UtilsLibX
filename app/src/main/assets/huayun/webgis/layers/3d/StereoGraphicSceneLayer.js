//>>built
define("com/huayun/webgis/layers/3d/StereoGraphicSceneLayer",["dojo/_base/declare","dojo/request","dojo/topic","dojo/dom-construct","./TileSceneLayer","./GraphicSceneLayer","../../geometry/Extent","../../geometry/MapPoint","../../geometry/Point","../support/Tile"],function(_1,_2,_3,_4,_5,_6,_7,_8){return _1("com.huayun.webgis.layers.3d.StereoGraphicSceneLayer",[_5,_6],{group:null,map:null,extrudeSettings:null,material:null,name:"矢量底图",origin:null,size:256,url:null,configUrl:null,lastIndexArray:[],currentIndexArray:[],needRemovedArrayOfTielIndex:[],needLoadIndex:[],vectorCache:null,poiCache:null,layerLv:12,buildingData:null,iconObj:null,needRemoveObj:null,indexIds:null,loadPromise:null,selectedPoi:[],constructor:function(_9){_1.safeMixin(this,_9);this.group=new THREE.Group();this.group.visible=_9.visible;this.extrudeSettings={depth:50,bevelEnabled:false,bevelSegments:1,steps:1,bevelSize:1,bevelThickness:1,curveSegments:1};this.material=new THREE.MeshLambertMaterial({color:14540253,transparent:false,opacity:1});this.vectorCache={};this.poiCache={};this.buildingData={};this.iconObj={};this.needRemoveObj=[];this.indexIds={};this.loadPromise={};this.selectPOIID=null;this.poiNode=_4.create("div",{id:"poiResult"});this.moveNode=_4.create("div",{id:"poiMove",innerHTML:"点击可查看详情"});document.body.appendChild(this.poiNode);document.body.appendChild(this.moveNode);_3.subscribe("mapOnClick",function(_a,x,y){var _b=_a[this.id],_c=_b?_b.length:0;for(var i=_c-1;i>-1;i--){if(_b[i].object.isSprite){this.poiNode.innerText=_b[i].object.userData.name;this.poiNode.style.top=y+"px";this.poiNode.style.left=x+"px";this.poiNode.style.display="block";this.selectPOIID=_b[i].object.uuid;this.moveNode.style.display="none";return;}}this.poiNode.style.display="none";}.bind(this));_3.subscribe("mapMovePOI",function(_d,x,y){if(_d&&_d!==this.selectPOIID){this.moveNode.style.top=(y+3)+"px";this.moveNode.style.left=(x+3)+"px";this.moveNode.style.display="block";}else{this.moveNode.style.display="none";}}.bind(this));},resize:function(){this.refresh();},pan:function(_e,_f,_10){this.group.position.x+=_e;this.group.position.y-=_f;if(_10){this.refresh();}},refresh:function(){if(this.visible){this.readyData();this.startRender();}},readyData:function(){var _11=this.map.level;if(_11>this.layerLv){if(this.visible){if(!this.group.visible){this.group.visible=true;}this.computeIndex();this.removeTiles();this.fetchTiles();}else{if(this.group.visible){this.group.visible=false;}}}else{if(this.group.visible){this.clearTiles();this.lastIndexArray=[];}this.group.visible=false;}},computeIndex:function(){var _12=this.map.origin,_13=this.map.size,_14=this.map.extent,_15=this.map.resolution,_16=this.map.level,rs=_15*_13;var _17=Math.floor((_14.minx-_12.x)/rs),_18=Math.floor((_12.y-_14.maxy)/rs),_19=Math.ceil((_14.maxx-_12.x)/rs),_1a=Math.ceil((_12.y-_14.miny)/rs);this.currentIndexArray=[];this.needLoadIndex=[];if(this.map.needCal){this.startCol=_17;this.startRow=_18;this.endCol=_19;this.endRow=_1a;this.group.position.x=0;this.group.position.y=0;}var _1b,i,j;for(i=_18;i<_1a;i++){for(j=(_17);j<(_19);j++){if(i>=0&&j>=0){_1b=_16+"/"+j+"/"+i;this.currentIndexArray.push(_1b);}}}var _1c=false,_1d=false;var _1e=this.lastIndexArray.concat(this.currentIndexArray);for(i=0;i<_1e.length;i++){_1c=false;_1d=false;for(j=0;j<this.lastIndexArray.length;j++){if(_1e[i]==this.lastIndexArray[j]){_1c=true;break;}}for(j=0;j<this.currentIndexArray.length;j++){if(_1e[i]==this.currentIndexArray[j]){_1d=true;break;}}if(_1c&&!_1d){this.needRemovedArrayOfTielIndex.push(_1e[i]);}if(_1d&&!_1c){this.needLoadIndex.push(_1e[i]);}}this.lastIndexArray=this.currentIndexArray;},fetchTiles:function(){if(this.group.visible){var url=null,_1f,len=this.needLoadIndex.length;if(len>0){for(var p=0;p<len;p++){_1f=this.needLoadIndex[p];this.loadPromise[_1f]=_2(this.url+_1f+".pbf",{handleAs:"arraybuffer"});}}else{this.map.layerContainer.threeRender();}}},removeTiles:function(){var _20=Math.pow(2,this.map.initLevel-this.map.level);this.group.scale.set(_20,_20,1);var _21;for(var n=0;n<this.needRemovedArrayOfTielIndex.length;n++){_21=this.needRemovedArrayOfTielIndex[n];this.group.remove(this.vectorCache[_21]);this.group.remove(this.poiCache[_21]);delete this.vectorCache[_21];delete this.poiCache[_21];var ids=this.indexIds[_21];if(ids){for(var i=0;i<ids.length;i++){delete this.buildingData[ids[i]];}}}for(n=0;n<this.needRemoveObj.length;n++){this.group.remove(this.needRemoveObj[n]);}this.needRemoveObj=[];this.needRemovedArrayOfTielIndex=[];},clearTiles:function(){var _22=Math.pow(2,this.map.initLevel-this.map.level);this.group.scale.set(_22,_22,1);var _23=this.group.children,_24;for(var i=_23.length-1;i>-1;i--){_24=_23[i];_24.geometry.dispose();if(_24.isSprite){_24.material.map.dispose();_24.material.dispose();}this.group.remove(_24);}this.vectorCache={};this.poiCache={};this.indexIds={};this.buildingData={};this.needRemoveObj=[];this.needRemovedArrayOfTielIndex=[];},onload:function(_25,_26,_27,len){if(_25.length>0){var _28=Number(_26[1]);var _29=Number(_26[2]);var _2a=[];var _2b=true;var _2c=this.map.origin;var pos=this.group.position;var px=_28*this.map.resolution*256+_2c.x,py=_2c.y-_29*this.map.resolution*256,_2d=this.map.extent.getCenter(),_2e=(px-_2d.x)/this.map.resolution-pos.x*this.map.initResolution/this.map.resolution,_2f=(py-_2d.y)/this.map.resolution-256-pos.y*this.map.initResolution/this.map.resolution;for(var i=_25.length-1;i>-1;i--){var _30=_25[i].type_;var _31=_25[i].flatCoordinates_;var _32=_25[i].properties_;if(_30!="Point"){_2a.push({data:_31,properties_:_32});}else{if(_2b){this.drawPoi2(_31,_32.name,_2e,_2f,_27);_2b=false;}}}this.vectorCache[_27]={buildData:_2a};this.drawWholeTile2(_2a,_2e,_2f,_27,_28,_29);}},drawWholeTile2:function(_33,_34,_35,_36,col,row){var _37,id,h;var _38=this.map.initResolution;var g=new THREE.Geometry();for(var i=0;i<_33.length;i++){_37=_33[i].data;_37=_33[i].data;h=_33[i].properties_.height;id=_33[i].properties_.id;if(!this.buildingData.hasOwnProperty(id)){this.buildingData[id]=[];}this.buildingData[id].push({data:_37,col:col,row:row,h:h});var _39=_37[0]/16,_3a=_37[1]/16,len=_37.length;var _3b=new THREE.Shape();_3b.moveTo(_39,256-_3a);for(var j=2;j<len-2;j=j+2){var _3c=_37[j]/16,_3d=_37[j+1]/16;_3b.lineTo(_3c,256-_3d);}this.extrudeSettings.depth=h/_38*2;var _3e=new THREE.ExtrudeGeometry(_3b,this.extrudeSettings);g.merge(_3e);}var _3f=new THREE.Mesh(g,this.material);_3f.position.set(_34,_35,0);this.vectorCache[_36]=_3f;this.group.add(_3f);this.map.layerContainer.threeRender();},onError:function(){},drawPoi2:function(_40,_41,_42,_43,_44){var _45=Math.pow(2,this.map.initLevel-this.map.level);var _46=_40[0]/16;var _47=_40[1]/16;var _48=document.createElement("canvas");_48.width=256;_48.height=64;var ctx=_48.getContext("2d");ctx.fillStyle="#5BBAD3";ctx.strokeStyle="#5BBAD3";ctx.font="25px 微软雅黑";var _49="xiezilou";if(_41.length<9){ctx.strokeText(_41,32,25);ctx.fillText(_41,32,25);}else{var l=Math.floor(_41.length/2);var _4a=_41.substring(0,l);var _4b=_41.substring(l);ctx.strokeText(_4a,32,25);ctx.fillText(_4a,32,25);ctx.strokeText(_4b,32,54);ctx.fillText(_4b,32,54);}var _4c=new THREE.Texture(_48);_4c.needsUpdate=true;_4c.minFilter=THREE.LinearFilter;var ma=new THREE.SpriteMaterial({map:_4c,sizeAttenuation:false,depthTest:false});var o=new THREE.Sprite(ma);o.name=_41;o.userData={name:_41};o.position.set(_42+_46,_43+256-_47,0);o.scale.set(0.08/_45,0.02/_45,1/_45);this.group.add(o);this.poiCache[_44]=o;this.map.layerContainer.threeRender();},drawPoi:function(_4d,_4e,_4f,_50,ddx,ddy,_51){var _52=Math.pow(2,this.map.initLevel-this.map.level);var _53=this.map.initz;var dx=_4f*256-ddx;var dy=_50*256-ddy;var _54=_4d[0]/16+dx;var _55=_4d[1]/16+dy;var _56=this.map.height;var _57=document.createElement("canvas");_57.width=256;_57.height=64;var ctx=_57.getContext("2d");ctx.fillStyle="#5BBAD3";ctx.strokeStyle="#5BBAD3";ctx.font="25px 微软雅黑";var _58="xiezilou";if(_4e.length<9){ctx.strokeText(_4e,32,25);ctx.fillText(_4e,32,25);}else{var l=Math.floor(_4e.length/2);var _59=_4e.substring(0,l);var _5a=_4e.substring(l);ctx.strokeText(_59,32,25);ctx.fillText(_59,32,25);ctx.strokeText(_5a,32,54);ctx.fillText(_5a,32,54);}var _5b=new THREE.Texture(_57);_5b.needsUpdate=true;_5b.minFilter=THREE.LinearFilter;var ma=new THREE.SpriteMaterial({map:_5b,sizeAttenuation:false,depthTest:false});var o=new THREE.Sprite(ma);o.name=_4e;if(this.map.rotationAngela!==0){var e=this.map.extent;var r=this.map.resolution;var w=e.getWidth()/r/2,h=e.getHeight()/r/2;o.position.set(_54-w+0.08/_52*128,h-_55+32*0.02/_52,0);}else{o.position.set(_54-this.map.width/2+0.08/_52*128,_56/2-_55+32*0.02/_52,0);}o.scale.set(1/_53*256,1/_53*64,1);this.group.add(o);this.poiCache[_51]=o;this.map.layerContainer.threeRender();},startRender:function(){if(this.group.visible){this.render();}},render:function(){var len=this.needLoadIndex.length;this.needLoadIndex.forEach(function(_5c){this.loadPromise[_5c].then(function(_5d){var _5e=new ol.format.MVT();var _5f=_5e.readFeatures(_5d);this.onload(_5f,_5c.split("/"),_5c,len);}.bind(this),function(_60){});}.bind(this));},setVisible:function(_61){this.visible=_61;this.group.visible=_61;if(_61){this.refresh();}else{this.map.layerContainer.threeRender();}},getObjects:function(){return this.buildingData;},locateByBuildId:function(id){if(this.buildingData.hasOwnProperty(id)){var _62=this.buildingData[id][0];var _63=this.map.size,_64=this.map.origin,r=this.map.resolution,px=_62.data[0],py=_62.data[1],col=_62.col,row=_62.row;var x=Math.floor(((px/_63/16+col)*r*_63+_64.x)*100)/100;var y=Math.floor((_64.y-(py/_63/16+row)*r*_63)*100)/100;return {x:x,y:y};}else{return null;}},renderBuild:function(_65){var _66=this.map.initResolution;var _67=this.buildingData[_65];var _68=this.map.size,_69=this.map.origin,r=this.map.resolution;var _6a=[];var col,row,_6b;var h=_67[0].h;for(var i=0;i<1;i++){col=_67[i].col;row=_67[i].row;_6b=_67[i].data;for(var j=0;j<_6b.length;j=j+2){var x=Math.floor(((_6b[j]/_68/16+col)*r*_68+_69.x)*100)/100;var y=Math.floor((_69.y-(_6b[j+1]/_68/16+row)*r*_68)*100)/100;_6a.push(x,y);}}var _6c=this.map.geometryTo3D(new _8(_6a[0],_6a[1]));var _6d;var _6e=new THREE.Shape(),len=_6a.length;_6e.moveTo(_6c.x,_6c.y);for(i=2;i<len;i=i+2){_6d=this.map.geometryTo3D(new _8(_6a[i],_6a[i+1]));_6e.lineTo(_6d.x,_6d.y);}this.extrudeSettings.depth=h/_66*2;var _6f=new THREE.ExtrudeGeometry(_6e,this.extrudeSettings);var _70=new THREE.Mesh(_6f,new THREE.MeshLambertMaterial({color:6011603}));var pos=this.group.position;_70.position.set(-_6c.x-pos.x,-_6c.y-pos.y,2);this.group.add(_70);this.needRemoveObj.push(_70);this.map.layerContainer.threeRender();},rectSelect:function(_71){this.removeSelectedPoi();var _72=this.group.children,pos,pt;for(var i=_72.length-1;i>-1;i--){if(_72[i].isSprite){pos=_72[i].position;pt=turf.point([pos.x,pos.y]);if(turf.booleanPointInPolygon(pt,_71)){_72[i].material.color=new THREE.Color(16711680);this.selectedPoi.push(_72[i]);}}}},circleSelect:function(_73){this.removeSelectedPoi();var _74=this.group.children,pos,pt;for(var i=_74.length-1;i>-1;i--){if(_74[i].isSprite){pos=_74[i].position;pt=turf.point([pos.x,pos.y]);if(turf.booleanPointInPolygon(pt,_73)){_74[i].material.color=new THREE.Color(16711680);this.selectedPoi.push(_74[i]);}}}},removeSelectedPoi:function(){if(this.selectedPoi&&this.selectedPoi.length>0){this.selectedPoi.forEach(function(_75){_75.material.color=new THREE.Color(2655160);});}this.selectedPoi=[];}});});