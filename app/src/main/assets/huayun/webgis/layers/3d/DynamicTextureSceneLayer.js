//>>built
define("com/huayun/webgis/layers/3d/DynamicTextureSceneLayer",["dojo/_base/declare","../../request","./TextureSceneLayer"],function(_1,_2,_3){return _1("com.huayun.webgis.layers.3d.DynamicTextureSceneLayer",[_3],{constructor:function(_4){_1.safeMixin(this,_4);var _5=this.map.width,_6=this.map.height;this.canvas=document.createElement("canvas");this.canvas.width=_5;this.canvas.height=_6;this.ctx=this.canvas.getContext("2d");this.ctx.imageSmoothingEnabled=false;this.group=new THREE.Group();var _7=new THREE.PlaneBufferGeometry(_5,_6);this.texture=new THREE.CanvasTexture(this.canvas);this.texture.generateMipmaps=false;this.texture.magFilter=THREE.NearestFilter;this.texture.minFilter=THREE.NearestFilter;if(this.map.is3D){this.texture.anisotropy=16;}else{this.texture.anisotropy=1;}var _8=new THREE.MeshBasicMaterial({map:this.texture,transparent:true,opacity:this.opacity});this.plane=new THREE.Mesh(_7,_8);this.plane.renderOrder=2;this.group.renderOrder=2;this.group.add(this.plane);this.group.visible=this.visible;},resize:function(){this.plane.geometry.dispose();this.plane.material.dispose();this.texture.dispose();this.group.remove(this.plane);var _9=this.map.width,_a=this.map.height;this.canvas=document.createElement("canvas");this.canvas.width=_9;this.canvas.height=_a;this.ctx=this.canvas.getContext("2d");this.ctx.imageSmoothingEnabled=false;var _b=new THREE.PlaneBufferGeometry(_9,_a);this.texture=new THREE.CanvasTexture(this.canvas);this.texture.magFilter=THREE.NearestFilter;this.texture.minFilter=THREE.NearestFilter;var _c=new THREE.MeshBasicMaterial({map:this.texture,transparent:true});this.plane=new THREE.Mesh(_b,_c);this.plane.position.set(0,0,0.01);this.plane.renderOrder=2;this.group.add(this.plane);this.refresh();},fetchData:function(){if(this.map.extent){var _d=this.fetchUrl(this);if(this.loadPromise&&!this.loadPromise.isResolved()){this.loadPromise.cancel();}this.loadPromise=_2(_d,{responseType:"image",allowImageDataAccess:false});}else{this.loadPromise=null;}},fetchUrl:function(){return this.url;},render:function(){var _e=this;var _f=this.map.width,_10=this.map.height;var _11=(this.map.width-this.map.realWidth)/2,_12=(this.map.height-this.map.realHeight)/2;var _13=this.map.rotationAngela,cos=Math.abs(Math.cos(_13/180*Math.PI)),sin=Math.abs(Math.sin(_13/180*Math.PI));var _14=Math.round(_11*cos+_12*sin),_15=Math.round(_11*sin+_12*cos);this.ctx.clearRect(0,0,this.map.width,this.map.height);this.texture.needsUpdate=true;this.map.layerContainer.threeRender();if(this.loadPromise){this.loadPromise.then(function(_16){if(_16.data){var _17=Math.pow(2,_e.map.initLevel-_e.map.level);_e.group.scale.set(_17,_17,1);_e.ctx.save();var _18=_e.map.rotationAngela,_19=_e.deltaAngela;var _1a=Math.PI*_18/180,_1b=Math.PI*_19/180,_1c=Math.abs(Math.sin(_1a)),_1d=Math.abs(Math.cos(_1a)),px=_f/2,py=_10/2;_e.group.rotateZ(_1b);_e.deltaAngela=0;_e.ctx.translate(px,py);_e.ctx.rotate(_1a);var tx=-px*_1d-py*_1c,ty=-py*_1d-px*_1c;_e.ctx.translate(tx,ty);_e.ctx.drawImage(_16.data,_14,_15);_e.texture.needsUpdate=true;_e.ctx.restore();_e.group.position.x=0;_e.group.position.y=0;_e.movex=0;_e.movey=0;_e.map.layerContainer.threeRender();}});}},setOpacity:function(_1e){this.opacity=_1e;this.plane.material.opacity=_1e;this.map.layerContainer.threeRender();}});});