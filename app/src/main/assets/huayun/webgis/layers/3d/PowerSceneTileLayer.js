//>>built
define("com/huayun/webgis/layers/3d/PowerSceneTileLayer",["dojo/_base/declare","dojo/topic","./SceneLayer","../../request","../../facade/PowerFacade"],function(_1,_2,_3,_4,_5){return _1("com.huayun.webgis.layers.3d.PowerSceneTileLayer",[_3],{group:null,canvas:null,ctx:null,texture:null,map:null,url:null,loadPromise:null,movex:0,movey:0,name:"电网图",_powerFacade:null,_powerLayers:[],version:0,constructor:function(_6){_1.safeMixin(this,_6);this.version=0;var _7=this.map.width,_8=this.map.height;this.canvas=document.createElement("canvas");this.canvas.width=_7;this.canvas.height=_8;this.ctx=this.canvas.getContext("2d");this.ctx.imageSmoothingEnabled=false;this.group=new THREE.Group();var _9=new THREE.PlaneBufferGeometry(_7,_8);this.texture=new THREE.CanvasTexture(this.canvas);this.texture.magFilter=THREE.NearestFilter;this.texture.minFilter=THREE.NearestFilter;if(this.map.is3D){this.texture.anisotropy=16;}else{this.texture.anisotropy=1;}var _a=new THREE.MeshBasicMaterial({map:this.texture,transparent:true});this.plane=new THREE.Mesh(_9,_a);this.plane.renderOrder=2;this.group.renderOrder=2;this.group.add(this.plane);this.group.visible=this.visible;var _b=/^((http|https):\/\/.*\/)/;var _c=this.url.match(_b)[0]+"?f=json";this._powerFacade=new _5({url:_c});this._getMapInfoMethod();},pan:function(_d,_e,_f){this.group.position.x+=_d;this.group.position.y-=_e;this.movex+=_d;this.movey+=_e;if(_f){this.refresh();}},resize:function(){this.plane.geometry.dispose();this.plane.material.dispose();this.texture.dispose();this.group.remove(this.plane);var _10=this.map.width,_11=this.map.height;this.canvas=document.createElement("canvas");this.canvas.width=_10;this.canvas.height=_11;this.ctx=this.canvas.getContext("2d");this.ctx.imageSmoothingEnabled=false;var _12=new THREE.PlaneBufferGeometry(_10,_11);this.texture=new THREE.CanvasTexture(this.canvas);this.texture.magFilter=THREE.NearestFilter;this.texture.minFilter=THREE.NearestFilter;var _13=new THREE.MeshBasicMaterial({map:this.texture,transparent:true});this.plane=new THREE.Mesh(_12,_13);this.group.add(this.plane);this.refresh();},_getMapInfoMethod:function(){this._powerFacade.getMapInfoData(function(_14){this._powerLayers=_14["layers"];}.bind(this),function(_15){}.bind(this));},refresh:function(){this.readyData();this.startRender();},readyData:function(){if(this.visible){this.fetchTiles();}},fetchTiles:function(){var _16=this.map.extent;var _17=this.map.resolution;if(_16){var _18=Math.round(_16.getWidth()/_17),_19=Math.round(_16.getHeight()/_17),url=this.url+"&bbox="+_16.minx+","+_16.miny+","+_16.maxx+","+_16.maxy+"&size="+_18+","+_19;if(this.loadPromise&&!this.loadPromise.isResolved()){this.loadPromise.cancel();}this.loadPromise=_4(url,{responseType:"image",allowImageDataAccess:false});}else{this.loadPromise=null;}},startRender:function(){if(this.visible){this.render();}},render:function(){var obj=this;var _1a=this.map.width,_1b=this.map.height;var _1c=(this.map.width-this.map.realWidth)/2,_1d=(this.map.height-this.map.realHeight)/2;var _1e=this.map.rotationAngela,cos=Math.abs(Math.cos(_1e/180*Math.PI)),sin=Math.abs(Math.sin(_1e/180*Math.PI));var _1f=Math.round(_1c*cos+_1d*sin),_20=Math.round(_1c*sin+_1d*cos);this.ctx.clearRect(0,0,this.map.width,this.map.height);this.texture.needsUpdate=true;this.map.layerContainer.threeRender();if(this.loadPromise){this.loadPromise.then(function(_21){if(_21.data){var _22=Math.pow(2,obj.map.initLevel-obj.map.level);obj.group.scale.set(_22,_22,1);obj.ctx.save();var _23=obj.map.rotationAngela,_24=obj.deltaAngela;var _25=Math.PI*_23/180,_26=Math.PI*_24/180,_27=Math.abs(Math.sin(_25)),_28=Math.abs(Math.cos(_25)),px=_1a/2,py=_1b/2;obj.group.rotateZ(_26);obj.deltaAngela=0;obj.ctx.translate(px,py);obj.ctx.rotate(_25);var tx=-px*_28-py*_27,ty=-py*_28-px*_27;obj.ctx.translate(tx,ty);obj.ctx.drawImage(_21.data,_1f,_20);obj.texture.needsUpdate=true;obj.ctx.restore();obj.group.position.x=0;obj.group.position.y=0;obj.movex=0;obj.movey=0;obj.map.layerContainer.threeRender();}});}},setVisible:function(_29){this.visible=_29;this.group.visible=_29;if(_29){this.refresh();}else{this.map.layerContainer.threeRender();}},openGridLayerMethod:function(){this.setVisible(true);},closeGridLayerMethod:function(){this.setVisible(false);},updateShowHideMethod:function(key,_2a){var _2b=_2a.get(key);var _2c="";if(_2b.visible){_2c="show";}else{_2c="hide";}this._getFetchTiles(_2c,_2a);this.startRender();},_getFetchTiles:function(_2d,_2e){var _2f=[];var _30=[];var _31=_2e.getKeyList();for(var i=0;i<_31.length;i++){var _32=_31[i];var _33=_2e.get(_32);var _34=this._getsubLayerIdsMethod(_32);if(_33.visible){_2f.push(_34);}else{_30.push(_34);}}var _35=this._getLayerParamsMethod(_2d,_2f,_30);var _36=this.map.extent;var _37=this.map.resolution;if(_36){var _38=Math.round(_36.getWidth()/_37),_39=Math.round(_36.getHeight()/_37),url=this.url+"&bbox="+_36.minx+","+_36.miny+","+_36.maxx+","+_36.maxy+"&size="+_38+","+_39+"&"+_35;if(this.loadPromise&&!this.loadPromise.isResolved()){this.loadPromise.cancel();}this.loadPromise=_4(url,{responseType:"image",allowImageDataAccess:false});}else{this.loadPromise=null;}},_getsubLayerIdsMethod:function(key){for(var i=0;i<this._powerLayers.length;i++){if(this._powerLayers[i]["name"]===key){return this._powerLayers[i]["subLayerIds"];}}return null;},_getLayerParamsMethod:function(_3a,_3b,_3c){var _3d="";var _3e=[],_3f=[];var i=0;if(_3a==="show"){for(i=0;i<_3b.length;i++){_3f=_3b[i];_3e=_3e.concat(_3f);}}else{if(_3a==="hide"){for(i=0;i<_3c.length;i++){_3f=_3c[i];_3e=_3e.concat(_3f);}}}var _40=[];for(var j=0;j<_3e.length;j++){_40.push(_3e[j]);}_3d="layers="+_3a+":"+_40.toString();return _3d;},setOpacity:function(_41){this.opacity=_41;this.plane.material.opacity=_41;this.map.layerContainer.threeRender();}});});