//>>built
define("com/huayun/webgis/layers/3d/DrawSceneLayer",["dojo/_base/declare","dojo/topic","dojo/on","./SceneLayer","../../geometry/MapPoint","../../symbols/CircleSpriteSymbol","../../symbols/LineSymbol","../../symbols/PolygonSymbol","../../symbols/CircleSymbol","../../Feature","../../Graphic"],function(_1,_2,on,_3,_4,_5,_6,_7,_8,_9,_a){return _1("com.huayun.webgis.layers.3d.DrawSceneLayer",[_3],{group:null,map:null,lineSymbol:null,mainColor:255,currentGraphic:null,lineMaterial:null,lineObj:null,lineIndex:0,lineNodeMaterial:null,linePrevPoint:null,circleObj:null,circleIndex:0,circleMaterial:null,polygonObj:null,polygonIndex:0,polygonArray:[],polygonMaterial:null,sphereObj:null,sphereIndex:0,sphereMaterial:null,name:"画图图层",id:"graphic",dotSymbol:null,measureLineNodes:[],measureLines:{},AngleNodes:[],constructor:function(_b){var _c=this;_1.safeMixin(this,_b);this.group=new THREE.Group();this.dotSymbol=new _5({r:10,fill:16711680,initz:this.map.initz});this.lineSymbol=new _6({color:16711680,isDashLine:false,linewidth:1});this.polygonSymbol=new _7({color:16711680,depthTest:false});this.circleSymbol=new _8({color:16711680,fillAlpha:1,depthTest:false});this.lineMaterial=new THREE.LineBasicMaterial({color:_c.mainColor,depthTest:false});this.lineNodeMaterial=new THREE.PointsMaterial({size:2,color:_c.mainColor,depthTest:false});this.circleMaterial=new THREE.LineBasicMaterial({color:_c.mainColor,depthTest:false});this.polygonMaterial=new THREE.MeshPhongMaterial({color:_c.mainColor,depthTest:false});this.sphereMaterial=new THREE.MeshLambertMaterial({color:_c.mainColor,wireframe:true});this.lineIndex=0;this.circleIndex=0;this.polygonIndex=0;this.sphereIndex=0;this.lineObj=new Object();this.circleObj=new Object();this.polygonObj=new Object();this.polygonArray=new Array();this.sphereObj=new Object();var _d=this;_2.subscribe("calculatePolyArea",function(){var _e=_d.polygonArray;var _f=0;for(var i=0;i<_e.length-1;i++){_f+=_e[i].x*_e[i+1].y-_e[i+1].x*_e[i].y;}_f=_f*_d.map.resolution*_d.map.resolution;var _10=_d.map.screenTo3dPoint(_e[0].x,_e[0].y);var _11="";if(_f>1000000){_11=(_f/1000000).toFixed(2)+"平方千米";}else{_11=_f.toFixed(2)+"平方米";}_d.addTextTexture({text:_11},_d.map.screenTo3dPoint(_e[0].x,_e[0].y));});_2.subscribe("clearMapGraphic",function(){var _12=_d.group.children;_d.lineIndex=0;_d.circleIndex=0;_d.polygonIndex=0;_d.sphereIndex=0;_d.linePrevPoint={};_d.lineObj={};_d.circleObj={};_d.polygonObj={};_d.polygonArray=[];_d.sphereObj={};_d.measureLineNodes=[];_d.measureLines={};_d.AngleNodes=[];for(var i=_12.length-1;i>-1;i--){_d.group.remove(_12[i]);}_d.map.layerContainer.threeRender();});},addPoint:function(_13){var _14=this.map.rotationAngela/180*Math.PI,_15=this.group.position;_13=this.map.calRotatePoint(_13.x,_13.y,_14);_13.x=_13.x-_15.x;_13.y=_13.y-_15.y;var _16=new _9({_geometry:new _4(_13.x,_13.y,0.1)});var _17=new _a({feature:_16,symbol:this.dotSymbol,graphicLayer:this});this.addGraphic(_17);},addLinePoint:function(_18){var _19=this.group.position,_1a=this.map.rotationAngela/180*Math.PI;var _1b=new THREE.Geometry();this.linePrevPoint=_18;_1b.vertices.push(new THREE.Vector3(_18.x,_18.y,0.1));var _1c=new THREE.Points(_1b,this.lineNodeMaterial);_1c.rotateZ(_1a);_1c.position.set(-_19.x,-_19.y,0.1);this.group.add(_1c);this.lineIndex++;this.map.layerContainer.threeRender();},addLine:function(sp,ep){var _1d=[sp.x,sp.y,0,ep.x,ep.y,0];var _1e=new _9({_geometry:_1d});var _1f=new _a({feature:_1e,symbol:this.lineSymbol,graphicLayer:this});this.currentGraphic=_1f;this.addGraphic(_1f);},addPolygon:function(_20){var _21=new _9({_geometry:_20});var _22=new _a({feature:_21,symbol:this.polygonSymbol,graphicLayer:this});this.currentGraphic=_22;this.addGraphic(_22);},addCircle:function(cp,r){var _23=new _9({_geometry:new _4(cp.x,cp.y,0.1)});this.circleSymbol.r=r;var _24=new _a({feature:_23,symbol:this.circleSymbol,graphicLayer:this});this.currentGraphic=_24;this.addGraphic(_24);},addSphere:function(_25){var _26=this.group.position,_27=this.map.rotationAngela/180*Math.PI;if(this.sphereObj[this.sphereIndex]){this.group.remove(this.sphereObj[this.sphereIndex]);}var _28=new THREE.SphereGeometry(_25.r,60,60);var _29=new THREE.Mesh(_28,this.sphereMaterial);this.sphereObj[this.sphereIndex]=_29;_29.rotateZ(_27);_29.position.set(_25.cx-_26.x,_25.cy-_26.y,0.1);this.group.add(_29);this.map.layerContainer.threeRender();},createTextTexture:function(obj){var _2a=document.createElement("canvas");var ctx=_2a.getContext("2d");ctx.font=obj.font||"Bold 12px Arial";ctx.lineWidth=1;var _2b=ctx.measureText(obj.text);var _2c=_2b.width;_2a.width=128;_2a.height=64;this.createTextRect(ctx,2,2,_2c+4,26,2);ctx.strokeStyle=obj.borderColor||"#FF0000";ctx.fillStyle=obj.fontColor||"#FF0000";ctx.fillText(obj.text,4,20);ctx.backgroundColor="#FAFAD2";var _2d=new THREE.Texture(_2a);_2d.needsUpdate=true;_2d.wrapS=THREE.RepeatWrapping;_2d.wrapT=THREE.RepeatWrapping;return {"texture":_2d,"canvasW":128,"textW":_2c};},addTextTexture:function(obj,_2e){var _2f=this.createTextTexture(obj);var mat=new THREE.SpriteMaterial({map:_2f.texture,opacity:1,transparent:true,sizeAttenuation:false});var _30=new THREE.Sprite(mat);_30.scale.set(0.08,0.04,1);var p=this.group.position;_30.position.set(_2e.x-p.x,_2e.y-p.y,0.1);this.group.add(_30);this.map.layerContainer.threeRender();},pan:function(_31,_32){this.group.position.x+=_31;this.group.position.y-=_32;},addSymbol:function(_33,_34){_34.draw(this.group,_33);},addGraphic:function(_35){_35.draw();},removeGraphic:function(_36){if(_36){var _37=_36.symbol.meshs[0];_37.geometry.dispose();this.group.remove(_37);}},setVisible:function(_38){this.visible=_38;this.group.visible=_38;},lonLat2Mercator:function(poi){var _39={};var R=6378137;_39.x=poi[0]*Math.PI/180*R;var a=poi[1]*Math.PI/180;_39.y=R/2*Math.log((1+Math.sin(a))/(1-Math.sin(a)));return _39;},mercator2LonLat:function(poi){var _3a={};_3a.lng=poi.x/20037508.34*180;var m=poi.y/20037508.34*180;_3a.lat=180/Math.PI*(2*Math.atan(Math.exp(m*Math.PI/180))-Math.PI/2);return _3a;},refresh:function(){this.readyData();this.startRender();},readyData:function(){},startRender:function(){}});});