//>>built
define("com/huayun/webgis/layers/support/TerrainSourceCacheHyTerrain",["./TileSourceHyTerrain","./funcUtils","./TileCache","./Tile","./SourceFeatureState","com/huayun/webgis/layers/support/tileCover","com/huayun/webgis/geometry/Point2D","../../utils/utils","../../work/createVerticesFromQuantizedTerrainMesh","../../data/IndexDatatype","../../gl/SegmentVector","../../data/ArrayType","./TerrainMesh"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d){var _e=new _c.StructArrayLayout3f12();var _f=new _c.StructArrayLayout3ui6();_e.emplaceBack(0,0,0);_e.emplaceBack(1,0,0);_e.emplaceBack(0,1,0);_e.emplaceBack(1,1,0);_f.emplaceBack(0,1,2);_f.emplaceBack(2,1,3);function _10(id,_11,_12,_13,_14,url,_15,_16){this.id=id;this.dispatcher=_12;this._source=new _1.TerrainSourceCache(id,_11,_12,url,_16,_15);this._tiles={};this._cache=new _3(0,this._unloadTile.bind(this));this._timers={};this._cacheTimers={};this._maxTileCacheSize=null;this._coveredTiles={};this.updateCacheSize(_13,_14);this.layer=_15;this.view=_16;this.defaultIndexBuffer=this.view.context.createIndexBuffer(_f);this.defaultVertexBuffer=this.view.context.createVertexBuffer(_e,[{name:"a_pos",type:"Float32",components:3,offset:0}]);this.defaultSegments=_b.simpleSegment(0,0,4,2);};_10.prototype.constructor=_10;_10.prototype.updateTileSize=function(_17){this._source.setSize(_17);};_10.prototype.onRemove=function onRemove(map){if(this._source&&this._source.onRemove){this._source.onRemove(map);}};_10.prototype.loaded=function loaded(){if(this._sourceErrored){return true;}if(!this._sourceLoaded){return false;}for(var t in this._tiles){var _18=this._tiles[t];if(_18.state!=="loaded"&&_18.state!=="errored"){return false;}}return true;};_10.prototype.getSource=function getSource(){return this._source;};_10.prototype.pause=function pause(){this._paused=true;};_10.prototype.resume=function resume(){if(!this._paused){return;}var _19=this._shouldReloadOnResume;this._paused=false;this._shouldReloadOnResume=false;if(_19){this.reload();}if(this.transform){this.update(this.transform);}};_10.prototype._loadTile=function _loadTile(_1a,_1b){return this._source.loadTile(_1a,_1b);};_10.prototype._unloadTile=function _unloadTile(_1c){if(this._source.unloadTile){return this._source.unloadTile(_1c,function(){});}};_10.prototype._abortTile=function _abortTile(_1d){if(this._source.abortTile){return this._source.abortTile(_1d,function(){});}};_10.prototype.serialize=function serialize(){return this._source.serialize();};_10.prototype.getIds=function getIds(){var _1e=[];for(var key in this._tiles){_1e.push(this._tiles[key].tileID);}return _1e;};_10.prototype.getRenderableIds=function getRenderableIds(){var ids=[];for(var id in this._tiles){if(this._isIdRenderable(id)){ids.push(id);}}return ids.sort(_8.compareKeyZoom);};_10.prototype.hasRenderableParent=function hasRenderableParent(_1f){var _20=this.findLoadedParent(_1f,0);if(_20){return this._isIdRenderable(_20.tileID.key);}return false;};_10.prototype._isIdRenderable=function _isIdRenderable(id){return this._tiles[id]&&this._tiles[id].hasData()&&!this._coveredTiles[id]&&(!this._tiles[id].holdingForFade());};_10.prototype.reload=function reload(){if(this._paused){this._shouldReloadOnResume=true;return;}this._cache.reset();for(var i in this._tiles){if(this._tiles[i].state!=="errored"){this._reloadTile(i,"reloading");}}};_10.prototype._reloadTile=function _reloadTile(id,_21){var _22=this._tiles[id];if(!_22){return;}if(_22.state!=="loading"){_22.state=_21;}this._loadTile(_22,this._tileLoaded.bind(this,_22,id,_21));};_10.prototype.updateTileUrl=function(url){this._source.updateTileUrl(url);};_10.prototype._tileLoaded=function _tileLoaded(_23,id,_24,err,_25){if(err){_23.bucket={layoutVertexBuffer:this.defaultVertexBuffer,indexBuffer:this.defaultIndexBuffer,segments:this.defaultSegments};_23.minimumHeight=0;_23.maximumHeight=0;this.layer.layerView.drawHeightMap(this.layer.layerView,_23);this.layer.layerView._sourcesDirty=true;this.view.threeRender();}if(_25){var _26=this.view.context;_23.bucket={layoutVertexBuffer:_26.createVertexBuffer(_25.vertices,[{name:"a_pos",type:"Float32",components:3,offset:0}]),indexBuffer:_26.createIndexBuffer(_25.indices),segments:_25.segments};_23.minimumHeight=_25.minH;_23.maximumHeight=_25.maxH;this.layer.layerView.drawHeightMap(this.layer.layerView,_23);this.layer.layerView._sourcesDirty=true;this.view.threeRender();}else{_23.bucket={layoutVertexBuffer:this.layer.layerView.rasterBoundsBuffer,indexBuffer:this.layer.layerView.quadTriangleIndexBuffer,segments:this.layer.layerView.rasterBoundsSegments};_23.minimumHeight=0;_23.maximumHeight=0;this.layer.layerView._sourcesDirty=true;this.view.threeRender();}};_10.prototype.getTile=function getTile(_27){return this.getTileByID(_27.key);};_10.prototype.getTileByID=function getTileByID(id){return this._tiles[id];};_10.prototype.getZoom=function getZoom(_28){return _28.level+_28.scaleZoom(_28.tileSize/this._source.tileSize);};_10.prototype._retainLoadedChildren=function _retainLoadedChildren(_29,_2a,_2b,_2c){for(var id in this._tiles){var _2d=this._tiles[id];if(_2c[id]||!_2d.hasData()||_2d.tileID.overscaledZ<=_2a||_2d.tileID.overscaledZ>_2b){continue;}var _2e=_2d.tileID;while(_2d&&_2d.tileID.overscaledZ>_2a+1){var _2f=_2d.tileID.scaledTo(_2d.tileID.overscaledZ-1);_2d=this._tiles[_2f.key];if(_2d&&_2d.hasData()){_2e=_2f;}}var _30=_2e;while(_30.overscaledZ>_2a){_30=_30.scaledTo(_30.overscaledZ-1);if(_29[_30.key]){_2c[_2e.key]=_2e;break;}}}};_10.prototype.findLoadedParent=function findLoadedParent(_31,_32){for(var z=_31.overscaledZ-1;z>=_32;z--){var _33=_31.scaledTo(z);if(!_33){return;}var id=String(_33.key);var _34=this._tiles[id];if(_34&&_34.hasData()){return _34;}if(this._cache.has(_33)){return this._cache.get(_33);}}};_10.prototype.updateCacheSize=function updateCacheSize(_35,_36){var _37=Math.ceil(_35/this._source.tileSize)+1;var _38=Math.ceil(_36/this._source.tileSize)+1;var _39=_37*_38;var _3a=3;var _3b=Math.floor(_39*_3a);var _3c=typeof this._maxTileCacheSize==="number"?Math.min(this._maxTileCacheSize,_3b):_3b;this._cache.setMaxSize(_3c);};_10.prototype.update=function update(_3d,_3e,_3f,cx,cy){this._coveredTiles={};var _40=_6(_3d,_3e,_3f);_40=_40.sort(function(a,b){a=a.canonical;b=b.canonical;return Math.sqrt((cx-a.x)*(cx-a.x)+(cy-a.y)*(cy-a.y))-Math.sqrt((cx-b.x)*(cx-b.x)+(cy-b.y)*(cy-b.y));});var _41=this._updateRetainedTiles(_40,_3d);for(var _42 in _41){this._tiles[_42].clearFadeHold();}var _43=_8.keysDifference(this._tiles,_41);for(var i$1=0,_44=_43;i$1<_44.length;i$1+=1){var _45=_44[i$1];this._removeTile(_45);}};_10.prototype.updateTile=function updateTile(_46,_47,_48,cx,cy){this._coveredTiles={};var _49=_6(_46,_47,_48,"tms");_49=_49.sort(function(a,b){a=a.canonical;b=b.canonical;return Math.sqrt((cx-a.x)*(cx-a.x)+(cy-a.y)*(cy-a.y))-Math.sqrt((cx-b.x)*(cx-b.x)+(cy-b.y)*(cy-b.y));});this._updateRetainedTiles(_49,_46);return _49;};_10.prototype.releaseSymbolFadeTiles=function releaseSymbolFadeTiles(){for(var id in this._tiles){if(this._tiles[id].holdingForFade()){this._removeTile(id);}}};_10.prototype._updateRetainedTiles=function _updateRetainedTiles(_4a,_4b){var _4c={};var _4d={};var _4e=Math.max(_4b-_10.maxOverzooming,this._source.minzoom);var _4f=Math.max(_4b+_10.maxUnderzooming,this._source.minzoom);var _50={};for(var i=0,_51=_4a;i<_51.length;i+=1){var _52=_51[i];var _53=this._addTile(_52);_4c[_52.key]=_52;if(_53.hasData()){continue;}if(_4b<this._source.maxzoom){_50[_52.key]=_52;}}this._retainLoadedChildren(_50,_4b,_4f,_4c);for(var i$1=0,_54=_4a;i$1<_54.length;i$1+=1){var _55=_54[i$1];var _56=this._tiles[_55.key];if(_56.hasData()){continue;}if(_4b+1>this._source.maxzoom){var _57=_55.children(this._source.maxzoom)[0];var _58=this.getTile(_57);if(!!_58&&_58.hasData()){_4c[_57.key]=_57;continue;}}else{var _59=_55.children(this._source.maxzoom);if(_4c[_59[0].key]&&_4c[_59[1].key]&&_4c[_59[2].key]&&_4c[_59[3].key]){continue;}}var _5a=_56.wasRequested();for(var _5b=_55.overscaledZ-1;_5b>=_4e;--_5b){var _5c=_55.scaledTo(_5b);if(_4d[_5c.key]){break;}_4d[_5c.key]=true;_56=this.getTile(_5c);if(!_56&&_5a){_56=this._addTile(_5c);}if(_56){_4c[_5c.key]=_5c;_5a=_56.wasRequested();if(_56.hasData()){break;}}}}return _4c;};_10.prototype._reAddTile=function _reAddTile(_5d){var _5e=new _4(_5d,this._source.tileSize*_5d.overscaleFactor());this._loadTile(_5e,this._tileReAddLoaded.bind(this,_5e,_5d.key,_5e.state));};_10.prototype._tileReAddLoaded=function _tileLoaded(_5f,id,_60,err,_61){this._removeTile(id);this._tiles[_5f.tileID.key]=_5f;if(err){_5f.bucket={layoutVertexBuffer:this.defaultVertexBuffer,indexBuffer:this.defaultIndexBuffer,segments:this.defaultSegments};_5f.minimumHeight=0;_5f.maximumHeight=0;this.layer.layerView.drawHeightMap(this.layer.layerView,_5f);this.layer.layerView._sourcesDirty=true;this.view.threeRender();}if(_61){var _62=this.view.context;_5f.bucket={layoutVertexBuffer:_62.createVertexBuffer(_61.vertices,[{name:"a_pos",type:"Float32",components:3,offset:0}]),indexBuffer:_62.createIndexBuffer(_61.indices),segments:_61.segments};_5f.minimumHeight=_61.minH;_5f.maximumHeight=_61.maxH;this.layer.layerView.drawHeightMap(this.layer.layerView,_5f);this.layer.layerView._sourcesDirty=true;this.view.threeRender();}};_10.prototype._addTile=function _addTile(_63){var _64=this._tiles[_63.key];if(_64){return _64;}_64=this._cache.getAndRemove(_63);if(_64){this._setTileReloadTimer(_63.key,_64);_64.tileID=_63;if(this._cacheTimers[_63.key]){clearTimeout(this._cacheTimers[_63.key]);delete this._cacheTimers[_63.key];this._setTileReloadTimer(_63.key,_64);}}var _65=Boolean(_64);if(!_65){_64=new _4(_63,this._source.tileSize*_63.overscaleFactor());this._loadTile(_64,this._tileLoaded.bind(this,_64,_63.key,_64.state));}if(!_64){return (null);}_64.uses++;this._tiles[_63.key]=_64;return _64;};_10.prototype._setTileReloadTimer=function _setTileReloadTimer(id,_66){var _67=this;if(id in this._timers){clearTimeout(this._timers[id]);delete this._timers[id];}var _68=_66.getExpiryTimeout();if(_68){this._timers[id]=setTimeout(function(){_67._reloadTile(id,"expired");delete _67._timers[id];},_68);}};_10.prototype._removeTile=function _removeTile(id){var _69=this._tiles[id];if(!_69){return;}_69.uses--;delete this._tiles[id];if(this._timers[id]){clearTimeout(this._timers[id]);delete this._timers[id];}if(_69.uses>0){return;}if(_69.hasData()){}else{_69.aborted=true;this._abortTile(_69);this._unloadTile(_69);}};_10.prototype.clearTiles=function clearTiles(){this._shouldReloadOnResume=false;this._paused=false;for(var id in this._tiles){this._removeTile(id);}this._cache.reset();};_10.prototype.clearOtherLevel=function clearOtherLevel(_6a){this._shouldReloadOnResume=false;this._paused=false;for(var id in this._tiles){var _6b=this._tiles[id];if(_6b.tileID.canonical.z!==_6a){this._removeTile(id);}}};_10.prototype.tilesIn=function tilesIn(_6c,_6d,_6e){var _6f=this;var _70=[];var _71=this.transform;if(!_71){return _70;}var _72=_6e?_71.getCameraQueryGeometry(_6c):_6c;var _73=_6c.map(function(p){return _71.pointCoordinate(p);});var _74=_72.map(function(p){return _71.pointCoordinate(p);});var ids=this.getIds();var _75=Infinity;var _76=Infinity;var _77=-Infinity;var _78=-Infinity;for(var i$1=0,_79=_74;i$1<_79.length;i$1+=1){var p=_79[i$1];_75=Math.min(_75,p.x);_76=Math.min(_76,p.y);_77=Math.max(_77,p.x);_78=Math.max(_78,p.y);}var _7a=function(i){var _7b=_6f._tiles[ids[i]];if(_7b.holdingForFade()){return;}var _7c=_7b.tileID;var _7d=Math.pow(2,_71.level-_7b.tileID.overscaledZ);var _7e=_6d*_7b.queryPadding*__chunk_1.EXTENT/_7b.tileSize/_7d;var _7f=[_7c.getTilePoint(new __chunk_1.MercatorCoordinate(_75,_76)),_7c.getTilePoint(new __chunk_1.MercatorCoordinate(_77,_78))];if(_7f[0].x-_7e<__chunk_1.EXTENT&&_7f[0].y-_7e<__chunk_1.EXTENT&&_7f[1].x+_7e>=0&&_7f[1].y+_7e>=0){var _80=_73.map(function(c){return _7c.getTilePoint(c);});var _81=_74.map(function(c){return _7c.getTilePoint(c);});_70.push({tile:_7b,tileID:_7c,queryGeometry:_80,cameraQueryGeometry:_81,scale:_7d});}};for(var i=0;i<ids.length;i++){_7a(i);}return _70;};_10.prototype.getVisibleCoordinates=function getVisibleCoordinates(_82,_83){var _84=this;var _85=this.getRenderableIds().map(function(id){return _84._tiles[id].tileID;});this.currentCoords=[];for(var i=0,_86=_85;i<_86.length;i+=1){var _87=_86[i];var _88=_87.toUnwrapped();if(!_87.geometry){_87.geometry=this.layer.tileInfo.getGeometry(_88);}_87.posMatrix=_83.calculatePosMatrix(_88,_87.geometry,true);this.currentCoords.push(_87);}return _85;};_10.prototype.updateTileMatrix=function updateTileMatrix(_89,_8a){var _8b=this.currentCoords;for(var i=0,_8c=_8b;i<_8c.length;i+=1){var _8d=_8c[i];_8d.posMatrix=_8a.updatePosMatrix(_8d.toUnwrapped(),_8d.geometry,true);}return _8b;};_10.prototype.hasTransition=function hasTransition(){if(this._source.hasTransition()){return true;}for(var id in this._tiles){var _8e=this._tiles[id];if(_8e.fadeEndTime!==undefined&&_8e.fadeEndTime>=_8.now()){return true;}}return false;};_10.maxOverzooming=10;_10.maxUnderzooming=3;return _10;});