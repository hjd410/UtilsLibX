//>>built
define("com/huayun/webgis/layers/support/CrossTileSymbolIndex",["com/huayun/webgis/utils/Constant"],function(_1){var _2=_1.layout.EXTENT;var _3=256/_2/2;var _4=function _4(_5,_6,_7){this.tileID=_5;this.indexedSymbolInstances={};this.bucketInstanceId=_7;for(var i=0;i<_6.length;i++){var _8=_6.get(i);var _9=_8.key;if(!this.indexedSymbolInstances[_9]){this.indexedSymbolInstances[_9]=[];}this.indexedSymbolInstances[_9].push({crossTileID:_8.crossTileID,coord:this.getScaledCoordinates(_8,_5)});}};_4.prototype.getScaledCoordinates=function getScaledCoordinates(_a,_b){var _c=_b.canonical.z-this.tileID.canonical.z;var _d=_3/Math.pow(2,_c);return {x:Math.floor((_b.canonical.x*_2+_a.anchorX)*_d),y:Math.floor((_b.canonical.y*_2+_a.anchorY)*_d)};};_4.prototype.findMatches=function findMatches(_e,_f,_10){var _11=this.tileID.canonical.z<_f.canonical.z?1:Math.pow(2,this.tileID.canonical.z-_f.canonical.z);for(var i=0;i<_e.length;i++){var _12=_e.get(i);if(_12.crossTileID){continue;}var _13=this.indexedSymbolInstances[_12.key];if(!_13){continue;}var _14=this.getScaledCoordinates(_12,_f);for(var i$1=0,_15=_13;i$1<_15.length;i$1+=1){var _16=_15[i$1];if(Math.abs(_16.coord.x-_14.x)<=_11&&Math.abs(_16.coord.y-_14.y)<=_11&&!_10[_16.crossTileID]){_10[_16.crossTileID]=true;_12.crossTileID=_16.crossTileID;break;}}}};var _17=function _17(){this.maxCrossTileID=0;};_17.prototype.generate=function generate(){return ++this.maxCrossTileID;};var _18=function _18(){this.indexes={};this.usedCrossTileIDs={};this.lng=0;};_18.prototype.handleWrapJump=function handleWrapJump(lng){};_18.prototype.addBucket=function addBucket(_19,_1a,_1b){if(this.indexes[_19.overscaledZ]&&this.indexes[_19.overscaledZ][_19.key]){if(this.indexes[_19.overscaledZ][_19.key].bucketInstanceId===_1a.bucketInstanceId){return false;}else{this.removeBucketCrossTileIDs(_19.overscaledZ,this.indexes[_19.overscaledZ][_19.key]);}}for(var i=0;i<_1a.symbolInstances.length;i++){var _1c=_1a.symbolInstances.get(i);_1c.crossTileID=0;}if(!this.usedCrossTileIDs[_19.overscaledZ]){this.usedCrossTileIDs[_19.overscaledZ]={};}var _1d=this.usedCrossTileIDs[_19.overscaledZ];for(var _1e in this.indexes){var _1f=this.indexes[_1e];if(Number(_1e)>_19.overscaledZ){for(var id in _1f){var _20=_1f[id];if(_20.tileID.isChildOf(_19)){_20.findMatches(_1a.symbolInstances,_19,_1d);}}}else{var _21=_19.scaledTo(Number(_1e));var _22=_1f[_21.key];if(_22){_22.findMatches(_1a.symbolInstances,_19,_1d);}}}for(var i$1=0;i$1<_1a.symbolInstances.length;i$1++){var _23=_1a.symbolInstances.get(i$1);if(!_23.crossTileID){_23.crossTileID=_1b.generate();_1d[_23.crossTileID]=true;}}if(this.indexes[_19.overscaledZ]===undefined){this.indexes[_19.overscaledZ]={};}this.indexes[_19.overscaledZ][_19.key]=new _4(_19,_1a.symbolInstances,_1a.bucketInstanceId);return true;};_18.prototype.removeBucketCrossTileIDs=function removeBucketCrossTileIDs(_24,_25){for(var key in _25.indexedSymbolInstances){for(var i=0,_26=_25.indexedSymbolInstances[(key)];i<_26.length;i+=1){var _27=_26[i];delete this.usedCrossTileIDs[_24][_27.crossTileID];}}};_18.prototype.removeStaleBuckets=function removeStaleBuckets(_28){var _29=false;for(var z in this.indexes){var _2a=this.indexes[z];for(var _2b in _2a){if(!_28[_2a[_2b].bucketInstanceId]){this.removeBucketCrossTileIDs(z,_2a[_2b]);delete _2a[_2b];_29=true;}}}return _29;};var _2c=function _2c(){this.layerIndexes={};this.crossTileIDs=new _17();this.maxBucketInstanceId=0;this.bucketsInCurrentPlacement={};};_2c.prototype.addLayer=function addLayer(_2d,_2e){var _2f=this.layerIndexes[_2d.id];if(_2f===undefined){_2f=this.layerIndexes[_2d.id]=new _18();}var _30=false;var _31={};for(var i=0,_32=_2e;i<_32.length;i+=1){var _33=_32[i];var _34=((_33.getBucket(_2d)));if(!_34||_2d.id!==_34.layerIds[0]){continue;}if(!_34.bucketInstanceId){_34.bucketInstanceId=++this.maxBucketInstanceId;}if(_2f.addBucket(_33.tileID,_34,this.crossTileIDs)){_30=true;}_31[_34.bucketInstanceId]=true;}if(_2f.removeStaleBuckets(_31)){_30=true;}return _30;};_2c.prototype.pruneUnusedLayers=function pruneUnusedLayers(_35){var _36={};_35.forEach(function(_37){_36[_37]=true;});for(var _38 in this.layerIndexes){if(!_36[_38]){delete this.layerIndexes[_38];}}};return _2c;});