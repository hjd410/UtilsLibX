//>>built
define("com/huayun/webgis/layers/support/funcUtils",["exports","com/huayun/webgis/geometry/Point2D","./expression/Interpolate","custom/gl-matrix-min"],function(_1,_2,_3,_4){_1.pick=function(_5,_6){var _7={};for(var i=0;i<_6.length;i++){var k=_6[i];if(k in _5){_7[k]=_5[k];}}return _7;};_1.bindAll=function(_8,_9){_8.forEach(function(fn){if(!_9[fn]){return;}_9[fn]=_9[fn].bind(_9);});};_1.asyncAll=function(_a,fn,_b){if(!_a.length){return _b(null,[]);}var _c=_a.length;var _d=new Array(_a.length);var _e=null;_a.forEach(function(_f,i){fn(_f,function(err,_10){if(err){_e=err;}_d[i]=((_10));if(--_c===0){_b(_e,_d);}});});};_1.calculateKey=function(_11,z,x,y){return z+"/"+x+"/"+y;};_1.now=self.performance&&self.performance.now?self.performance.now.bind(self.performance):Date.now.bind(Date);var _12={"Latin-1 Supplement":function(ch){return ch>=128&&ch<=255;},"Arabic":function(ch){return ch>=1536&&ch<=1791;},"Arabic Supplement":function(ch){return ch>=1872&&ch<=1919;},"Arabic Extended-A":function(ch){return ch>=2208&&ch<=2303;},"Hangul Jamo":function(ch){return ch>=4352&&ch<=4607;},"Unified Canadian Aboriginal Syllabics":function(ch){return ch>=5120&&ch<=5759;},"Khmer":function(ch){return ch>=6016&&ch<=6143;},"Unified Canadian Aboriginal Syllabics Extended":function(ch){return ch>=6320&&ch<=6399;},"General Punctuation":function(ch){return ch>=8192&&ch<=8303;},"Letterlike Symbols":function(ch){return ch>=8448&&ch<=8527;},"Number Forms":function(ch){return ch>=8528&&ch<=8591;},"Miscellaneous Technical":function(ch){return ch>=8960&&ch<=9215;},"Control Pictures":function(ch){return ch>=9216&&ch<=9279;},"Optical Character Recognition":function(ch){return ch>=9280&&ch<=9311;},"Enclosed Alphanumerics":function(ch){return ch>=9312&&ch<=9471;},"Geometric Shapes":function(ch){return ch>=9632&&ch<=9727;},"Miscellaneous Symbols":function(ch){return ch>=9728&&ch<=9983;},"Miscellaneous Symbols and Arrows":function(ch){return ch>=11008&&ch<=11263;},"CJK Radicals Supplement":function(ch){return ch>=11904&&ch<=12031;},"Kangxi Radicals":function(ch){return ch>=12032&&ch<=12255;},"Ideographic Description Characters":function(ch){return ch>=12272&&ch<=12287;},"CJK Symbols and Punctuation":function(ch){return ch>=12288&&ch<=12351;},"Hiragana":function(ch){return ch>=12352&&ch<=12447;},"Katakana":function(ch){return ch>=12448&&ch<=12543;},"Bopomofo":function(ch){return ch>=12544&&ch<=12591;},"Hangul Compatibility Jamo":function(ch){return ch>=12592&&ch<=12687;},"Kanbun":function(ch){return ch>=12688&&ch<=12703;},"Bopomofo Extended":function(ch){return ch>=12704&&ch<=12735;},"CJK Strokes":function(ch){return ch>=12736&&ch<=12783;},"Katakana Phonetic Extensions":function(ch){return ch>=12784&&ch<=12799;},"Enclosed CJK Letters and Months":function(ch){return ch>=12800&&ch<=13055;},"CJK Compatibility":function(ch){return ch>=13056&&ch<=13311;},"CJK Unified Ideographs Extension A":function(ch){return ch>=13312&&ch<=19903;},"Yijing Hexagram Symbols":function(ch){return ch>=19904&&ch<=19967;},"CJK Unified Ideographs":function(ch){return ch>=19968&&ch<=40959;},"Yi Syllables":function(ch){return ch>=40960&&ch<=42127;},"Yi Radicals":function(ch){return ch>=42128&&ch<=42191;},"Hangul Jamo Extended-A":function(ch){return ch>=43360&&ch<=43391;},"Hangul Syllables":function(ch){return ch>=44032&&ch<=55215;},"Hangul Jamo Extended-B":function(ch){return ch>=55216&&ch<=55295;},"Private Use Area":function(ch){return ch>=57344&&ch<=63743;},"CJK Compatibility Ideographs":function(ch){return ch>=63744&&ch<=64255;},"Arabic Presentation Forms-A":function(ch){return ch>=64336&&ch<=65023;},"Vertical Forms":function(ch){return ch>=65040&&ch<=65055;},"CJK Compatibility Forms":function(ch){return ch>=65072&&ch<=65103;},"Small Form Variants":function(ch){return ch>=65104&&ch<=65135;},"Arabic Presentation Forms-B":function(ch){return ch>=65136&&ch<=65279;},"Halfwidth and Fullwidth Forms":function(ch){return ch>=65280&&ch<=65519;}};_1.isChar=_12;function _13(_14){for(var i=0,_15=_14;i<_15.length;i+=1){var ch=_15[i];if(!_16(ch.charCodeAt(0))){return false;}}return true;};function _16(ch){if(_12["Arabic"](ch)){return false;}if(_12["Arabic Supplement"](ch)){return false;}if(_12["Arabic Extended-A"](ch)){return false;}if(_12["Arabic Presentation Forms-A"](ch)){return false;}if(_12["Arabic Presentation Forms-B"](ch)){return false;}return true;};function _17(ch){if(ch===746||ch===747){return true;}if(ch<4352){return false;}if(_12["Bopomofo Extended"](ch)){return true;}if(_12["Bopomofo"](ch)){return true;}if(_12["CJK Compatibility Forms"](ch)){if(!((ch>=65097&&ch<=65103))){return true;}}if(_12["CJK Compatibility Ideographs"](ch)){return true;}if(_12["CJK Compatibility"](ch)){return true;}if(_12["CJK Radicals Supplement"](ch)){return true;}if(_12["CJK Strokes"](ch)){return true;}if(_12["CJK Symbols and Punctuation"](ch)){if(!((ch>=12296&&ch<=12305))&&!((ch>=12308&&ch<=12319))&&ch!==12336){return true;}}if(_12["CJK Unified Ideographs Extension A"](ch)){return true;}if(_12["CJK Unified Ideographs"](ch)){return true;}if(_12["Enclosed CJK Letters and Months"](ch)){return true;}if(_12["Hangul Compatibility Jamo"](ch)){return true;}if(_12["Hangul Jamo Extended-A"](ch)){return true;}if(_12["Hangul Jamo Extended-B"](ch)){return true;}if(_12["Hangul Jamo"](ch)){return true;}if(_12["Hangul Syllables"](ch)){return true;}if(_12["Hiragana"](ch)){return true;}if(_12["Ideographic Description Characters"](ch)){return true;}if(_12["Kanbun"](ch)){return true;}if(_12["Kangxi Radicals"](ch)){return true;}if(_12["Katakana Phonetic Extensions"](ch)){return true;}if(_12["Katakana"](ch)){if(ch!==12540){return true;}}if(_12["Halfwidth and Fullwidth Forms"](ch)){if(ch!==65288&&ch!==65289&&ch!==65293&&!((ch>=65306&&ch<=65310))&&ch!==65339&&ch!==65341&&ch!==65343&&!(ch>=65371&&ch<=65503)&&ch!==65507&&!(ch>=65512&&ch<=65519)){return true;}}if(_12["Small Form Variants"](ch)){if(!((ch>=65112&&ch<=65118))&&!((ch>=65123&&ch<=65126))){return true;}}if(_12["Unified Canadian Aboriginal Syllabics"](ch)){return true;}if(_12["Unified Canadian Aboriginal Syllabics Extended"](ch)){return true;}if(_12["Vertical Forms"](ch)){return true;}if(_12["Yijing Hexagram Symbols"](ch)){return true;}if(_12["Yi Syllables"](ch)){return true;}if(_12["Yi Radicals"](ch)){return true;}return false;};_1.allowsLetterSpacing=_13;_1.charHasUprightVerticalOrientation=_17;function _18(ids,_19,_1a,_1b){if(_1a>=_1b){return;}var _1c=ids[(_1a+_1b)>>1];var i=_1a-1;var j=_1b+1;while(true){do{i++;}while(ids[i]<_1c);do{j--;}while(ids[j]>_1c);if(i>=j){break;}_1d(ids,i,j);_1d(_19,3*i,3*j);_1d(_19,3*i+1,3*j+1);_1d(_19,3*i+2,3*j+2);}_18(ids,_19,_1a,j);_18(ids,_19,j+1,_1b);};function _1d(arr,i,j){var tmp=arr[i];arr[i]=arr[j];arr[j]=tmp;};_1.sort=_18;_1.swap=_1d;function _1e(_1f){return _1f["property-type"]==="data-driven"||_1f["property-type"]==="cross-faded-data-driven";};_1.supportsPropertyExpression=_1e;function _20(_21,_22){var _23={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern_to","pattern_from"],"fill-pattern":["pattern_to","pattern_from"],"fill-extrusion-pattern":["pattern_to","pattern_from"]};return _23[_21]||[_21.replace((_22+"-"),"").replace(/-/g,"_")];};_1.paintAttributeNames=_20;function _24(arr,k,_25,_26,_27){_28(arr,k,_25||0,_26||(arr.length-1),_27||_29);};function _28(arr,k,_2a,_2b,_2c){while(_2b>_2a){if(_2b-_2a>600){var n=_2b-_2a+1;var m=k-_2a+1;var z=Math.log(n);var s=0.5*Math.exp(2*z/3);var sd=0.5*Math.sqrt(z*s*(n-s)/n)*(m-n/2<0?-1:1);var _2d=Math.max(_2a,Math.floor(k-m*s/n+sd));var _2e=Math.min(_2b,Math.floor(k+(n-m)*s/n+sd));_28(arr,k,_2d,_2e,_2c);}var t=arr[k];var i=_2a;var j=_2b;_2f(arr,_2a,k);if(_2c(arr[_2b],t)>0){_2f(arr,_2a,_2b);}while(i<j){_2f(arr,i,j);i++;j--;while(_2c(arr[i],t)<0){i++;}while(_2c(arr[j],t)>0){j--;}}if(_2c(arr[_2a],t)===0){_2f(arr,_2a,j);}else{j++;_2f(arr,j,_2b);}if(j<=k){_2a=j+1;}if(k<=j){_2b=j-1;}}};function _2f(arr,i,j){var tmp=arr[i];arr[i]=arr[j];arr[j]=tmp;};function _29(a,b){return a<b?-1:a>b?1:0;};function _30(ch){if(_12["Latin-1 Supplement"](ch)){if(ch===167||ch===169||ch===174||ch===177||ch===188||ch===189||ch===190||ch===215||ch===247){return true;}}if(_12["General Punctuation"](ch)){if(ch===8214||ch===8224||ch===8225||ch===8240||ch===8241||ch===8251||ch===8252||ch===8258||ch===8263||ch===8264||ch===8265||ch===8273){return true;}}if(_12["Letterlike Symbols"](ch)){return true;}if(_12["Number Forms"](ch)){return true;}if(_12["Miscellaneous Technical"](ch)){if((ch>=8960&&ch<=8967)||(ch>=8972&&ch<=8991)||(ch>=8996&&ch<=9000)||ch===9003||(ch>=9085&&ch<=9114)||(ch>=9150&&ch<=9165)||ch===9167||(ch>=9169&&ch<=9179)||(ch>=9186&&ch<=9215)){return true;}}if(_12["Control Pictures"](ch)&&ch!==9251){return true;}if(_12["Optical Character Recognition"](ch)){return true;}if(_12["Enclosed Alphanumerics"](ch)){return true;}if(_12["Geometric Shapes"](ch)){return true;}if(_12["Miscellaneous Symbols"](ch)){if(!((ch>=9754&&ch<=9759))){return true;}}if(_12["Miscellaneous Symbols and Arrows"](ch)){if((ch>=11026&&ch<=11055)||(ch>=11088&&ch<=11097)||(ch>=11192&&ch<=11243)){return true;}}if(_12["CJK Symbols and Punctuation"](ch)){return true;}if(_12["Katakana"](ch)){return true;}if(_12["Private Use Area"](ch)){return true;}if(_12["CJK Compatibility Forms"](ch)){return true;}if(_12["Small Form Variants"](ch)){return true;}if(_12["Halfwidth and Fullwidth Forms"](ch)){return true;}if(ch===8734||ch===8756||ch===8757||(ch>=9984&&ch<=10087)||(ch>=10102&&ch<=10131)||ch===65532||ch===65533){return true;}return false;};function _31(ch){return !(_17(ch)||_30(ch));};function _32(_33,_34,_35,_36,_37){var m=_4.mat4.create();if(_34){_4.mat4.scale(m,m,[1/_37,1/_37,1]);if(!_35){_4.mat4.rotateZ(m,m,_36.angle);}}else{_4.mat4.multiply(m,_36.labelPlaneMatrix,_33);}return m;};_1.getLabelPlaneMatrix=_32;function _38(_39,_3a,_3b,_3c,_3d){if(_3a){var m=_4.mat4.clone(_39);_4.mat4.scale(m,m,[_3d,_3d,1]);if(!_3b){_4.mat4.rotateZ(m,m,-_3c.angle);}return m;}else{return _3c.glCoordMatrix;}};_1.getGlCoordMatrix=_38;function _3e(out,a,v){var x=v[0],y=v[1],z=v[2];var a00,a01,a02,a03;var a10,a11,a12,a13;var a20,a21,a22,a23;if(a===out){out[12]=a[0]*x+a[4]*y+a[8]*z+a[12];out[13]=a[1]*x+a[5]*y+a[9]*z+a[13];out[14]=a[2]*x+a[6]*y+a[10]*z+a[14];out[15]=a[3]*x+a[7]*y+a[11]*z+a[15];}else{a00=a[0];a01=a[1];a02=a[2];a03=a[3];a10=a[4];a11=a[5];a12=a[6];a13=a[7];a20=a[8];a21=a[9];a22=a[10];a23=a[11];out[0]=a00;out[1]=a01;out[2]=a02;out[3]=a03;out[4]=a10;out[5]=a11;out[6]=a12;out[7]=a13;out[8]=a20;out[9]=a21;out[10]=a22;out[11]=a23;out[12]=a00*x+a10*y+a20*z+a[12];out[13]=a01*x+a11*y+a21*z+a[13];out[14]=a02*x+a12*y+a22*z+a[14];out[15]=a03*x+a13*y+a23*z+a[15];}return out;};function _3f(_40,_41,_42,_43,_44,_45,_46){if(!_42[0]&&!_42[1]){return _40;}var _47=_44?(_43==="map"?_45:0):(_43==="viewport"?-_45:0);if(_47){var _48=Math.sin(_47);var _49=Math.cos(_47);_42=[_42[0]*_49-_42[1]*_48,_42[0]*_48+_42[1]*_49];}var _4a=[_44?_42[0]:pixelsToTileUnits(_41,_42[0],_46),_44?_42[1]:pixelsToTileUnits(_41,_42[1],_46),0];var _4b=new Float32Array(16);_3e(_4b,_40,_4a);return _4b;};_1.translatePosMatrix=_3f;function _4c(n,min,max){return Math.min(max,Math.max(min,n));};function _4d(_4e,_4f){var _50=0;var _51=0;if(_4e.kind==="constant"){_51=_4e.layoutSize;}else{if(_4e.kind!=="source"){var _52=_4e.interpolationType;var _53=_4e.minZoom;var _54=_4e.maxZoom;var t=!_52?0:_4c(_3.interpolationFactor(_52,_4f,_53,_54),0,1);if(_4e.kind==="camera"){_51=_55(_4e.minSize,_4e.maxSize,t);}else{_50=t;}}}return {uSizeT:_50,uSize:_51};};_1.evaluateSizeForZoom=_4d;function _56(out,a,m){var x=a[0],y=a[1];out[0]=m[0]*x+m[4]*y+m[12];out[1]=m[1]*x+m[5]*y+m[13];out[3]=m[3]*x+m[7]*y+m[15];return out;};_1.xyTransformMat4=_56;var _57=256;function _55(a,b,t){return (a*(1-t))+(b*t);};function _58(_59,ref,_5a){var _5b=ref.uSize;var _5c=ref.uSizeT;var _5d=_5a.lowerSize;var _5e=_5a.upperSize;if(_59.kind==="source"){return _5d/_57;}else{if(_59.kind==="composite"){return _55(_5d/_57,_5e/_57,_5c);}}return _5b;};_1.evaluateSizeForFeature=_58;function _5f(out,a,m){var x=a[0],y=a[1],z=a[2],w=a[3];out[0]=m[0]*x+m[4]*y+m[8]*z+m[12]*w;out[1]=m[1]*x+m[5]*y+m[9]*z+m[13]*w;out[2]=m[2]*x+m[6]*y+m[10]*z+m[14]*w;out[3]=m[3]*x+m[7]*y+m[11]*z+m[15]*w;return out;};_1.transformMat4=_5f;var _60={horizontal:1,vertical:2,horizontalOnly:3};function _61(_62,_63,_64,_65){if(_62===_60.horizontal){var _66=Math.abs(_64.y-_63.y);var run=Math.abs(_64.x-_63.x)*_65;if(_66>run){return {useVertical:true};}}if(_62===_60.vertical?_63.y<_64.y:_63.x>_64.x){return {needsFlipping:true};}return null;};function _67(_68,_69){var pos=[_68.x,_68.y,0,1];_56(pos,pos,_69);var w=pos[3];return {point:new _2(pos[0]/w,pos[1]/w),signedDistanceFromCamera:w};};function _6a(_6b,_6c,_6d,_6e,_6f,_70,_71,_72,_73,_74,_75,_76,_77){var _78=_6e?_6b-_6c:_6b+_6c;var dir=_78>0?1:-1;var _79=0;if(_6e){dir*=-1;_79=Math.PI;}if(dir<0){_79+=Math.PI;}var _7a=dir>0?_72+_71:_72+_71+1;var _7b=_7a;var _7c=_6f;var _7d=_6f;var _7e=0;var _7f=0;var _80=Math.abs(_78);while(_7e+_7f<=_80){_7a+=dir;if(_7a<_72||_7a>=_73){return null;}_7d=_7c;_7c=_76[_7a];if(_7c===undefined){var _81=new _2(_74.getx(_7a),_74.gety(_7a));var _82=_67(_81,_75);if(_82.signedDistanceFromCamera>0){_7c=_76[_7a]=_82.point;}else{var _83=_7a-dir;var _84=_7e===0?_70:new _2(_74.getx(_83),_74.gety(_83));_7c=_85(_84,_81,_7d,_80-_7e+1,_75);}}_7e+=_7f;_7f=_7d.dist(_7c);}var _86=(_80-_7e)/_7f;var _87=_7c.sub(_7d);var p=_87.mult(_86)._add(_7d);p._add(_87._unit()._perp()._mult(_6d*dir));var _88=_79+Math.atan2(_7c.y-_7d.y,_7c.x-_7d.x);return {point:p,angle:_88,tileDistance:_77?{prevTileDistance:(_7a-dir)===_7b?0:_74.gettileUnitDistanceFromAnchor(_7a-dir),lastSegmentViewportDistance:_80-_7e}:null};};function _85(_89,_8a,_8b,_8c,_8d){var _8e=_67(_89.add(_89.sub(_8a)._unit()),_8d).point;var _8f=_8b.sub(_8e);return _8b.add(_8f._mult(_8c/_8f.mag()));};function _90(_91,p,_92){_91.emplaceBack(p.x,p.y,_92);_91.emplaceBack(p.x,p.y,_92);_91.emplaceBack(p.x,p.y,_92);_91.emplaceBack(p.x,p.y,_92);};function _93(_94,_95,_96,_97,_98,_99,_9a,_9b,_9c,_9d,_9e,_9f){var _a0=_9b.glyphStartIndex+_9b.numGlyphs;var _a1=_9b.lineStartIndex;var _a2=_9b.lineStartIndex+_9b.lineLength;var _a3=_95.getoffsetX(_9b.glyphStartIndex);var _a4=_95.getoffsetX(_a0-1);var _a5=_6a(_94*_a3,_96,_97,_98,_99,_9a,_9b.segment,_a1,_a2,_9c,_9d,_9e,_9f);if(!_a5){return null;}var _a6=_6a(_94*_a4,_96,_97,_98,_99,_9a,_9b.segment,_a1,_a2,_9c,_9d,_9e,_9f);if(!_a6){return null;}return {first:_a5,last:_a6};};function _a7(_a8,_a9,_aa,_ab,_ac,_ad,_ae,_af,_b0,_b1,_b2,_b3,_b4,_b5){var _b6=_a9/24;var _b7=_a8.lineOffsetX*_b6;var _b8=_a8.lineOffsetY*_b6;var _b9;if(_a8.numGlyphs>1){var _ba=_a8.glyphStartIndex+_a8.numGlyphs;var _bb=_a8.lineStartIndex;var _bc=_a8.lineStartIndex+_a8.lineLength;var _bd=_93(_b6,_af,_b7,_b8,_aa,_b2,_b3,_a8,_b0,_ad,_b4,false);if(!_bd){return {notEnoughRoom:true};}var _be=_67(_bd.first.point,_ae).point;var _bf=_67(_bd.last.point,_ae).point;if(_ab&&!_aa){var _c0=_61(_a8.writingMode,_be,_bf,_b5);if(_c0){return _c0;}}_b9=[_bd.first];for(var _c1=_a8.glyphStartIndex+1;_c1<_ba-1;_c1++){_b9.push(_6a(_b6*_af.getoffsetX(_c1),_b7,_b8,_aa,_b2,_b3,_a8.segment,_bb,_bc,_b0,_ad,_b4,false));}_b9.push(_bd.last);}else{if(_ab&&!_aa){var a=_67(_b3,_ac).point;var _c2=(_a8.lineStartIndex+_a8.segment+1);var _c3=new _2(_b0.getx(_c2),_b0.gety(_c2));var _c4=_67(_c3,_ac);var b=(_c4.signedDistanceFromCamera>0)?_c4.point:_85(_b3,_c3,a,1,_ac);var _c5=_61(_a8.writingMode,a,b,_b5);if(_c5){return _c5;}}var _c6=_6a(_b6*_af.getoffsetX(_a8.glyphStartIndex),_b7,_b8,_aa,_b2,_b3,_a8.segment,_a8.lineStartIndex,_a8.lineStartIndex+_a8.lineLength,_b0,_ad,_b4,false);if(!_c6){return {notEnoughRoom:true};}_b9=[_c6];}for(var i=0,_c7=_b9;i<_c7.length;i+=1){var _c8=_c7[i];_90(_b1,_c8.point,_c8.angle);}return {};};_1.placeGlyphsAlongLine=_a7;});