//>>built
define("com/huayun/webgis/layers/support/TileSourceCache",["./RasterTileSource","./tileCover","./Tile","./funcUtils","./TileCache","./SourceFeatureState","com/huayun/webgis/geometry/Point2D","../../utils/utils"],function(_1,_2,_3,_4,_5,_6,_7,_8){var _9={raster:_1};function _a(_b){return _b==="raster"||_b==="image"||_b==="video";};function _c(id,_d,_e,_f,url,_10,_11){this.id=id;this._source=new _9[_d.type](id,_d,url,_10,_11);this._tiles={};this._cache=new _5(0,this._unloadTile.bind(this));this._timers={};this._cacheTimers={};this._maxTileCacheSize=null;this._coveredTiles={};this.layer=_10;this.view=_10.layerView.view;this.updateCacheSize(_e,_f);};_c.prototype.updateTileSize=function(_12){this._source.setSize(_12);};_c.prototype.onRemove=function onRemove(map){if(this._source&&this._source.onRemove){this._source.onRemove(map);}};_c.prototype.loaded=function loaded(){if(this._sourceErrored){return true;}if(!this._sourceLoaded){return false;}for(var t in this._tiles){var _13=this._tiles[t];if(_13.state!=="loaded"&&_13.state!=="errored"){return false;}}return true;};_c.prototype.getSource=function getSource(){return this._source;};_c.prototype.pause=function pause(){this._paused=true;};_c.prototype.resume=function resume(){if(!this._paused){return;}var _14=this._shouldReloadOnResume;this._paused=false;this._shouldReloadOnResume=false;if(_14){this.reload();}if(this.transform){this.update(this.transform);}};_c.prototype._loadTile=function _loadTile(_15,_16){return this._source.loadTile(_15,_16);};_c.prototype._unloadTile=function _unloadTile(_17){if(this._source.unloadTile){return this._source.unloadTile(_17,function(){});}};_c.prototype._abortTile=function _abortTile(_18){if(this._source.abortTile){return this._source.abortTile(_18,function(){});}};_c.prototype.serialize=function serialize(){return this._source.serialize();};_c.prototype.getIds=function getIds(){var _19=[];for(var key in this._tiles){_19.push(this._tiles[key].tileID);}return _19;};_c.prototype.getRenderableIds=function getRenderableIds(){var ids=[];for(var id in this._tiles){if(this._isIdRenderable(id)){ids.push(id);}}return ids.sort(_8.compareKeyZoom);};_c.prototype.hasRenderableParent=function hasRenderableParent(_1a){var _1b=this.findLoadedParent(_1a,0);if(_1b){return this._isIdRenderable(_1b.tileID.key);}return false;};_c.prototype._isIdRenderable=function _isIdRenderable(id){return this._tiles[id]&&this._tiles[id].hasData()&&!this._coveredTiles[id]&&(!this._tiles[id].holdingForFade());};_c.prototype.reload=function reload(){if(this._paused){this._shouldReloadOnResume=true;return;}this._cache.reset();for(var i in this._tiles){if(this._tiles[i].state!=="errored"){this._reloadTile(i,"reloading");}}};_c.prototype._reloadTile=function _reloadTile(id,_1c){var _1d=this._tiles[id];if(!_1d){return;}if(_1d.state!=="loading"){_1d.state=_1c;}this._loadTile(_1d,this._tileLoaded.bind(this,_1d,id,_1c));};_c.prototype.updateTileUrl=function(url){this._source.updateTileUrl(url);};_c.prototype._tileLoaded=function _tileLoaded(_1e,id,_1f,err){if(err){_1e.state="errored";if(err.status===404){this.update(this.transform);}return;}_1e.timeAdded=_8.now();this._setTileReloadTimer(id,_1e);this.layer.layerView._sourcesDirty=true;this.view.threeRender();};_c.prototype.getTile=function getTile(_20){return this.getTileByID(_20.key);};_c.prototype.getTileByID=function getTileByID(id){return this._tiles[id];};_c.prototype.getZoom=function getZoom(_21){return _21.level+_21.scaleZoom(_21.tileSize/this._source.tileSize);};_c.prototype._retainLoadedChildren=function _retainLoadedChildren(_22,_23,_24,_25){for(var id in this._tiles){var _26=this._tiles[id];if(_25[id]||!_26.hasData()||_26.tileID.overscaledZ<=_23||_26.tileID.overscaledZ>_24){continue;}var _27=_26.tileID;while(_26&&_26.tileID.overscaledZ>_23+1){var _28=_26.tileID.scaledTo(_26.tileID.overscaledZ-1);_26=this._tiles[_28.key];if(_26&&_26.hasData()){_27=_28;}}var _29=_27;while(_29.overscaledZ>_23){_29=_29.scaledTo(_29.overscaledZ-1);if(_22[_29.key]){_25[_27.key]=_27;break;}}}};_c.prototype.findLoadedParent=function findLoadedParent(_2a,_2b){for(var z=_2a.overscaledZ-1;z>=_2b;z--){var _2c=_2a.scaledTo(z);if(!_2c){return;}var id=String(_2c.key);var _2d=this._tiles[id];if(_2d&&_2d.hasData()){return _2d;}if(this._cache.has(_2c)){return this._cache.get(_2c);}}};_c.prototype.updateCacheSize=function updateCacheSize(_2e,_2f){var _30=Math.ceil(_2e/this._source.tileSize)+1;var _31=Math.ceil(_2f/this._source.tileSize)+1;var _32=_30*_31;var _33=3;var _34=Math.floor(_32*_33);var _35=typeof this._maxTileCacheSize==="number"?Math.min(this._maxTileCacheSize,_34):_34;this._cache.setMaxSize(_35);};_c.prototype.update=function update(_36,_37,_38,cx,cy){this._coveredTiles={};var _39=_2(_36,_37,_38);_39=_39.sort(function(a,b){a=a.canonical;b=b.canonical;return Math.sqrt((cx-a.x)*(cx-a.x)+(cy-a.y)*(cy-a.y))-Math.sqrt((cx-b.x)*(cx-b.x)+(cy-b.y)*(cy-b.y));});var _3a=this._updateRetainedTiles(_39,_36);var _3b=_36;var _3c=0;var _3d=15;for(var _3e in _3a){this._tiles[_3e].clearFadeHold();}var _3f=_8.keysDifference(this._tiles,_3a);for(var i$1=0,_40=_3f;i$1<_40.length;i$1+=1){var _41=_40[i$1];var _42=this._tiles[_41];this._removeTile(_41);}};_c.prototype.updateTile=function updateTile(_43,_44,_45,cx,cy){this._coveredTiles={};var _46=_2(_43,_44,_45);_46=_46.sort(function(a,b){a=a.canonical;b=b.canonical;return Math.sqrt((cx-a.x)*(cx-a.x)+(cy-a.y)*(cy-a.y))-Math.sqrt((cx-b.x)*(cx-b.x)+(cy-b.y)*(cy-b.y));});this._updateRetainedTiles(_46,_43);return _46;};_c.prototype.releaseSymbolFadeTiles=function releaseSymbolFadeTiles(){for(var id in this._tiles){if(this._tiles[id].holdingForFade()){this._removeTile(id);}}};_c.prototype._updateRetainedTiles=function _updateRetainedTiles(_47,_48){var _49={};var _4a={};var _4b=Math.max(_48-_c.maxOverzooming,this._source.minzoom);var _4c=Math.max(_48+_c.maxUnderzooming,this._source.minzoom);var _4d={};for(var i=0,_4e=_47;i<_4e.length;i+=1){var _4f=_4e[i];var _50=this._addTile(_4f);_49[_4f.key]=_4f;if(_50.hasData()){continue;}if(_48<this._source.maxzoom){_4d[_4f.key]=_4f;}}this._retainLoadedChildren(_4d,_48,_4c,_49);for(var i$1=0,_51=_47;i$1<_51.length;i$1+=1){var _52=_51[i$1];var _53=this._tiles[_52.key];if(_53.hasData()){continue;}if(_48+1>this._source.maxzoom){var _54=_52.children(this._source.maxzoom)[0];var _55=this.getTile(_54);if(!!_55&&_55.hasData()){_49[_54.key]=_54;continue;}}else{var _56=_52.children(this._source.maxzoom);if(_49[_56[0].key]&&_49[_56[1].key]&&_49[_56[2].key]&&_49[_56[3].key]){continue;}}var _57=_53.wasRequested();for(var _58=_52.overscaledZ-1;_58>=_4b;--_58){var _59=_52.scaledTo(_58);if(_4a[_59.key]){break;}_4a[_59.key]=true;_53=this.getTile(_59);if(!_53&&_57){_53=this._addTile(_59);}if(_53){_49[_59.key]=_59;_57=_53.wasRequested();if(_53.hasData()){break;}}}}return _49;};_c.prototype._reAddTile=function _reAddTile(_5a){var _5b=new _3(_5a,this._source.tileSize*_5a.overscaleFactor());this._loadTile(_5b,this._tileReAddLoaded.bind(this,_5b,_5a.key,_5b.state));};_c.prototype._tileReAddLoaded=function _tileLoaded(_5c,id,_5d,err){this._removeTile(id);this._tiles[_5c.tileID.key]=_5c;if(err){_5c.state="errored";if(err.status===404){this.update(this.transform);}return;}_5c.timeAdded=_8.now();this._setTileReloadTimer(id,_5c);this.layer.layerView._sourcesDirty=true;this.view.threeRender();};_c.prototype._addTile=function _addTile(_5e){var _5f=this._tiles[_5e.key];if(_5f){return _5f;}_5f=this._cache.getAndRemove(_5e);if(_5f){this._setTileReloadTimer(_5e.key,_5f);_5f.tileID=_5e;if(this._cacheTimers[_5e.key]){clearTimeout(this._cacheTimers[_5e.key]);delete this._cacheTimers[_5e.key];this._setTileReloadTimer(_5e.key,_5f);}}var _60=Boolean(_5f);if(!_60){_5f=new _3(_5e,this._source.tileSize*_5e.overscaleFactor());this._loadTile(_5f,this._tileLoaded.bind(this,_5f,_5e.key,_5f.state));}if(!_5f){return (null);}_5f.uses++;this._tiles[_5e.key]=_5f;return _5f;};_c.prototype._setTileReloadTimer=function _setTileReloadTimer(id,_61){var _62=this;if(id in this._timers){clearTimeout(this._timers[id]);delete this._timers[id];}var _63=_61.getExpiryTimeout();if(_63){this._timers[id]=setTimeout(function(){_62._reloadTile(id,"expired");delete _62._timers[id];},_63);}};_c.prototype._removeTile=function _removeTile(id){var _64=this._tiles[id];if(!_64){return;}_64.uses--;delete this._tiles[id];if(this._timers[id]){clearTimeout(this._timers[id]);delete this._timers[id];}if(_64.uses>0){return;}if(_64.hasData()){}else{_64.aborted=true;this._abortTile(_64);this._unloadTile(_64);}};_c.prototype.clearTiles=function clearTiles(){this._shouldReloadOnResume=false;this._paused=false;for(var id in this._tiles){this._removeTile(id);}this._cache.reset();};_c.prototype.clearOtherLevel=function clearOtherLevel(_65){this._shouldReloadOnResume=false;this._paused=false;for(var id in this._tiles){var _66=this._tiles[id];if(_66.tileID.canonical.z!==_65){this._removeTile(id);}}};_c.prototype.tilesIn=function tilesIn(_67,_68,_69){var _6a=this;var _6b=[];var _6c=this.transform;if(!_6c){return _6b;}var _6d=_69?_6c.getCameraQueryGeometry(_67):_67;var _6e=_67.map(function(p){return _6c.pointCoordinate(p);});var _6f=_6d.map(function(p){return _6c.pointCoordinate(p);});var ids=this.getIds();var _70=Infinity;var _71=Infinity;var _72=-Infinity;var _73=-Infinity;for(var i$1=0,_74=_6f;i$1<_74.length;i$1+=1){var p=_74[i$1];_70=Math.min(_70,p.x);_71=Math.min(_71,p.y);_72=Math.max(_72,p.x);_73=Math.max(_73,p.y);}var _75=function(i){var _76=_6a._tiles[ids[i]];if(_76.holdingForFade()){return;}var _77=_76.tileID;var _78=Math.pow(2,_6c.level-_76.tileID.overscaledZ);var _79=_68*_76.queryPadding*__chunk_1.EXTENT/_76.tileSize/_78;var _7a=[_77.getTilePoint(new __chunk_1.MercatorCoordinate(_70,_71)),_77.getTilePoint(new __chunk_1.MercatorCoordinate(_72,_73))];if(_7a[0].x-_79<__chunk_1.EXTENT&&_7a[0].y-_79<__chunk_1.EXTENT&&_7a[1].x+_79>=0&&_7a[1].y+_79>=0){var _7b=_6e.map(function(c){return _77.getTilePoint(c);});var _7c=_6f.map(function(c){return _77.getTilePoint(c);});_6b.push({tile:_76,tileID:_77,queryGeometry:_7b,cameraQueryGeometry:_7c,scale:_78});}};for(var i=0;i<ids.length;i++){_75(i);}return _6b;};_c.prototype.getVisibleCoordinates=function getVisibleCoordinates(_7d,_7e){var _7f=this;var _80=this.getRenderableIds().map(function(id){return _7f._tiles[id].tileID;});this.currentCoords=[];for(var i=0,_81=_80;i<_81.length;i+=1){var _82=_81[i];var _83=_82.toUnwrapped();if(!_82.geometry){_82.geometry=this.layer.tileInfo.getGeometry(_83);}_82.posMatrix=_7e.calculatePosMatrix(_83,_82.geometry,true);this.currentCoords.push(_82);}return _80;};_c.prototype.updateTileMatrix=function updateTileMatrix(_84,_85){var _86=this.currentCoords;for(var i=0,_87=_86;i<_87.length;i+=1){var _88=_87[i];_88.posMatrix=_85.updatePosMatrix(_88.toUnwrapped(),_88.geometry,true);}return _86;};_c.prototype.hasTransition=function hasTransition(){if(this._source.hasTransition()){return true;}for(var id in this._tiles){var _89=this._tiles[id];if(_89.fadeEndTime!==undefined&&_89.fadeEndTime>=_8.now()){return true;}}return false;};_c.maxOverzooming=10;_c.maxUnderzooming=3;return _c;});