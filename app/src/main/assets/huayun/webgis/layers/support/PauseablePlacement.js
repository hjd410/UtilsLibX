//>>built
define("com/huayun/webgis/layers/support/PauseablePlacement",["com/huayun/webgis/gl/MapGridIndex","com/huayun/webgis/geometry/Point2D","./funcUtils","../../utils/Constant","../../utils/utils","../../utils/intersectUtils"],function(_1,_2,_3,_4,_5,_6){var _7=function _7(_8,_9,_a,_b){if(_8){this.opacity=Math.max(0,Math.min(1,_8.opacity+(_8.placed?_9:-_9)));}else{this.opacity=(_b&&_a)?1:0;}this.placed=_a;};_7.prototype.isHidden=function isHidden(){return this.opacity===0&&!this.placed;};var _c=function _c(_d,_e,_f,_10,_11){this.text=new _7(_d?_d.text:null,_e,_f,_11);this.icon=new _7(_d?_d.icon:null,_e,_10,_11);};_c.prototype.isHidden=function isHidden(){return this.text.isHidden()&&this.icon.isHidden();};var _12=function _12(_13,_14,_15){this.text=_13;this.icon=_14;this.skipFade=_15;};var _16=100;var _17=Math.pow(2,25);var _18=Math.pow(2,24);var _19=Math.pow(2,17);var _1a=Math.pow(2,16);var _1b=Math.pow(2,9);var _1c=Math.pow(2,8);var _1d=Math.pow(2,1);function _1e(_1f){if(_1f.opacity===0&&!_1f.placed){return 0;}else{if(_1f.opacity===1&&_1f.placed){return 4294967295;}}var _20=_1f.placed?1:0;var _21=Math.floor(_1f.opacity*127);return _21*_17+_20*_18+_21*_19+_20*_1a+_21*_1b+_20*_1c+_21*_1d+_20;};function _22(_23,_24,_25,_26,_27){var _28=_29(_23.add(_23.sub(_24)._unit()),_27).point;var _2a=_25.sub(_28);return _25.add(_2a._mult(_26/_2a.mag()));};function _29(_2b,_2c){var pos=[_2b.x,_2b.y,0,1];_3.xyTransformMat4(pos,pos,_2c);var w=pos[3];return {point:new _2(pos[0]/w,pos[1]/w),signedDistanceFromCamera:w};};function _2d(_2e,_2f,_30){_2e[_2f+4]=_30?1:0;};function _31(_32,_33,_34,_35,_36,_37,_38,_39,_3a,_3b,_3c,_3d,_3e){var _3f=_35?_32-_33:_32+_33;var dir=_3f>0?1:-1;var _40=0;if(_35){dir*=-1;_40=Math.PI;}if(dir<0){_40+=Math.PI;}var _41=dir>0?_39+_38:_39+_38+1;var _42=_41;var _43=_36;var _44=_36;var _45=0;var _46=0;var _47=Math.abs(_3f);while(_45+_46<=_47){_41+=dir;if(_41<_39||_41>=_3a){return null;}_44=_43;_43=_3d[_41];if(_43===undefined){var _48=new _2(_3b.getx(_41),_3b.gety(_41));var _49=_29(_48,_3c);if(_49.signedDistanceFromCamera>0){_43=_3d[_41]=_49.point;}else{var _4a=_41-dir;var _4b=_45===0?_37:new _2(_3b.getx(_4a),_3b.gety(_4a));_43=_22(_4b,_48,_44,_47-_45+1,_3c);}}_45+=_46;_46=_44.dist(_43);}var _4c=(_47-_45)/_46;var _4d=_43.sub(_44);var p=_4d.mult(_4c)._add(_44);p._add(_4d._unit()._perp()._mult(_34*dir));var _4e=_40+Math.atan2(_43.y-_44.y,_43.x-_44.x);return {point:p,angle:_4e,tileDistance:_3e?{prevTileDistance:(_41-dir)===_42?0:_3b.gettileUnitDistanceFromAnchor(_41-dir),lastSegmentViewportDistance:_47-_45}:null};};function _4f(_50,_51,_52,_53,_54,_55,_56,_57,_58,_59,_5a,_5b){var _5c=_57.glyphStartIndex+_57.numGlyphs;var _5d=_57.lineStartIndex;var _5e=_57.lineStartIndex+_57.lineLength;var _5f=_51.getoffsetX(_57.glyphStartIndex);var _60=_51.getoffsetX(_5c-1);var _61=_31(_50*_5f,_52,_53,_54,_55,_56,_57.segment,_5d,_5e,_58,_59,_5a,_5b);if(!_61){return null;}var _62=_31(_50*_60,_52,_53,_54,_55,_56,_57.segment,_5d,_5e,_58,_59,_5a,_5b);if(!_62){return null;}return {first:_61,last:_62};};var _63=function _63(_64,_65,_66,_67,_68){this.bucketInstanceId=_64;this.featureIndex=_65;this.sourceLayerIndex=_66;this.bucketIndex=_67;this.tileID=_68;};var _69=function _69(_6a,_6b,_6c){if(_6b===void 0){_6b=new _1(_6a.width+2*_16,_6a.height+2*_16,25);}if(_6c===void 0){_6c=new _1(_6a.width+2*_16,_6a.height+2*_16,25);}this.transform=_6a;this.grid=_6b;this.ignoredGrid=_6c;this.pitchfactor=Math.cos(_6a._pitch)*_6a.cameraToCenterDistance;this.screenRightBoundary=_6a.width+_16;this.screenBottomBoundary=_6a.height+_16;this.gridRightBoundary=_6a.width+2*_16;this.gridBottomBoundary=_6a.height+2*_16;};_69.prototype.placeCollisionBox=function placeCollisionBox(_6d,_6e,_6f,_70,_71){var _72=this.projectAndGetPerspectiveRatio(_70,_6d.anchorPointX,_6d.anchorPointY);var _73=_6f*_72.perspectiveRatio;var tlX=_6d.x1*_73+_72.point.x;var tlY=_6d.y1*_73+_72.point.y;var brX=_6d.x2*_73+_72.point.x;var brY=_6d.y2*_73+_72.point.y;if(!this.isInsideGrid(tlX,tlY,brX,brY)||(!_6e&&this.grid.hitTest(tlX,tlY,brX,brY,_71))){return {box:[],offscreen:false};}return {box:[tlX,tlY,brX,brY],offscreen:this.isOffscreen(tlX,tlY,brX,brY)};};_69.prototype.approximateTileDistance=function approximateTileDistance(_74,_75,_76,_77,_78){var _79=_78?1:_77/this.pitchfactor;var _7a=_74.lastSegmentViewportDistance*_76;return _74.prevTileDistance+_7a+(_79-1)*_7a*Math.abs(Math.sin(_75));};_69.prototype.placeCollisionCircles=function placeCollisionCircles(_7b,_7c,_7d,_7e,_7f,_80,_81,_82,_83,_84,_85,_86,_87){var _88=[];var _89=this.projectAnchor(_83,_7f.anchorX,_7f.anchorY);var _8a={};var _8b=_82/24;var _8c=_7f.lineOffsetX*_82;var _8d=_7f.lineOffsetY*_82;var _8e=new _2(_7f.anchorX,_7f.anchorY);var _8f=_29(_8e,_84).point;var _90=_4f(_8b,_81,_8c,_8d,false,_8f,_8e,_7f,_80,_84,_8a,true);var _91=false;var _92=false;var _93=true;var _94=_89.perspectiveRatio*_7e;var _95=1/(_7e*_7d);var _96=0,_97=0;if(_90){_96=this.approximateTileDistance(_90.first.tileDistance,_90.first.angle,_95,_89.cameraDistance,_86);_97=this.approximateTileDistance(_90.last.tileDistance,_90.last.angle,_95,_89.cameraDistance,_86);}for(var k=0;k<_7b.length;k+=5){var _98=_7b[k];var _99=_7b[k+1];var _9a=_7b[k+2];var _9b=_7b[k+3];if(!_90||(_9b<-_96)||(_9b>_97)){_2d(_7b,k,false);continue;}var _9c=this.projectPoint(_83,_98,_99);var _9d=_9a*_94;var _9e=_88.length>0;if(_9e){var dx=_9c.x-_88[_88.length-4];var dy=_9c.y-_88[_88.length-3];var _9f=_9d*_9d*2>dx*dx+dy*dy;if(_9f){var _a0=(k+8)<_7b.length;if(_a0){var _a1=_7b[k+8];if((_a1>-_96)&&(_a1<_97)){_2d(_7b,k,false);continue;}}}}var _a2=k/5;_88.push(_9c.x,_9c.y,_9d,_a2);_2d(_7b,k,true);var x1=_9c.x-_9d;var y1=_9c.y-_9d;var x2=_9c.x+_9d;var y2=_9c.y+_9d;_93=_93&&this.isOffscreen(x1,y1,x2,y2);_92=_92||this.isInsideGrid(x1,y1,x2,y2);if(!_7c){if(this.grid.hitTestCircle(_9c.x,_9c.y,_9d,_87)){if(!_85){return {circles:[],offscreen:false};}else{_91=true;}}}}return {circles:(_91||!_92)?[]:_88,offscreen:_93};};_69.prototype.queryRenderedSymbols=function queryRenderedSymbols(_a3){if(_a3.length===0||(this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)){return {};}var _a4=[];var _a5=Infinity;var _a6=Infinity;var _a7=-Infinity;var _a8=-Infinity;for(var i=0,_a9=_a3;i<_a9.length;i+=1){var _aa=_a9[i];var _ab=new _2(_aa.x+_16,_aa.y+_16);_a5=Math.min(_a5,_ab.x);_a6=Math.min(_a6,_ab.y);_a7=Math.max(_a7,_ab.x);_a8=Math.max(_a8,_ab.y);_a4.push(_ab);}var _ac=this.grid.query(_a5,_a6,_a7,_a8).concat(this.ignoredGrid.query(_a5,_a6,_a7,_a8));var _ad={};var _ae={};for(var i$1=0,_af=_ac;i$1<_af.length;i$1+=1){var _b0=_af[i$1];var _b1=_b0.key;if(_ad[_b1.bucketInstanceId]===undefined){_ad[_b1.bucketInstanceId]={};}if(_ad[_b1.bucketInstanceId][_b1.featureIndex]){continue;}var _b2=[new _2(_b0.x1,_b0.y1),new _2(_b0.x2,_b0.y1),new _2(_b0.x2,_b0.y2),new _2(_b0.x1,_b0.y2)];if(!_6.polygonIntersectsPolygon(_a4,_b2)){continue;}_ad[_b1.bucketInstanceId][_b1.featureIndex]=true;if(_ae[_b1.bucketInstanceId]===undefined){_ae[_b1.bucketInstanceId]=[];}_ae[_b1.bucketInstanceId].push(_b1.featureIndex);}return _ae;};_69.prototype.insertCollisionBox=function insertCollisionBox(_b3,_b4,_b5,_b6,_b7){var _b8=_b4?this.ignoredGrid:this.grid;var key={bucketInstanceId:_b5,featureIndex:_b6,collisionGroupID:_b7};_b8.insert(key,_b3[0],_b3[1],_b3[2],_b3[3]);};_69.prototype.insertCollisionCircles=function insertCollisionCircles(_b9,_ba,_bb,_bc,_bd){var _be=_ba?this.ignoredGrid:this.grid;var key={bucketInstanceId:_bb,featureIndex:_bc,collisionGroupID:_bd};for(var k=0;k<_b9.length;k+=4){_be.insertCircle(key,_b9[k],_b9[k+1],_b9[k+2]);}};_69.prototype.projectAnchor=function projectAnchor(_bf,x,y){var p=[x,y,0,1];_3.xyTransformMat4(p,p,_bf);return {perspectiveRatio:0.5+0.5*(this.transform.cameraToCenterDistance/p[3]),cameraDistance:p[3]};};_69.prototype.projectPoint=function projectPoint(_c0,x,y){var p=[x,y,0,1];_3.xyTransformMat4(p,p,_c0);return new _2((((p[0]/p[3]+1)/2)*this.transform.width)+_16,(((-p[1]/p[3]+1)/2)*this.transform.height)+_16);};_69.prototype.projectAndGetPerspectiveRatio=function projectAndGetPerspectiveRatio(_c1,x,y){var p=[x,y,0,1];_3.xyTransformMat4(p,p,_c1);var a=new _2((((p[0]/p[3]+1)/2)*this.transform.width)+_16,(((-p[1]/p[3]+1)/2)*this.transform.height)+_16);return {point:a,perspectiveRatio:0.5+0.5*(this.transform.cameraToCenterDistance/p[3])};};_69.prototype.isOffscreen=function isOffscreen(x1,y1,x2,y2){return x2<_16||x1>=this.screenRightBoundary||y2<_16||y1>this.screenBottomBoundary;};_69.prototype.isInsideGrid=function isInsideGrid(x1,y1,x2,y2){return x2>=0&&x1<this.gridRightBoundary&&y2>=0&&y1<this.gridBottomBoundary;};var _c2=function _c2(_c3){this.crossSourceCollisions=_c3;this.maxGroupID=0;this.collisionGroups={};};_c2.prototype.get=function get(_c4){if(!this.crossSourceCollisions){if(!this.collisionGroups[_c4]){var _c5=++this.maxGroupID;this.collisionGroups[_c4]={ID:_c5,predicate:function(key){return key.collisionGroupID===_c5;}};}return this.collisionGroups[_c4];}else{return {ID:0,predicate:null};}};var _c6=function _c6(){this._currentTileIndex=0;this._seenCrossTileIDs={};};_c6.prototype.continuePlacement=function continuePlacement(_c7,_c8,_c9,_ca,_cb){while(this._currentTileIndex<_c7.length){var _cc=_c7[this._currentTileIndex];_c8.placeLayerTile(_ca,_cc,_c9,this._seenCrossTileIDs);this._currentTileIndex++;if(_cb()){return true;}}};var _cd=function _cd(_ce,_cf,_d0,_d1){this.transform=_ce;this.collisionIndex=new _69(_ce);this.placements={};this.opacities={};this.variableOffsets={};this.stale=false;this.commitTime=0;this.fadeDuration=_cf;this.retainedQueryData={};this.collisionGroups=new _c2(_d0);this.prevPlacement=_d1;if(_d1){_d1.prevPlacement=undefined;}};_cd.prototype.placeLayerTile=function placeLayerTile(_d2,_d3,_d4,_d5){var _d6=((_d3.getBucket(_d2)));var _d7=_d3.latestFeatureIndex;if(!_d6||!_d7||_d2.id!==_d6.layerIds[0]){return;}var _d8=_d3.collisionBoxArray;var _d9=_d6.layers[0].layout;var _da=Math.pow(2,this.transform.zoom-_d3.tileID.overscaledZ);var _db=512/_4.layout.EXTENT;var _dc=this.transform.updatePosMatrix(_d3.tileID.toUnwrapped());var _dd=_3.getLabelPlaneMatrix(_dc,_d9.get("text-pitch-alignment")==="map",_d9.get("text-rotation-alignment")==="map",this.transform,_5.pixelsToTileUnits(_d3,1,this.transform.zoom));var _de=_3.getLabelPlaneMatrix(_dc,_d9.get("icon-pitch-alignment")==="map",_d9.get("icon-rotation-alignment")==="map",this.transform,_5.pixelsToTileUnits(_d3,1,this.transform.zoom));this.retainedQueryData[_d6.bucketInstanceId]=new _63(_d6.bucketInstanceId,_d7,_d6.sourceLayerIndex,_d6.index,_d3.tileID);this.placeLayerBucket(_d6,_dc,_dd,_de,_da,_db,_d4,_d3.holdingForFade(),_d5,_d8);};_cd.prototype.attemptAnchorPlacement=function attemptAnchorPlacement(_df,_e0,_e1,_e2,_e3,_e4,_e5,_e6,_e7,_e8,_e9,_ea,_eb,_ec){var _ed=calculateVariableLayoutOffset(_df,_e1,_e2,_e3,_e4);var _ee=this.collisionIndex.placeCollisionBox(shiftVariableCollisionBox(_e0,_ed.x,_ed.y,_e5,_e6,this.transform.angle),_ea,_e7,_e8,_e9.predicate);if(_ee.box.length>0){var _ef;if(this.prevPlacement&&this.prevPlacement.variableOffsets[_eb.crossTileID]&&this.prevPlacement.placements[_eb.crossTileID]&&this.prevPlacement.placements[_eb.crossTileID].text){_ef=this.prevPlacement.variableOffsets[_eb.crossTileID].anchor;}this.variableOffsets[_eb.crossTileID]={radialOffset:_e3,width:_e1,height:_e2,anchor:_df,textBoxScale:_e4,prevAnchor:_ef};this.markUsedJustification(_ec,_df,_eb);return _ee;}};_cd.prototype.placeLayerBucket=function placeLayerBucket(_f0,_f1,_f2,_f3,_f4,_f5,_f6,_f7,_f8,_f9){var _fa=this;var _fb=_f0.layers[0].layout;var _fc=_3.evaluateSizeForZoom(_f0.textSizeData,this.transform.zoom);var _fd=_fb.get("text-optional");var _fe=_fb.get("icon-optional");var _ff=_fb.get("text-allow-overlap");var _100=_fb.get("icon-allow-overlap");var _101=_ff&&(_100||!_f0.hasIconData()||_fe);var _102=_100&&(_ff||!_f0.hasTextData()||_fd);var _103=this.collisionGroups.get(_f0.sourceID);var _104=_fb.get("text-rotation-alignment")==="map";var _105=_fb.get("text-pitch-alignment")==="map";var _106=_fb.get("symbol-z-order")==="viewport-y";if(!_f0.collisionArrays&&_f9){_f0.deserializeCollisionBoxes(_f9);}var _107=function(_108,_109){if(_f8[_108.crossTileID]){return;}if(_f7){_fa.placements[_108.crossTileID]=new joint.JointPlacement(false,false,false);return;}var _10a=false;var _10b=false;var _10c=true;var _10d=null;var _10e=null;var _10f=null;var _110=0;var _111=0;if(_109.textFeatureIndex){_110=_109.textFeatureIndex;}var _112=_109.textBox;if(_112){if(!_fb.get("text-variable-anchor")){_10d=_fa.collisionIndex.placeCollisionBox(_112,_fb.get("text-allow-overlap"),_f5,_f1,_103.predicate);_10a=_10d.box.length>0;}else{var _113=_112.x2-_112.x1;var _114=_112.y2-_112.y1;var _115=_108.textBoxScale;var _116=_fb.get("text-variable-anchor");if(_fa.prevPlacement&&_fa.prevPlacement.variableOffsets[_108.crossTileID]){var _117=_fa.prevPlacement.variableOffsets[_108.crossTileID];if(_116[0]!==_117.anchor){_116=_116.filter(function(_118){return _118!==_117.anchor;});_116.unshift(_117.anchor);}}for(var i=0,list=_116;i<list.length;i+=1){var _119=list[i];_10d=_fa.attemptAnchorPlacement(_119,_112,_113,_114,_108.radialTextOffset,_115,_104,_105,_f5,_f1,_103,_ff,_108,_f0);if(_10d){_10a=true;break;}}if(!_fa.variableOffsets[_108.crossTileID]&&_fa.prevPlacement){var _11a=_fa.prevPlacement.variableOffsets[_108.crossTileID];if(_11a){_fa.variableOffsets[_108.crossTileID]=_11a;_fa.markUsedJustification(_f0,_11a.anchor,_108);}}}}_10c=_10d&&_10d.offscreen;var _11b=_109.textCircles;if(_11b){var _11c=_f0.text.placedSymbolArray.get(_108.centerJustifiedTextSymbolIndex);var _11d=_3.evaluateSizeForFeature(_f0.textSizeData,_fc,_11c);_10e=_fa.collisionIndex.placeCollisionCircles(_11b,_fb.get("text-allow-overlap"),_f4,_f5,_11c,_f0.lineVertexArray,_f0.glyphOffsetArray,_11d,_f1,_f2,_f6,_105,_103.predicate);_10a=_fb.get("text-allow-overlap")||_10e.circles.length>0;_10c=_10c&&_10e.offscreen;}if(_109.iconFeatureIndex){_111=_109.iconFeatureIndex;}if(_109.iconBox){_10f=_fa.collisionIndex.placeCollisionBox(_109.iconBox,_fb.get("icon-allow-overlap"),_f5,_f1,_103.predicate);_10b=_10f.box.length>0;_10c=_10c&&_10f.offscreen;}var _11e=_fd||(_108.numHorizontalGlyphVertices===0&&_108.numVerticalGlyphVertices===0);var _11f=_fe||_108.numIconVertices===0;if(!_11e&&!_11f){_10b=_10a=_10b&&_10a;}else{if(!_11f){_10a=_10b&&_10a;}else{if(!_11e){_10b=_10b&&_10a;}}}if(_10a&&_10d){_fa.collisionIndex.insertCollisionBox(_10d.box,_fb.get("text-ignore-placement"),_f0.bucketInstanceId,_110,_103.ID);}if(_10b&&_10f){_fa.collisionIndex.insertCollisionBox(_10f.box,_fb.get("icon-ignore-placement"),_f0.bucketInstanceId,_111,_103.ID);}if(_10a&&_10e){_fa.collisionIndex.insertCollisionCircles(_10e.circles,_fb.get("text-ignore-placement"),_f0.bucketInstanceId,_110,_103.ID);}_fa.placements[_108.crossTileID]=new _12(_10a||_101,_10b||_102,_10c||_f0.justReloaded);_f8[_108.crossTileID]=true;};if(_106){var _120=_f0.getSortedSymbolIndexes(this.transform.angle);for(var i=_120.length-1;i>=0;--i){var _121=_120[i];_107(_f0.symbolInstances.get(_121),_f0.collisionArrays[_121]);}}else{for(var i$1=0;i$1<_f0.symbolInstances.length;++i$1){_107(_f0.symbolInstances.get(i$1),_f0.collisionArrays[i$1]);}}_f0.justReloaded=false;};_cd.prototype.markUsedJustification=function markUsedJustification(_122,_123,_124){var _125={"left":_124.leftJustifiedTextSymbolIndex,"center":_124.centerJustifiedTextSymbolIndex,"right":_124.rightJustifiedTextSymbolIndex};var _126=_125[__chunk_1.getAnchorJustification(_123)];for(var _127 in _125){var _128=_125[_127];if(_128>=0){if(_126>=0&&_128!==_126){_122.text.placedSymbolArray.get(_128).crossTileID=0;}else{_122.text.placedSymbolArray.get(_128).crossTileID=_124.crossTileID;}}}};_cd.prototype.commit=function commit(now){this.commitTime=now;var _129=this.prevPlacement;var _12a=false;var _12b=(_129&&this.fadeDuration!==0)?(this.commitTime-_129.commitTime)/this.fadeDuration:1;var _12c=_129?_129.opacities:{};var _12d=_129?_129.variableOffsets:{};for(var _12e in this.placements){var _12f=this.placements[_12e];var _130=_12c[_12e];if(_130){this.opacities[_12e]=new _c(_130,_12b,_12f.text,_12f.icon);_12a=_12a||_12f.text!==_130.text.placed||_12f.icon!==_130.icon.placed;}else{this.opacities[_12e]=new _c(null,_12b,_12f.text,_12f.icon,_12f.skipFade);_12a=_12a||_12f.text||_12f.icon;}}for(var _131 in _12c){var _132=_12c[_131];if(!this.opacities[_131]){var _133=new _c(_132,_12b,false,false);if(!_133.isHidden()){this.opacities[_131]=_133;_12a=_12a||_132.text.placed||_132.icon.placed;}}}for(var _134 in _12d){if(!this.variableOffsets[_134]&&this.opacities[_134]&&!this.opacities[_134].isHidden()){this.variableOffsets[_134]=_12d[_134];}}if(_12a){this.lastPlacementChangeTime=now;}else{if(typeof this.lastPlacementChangeTime!=="number"){this.lastPlacementChangeTime=_129?_129.lastPlacementChangeTime:now;}}};_cd.prototype.updateLayerOpacities=function updateLayerOpacities(_135,_136){var _137={};for(var i=0,list=_136;i<list.length;i+=1){var tile=list[i];var _138=((tile.getBucket(_135)));if(_138&&tile.latestFeatureIndex&&_135.id===_138.layerIds[0]){this.updateBucketOpacities(_138,_137,tile.collisionBoxArray);}}};_cd.prototype.updateBucketOpacities=function updateBucketOpacities(_139,_13a,_13b){if(_139.hasTextData()){_139.text.opacityVertexArray.clear();}if(_139.hasIconData()){_139.icon.opacityVertexArray.clear();}if(_139.hasCollisionBoxData()){_139.collisionBox.collisionVertexArray.clear();}if(_139.hasCollisionCircleData()){_139.collisionCircle.collisionVertexArray.clear();}var _13c=_139.layers[0].layout;var _13d=new _c(null,0,false,false,true);var _13e=_13c.get("text-allow-overlap");var _13f=_13c.get("icon-allow-overlap");var _140=_13c.get("text-variable-anchor");var _141=_13c.get("text-rotation-alignment")==="map";var _142=_13c.get("text-pitch-alignment")==="map";var _143=new _c(null,0,_13e&&(_13f||!_139.hasIconData()||_13c.get("icon-optional")),_13f&&(_13e||!_139.hasTextData()||_13c.get("text-optional")),true);if(!_139.collisionArrays&&_13b&&(_139.hasCollisionBoxData()||_139.hasCollisionCircleData())){_139.deserializeCollisionBoxes(_13b);}for(var s=0;s<_139.symbolInstances.length;s++){var _144=_139.symbolInstances.get(s);var _145=_144.numHorizontalGlyphVertices;var _146=_144.numVerticalGlyphVertices;var _147=_144.crossTileID;var _148=_13a[_147];var _149=this.opacities[_147];if(_148){_149=_13d;}else{if(!_149){_149=_143;this.opacities[_147]=_149;}}_13a[_147]=true;var _14a=_145>0||_146>0;var _14b=_144.numIconVertices>0;if(_14a){var _14c=_1e(_149.text);var _14d=(_145+_146)/4;for(var i=0;i<_14d;i++){_139.text.opacityVertexArray.emplaceBack(_14c);}var _14e=_149.text.isHidden()?1:0;[_144.rightJustifiedTextSymbolIndex,_144.centerJustifiedTextSymbolIndex,_144.leftJustifiedTextSymbolIndex,_144.verticalPlacedTextSymbolIndex].forEach(function(_14f){if(_14f>=0){_139.text.placedSymbolArray.get(_14f).hidden=_14e;}});var _150=this.variableOffsets[_144.crossTileID];if(_150){this.markUsedJustification(_139,_150.anchor,_144);}}if(_14b){var _151=_1e(_149.icon);for(var i$1=0;i$1<_144.numIconVertices/4;i$1++){_139.icon.opacityVertexArray.emplaceBack(_151);}_139.icon.placedSymbolArray.get(s).hidden=(_149.icon.isHidden());}if(_139.hasCollisionBoxData()||_139.hasCollisionCircleData()){var _152=_139.collisionArrays[s];if(_152){if(_152.textBox){var _153=new __chunk_1.Point(0,0);var used=true;if(_140){var _154=this.variableOffsets[_147];if(_154){_153=calculateVariableLayoutOffset(_154.anchor,_154.width,_154.height,_154.radialOffset,_154.textBoxScale);if(_141){_153._rotate(_142?this.transform.angle:-this.transform.angle);}}else{used=false;}}updateCollisionVertices(_139.collisionBox.collisionVertexArray,_149.text.placed,!used,_153.x,_153.y);}if(_152.iconBox){updateCollisionVertices(_139.collisionBox.collisionVertexArray,_149.icon.placed,false);}var _155=_152.textCircles;if(_155&&_139.hasCollisionCircleData()){for(var k=0;k<_155.length;k+=5){var _156=_148||_155[k+4]===0;updateCollisionVertices(_139.collisionCircle.collisionVertexArray,_149.text.placed,_156);}}}}}_139.sortFeatures(this.transform.angle);if(this.retainedQueryData[_139.bucketInstanceId]){this.retainedQueryData[_139.bucketInstanceId].featureSortOrder=_139.featureSortOrder;}if(_139.hasTextData()&&_139.text.opacityVertexBuffer){_139.text.opacityVertexBuffer.updateData(_139.text.opacityVertexArray);}if(_139.hasIconData()&&_139.icon.opacityVertexBuffer){_139.icon.opacityVertexBuffer.updateData(_139.icon.opacityVertexArray);}if(_139.hasCollisionBoxData()&&_139.collisionBox.collisionVertexBuffer){_139.collisionBox.collisionVertexBuffer.updateData(_139.collisionBox.collisionVertexArray);}if(_139.hasCollisionCircleData()&&_139.collisionCircle.collisionVertexBuffer){_139.collisionCircle.collisionVertexBuffer.updateData(_139.collisionCircle.collisionVertexArray);}};_cd.prototype.symbolFadeChange=function symbolFadeChange(now){return this.fadeDuration===0?1:(now-this.commitTime)/this.fadeDuration;};_cd.prototype.hasTransitions=function hasTransitions(now){return this.stale||now-this.lastPlacementChangeTime<this.fadeDuration;};_cd.prototype.stillRecent=function stillRecent(now){return this.commitTime+this.fadeDuration>now;};_cd.prototype.setStale=function setStale(){this.stale=true;};var _157=function _157(_158,_159,_15a,_15b,_15c,_15d,_15e){this.placement=new _cd(_158,_15c,_15d,_15e);this._currentPlacementIndex=_159.length-1;this._forceFullPlacement=_15a;this._showCollisionBoxes=_15b;this._done=false;};_157.prototype.isDone=function isDone(){return this._done;};_157.prototype.continuePlacement=function continuePlacement(_15f,_160,_161){var _162=this;var _163=_3.now();var _164=function(){var _165=_3.now()-_163;return _162._forceFullPlacement?false:_165>2;};while(this._currentPlacementIndex>=0){var _166=_15f[this._currentPlacementIndex];var _167=_160[_166];var _168=this.placement.collisionIndex.transform.zoom;if(_167.type==="symbol"&&(!_167.minzoom||_167.minzoom<=_168)&&(!_167.maxzoom||_167.maxzoom>_168)){if(!this._inProgressLayer){this._inProgressLayer=new _c6();}var _169=this._inProgressLayer.continuePlacement(_161[_167.source],this.placement,this._showCollisionBoxes,_167,_164);if(_169){return;}delete this._inProgressLayer;}this._currentPlacementIndex--;}this._done=true;};_157.prototype.commit=function commit(now){this.placement.commit(now);return this.placement;};return _157;});