//>>built
define("com/huayun/webgis/layers/support/TerrainSourceCache",["./TileSource","./funcUtils","./TileCache","./Tile","./SourceFeatureState","com/huayun/webgis/layers/support/tileCover","com/huayun/webgis/geometry/Point2D","../../utils/utils","../../work/createVerticesFromQuantizedTerrainMesh","../../data/IndexDatatype","../../gl/SegmentVector","./TerrainMesh","../../data/ArrayType"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d){var _e=10;function _f(_10,_11,_12){var _13=_11.vertices;var _14=_10.createVertexBuffer({length:_13.length/7,bytesPerElement:28,arrayBuffer:_13},[{name:"position3DAndHeight",type:"Float32",components:4,offset:0},{name:"textureCoordAndEncodedNormals",type:"Float32",components:3,offset:16}]);var _15=_11.indices;var _16=_10.createIndexBuffer({arrayBuffer:_15});var _17=_b.simpleSegment(0,0,_12,_15.length/3);return {vertexBuffer:_14,indexBuffer:_16,segments:_17};};function _18(id,_19,_1a,_1b,url,_1c,_1d){this.id=id;this._source=new _1.TerrainSourceCache(id,_19,url,_1d);this._tiles={};this._cache=new _3(0,this._unloadTile.bind(this));this._timers={};this._cacheTimers={};this._maxTileCacheSize=null;this._coveredTiles={};this.updateCacheSize(_1a,_1b);this.layer=_1c;this.view=_1d;};_18.prototype.constructor=_18;_18.prototype.updateTileSize=function(_1e){this._source.setSize(_1e);};_18.prototype.onRemove=function onRemove(map){if(this._source&&this._source.onRemove){this._source.onRemove(map);}};_18.prototype.loaded=function loaded(){if(this._sourceErrored){return true;}if(!this._sourceLoaded){return false;}for(var t in this._tiles){var _1f=this._tiles[t];if(_1f.state!=="loaded"&&_1f.state!=="errored"){return false;}}return true;};_18.prototype.getSource=function getSource(){return this._source;};_18.prototype.pause=function pause(){this._paused=true;};_18.prototype.resume=function resume(){if(!this._paused){return;}var _20=this._shouldReloadOnResume;this._paused=false;this._shouldReloadOnResume=false;if(_20){this.reload();}if(this.transform){this.update(this.transform);}};_18.prototype._loadTile=function _loadTile(_21,_22){return this._source.loadTile(_21,_22);};_18.prototype._unloadTile=function _unloadTile(_23){if(this._source.unloadTile){return this._source.unloadTile(_23,function(){});}};_18.prototype._abortTile=function _abortTile(_24){if(this._source.abortTile){return this._source.abortTile(_24,function(){});}};_18.prototype.serialize=function serialize(){return this._source.serialize();};_18.prototype.getIds=function getIds(){var _25=[];for(var key in this._tiles){_25.push(this._tiles[key].tileID);}return _25;};_18.prototype.getRenderableIds=function getRenderableIds(){var ids=[];for(var id in this._tiles){if(this._isIdRenderable(id)){ids.push(id);}}return ids.sort(_8.compareKeyZoom);};_18.prototype.hasRenderableParent=function hasRenderableParent(_26){var _27=this.findLoadedParent(_26,0);if(_27){return this._isIdRenderable(_27.tileID.key);}return false;};_18.prototype._isIdRenderable=function _isIdRenderable(id){return this._tiles[id]&&this._tiles[id].hasData()&&!this._coveredTiles[id]&&(!this._tiles[id].holdingForFade());};_18.prototype.reload=function reload(){if(this._paused){this._shouldReloadOnResume=true;return;}this._cache.reset();for(var i in this._tiles){if(this._tiles[i].state!=="errored"){this._reloadTile(i,"reloading");}}};_18.prototype._reloadTile=function _reloadTile(id,_28){var _29=this._tiles[id];if(!_29){return;}if(_29.state!=="loading"){_29.state=_28;}this._loadTile(_29,this._tileLoaded.bind(this,_29,id,_28));};_18.prototype.updateTileUrl=function(url){this._source.updateTileUrl(url);};_18.prototype._tileLoaded=function _tileLoaded(_2a,id,_2b,err,_2c){if(err){_2a.state="errored";if(err.status===404){this.update(this.transform);}return;}var _2d=_2a.tileID.canonical;var _2e=this.layer.tileInfo.tileXYToRectangle(_2d.x,_2d.y,_2d.z);var _2f=this.view.viewpoint.targetZoom||this.view.viewpoint.level;var _30=this.view.viewpoint.tileInfo.getResolution(_2f);var _31={rectangle:_2e,resolution:_30,type:"terrain"};var _32=this.view.groundData;var _33=_32.createTerrainVertice(_31.rectangle,_31.resolution);var _34={layoutVertexArray:_33.vertices,indexArray:_33.indices,segments:_33.segments};var _35=obj.view.context;_2a.bucket={layoutVertexBuffer:_35.createVertexBuffer(_34.layoutVertexArray,[{name:"a_pos",type:"Float32",components:3,offset:0}]),indexBuffer:_35.createIndexBuffer(_34.indexArray),segments:_34.segments};_2a.minimumHeight=_33.minH;_2a.maximumHeight=_33.maxH;_2a.timeAdded=_8.now();this.layer.layerView._sourcesDirty=true;this.view.threeRender();};_18.prototype.getTile=function getTile(_36){return this.getTileByID(_36.key);};_18.prototype.getTileByID=function getTileByID(id){return this._tiles[id];};_18.prototype.getZoom=function getZoom(_37){return _37.level+_37.scaleZoom(_37.tileSize/this._source.tileSize);};_18.prototype._retainLoadedChildren=function _retainLoadedChildren(_38,_39,_3a,_3b){for(var id in this._tiles){var _3c=this._tiles[id];if(_3b[id]||!_3c.hasData()||_3c.tileID.overscaledZ<=_39||_3c.tileID.overscaledZ>_3a){continue;}var _3d=_3c.tileID;while(_3c&&_3c.tileID.overscaledZ>_39+1){var _3e=_3c.tileID.scaledTo(_3c.tileID.overscaledZ-1);_3c=this._tiles[_3e.key];if(_3c&&_3c.hasData()){_3d=_3e;}}var _3f=_3d;while(_3f.overscaledZ>_39){_3f=_3f.scaledTo(_3f.overscaledZ-1);if(_38[_3f.key]){_3b[_3d.key]=_3d;break;}}}};_18.prototype.findLoadedParent=function findLoadedParent(_40,_41){for(var z=_40.overscaledZ-1;z>=_41;z--){var _42=_40.scaledTo(z);if(!_42){return;}var id=String(_42.key);var _43=this._tiles[id];if(_43&&_43.hasData()){return _43;}if(this._cache.has(_42)){return this._cache.get(_42);}}};_18.prototype.updateCacheSize=function updateCacheSize(_44,_45){var _46=Math.ceil(_44/this._source.tileSize)+1;var _47=Math.ceil(_45/this._source.tileSize)+1;var _48=_46*_47;var _49=3;var _4a=Math.floor(_48*_49);var _4b=typeof this._maxTileCacheSize==="number"?Math.min(this._maxTileCacheSize,_4a):_4a;this._cache.setMaxSize(_4b);};_18.prototype.update=function update(_4c,_4d,_4e,cx,cy){this._coveredTiles={};var _4f=_6.tileCover(_4c,_4d,_4e);_4f=_4f.sort(function(a,b){a=a.canonical;b=b.canonical;return Math.sqrt((cx-a.x)*(cx-a.x)+(cy-a.y)*(cy-a.y))-Math.sqrt((cx-b.x)*(cx-b.x)+(cy-b.y)*(cy-b.y));});var _50=this._updateRetainedTiles(_4f,_4c);for(var _51 in _50){this._tiles[_51].clearFadeHold();}var _52=_8.keysDifference(this._tiles,_50);for(var i$1=0,_53=_52;i$1<_53.length;i$1+=1){var _54=_53[i$1];this._removeTile(_54);}};_18.prototype.updateTile=function updateTile(_55,_56,_57,cx,cy){this._coveredTiles={};var _58=_6.tileCover(_55,_56,_57,"tms");_58=_58.sort(function(a,b){a=a.canonical;b=b.canonical;return Math.sqrt((cx-a.x)*(cx-a.x)+(cy-a.y)*(cy-a.y))-Math.sqrt((cx-b.x)*(cx-b.x)+(cy-b.y)*(cy-b.y));});this._updateRetainedTiles(_58,_55);return _58;};_18.prototype.releaseSymbolFadeTiles=function releaseSymbolFadeTiles(){for(var id in this._tiles){if(this._tiles[id].holdingForFade()){this._removeTile(id);}}};_18.prototype._updateRetainedTiles=function _updateRetainedTiles(_59,_5a){var _5b={};var _5c={};var _5d=Math.max(_5a-_18.maxOverzooming,this._source.minzoom);var _5e=Math.max(_5a+_18.maxUnderzooming,this._source.minzoom);var _5f={};for(var i=0,_60=_59;i<_60.length;i+=1){var _61=_60[i];var _62=this._addTile(_61);_5b[_61.key]=_61;if(_62.hasData()){continue;}if(_5a<this._source.maxzoom){_5f[_61.key]=_61;}}this._retainLoadedChildren(_5f,_5a,_5e,_5b);for(var i$1=0,_63=_59;i$1<_63.length;i$1+=1){var _64=_63[i$1];var _65=this._tiles[_64.key];if(_65.hasData()){continue;}if(_5a+1>this._source.maxzoom){var _66=_64.children(this._source.maxzoom)[0];var _67=this.getTile(_66);if(!!_67&&_67.hasData()){_5b[_66.key]=_66;continue;}}else{var _68=_64.children(this._source.maxzoom);if(_5b[_68[0].key]&&_5b[_68[1].key]&&_5b[_68[2].key]&&_5b[_68[3].key]){continue;}}var _69=_65.wasRequested();for(var _6a=_64.overscaledZ-1;_6a>=_5d;--_6a){var _6b=_64.scaledTo(_6a);if(_5c[_6b.key]){break;}_5c[_6b.key]=true;_65=this.getTile(_6b);if(!_65&&_69){_65=this._addTile(_6b);}if(_65){_5b[_6b.key]=_6b;_69=_65.wasRequested();if(_65.hasData()){break;}}}}return _5b;};_18.prototype._reAddTile=function _reAddTile(_6c){var _6d=new _4(_6c,this._source.tileSize*_6c.overscaleFactor());this._loadTile(_6d,this._tileReAddLoaded.bind(this,_6d,_6c.key,_6d.state));};_18.prototype._tileReAddLoaded=function _tileLoaded(_6e,id,_6f,err){this._removeTile(id);this._tiles[_6e.tileID.key]=_6e;if(err){_6e.state="errored";if(err.status===404){this.update(this.transform);}return;}_6e.timeAdded=_8.now();this._setTileReloadTimer(id,_6e);this.layer.layerViews[0]._sourcesDirty=true;this.view.threeRender();};_18.prototype._addTile=function _addTile(_70){var _71=this._tiles[_70.key];if(_71){return _71;}_71=this._cache.getAndRemove(_70);if(_71){this._setTileReloadTimer(_70.key,_71);_71.tileID=_70;if(this._cacheTimers[_70.key]){clearTimeout(this._cacheTimers[_70.key]);delete this._cacheTimers[_70.key];this._setTileReloadTimer(_70.key,_71);}}var _72=Boolean(_71);if(!_72){_71=new _4(_70,this._source.tileSize*_70.overscaleFactor());this._loadTile(_71,this._tileLoaded.bind(this,_71,_70.key,_71.state));}if(!_71){return (null);}_71.uses++;this._tiles[_70.key]=_71;return _71;};_18.prototype._setTileReloadTimer=function _setTileReloadTimer(id,_73){var _74=this;if(id in this._timers){clearTimeout(this._timers[id]);delete this._timers[id];}var _75=_73.getExpiryTimeout();if(_75){this._timers[id]=setTimeout(function(){_74._reloadTile(id,"expired");delete _74._timers[id];},_75);}};_18.prototype._removeTile=function _removeTile(id){var _76=this._tiles[id];if(!_76){return;}_76.uses--;delete this._tiles[id];if(this._timers[id]){clearTimeout(this._timers[id]);delete this._timers[id];}if(_76.uses>0){return;}if(_76.hasData()){}else{_76.aborted=true;this._abortTile(_76);this._unloadTile(_76);}};_18.prototype.clearTiles=function clearTiles(){this._shouldReloadOnResume=false;this._paused=false;for(var id in this._tiles){this._removeTile(id);}this._cache.reset();};_18.prototype.clearOtherLevel=function clearOtherLevel(_77){this._shouldReloadOnResume=false;this._paused=false;for(var id in this._tiles){var _78=this._tiles[id];if(_78.tileID.canonical.z!==_77){this._removeTile(id);}}};_18.prototype.tilesIn=function tilesIn(_79,_7a,_7b){var _7c=this;var _7d=[];var _7e=this.transform;if(!_7e){return _7d;}var _7f=_7b?_7e.getCameraQueryGeometry(_79):_79;var _80=_79.map(function(p){return _7e.pointCoordinate(p);});var _81=_7f.map(function(p){return _7e.pointCoordinate(p);});var ids=this.getIds();var _82=Infinity;var _83=Infinity;var _84=-Infinity;var _85=-Infinity;for(var i$1=0,_86=_81;i$1<_86.length;i$1+=1){var p=_86[i$1];_82=Math.min(_82,p.x);_83=Math.min(_83,p.y);_84=Math.max(_84,p.x);_85=Math.max(_85,p.y);}var _87=function(i){var _88=_7c._tiles[ids[i]];if(_88.holdingForFade()){return;}var _89=_88.tileID;var _8a=Math.pow(2,_7e.level-_88.tileID.overscaledZ);var _8b=_7a*_88.queryPadding*__chunk_1.EXTENT/_88.tileSize/_8a;var _8c=[_89.getTilePoint(new __chunk_1.MercatorCoordinate(_82,_83)),_89.getTilePoint(new __chunk_1.MercatorCoordinate(_84,_85))];if(_8c[0].x-_8b<__chunk_1.EXTENT&&_8c[0].y-_8b<__chunk_1.EXTENT&&_8c[1].x+_8b>=0&&_8c[1].y+_8b>=0){var _8d=_80.map(function(c){return _89.getTilePoint(c);});var _8e=_81.map(function(c){return _89.getTilePoint(c);});_7d.push({tile:_88,tileID:_89,queryGeometry:_8d,cameraQueryGeometry:_8e,scale:_8a});}};for(var i=0;i<ids.length;i++){_87(i);}return _7d;};_18.prototype.getVisibleCoordinates=function getVisibleCoordinates(_8f,_90){var _91=this;var _92=this.getRenderableIds().map(function(id){return _91._tiles[id].tileID;});this.currentCoords=[];for(var i=0,_93=_92;i<_93.length;i+=1){var _94=_93[i];var _95=_94.toUnwrapped();if(!_94.geometry){_94.geometry=this.layer.tileInfo.getGeometry(_95,_90.level);}_94.posMatrix=_90.calculatePosMatrix(_95,_94.geometry,true);this.currentCoords.push(_94);}return _92;};_18.prototype.updateTileMatrix=function updateTileMatrix(_96,_97){var _98=this.currentCoords;for(var i=0,_99=_98;i<_99.length;i+=1){var _9a=_99[i];_9a.posMatrix=_97.updatePosMatrix(_9a.toUnwrapped(),_9a.geometry,true);}return _98;};_18.prototype.hasTransition=function hasTransition(){if(this._source.hasTransition()){return true;}for(var id in this._tiles){var _9b=this._tiles[id];if(_9b.fadeEndTime!==undefined&&_9b.fadeEndTime>=_8.now()){return true;}}return false;};_18.maxOverzooming=10;_18.maxUnderzooming=3;return _18;});