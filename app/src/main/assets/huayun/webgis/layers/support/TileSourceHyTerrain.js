//>>built
define("com/huayun/webgis/layers/support/TileSourceHyTerrain","exports dojo/request ../../request ../../utils/utils ../../gl/Texture ./terrainUtils ../../data/ArrayType ../../gl/SegmentVector".split(" "),function(l,q,n,k,p,r,t,u){function b(a,d,e,b,m){this.id=a;this.dispatcher=e;this.type="vector";this.minzoom=0;this.maxzoom=16;this.scheme="xyz";this.isTileClipped=this.reparseOverscaled=!0;k.extend(this,k.pick(d,["scheme","tileSize"]));this._options=k.extend({type:"vector"},d);this._collectResourceTiming=
d.collectResourceTiming;this.url=b;this.layer=m}function f(a,d,e,b){this.id=a;this.type="raster";this.minzoom=0;this.maxzoom=22;this.roundZoom=!0;this.scheme="xyz";this.tileSize=d.tileSize||256;this.url=e;this.view=b}function g(a,d,e,b,m,c){this.id=a;this.type="terrain";this.minzoom=0;this.maxzoom=22;this.roundZoom=!0;this.scheme="xyz";this.tileSize=d.tileSize||256;this.url=b;this.view=m;this.layer=c;this.dispatcher=e}b.prototype.constructor=b;b.prototype.load=function(){};b.prototype.hasTile=function(a){return!0};
b.prototype.onAdd=function(a){this.map=a;this.load()};b.prototype.setSize=function(a){this.tileSize=a};b.prototype.onRemove=function(){};b.prototype.serialize=function(){return k.extend({},this._options)};b.prototype.updateTileUrl=function(a){this.url=[a]};b.prototype.loadTile=function(a,d){function e(b,c){if(a.aborted)return d(null);if(b&&404!==b.status)return d(b);c&&a.setExpiryData(c);a.loadVectorData(c,this.layer);d(null);a.reloadCallback&&(this.loadTile(a,a.reloadCallback),a.reloadCallback=null)}
var b={request:{url:a.tileID.canonical.url(this.url,this.scheme)},uid:a.uid,tileID:a.tileID,zoom:a.tileID.overscaledZ,tileSize:this.tileSize,type:this.type,source:this.id,pixelRatio:1,showCollisionBoxes:!1};void 0===a.workerID||"expired"===a.state?a.workerID=this.dispatcher.send("loadTile",b,e.bind(this)):"loading"===a.state?a.reloadCallback=d:this.dispatcher.send("reloadTile",b,e.bind(this),a.workerID)};b.prototype.abortTile=function(a){this.dispatcher.send("abortTile",{uid:a.uid,type:this.type,
source:this.id},void 0,a.workerID)};b.prototype.unloadTile=function(a){a.unloadVectorData();this.dispatcher.send("removeTile",{uid:a.uid,type:this.type,source:this.id},void 0,a.workerID)};b.prototype.hasTransition=function(){return!1};l.VectorTileSource=b;f.prototype.constructor=f;f.prototype.load=function(){};f.prototype.hasTile=function(a){};f.prototype.updateTileUrl=function(a){this.url=a};f.prototype.loadTile=function(a,d){var b=this,f=a.tileID.canonical.url([this.url]);a.request=n(f,{responseType:"image"}).then(function(a){return a.data}).then(function(e){delete a.request;
if(a.aborted)a.state="unloaded",d(null);else if(e){var c=b.view.context,f=c.gl;a.texture=b.view.getTileTexture(e.width);a.texture?a.texture.update(e,{useMipmap:!0}):(a.texture=new p(c,e,f.RGBA,{useMipmap:!0}),a.texture.bind(f.LINEAR,f.CLAMP_TO_EDGE,f.LINEAR_MIPMAP_NEAREST),c.extTextureFilterAnisotropic&&f.texParameterf(f.TEXTURE_2D,c.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,c.extTextureFilterAnisotropicMax));a.state="loaded";d(null)}}).catch(function(b){a.state="errored";d(b)})};f.prototype.abortTile=
function(a,b){a.request&&(a.request.cancel(),delete a.request);b()};f.prototype.unloadTile=function(a,b){a.texture&&this.view.saveTileTexture(a.texture);b()};f.prototype.hasTransition=function(){return!1};l.RasterTileSource=f;g.prototype.constructor=g;g.prototype.load=function(){};g.prototype.hasTile=function(a){};g.prototype.updateTileUrl=function(a){this.url=a};g.prototype.loadTile=function(a,b){var e=this,d=this.layer.imageUrl,f=a.tileID.canonical.url([this.url],this.scheme),d=a.tileID.canonical.url([d]);
n(d,{responseType:"image"}).then(function(a){return a.data}).then(function(c){delete a.request;if(a.aborted)a.state="unloaded",b(null);else if(c){var d=function(a,d){a||b(null,d)};a.state="loaded";var g=e.view.context,h=g.gl;a.texture=e.view.getTileTexture(c.width);a.texture?a.texture.update(c,{useMipmap:!0}):(a.texture=new p(g,c,h.RGBA,{useMipmap:!0}),a.texture.bind(h.LINEAR,h.CLAMP_TO_EDGE,h.LINEAR_MIPMAP_NEAREST),g.extTextureFilterAnisotropic&&h.texParameterf(h.TEXTURE_2D,g.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,
g.extTextureFilterAnisotropicMax));c=a.tileID.canonical;c=e.view.viewpoint.tileInfo.tileXYToRectangle(c.x,c.y,c.z);a.rectangle=c;a.tileID.canonical.z<e.layer.changeLevel?b("\u6ca1\u6709\u5730\u5f62\u5207\u7247"):(g=e.view.viewpoint.tileInfo.getResolution(Math.min(e.view.viewpoint.targetZoom||e.view.viewpoint.level,e.layer.maxLevel)),c={rectangle:c,resolution:g,type:"terrain",uid:a.uid,url:f},void 0===a.workerID||"expired"===a.state?a.workerID=e.dispatcher.send("loadTerrain",c,d):"loading"===a.state?
a.reloadCallback=b:e.dispatcher.send("reloadTerrain",c,d,a.workerID))}})};g.prototype.abortTile=function(a,b){a.request&&(a.request.cancel(),delete a.request);b()};g.prototype.unloadTile=function(a,b){a.texture&&this.view.saveTileTexture(a.texture);b()};g.prototype.hasTransition=function(){return!1};l.TerrainSourceCache=g});