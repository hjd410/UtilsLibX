//>>built
define("com/huayun/webgis/layers/support/TileSourceTerrain","exports dojo/request ../../request ../../utils/utils ../../gl/Texture ./terrainUtils".split(" "),function(l,r,m,k,n,p){function b(a,d,b,c,q){this.id=a;this.dispatcher=b;this.type="vector";this.minzoom=0;this.maxzoom=16;this.scheme="xyz";this.isTileClipped=this.reparseOverscaled=!0;k.extend(this,k.pick(d,["scheme","tileSize"]));this._options=k.extend({type:"vector"},d);this._collectResourceTiming=d.collectResourceTiming;this.url=c;this.layer=
q}function f(a,d,b,c){this.id=a;this.type="raster";this.minzoom=0;this.maxzoom=22;this.roundZoom=!0;this.scheme="xyz";this.tileSize=d.tileSize||256;this.url=b;this.view=c}function e(a,d,b,c){this.id=a;this.type="terrain";this.minzoom=0;this.maxzoom=22;this.roundZoom=!0;this.scheme="tms";this.tileSize=d.tileSize||256;this.url=b;this.view=c}b.prototype.constructor=b;b.prototype.load=function(){};b.prototype.hasTile=function(a){return!0};b.prototype.onAdd=function(a){this.map=a;this.load()};b.prototype.setSize=
function(a){this.tileSize=a};b.prototype.onRemove=function(){};b.prototype.serialize=function(){return k.extend({},this._options)};b.prototype.updateTileUrl=function(a){this.url=[a]};b.prototype.loadTile=function(a,d){function b(b,g){if(a.aborted)return d(null);if(b&&404!==b.status)return d(b);g&&a.setExpiryData(g);a.loadVectorData(g,this.layer);d(null);a.reloadCallback&&(this.loadTile(a,a.reloadCallback),a.reloadCallback=null)}var c={request:{url:a.tileID.canonical.url(this.url,this.scheme)},uid:a.uid,
tileID:a.tileID,zoom:a.tileID.overscaledZ,tileSize:this.tileSize,type:this.type,source:this.id,pixelRatio:1,showCollisionBoxes:!1};void 0===a.workerID||"expired"===a.state?a.workerID=this.dispatcher.send("loadTile",c,b.bind(this)):"loading"===a.state?a.reloadCallback=d:this.dispatcher.send("reloadTile",c,b.bind(this),a.workerID)};b.prototype.abortTile=function(a){this.dispatcher.send("abortTile",{uid:a.uid,type:this.type,source:this.id},void 0,a.workerID)};b.prototype.unloadTile=function(a){a.unloadVectorData();
this.dispatcher.send("removeTile",{uid:a.uid,type:this.type,source:this.id},void 0,a.workerID)};b.prototype.hasTransition=function(){return!1};l.VectorTileSource=b;f.prototype.constructor=f;f.prototype.load=function(){};f.prototype.hasTile=function(a){};f.prototype.updateTileUrl=function(a){this.url=a};f.prototype.loadTile=function(a,b){var d=this,c=a.tileID.canonical.url([this.url]);a.request=m(c,{responseType:"image"}).then(function(a){return a.data}).then(function(c){delete a.request;if(a.aborted)a.state=
"unloaded",b(null);else if(c){var g=d.view.context,h=g.gl;a.texture=d.view.getTileTexture(c.width);a.texture?a.texture.update(c,{useMipmap:!0}):(a.texture=new n(g,c,h.RGBA,{useMipmap:!0}),a.texture.bind(h.LINEAR,h.CLAMP_TO_EDGE,h.LINEAR_MIPMAP_NEAREST),g.extTextureFilterAnisotropic&&h.texParameterf(h.TEXTURE_2D,g.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,g.extTextureFilterAnisotropicMax));a.state="loaded";b(null)}}).catch(function(d){a.state="errored";b(d)})};f.prototype.abortTile=function(a,
b){a.request&&(a.request.cancel(),delete a.request);b()};f.prototype.unloadTile=function(a,b){a.texture&&this.view.saveTileTexture(a.texture);b()};f.prototype.hasTransition=function(){return!1};l.RasterTileSource=f;e.prototype.constructor=e;e.prototype.load=function(){};e.prototype.hasTile=function(a){};e.prototype.updateTileUrl=function(a){this.url=a};e.prototype.loadTile=function(a,b){var d=this,c=a.tileID.canonical.url([this.url],this.scheme),f=a.tileID.canonical.url(["../images/{z}/{x}/{y}.jpg"]);
a.request=Promise.all([fetch(c).then(function(a){return a.arrayBuffer()}),m(f,{responseType:"image"}).then(function(a){return a.data})]).then(function(c){delete a.request;var f=c[0];c=c[1];if(a.aborted)a.state="unloaded",b(null);else if(c&&f){var e=a.tileID.canonical;a.state="loaded";var f=p.createQuantizedMeshTerrainData(f,e.z,e.x,e.y),e=d.view.context,g=e.gl;a.texture=d.view.getTileTexture(c.width);a.texture?a.texture.update(c,{useMipmap:!0}):(a.texture=new n(e,c,g.RGBA,{useMipmap:!0}),a.texture.bind(g.LINEAR,
g.CLAMP_TO_EDGE,g.LINEAR_MIPMAP_NEAREST),e.extTextureFilterAnisotropic&&g.texParameterf(g.TEXTURE_2D,e.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,e.extTextureFilterAnisotropicMax));b(null,f)}})};e.prototype.abortTile=function(a,b){a.request&&(a.request.cancel(),delete a.request);b()};e.prototype.unloadTile=function(a,b){a.texture&&this.view.saveTileTexture(a.texture);b()};e.prototype.hasTransition=function(){return!1};l.TerrainSourceCache=e});