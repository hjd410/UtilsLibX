//>>built
define("com/huayun/webgis/layers/support/TerrainSourceCacheTerrain",["./TileSource","./funcUtils","./TileCache","./Tile","./SourceFeatureState","com/huayun/webgis/layers/support/tileCover","com/huayun/webgis/geometry/Point2D","../../utils/utils","../../work/createVerticesFromQuantizedTerrainMesh","../../data/IndexDatatype","../../gl/SegmentVector","./TerrainMesh"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c){function _d(_e,_f,_10){var _11=_f.vertices;var _12=_e.createVertexBuffer({length:_11.length/7,bytesPerElement:28,arrayBuffer:_11},[{name:"position3DAndHeight",type:"Float32",components:4,offset:0},{name:"textureCoordAndEncodedNormals",type:"Float32",components:3,offset:16}]);var _13=_f.indices;var _14=_e.createIndexBuffer({arrayBuffer:_13});var _15=_b.simpleSegment(0,0,_10,_13.length/3);return {vertexBuffer:_12,indexBuffer:_14,segments:_15};};function _16(id,_17,_18,_19,url,_1a,_1b){this.id=id;this._source=new _1.TerrainSourceCache(id,_17,url,_1b);this._tiles={};this._cache=new _3(0,this._unloadTile.bind(this));this._timers={};this._cacheTimers={};this._maxTileCacheSize=null;this._coveredTiles={};this.updateCacheSize(_18,_19);this.layer=_1a;this.view=_1b;};_16.prototype.constructor=_16;_16.prototype.updateTileSize=function(_1c){this._source.setSize(_1c);};_16.prototype.onRemove=function onRemove(map){if(this._source&&this._source.onRemove){this._source.onRemove(map);}};_16.prototype.loaded=function loaded(){if(this._sourceErrored){return true;}if(!this._sourceLoaded){return false;}for(var t in this._tiles){var _1d=this._tiles[t];if(_1d.state!=="loaded"&&_1d.state!=="errored"){return false;}}return true;};_16.prototype.getSource=function getSource(){return this._source;};_16.prototype.pause=function pause(){this._paused=true;};_16.prototype.resume=function resume(){if(!this._paused){return;}var _1e=this._shouldReloadOnResume;this._paused=false;this._shouldReloadOnResume=false;if(_1e){this.reload();}if(this.transform){this.update(this.transform);}};_16.prototype._loadTile=function _loadTile(_1f,_20){return this._source.loadTile(_1f,_20);};_16.prototype._unloadTile=function _unloadTile(_21){if(this._source.unloadTile){return this._source.unloadTile(_21,function(){});}};_16.prototype._abortTile=function _abortTile(_22){if(this._source.abortTile){return this._source.abortTile(_22,function(){});}};_16.prototype.serialize=function serialize(){return this._source.serialize();};_16.prototype.getIds=function getIds(){var _23=[];for(var key in this._tiles){_23.push(this._tiles[key].tileID);}return _23;};_16.prototype.getRenderableIds=function getRenderableIds(){var ids=[];for(var id in this._tiles){if(this._isIdRenderable(id)){ids.push(id);}}return ids.sort(_8.compareKeyZoom);};_16.prototype.hasRenderableParent=function hasRenderableParent(_24){var _25=this.findLoadedParent(_24,0);if(_25){return this._isIdRenderable(_25.tileID.key);}return false;};_16.prototype._isIdRenderable=function _isIdRenderable(id){return this._tiles[id]&&this._tiles[id].hasData()&&!this._coveredTiles[id]&&(!this._tiles[id].holdingForFade());};_16.prototype.reload=function reload(){if(this._paused){this._shouldReloadOnResume=true;return;}this._cache.reset();for(var i in this._tiles){if(this._tiles[i].state!=="errored"){this._reloadTile(i,"reloading");}}};_16.prototype._reloadTile=function _reloadTile(id,_26){var _27=this._tiles[id];if(!_27){return;}if(_27.state!=="loading"){_27.state=_26;}this._loadTile(_27,this._tileLoaded.bind(this,_27,id,_26));};_16.prototype.updateTileUrl=function(url){this._source.updateTileUrl(url);};_16.prototype._tileLoaded=function _tileLoaded(_28,id,_29,err,_2a){if(err){_28.state="errored";if(err.status===404){this.update(this.transform);}return;}var _2b=_28.tileID.canonical;var _2c=this.layer.tileInfo.tileXYToRectangle(_2b.x,_2b.y,_2b.z);_28.rectangle=_2c;var _2d=_9({minimumHeight:_2a._minimumHeight,maximumHeight:_2a._maximumHeight,quantizedVertices:_2a._quantizedVertices,octEncodedNormals:_2a._encodedNormals,includeWebMercatorT:true,indices:_2a._indices,westIndices:_2a._westIndices,southIndices:_2a._southIndices,eastIndices:_2a._eastIndices,northIndices:_2a._northIndices,westSkirtHeight:_2a._westSkirtHeight,southSkirtHeight:_2a._southSkirtHeight,eastSkirtHeight:_2a._eastSkirtHeight,northSkirtHeight:_2a._northSkirtHeight,rectangle:_2c,relativeToCenter:_2a._boundingSphere.center,ellipsoid:null,exaggeration:1});var _2e=_2a._quantizedVertices.length/3;var _2f=_2e+_2a._westIndices.length+_2a._southIndices.length+_2a._eastIndices.length+_2a._northIndices.length;var _30=_a.createTypedArray(_2f,_2d.indices);var _31=new Float32Array(_2d.vertices);var rtc=_2d.center;var _32=_2d.minimumHeight;var _33=_2d.maximumHeight;var _34=_2a._boundingSphere;var obb=_2a._orientedBoundingBox;var _35=_2a._horizonOcclusionPoint;var _36=_2d.vertexStride;var _37=new _c(rtc,_31,_30,_2d.indexCountWithoutSkirts,_2e,_32,_33,_34,_35,_36,obb,undefined,1,_2d.westIndicesSouthToNorth,_2d.southIndicesEastToWest,_2d.eastIndicesNorthToSouth,_2d.northIndicesWestToEast);_28.minimumHeight=_37.minimumHeight;_28.maximumHeight=_37.maximumHeight;_28.bucket=_d(this.view.context,_37,_2f);this.layer.layerView.drawHeightMap(this.layer.layerView,_28);this.layer.layerView._sourcesDirty=true;this.view.threeRender();};_16.prototype.getTile=function getTile(_38){return this.getTileByID(_38.key);};_16.prototype.getTileByID=function getTileByID(id){return this._tiles[id];};_16.prototype.getZoom=function getZoom(_39){return _39.level+_39.scaleZoom(_39.tileSize/this._source.tileSize);};_16.prototype._retainLoadedChildren=function _retainLoadedChildren(_3a,_3b,_3c,_3d){for(var id in this._tiles){var _3e=this._tiles[id];if(_3d[id]||!_3e.hasData()||_3e.tileID.overscaledZ<=_3b||_3e.tileID.overscaledZ>_3c){continue;}var _3f=_3e.tileID;while(_3e&&_3e.tileID.overscaledZ>_3b+1){var _40=_3e.tileID.scaledTo(_3e.tileID.overscaledZ-1);_3e=this._tiles[_40.key];if(_3e&&_3e.hasData()){_3f=_40;}}var _41=_3f;while(_41.overscaledZ>_3b){_41=_41.scaledTo(_41.overscaledZ-1);if(_3a[_41.key]){_3d[_3f.key]=_3f;break;}}}};_16.prototype.findLoadedParent=function findLoadedParent(_42,_43){for(var z=_42.overscaledZ-1;z>=_43;z--){var _44=_42.scaledTo(z);if(!_44){return;}var id=String(_44.key);var _45=this._tiles[id];if(_45&&_45.hasData()){return _45;}if(this._cache.has(_44)){return this._cache.get(_44);}}};_16.prototype.updateCacheSize=function updateCacheSize(_46,_47){var _48=Math.ceil(_46/this._source.tileSize)+1;var _49=Math.ceil(_47/this._source.tileSize)+1;var _4a=_48*_49;var _4b=3;var _4c=Math.floor(_4a*_4b);var _4d=typeof this._maxTileCacheSize==="number"?Math.min(this._maxTileCacheSize,_4c):_4c;this._cache.setMaxSize(_4d);};_16.prototype.update=function update(_4e,_4f,_50,cx,cy){this._coveredTiles={};var _51=_6.tileCover(_4e,_4f,_50);_51=_51.sort(function(a,b){a=a.canonical;b=b.canonical;return Math.sqrt((cx-a.x)*(cx-a.x)+(cy-a.y)*(cy-a.y))-Math.sqrt((cx-b.x)*(cx-b.x)+(cy-b.y)*(cy-b.y));});var _52=this._updateRetainedTiles(_51,_4e);for(var _53 in _52){this._tiles[_53].clearFadeHold();}var _54=_8.keysDifference(this._tiles,_52);for(var i$1=0,_55=_54;i$1<_55.length;i$1+=1){var _56=_55[i$1];this._removeTile(_56);}};_16.prototype.updateTile=function updateTile(_57,_58,_59,cx,cy){this._coveredTiles={};var _5a=_6.tileCover(_57,_58,_59,"tms");_5a=_5a.sort(function(a,b){a=a.canonical;b=b.canonical;return Math.sqrt((cx-a.x)*(cx-a.x)+(cy-a.y)*(cy-a.y))-Math.sqrt((cx-b.x)*(cx-b.x)+(cy-b.y)*(cy-b.y));});this._updateRetainedTiles(_5a,_57);return _5a;};_16.prototype.releaseSymbolFadeTiles=function releaseSymbolFadeTiles(){for(var id in this._tiles){if(this._tiles[id].holdingForFade()){this._removeTile(id);}}};_16.prototype._updateRetainedTiles=function _updateRetainedTiles(_5b,_5c){var _5d={};var _5e={};var _5f=Math.max(_5c-_16.maxOverzooming,this._source.minzoom);var _60=Math.max(_5c+_16.maxUnderzooming,this._source.minzoom);var _61={};for(var i=0,_62=_5b;i<_62.length;i+=1){var _63=_62[i];var _64=this._addTile(_63);_5d[_63.key]=_63;if(_64.hasData()){continue;}if(_5c<this._source.maxzoom){_61[_63.key]=_63;}}this._retainLoadedChildren(_61,_5c,_60,_5d);for(var i$1=0,_65=_5b;i$1<_65.length;i$1+=1){var _66=_65[i$1];var _67=this._tiles[_66.key];if(_67.hasData()){continue;}if(_5c+1>this._source.maxzoom){var _68=_66.children(this._source.maxzoom)[0];var _69=this.getTile(_68);if(!!_69&&_69.hasData()){_5d[_68.key]=_68;continue;}}else{var _6a=_66.children(this._source.maxzoom);if(_5d[_6a[0].key]&&_5d[_6a[1].key]&&_5d[_6a[2].key]&&_5d[_6a[3].key]){continue;}}var _6b=_67.wasRequested();for(var _6c=_66.overscaledZ-1;_6c>=_5f;--_6c){var _6d=_66.scaledTo(_6c);if(_5e[_6d.key]){break;}_5e[_6d.key]=true;_67=this.getTile(_6d);if(!_67&&_6b){_67=this._addTile(_6d);}if(_67){_5d[_6d.key]=_6d;_6b=_67.wasRequested();if(_67.hasData()){break;}}}}return _5d;};_16.prototype._reAddTile=function _reAddTile(_6e){var _6f=new _4(_6e,this._source.tileSize*_6e.overscaleFactor());this._loadTile(_6f,this._tileReAddLoaded.bind(this,_6f,_6e.key,_6f.state));};_16.prototype._tileReAddLoaded=function _tileLoaded(_70,id,_71,err){this._removeTile(id);this._tiles[_70.tileID.key]=_70;if(err){_70.state="errored";if(err.status===404){this.update(this.transform);}return;}_70.timeAdded=_8.now();this._setTileReloadTimer(id,_70);this.layer.layerViews[0]._sourcesDirty=true;this.view.threeRender();};_16.prototype._addTile=function _addTile(_72){var _73=this._tiles[_72.key];if(_73){return _73;}_73=this._cache.getAndRemove(_72);if(_73){this._setTileReloadTimer(_72.key,_73);_73.tileID=_72;if(this._cacheTimers[_72.key]){clearTimeout(this._cacheTimers[_72.key]);delete this._cacheTimers[_72.key];this._setTileReloadTimer(_72.key,_73);}}var _74=Boolean(_73);if(!_74){_73=new _4(_72,this._source.tileSize*_72.overscaleFactor());this._loadTile(_73,this._tileLoaded.bind(this,_73,_72.key,_73.state));}if(!_73){return (null);}_73.uses++;this._tiles[_72.key]=_73;return _73;};_16.prototype._setTileReloadTimer=function _setTileReloadTimer(id,_75){var _76=this;if(id in this._timers){clearTimeout(this._timers[id]);delete this._timers[id];}var _77=_75.getExpiryTimeout();if(_77){this._timers[id]=setTimeout(function(){_76._reloadTile(id,"expired");delete _76._timers[id];},_77);}};_16.prototype._removeTile=function _removeTile(id){var _78=this._tiles[id];if(!_78){return;}_78.uses--;delete this._tiles[id];if(this._timers[id]){clearTimeout(this._timers[id]);delete this._timers[id];}if(_78.uses>0){return;}if(_78.hasData()){}else{_78.aborted=true;this._abortTile(_78);this._unloadTile(_78);}};_16.prototype.clearTiles=function clearTiles(){this._shouldReloadOnResume=false;this._paused=false;for(var id in this._tiles){this._removeTile(id);}this._cache.reset();};_16.prototype.clearOtherLevel=function clearOtherLevel(_79){this._shouldReloadOnResume=false;this._paused=false;for(var id in this._tiles){var _7a=this._tiles[id];if(_7a.tileID.canonical.z!==_79){this._removeTile(id);}}};_16.prototype.tilesIn=function tilesIn(_7b,_7c,_7d){var _7e=this;var _7f=[];var _80=this.transform;if(!_80){return _7f;}var _81=_7d?_80.getCameraQueryGeometry(_7b):_7b;var _82=_7b.map(function(p){return _80.pointCoordinate(p);});var _83=_81.map(function(p){return _80.pointCoordinate(p);});var ids=this.getIds();var _84=Infinity;var _85=Infinity;var _86=-Infinity;var _87=-Infinity;for(var i$1=0,_88=_83;i$1<_88.length;i$1+=1){var p=_88[i$1];_84=Math.min(_84,p.x);_85=Math.min(_85,p.y);_86=Math.max(_86,p.x);_87=Math.max(_87,p.y);}var _89=function(i){var _8a=_7e._tiles[ids[i]];if(_8a.holdingForFade()){return;}var _8b=_8a.tileID;var _8c=Math.pow(2,_80.level-_8a.tileID.overscaledZ);var _8d=_7c*_8a.queryPadding*__chunk_1.EXTENT/_8a.tileSize/_8c;var _8e=[_8b.getTilePoint(new __chunk_1.MercatorCoordinate(_84,_85)),_8b.getTilePoint(new __chunk_1.MercatorCoordinate(_86,_87))];if(_8e[0].x-_8d<__chunk_1.EXTENT&&_8e[0].y-_8d<__chunk_1.EXTENT&&_8e[1].x+_8d>=0&&_8e[1].y+_8d>=0){var _8f=_82.map(function(c){return _8b.getTilePoint(c);});var _90=_83.map(function(c){return _8b.getTilePoint(c);});_7f.push({tile:_8a,tileID:_8b,queryGeometry:_8f,cameraQueryGeometry:_90,scale:_8c});}};for(var i=0;i<ids.length;i++){_89(i);}return _7f;};_16.prototype.getVisibleCoordinates=function getVisibleCoordinates(_91,_92){var _93=this;var _94=this.getRenderableIds().map(function(id){return _93._tiles[id].tileID;});this.currentCoords=[];for(var i=0,_95=_94;i<_95.length;i+=1){var _96=_95[i];var _97=_96.toUnwrapped();if(!_96.geometry){_96.geometry=this.layer.tileInfo.getGeometry(_97,_92.level);}_96.posMatrix=_92.calculatePosMatrix(_97,_96.geometry,true);this.currentCoords.push(_96);}return _94;};_16.prototype.updateTileMatrix=function updateTileMatrix(_98,_99){var _9a=this.currentCoords;for(var i=0,_9b=_9a;i<_9b.length;i+=1){var _9c=_9b[i];_9c.posMatrix=_99.updatePosMatrix(_9c.toUnwrapped(),_9c.geometry,true);}return _9a;};_16.prototype.hasTransition=function hasTransition(){if(this._source.hasTransition()){return true;}for(var id in this._tiles){var _9d=this._tiles[id];if(_9d.fadeEndTime!==undefined&&_9d.fadeEndTime>=_8.now()){return true;}}return false;};_16.maxOverzooming=10;_16.maxUnderzooming=3;return _16;});