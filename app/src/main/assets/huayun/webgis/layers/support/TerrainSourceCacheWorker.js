//>>built
define("com/huayun/webgis/layers/support/TerrainSourceCacheWorker",["./TileSource","./funcUtils","./TileCache","./Tile","./SourceFeatureState","com/huayun/webgis/layers/support/tileCover","com/huayun/webgis/geometry/Point2D","../../utils/utils","../../work/createVerticesFromQuantizedTerrainMesh","../../data/IndexDatatype","../../gl/SegmentVector","./TerrainMesh","../../data/ArrayType"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d){var _e=10;function _f(_10,_11,_12){var _13=_11.vertices;var _14=_10.createVertexBuffer({length:_13.length/7,bytesPerElement:28,arrayBuffer:_13},[{name:"position3DAndHeight",type:"Float32",components:4,offset:0},{name:"textureCoordAndEncodedNormals",type:"Float32",components:3,offset:16}]);var _15=_11.indices;var _16=_10.createIndexBuffer({arrayBuffer:_15});var _17=_b.simpleSegment(0,0,_12,_15.length/3);return {vertexBuffer:_14,indexBuffer:_16,segments:_17};};function _18(id,_19,_1a,_1b,_1c,url,_1d,_1e){this.id=id;this.dispatcher=_1a;this._source=new _1.TerrainSourceCache(id,_19,url,_1e);this._tiles={};this._cache=new _3(0,this._unloadTile.bind(this));this._timers={};this._cacheTimers={};this._maxTileCacheSize=null;this._coveredTiles={};this.updateCacheSize(_1b,_1c);this.layer=_1d;this.view=_1e;};_18.prototype.constructor=_18;_18.prototype.updateTileSize=function(_1f){this._source.setSize(_1f);};_18.prototype.onRemove=function onRemove(map){if(this._source&&this._source.onRemove){this._source.onRemove(map);}};_18.prototype.loaded=function loaded(){if(this._sourceErrored){return true;}if(!this._sourceLoaded){return false;}for(var t in this._tiles){var _20=this._tiles[t];if(_20.state!=="loaded"&&_20.state!=="errored"){return false;}}return true;};_18.prototype.getSource=function getSource(){return this._source;};_18.prototype.pause=function pause(){this._paused=true;};_18.prototype.resume=function resume(){if(!this._paused){return;}var _21=this._shouldReloadOnResume;this._paused=false;this._shouldReloadOnResume=false;if(_21){this.reload();}if(this.transform){this.update(this.transform);}};_18.prototype._loadTile=function _loadTile(_22,_23){return this._source.loadTile(_22,_23);};_18.prototype._unloadTile=function _unloadTile(_24){if(this._source.unloadTile){return this._source.unloadTile(_24,function(){});}};_18.prototype._abortTile=function _abortTile(_25){if(this._source.abortTile){return this._source.abortTile(_25,function(){});}};_18.prototype.serialize=function serialize(){return this._source.serialize();};_18.prototype.getIds=function getIds(){var _26=[];for(var key in this._tiles){_26.push(this._tiles[key].tileID);}return _26;};_18.prototype.getRenderableIds=function getRenderableIds(){var ids=[];for(var id in this._tiles){if(this._isIdRenderable(id)){ids.push(id);}}return ids.sort(_8.compareKeyZoom);};_18.prototype.hasRenderableParent=function hasRenderableParent(_27){var _28=this.findLoadedParent(_27,0);if(_28){return this._isIdRenderable(_28.tileID.key);}return false;};_18.prototype._isIdRenderable=function _isIdRenderable(id){return this._tiles[id]&&this._tiles[id].hasData()&&!this._coveredTiles[id]&&(!this._tiles[id].holdingForFade());};_18.prototype.reload=function reload(){if(this._paused){this._shouldReloadOnResume=true;return;}this._cache.reset();for(var i in this._tiles){if(this._tiles[i].state!=="errored"){this._reloadTile(i,"reloading");}}};_18.prototype._reloadTile=function _reloadTile(id,_29){var _2a=this._tiles[id];if(!_2a){return;}if(_2a.state!=="loading"){_2a.state=_29;}this._loadTile(_2a,this._tileLoaded.bind(this,_2a,id,_29));};_18.prototype.updateTileUrl=function(url){this._source.updateTileUrl(url);};_18.prototype._tileLoaded=function _tileLoaded(_2b,id,_2c,err,_2d){if(err){_2b.state="errored";if(err.status===404){this.update(this.transform);}return;}var _2e=_2b.tileID.canonical;var _2f=this.layer.tileInfo.tileXYToRectangle(_2e.x,_2e.y,_2e.z);var _30=this.view.viewpoint.targetZoom||this.view.viewpoint.level;var _31=this.view.viewpoint.tileInfo.getResolution(_30);var _32={rectangle:_2f,resolution:_31,type:"terrain"};if(_2b.workerID===undefined||_2b.state==="expired"){_2b.workerID=this.dispatcher.send("loadTerrain",_32,_33.bind(this));}else{if(_2b.state==="loading"){_2b.reloadCallback=callback;}else{this.dispatcher.send("reloadTerrain",_32,_33.bind(this),_2b.workerID);}}var obj=this;function _33(err,_34){if(err){return;}var _35=obj.view.context;var _36=_34.bucket;_2b.bucket={layoutVertexBuffer:_35.createVertexBuffer(_36.layoutVertexArray,[{name:"a_pos",type:"Float32",components:3,offset:0}]),indexBuffer:_35.createIndexBuffer(_36.indexArray),segments:_36.segments};_2b.minimumHeight=_34.minimumHeight;_2b.maximumHeight=_34.maximumHeight;var _37=new _d.StructArrayLayout3ui6();_37.emplaceBack(0,2,1);_37.emplaceBack(2,3,1);_37.emplaceBack(2,4,3);_37.emplaceBack(4,5,3);_37.emplaceBack(4,6,5);_37.emplaceBack(6,7,5);_37.emplaceBack(6,0,7);_37.emplaceBack(0,1,7);_37.emplaceBack(1,3,7);_37.emplaceBack(5,7,3);var _38=new _d.StructArrayLayout3i6();var _39=8192;_38.emplaceBack(0,0,0);_38.emplaceBack(0,0,1);_38.emplaceBack(_39,0,0);_38.emplaceBack(_39,0,1);_38.emplaceBack(_39,_39,0);_38.emplaceBack(_39,_39,1);_38.emplaceBack(0,_39,0);_38.emplaceBack(0,_39,1);var _3a=_b.simpleSegment(0,0,8,10);_2b.waterBucket={layoutVertexBuffer:_35.createVertexBuffer(_38,[{name:"a_pos",type:"Int16",components:3,offset:0}]),indexBuffer:_35.createIndexBuffer(_37),segments:_3a};_2b.timeAdded=_8.now();obj.layer.layerView.drawHeightMap(obj.layer.layerView,_2b);obj.layer.layerView._sourcesDirty=true;obj.view.threeRender();};};_18.prototype.getTile=function getTile(_3b){return this.getTileByID(_3b.key);};_18.prototype.getTileByID=function getTileByID(id){return this._tiles[id];};_18.prototype.getZoom=function getZoom(_3c){return _3c.level+_3c.scaleZoom(_3c.tileSize/this._source.tileSize);};_18.prototype._retainLoadedChildren=function _retainLoadedChildren(_3d,_3e,_3f,_40){for(var id in this._tiles){var _41=this._tiles[id];if(_40[id]||!_41.hasData()||_41.tileID.overscaledZ<=_3e||_41.tileID.overscaledZ>_3f){continue;}var _42=_41.tileID;while(_41&&_41.tileID.overscaledZ>_3e+1){var _43=_41.tileID.scaledTo(_41.tileID.overscaledZ-1);_41=this._tiles[_43.key];if(_41&&_41.hasData()){_42=_43;}}var _44=_42;while(_44.overscaledZ>_3e){_44=_44.scaledTo(_44.overscaledZ-1);if(_3d[_44.key]){_40[_42.key]=_42;break;}}}};_18.prototype.findLoadedParent=function findLoadedParent(_45,_46){for(var z=_45.overscaledZ-1;z>=_46;z--){var _47=_45.scaledTo(z);if(!_47){return;}var id=String(_47.key);var _48=this._tiles[id];if(_48&&_48.hasData()){return _48;}if(this._cache.has(_47)){return this._cache.get(_47);}}};_18.prototype.updateCacheSize=function updateCacheSize(_49,_4a){var _4b=Math.ceil(_49/this._source.tileSize)+1;var _4c=Math.ceil(_4a/this._source.tileSize)+1;var _4d=_4b*_4c;var _4e=3;var _4f=Math.floor(_4d*_4e);var _50=typeof this._maxTileCacheSize==="number"?Math.min(this._maxTileCacheSize,_4f):_4f;this._cache.setMaxSize(_50);};_18.prototype.update=function update(_51,_52,_53,cx,cy){this._coveredTiles={};var _54=_6.tileCover(_51,_52,_53);_54=_54.sort(function(a,b){a=a.canonical;b=b.canonical;return Math.sqrt((cx-a.x)*(cx-a.x)+(cy-a.y)*(cy-a.y))-Math.sqrt((cx-b.x)*(cx-b.x)+(cy-b.y)*(cy-b.y));});var _55=this._updateRetainedTiles(_54,_51);for(var _56 in _55){this._tiles[_56].clearFadeHold();}var _57=_8.keysDifference(this._tiles,_55);for(var i$1=0,_58=_57;i$1<_58.length;i$1+=1){var _59=_58[i$1];this._removeTile(_59);}};_18.prototype.updateTile=function updateTile(_5a,_5b,_5c,cx,cy){this._coveredTiles={};var _5d=_6.tileCover(_5a,_5b,_5c,"tms");_5d=_5d.sort(function(a,b){a=a.canonical;b=b.canonical;return Math.sqrt((cx-a.x)*(cx-a.x)+(cy-a.y)*(cy-a.y))-Math.sqrt((cx-b.x)*(cx-b.x)+(cy-b.y)*(cy-b.y));});this._updateRetainedTiles(_5d,_5a);return _5d;};_18.prototype.releaseSymbolFadeTiles=function releaseSymbolFadeTiles(){for(var id in this._tiles){if(this._tiles[id].holdingForFade()){this._removeTile(id);}}};_18.prototype._updateRetainedTiles=function _updateRetainedTiles(_5e,_5f){var _60={};var _61={};var _62=Math.max(_5f-_18.maxOverzooming,this._source.minzoom);var _63=Math.max(_5f+_18.maxUnderzooming,this._source.minzoom);var _64={};for(var i=0,_65=_5e;i<_65.length;i+=1){var _66=_65[i];var _67=this._addTile(_66);_60[_66.key]=_66;if(_67.hasData()){continue;}if(_5f<this._source.maxzoom){_64[_66.key]=_66;}}this._retainLoadedChildren(_64,_5f,_63,_60);for(var i$1=0,_68=_5e;i$1<_68.length;i$1+=1){var _69=_68[i$1];var _6a=this._tiles[_69.key];if(_6a.hasData()){continue;}if(_5f+1>this._source.maxzoom){var _6b=_69.children(this._source.maxzoom)[0];var _6c=this.getTile(_6b);if(!!_6c&&_6c.hasData()){_60[_6b.key]=_6b;continue;}}else{var _6d=_69.children(this._source.maxzoom);if(_60[_6d[0].key]&&_60[_6d[1].key]&&_60[_6d[2].key]&&_60[_6d[3].key]){continue;}}var _6e=_6a.wasRequested();for(var _6f=_69.overscaledZ-1;_6f>=_62;--_6f){var _70=_69.scaledTo(_6f);if(_61[_70.key]){break;}_61[_70.key]=true;_6a=this.getTile(_70);if(!_6a&&_6e){_6a=this._addTile(_70);}if(_6a){_60[_70.key]=_70;_6e=_6a.wasRequested();if(_6a.hasData()){break;}}}}return _60;};_18.prototype._reAddTile=function _reAddTile(_71){var _72=new _4(_71,this._source.tileSize*_71.overscaleFactor());this._loadTile(_72,this._tileReAddLoaded.bind(this,_72,_71.key,_72.state));};_18.prototype._tileReAddLoaded=function _tileLoaded(_73,id,_74,err){this._removeTile(id);this._tiles[_73.tileID.key]=_73;if(err){_73.state="errored";if(err.status===404){this.update(this.transform);}return;}_73.timeAdded=_8.now();this._setTileReloadTimer(id,_73);this.layer.layerViews[0]._sourcesDirty=true;this.view.threeRender();};_18.prototype._addTile=function _addTile(_75){var _76=this._tiles[_75.key];if(_76){return _76;}_76=this._cache.getAndRemove(_75);if(_76){this._setTileReloadTimer(_75.key,_76);_76.tileID=_75;if(this._cacheTimers[_75.key]){clearTimeout(this._cacheTimers[_75.key]);delete this._cacheTimers[_75.key];this._setTileReloadTimer(_75.key,_76);}}var _77=Boolean(_76);if(!_77){_76=new _4(_75,this._source.tileSize*_75.overscaleFactor());this._loadTile(_76,this._tileLoaded.bind(this,_76,_75.key,_76.state));}if(!_76){return (null);}_76.uses++;this._tiles[_75.key]=_76;return _76;};_18.prototype._setTileReloadTimer=function _setTileReloadTimer(id,_78){var _79=this;if(id in this._timers){clearTimeout(this._timers[id]);delete this._timers[id];}var _7a=_78.getExpiryTimeout();if(_7a){this._timers[id]=setTimeout(function(){_79._reloadTile(id,"expired");delete _79._timers[id];},_7a);}};_18.prototype._removeTile=function _removeTile(id){var _7b=this._tiles[id];if(!_7b){return;}_7b.uses--;delete this._tiles[id];if(this._timers[id]){clearTimeout(this._timers[id]);delete this._timers[id];}if(_7b.uses>0){return;}if(_7b.hasData()){}else{_7b.aborted=true;this._abortTile(_7b);this._unloadTile(_7b);}};_18.prototype.clearTiles=function clearTiles(){this._shouldReloadOnResume=false;this._paused=false;for(var id in this._tiles){this._removeTile(id);}this._cache.reset();};_18.prototype.clearOtherLevel=function clearOtherLevel(_7c){this._shouldReloadOnResume=false;this._paused=false;for(var id in this._tiles){var _7d=this._tiles[id];if(_7d.tileID.canonical.z!==_7c){this._removeTile(id);}}};_18.prototype.tilesIn=function tilesIn(_7e,_7f,_80){var _81=this;var _82=[];var _83=this.transform;if(!_83){return _82;}var _84=_80?_83.getCameraQueryGeometry(_7e):_7e;var _85=_7e.map(function(p){return _83.pointCoordinate(p);});var _86=_84.map(function(p){return _83.pointCoordinate(p);});var ids=this.getIds();var _87=Infinity;var _88=Infinity;var _89=-Infinity;var _8a=-Infinity;for(var i$1=0,_8b=_86;i$1<_8b.length;i$1+=1){var p=_8b[i$1];_87=Math.min(_87,p.x);_88=Math.min(_88,p.y);_89=Math.max(_89,p.x);_8a=Math.max(_8a,p.y);}var _8c=function(i){var _8d=_81._tiles[ids[i]];if(_8d.holdingForFade()){return;}var _8e=_8d.tileID;var _8f=Math.pow(2,_83.level-_8d.tileID.overscaledZ);var _90=_7f*_8d.queryPadding*__chunk_1.EXTENT/_8d.tileSize/_8f;var _91=[_8e.getTilePoint(new __chunk_1.MercatorCoordinate(_87,_88)),_8e.getTilePoint(new __chunk_1.MercatorCoordinate(_89,_8a))];if(_91[0].x-_90<__chunk_1.EXTENT&&_91[0].y-_90<__chunk_1.EXTENT&&_91[1].x+_90>=0&&_91[1].y+_90>=0){var _92=_85.map(function(c){return _8e.getTilePoint(c);});var _93=_86.map(function(c){return _8e.getTilePoint(c);});_82.push({tile:_8d,tileID:_8e,queryGeometry:_92,cameraQueryGeometry:_93,scale:_8f});}};for(var i=0;i<ids.length;i++){_8c(i);}return _82;};_18.prototype.getVisibleCoordinates=function getVisibleCoordinates(_94,_95){var _96=this;var _97=this.getRenderableIds().map(function(id){return _96._tiles[id].tileID;});this.currentCoords=[];for(var i=0,_98=_97;i<_98.length;i+=1){var _99=_98[i];var _9a=_99.toUnwrapped();if(!_99.geometry){_99.geometry=this.layer.tileInfo.getGeometry(_9a,_95.level);}_99.posMatrix=_95.calculatePosMatrix(_9a,_99.geometry,true);this.currentCoords.push(_99);}return _97;};_18.prototype.updateTileMatrix=function updateTileMatrix(_9b,_9c){var _9d=this.currentCoords;for(var i=0,_9e=_9d;i<_9e.length;i+=1){var _9f=_9e[i];_9f.posMatrix=_9c.updatePosMatrix(_9f.toUnwrapped(),_9f.geometry,true);}return _9d;};_18.prototype.hasTransition=function hasTransition(){if(this._source.hasTransition()){return true;}for(var id in this._tiles){var _a0=this._tiles[id];if(_a0.fadeEndTime!==undefined&&_a0.fadeEndTime>=_8.now()){return true;}}return false;};_18.maxOverzooming=10;_18.maxUnderzooming=3;return _18;});