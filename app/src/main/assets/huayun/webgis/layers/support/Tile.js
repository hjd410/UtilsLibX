//>>built
define("com/huayun/webgis/layers/support/Tile",["com/huayun/webgis/data/bucket/SymbolBucket","com/huayun/webgis/gl/Texture","../../utils/utils","./EvaluationParameters","com/huayun/webgis/data/GeoJSONFeature"],function(_1,_2,_3,_4,_5){function _6(_7){var re=/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g;var _8={};_7.replace(re,function($0,$1,$2,$3){var _9=$2||$3;_8[$1]=_9?_9.toLowerCase():true;return "";});if(_8["max-age"]){var _a=parseInt(_8["max-age"],10);if(isNaN(_a)){delete _8["max-age"];}else{_8["max-age"]=_a;}}return _8;};function _b(_c,_d){var _e={};for(var _f=0,_10=_c;_f<_10.length;_f+=1){var _11=_10[_f];var _12=_11.layerIds.map(function(id){return _d[id];}).filter(Boolean);if(_12.length===0){return;}(_11).layers=_12;if((_11).stateDependentLayerIds){(_11).stateDependentLayers=(_11).stateDependentLayerIds.map(function(lId){return _12.filter(function(l){return l.id===lId;})[0];});}for(var i=0,_13=_12;i<_13.length;i+=1){var _14=_13[i];_e[_14.id]=_11;}}return _e;};var id=1;var _15=30000;var _16=function _16(_17,_18){this.tileID=_17;this.uid=id++;this.uses=0;this.tileSize=256;this.buckets={};this.expirationTime=null;this.queryPadding=0;this.hasSymbolBuckets=false;this.expiredRequestCount=0;this.state="loading";};_16.prototype.wasRequested=function wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading";};_16.prototype.setExpiryData=function setExpiryData(_19){var _1a=this.expirationTime;if(_19.cacheControl){var _1b=_6(_19.cacheControl);if(_1b["max-age"]){this.expirationTime=Date.now()+_1b["max-age"]*1000;}}if(this.expirationTime){var now=Date.now();var _1c=false;if(this.expirationTime>now){_1c=false;}else{if(!_1a){_1c=true;}else{if(this.expirationTime<_1a){_1c=true;}else{var _1d=this.expirationTime-_1a;if(!_1d){_1c=true;}else{this.expirationTime=now+Math.max(_1d,_15);}}}}if(_1c){this.expiredRequestCount++;this.state="expired";}else{this.expiredRequestCount=0;}}};_16.prototype.getExpiryTimeout=function getExpiryTimeout(){if(this.expirationTime){if(this.expiredRequestCount){return 1000*(1<<Math.min(this.expiredRequestCount-1,31));}else{return Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1);}}};_16.prototype.registerFadeDuration=function registerFadeDuration(_1e){var _1f=_1e+this.timeAdded;if(_1f<_3.now()){return;}if(this.fadeEndTime&&_1f<this.fadeEndTime){return;}this.fadeEndTime=_1f;};_16.prototype.loadVectorData=function loadVectorData(_20,_21,_22){if(this.hasData()){this.unloadVectorData();}this.state="loaded";if(!_20){this.collisionBoxArray=new CollisionBoxArray();return;}if(_20.featureIndex){this.latestFeatureIndex=_20.featureIndex;if(_20.rawTileData){this.latestRawTileData=_20.rawTileData;this.latestFeatureIndex.rawTileData=_20.rawTileData;}else{if(this.latestRawTileData){this.latestFeatureIndex.rawTileData=this.latestRawTileData;}}}this.collisionBoxArray=_20.collisionBoxArray;this.buckets=_b(_20.buckets,_21._layers);this.hasSymbolBuckets=false;for(var id in this.buckets){var _23=this.buckets[id];if(_23 instanceof _1){this.hasSymbolBuckets=true;if(_22){_23.justReloaded=true;}else{break;}}}this.queryPadding=0;for(var _24 in this.buckets){var _25=this.buckets[_24];this.queryPadding=Math.max(this.queryPadding,_21._layers[_24].queryRadius(_25));}if(_20.imageAtlas){this.imageAtlas=_20.imageAtlas;}if(_20.glyphAtlasImage){this.glyphAtlasImage=_20.glyphAtlasImage;}};_16.prototype.unloadVectorData=function unloadVectorData(){for(var id in this.buckets){this.buckets[id].destroy();}this.buckets={};if(this.imageAtlasTexture){this.imageAtlasTexture.destroy();}if(this.imageAtlas){this.imageAtlas=null;}if(this.glyphAtlasTexture){this.glyphAtlasTexture.destroy();}this.latestFeatureIndex=null;this.state="unloaded";};_16.prototype.getBucket=function getBucket(_26){return this.buckets[_26.id];};_16.prototype.upload=function upload(_27){for(var id in this.buckets){var _28=this.buckets[id];if(_28.uploadPending()){_28.upload(_27);}}var gl=_27.gl;if(this.imageAtlas&&!this.imageAtlas.uploaded){this.imageAtlasTexture=new _2(_27,this.imageAtlas.image,gl.RGBA);this.imageAtlas.uploaded=true;}if(this.glyphAtlasImage){this.glyphAtlasTexture=new _2(_27,this.glyphAtlasImage,gl.ALPHA);this.glyphAtlasImage=null;}};_16.prototype.prepare=function prepare(_29){if(this.imageAtlas){this.imageAtlas.patchUpdatedImages(_29,this.imageAtlasTexture);}};_16.prototype.queryRenderedFeatures=function(_2a,_2b,_2c,_2d,_2e,_2f,_30,_31,_32){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData){return {};}return this.latestFeatureIndex.query({queryGeometry:_2c,cameraQueryGeometry:_2d,scale:_2e,tileSize:this.tileSize,pixelPosMatrix:_32,transform:_30,params:_2f,queryPadding:this.queryPadding*_31},_2a,_2b);};_16.prototype.querySourceFeatures=function querySourceFeatures(_33,_34){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData){return;}var _35=this.latestFeatureIndex.loadVTLayers();var _36=_34?_34.sourceLayer:"";var _37=_35._geojsonTileLayer||_35[_36];if(!_37){return;}var _38=createFilter(_34&&_34.filter);var ref=this.tileID.canonical;var z=ref.z;var x=ref.x;var y=ref.y;var _39={z:z,x:x,y:y};for(var i=0;i<_37.length;i++){var _3a=_37.feature(i);if(_38(new _4(this.tileID.overscaledZ),_3a)){var _3b=new _5(_3a,z,x,y);_3b.tile=_39;_33.push(_3b);}}};_16.prototype.clearMask=function clearMask(){if(this.segments){this.segments.destroy();delete this.segments;}if(this.maskedBoundsBuffer){this.maskedBoundsBuffer.destroy();delete this.maskedBoundsBuffer;}if(this.maskedIndexBuffer){this.maskedIndexBuffer.destroy();delete this.maskedIndexBuffer;}};_16.prototype.setMask=function setMask(_3c,_3d){if(deepEqual(this.mask,_3c)){return;}this.mask=_3c;this.clearMask();if(deepEqual(_3c,{"0":true})){return;}var _3e=new StructArrayLayout4i8();var _3f=new StructArrayLayout3ui6();this.segments=new SegmentVector();this.segments.prepareSegment(0,_3e,_3f);var _40=Object.keys(_3c);for(var i=0;i<_40.length;i++){var _41=_3c[+_40[i]];var _42=EXTENT>>_41.z;var _43=new pointGeometry(_41.x*_42,_41.y*_42);var _44=new pointGeometry(_43.x+_42,_43.y+_42);var _45=(this.segments).prepareSegment(4,_3e,_3f);_3e.emplaceBack(_43.x,_43.y,_43.x,_43.y);_3e.emplaceBack(_44.x,_43.y,_44.x,_43.y);_3e.emplaceBack(_43.x,_44.y,_43.x,_44.y);_3e.emplaceBack(_44.x,_44.y,_44.x,_44.y);var _46=_45.vertexLength;_3f.emplaceBack(_46,_46+1,_46+2);_3f.emplaceBack(_46+1,_46+2,_46+3);_45.vertexLength+=4;_45.primitiveLength+=2;}this.maskedBoundsBuffer=_3d.createVertexBuffer(_3e,rasterBoundsAttributes.members);this.maskedIndexBuffer=_3d.createIndexBuffer(_3f);};_16.prototype.hasData=function hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired";};_16.prototype.patternsLoaded=function patternsLoaded(){return this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length;};_16.prototype.setFeatureState=function setFeatureState(_47,_48){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||Object.keys(_47).length===0){return;}var _49=this.latestFeatureIndex.loadVTLayers();for(var id in this.buckets){var _4a=this.buckets[id];var _4b=_4a.layers[0]["sourceLayer"]||"_geojsonTileLayer";var _4c=_49[_4b];var _4d=_47[_4b];if(!_4c||!_4d||Object.keys(_4d).length===0){continue;}_4a.update(_4d,_4c,this.imageAtlas&&this.imageAtlas.patternPositions||{});if(_48&&_48.style){this.queryPadding=Math.max(this.queryPadding,_48.style.getLayer(id).queryRadius(_4a));}}};_16.prototype.holdingForFade=function holdingForFade(){return this.symbolFadeHoldUntil!==undefined;};_16.prototype.symbolFadeFinished=function symbolFadeFinished(){return !this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<_3.now();};_16.prototype.clearFadeHold=function clearFadeHold(){this.symbolFadeHoldUntil=undefined;};_16.prototype.setHoldDuration=function setHoldDuration(_4e){this.symbolFadeHoldUntil=exported.now()+_4e;};return _16;});