//>>built
define("com/huayun/webgis/layers/support/WaterTileSourceCache",["./TileSource","./funcUtils","./TileCache","./Tile","./SourceFeatureState","com/huayun/webgis/layers/support/tileCover","com/huayun/webgis/geometry/Point2D","../../utils/utils"],function(_1,_2,_3,_4,_5,_6,_7,_8){function _9(id,_a,_b,_c,_d,_e,_f){this.id=id;this._tiles={};this._cache=new _3(0,this._unloadTile.bind(this));this._timers={};this._cacheTimers={};this._maxTileCacheSize=null;this._coveredTiles={};this.updateCacheSize(_b,_c);this.layer=_e;this.view=_f;};_9.prototype.constructor=_9;_9.prototype.updateTileSize=function(_10){this._source.setSize(_10);};_9.prototype.onRemove=function onRemove(map){if(this._source&&this._source.onRemove){this._source.onRemove(map);}};_9.prototype.getIds=function getIds(){var _11=[];for(var key in this._tiles){_11.push(this._tiles[key].tileID);}return _11;};_9.prototype.getRenderableIds=function getRenderableIds(){var ids=[];for(var id in this._tiles){if(this._isIdRenderable(id)){ids.push(id);}}return ids.sort(_8.compareKeyZoom);};_9.prototype.hasRenderableParent=function hasRenderableParent(_12){var _13=this.findLoadedParent(_12,0);if(_13){return this._isIdRenderable(_13.tileID.key);}return false;};_9.prototype._isIdRenderable=function _isIdRenderable(id){return this._tiles[id]&&this._tiles[id].hasData()&&!this._coveredTiles[id]&&(!this._tiles[id].holdingForFade());};_9.prototype.reload=function reload(){if(this._paused){this._shouldReloadOnResume=true;return;}this._cache.reset();for(var i in this._tiles){if(this._tiles[i].state!=="errored"){this._reloadTile(i,"reloading");}}};_9.prototype._reloadTile=function _reloadTile(id,_14){var _15=this._tiles[id];if(!_15){return;}if(_15.state!=="loading"){_15.state=_14;}this._loadTile(_15,this._tileLoaded.bind(this,_15,id,_14));};_9.prototype.updateTileUrl=function(url){this._source.updateTileUrl(url);};_9.prototype._tileLoaded=function _tileLoaded(_16,id,_17,err){if(err){_16.state="errored";if(err.status===404){this.update(this.transform);}return;}_16.timeAdded=_8.now();this._setTileReloadTimer(id,_16);this.layer.layerViews[0]._sourcesDirty=true;this.view.threeRender();};_9.prototype.getTile=function getTile(_18){return this.getTileByID(_18.key);};_9.prototype.getTileByID=function getTileByID(id){return this._tiles[id];};_9.prototype.getZoom=function getZoom(_19){return _19.level+_19.scaleZoom(_19.tileSize/this._source.tileSize);};_9.prototype._retainLoadedChildren=function _retainLoadedChildren(_1a,_1b,_1c,_1d){for(var id in this._tiles){var _1e=this._tiles[id];if(_1d[id]||!_1e.hasData()||_1e.tileID.overscaledZ<=_1b||_1e.tileID.overscaledZ>_1c){continue;}var _1f=_1e.tileID;while(_1e&&_1e.tileID.overscaledZ>_1b+1){var _20=_1e.tileID.scaledTo(_1e.tileID.overscaledZ-1);_1e=this._tiles[_20.key];if(_1e&&_1e.hasData()){_1f=_20;}}var _21=_1f;while(_21.overscaledZ>_1b){_21=_21.scaledTo(_21.overscaledZ-1);if(_1a[_21.key]){_1d[_1f.key]=_1f;break;}}}};_9.prototype.findLoadedParent=function findLoadedParent(_22,_23){for(var z=_22.overscaledZ-1;z>=_23;z--){var _24=_22.scaledTo(z);if(!_24){return;}var id=String(_24.key);var _25=this._tiles[id];if(_25&&_25.hasData()){return _25;}if(this._cache.has(_24)){return this._cache.get(_24);}}};_9.prototype.updateCacheSize=function updateCacheSize(_26,_27){var _28=Math.ceil(_26/this._source.tileSize)+1;var _29=Math.ceil(_27/this._source.tileSize)+1;var _2a=_28*_29;var _2b=3;var _2c=Math.floor(_2a*_2b);var _2d=typeof this._maxTileCacheSize==="number"?Math.min(this._maxTileCacheSize,_2c):_2c;this._cache.setMaxSize(_2d);};_9.prototype.update=function update(_2e,_2f,_30,cx,cy){this._coveredTiles={};var _31=_6.tileCover(_2e,_2f,_30);_31=_31.sort(function(a,b){a=a.canonical;b=b.canonical;return Math.sqrt((cx-a.x)*(cx-a.x)+(cy-a.y)*(cy-a.y))-Math.sqrt((cx-b.x)*(cx-b.x)+(cy-b.y)*(cy-b.y));});var _32=this._updateRetainedTiles(_31,_2e);var _33=_2e;var _34=0;var _35=15;for(var _36 in _32){this._tiles[_36].clearFadeHold();}var _37=_8.keysDifference(this._tiles,_32);for(var i$1=0,_38=_37;i$1<_38.length;i$1+=1){var _39=_38[i$1];var _3a=this._tiles[_39];this._removeTile(_39);}};_9.prototype.updateTile=function updateTile(_3b,_3c,_3d,cx,cy){this._coveredTiles={};var _3e=_6.tileCover(_3b,_3c,_3d);_3e=_3e.sort(function(a,b){a=a.canonical;b=b.canonical;return Math.sqrt((cx-a.x)*(cx-a.x)+(cy-a.y)*(cy-a.y))-Math.sqrt((cx-b.x)*(cx-b.x)+(cy-b.y)*(cy-b.y));});this._updateRetainedTiles(_3e,_3b);return _3e;};_9.prototype.releaseSymbolFadeTiles=function releaseSymbolFadeTiles(){for(var id in this._tiles){if(this._tiles[id].holdingForFade()){this._removeTile(id);}}};_9.prototype._updateRetainedTiles=function _updateRetainedTiles(_3f,_40){var _41={};var _42={};var _43=Math.max(_40-_9.maxOverzooming,this._source.minzoom);var _44=Math.max(_40+_9.maxUnderzooming,this._source.minzoom);var _45={};for(var i=0,_46=_3f;i<_46.length;i+=1){var _47=_46[i];var _48=this._addTile(_47);_41[_47.key]=_47;if(_48.hasData()){continue;}if(_40<this._source.maxzoom){_45[_47.key]=_47;}}this._retainLoadedChildren(_45,_40,_44,_41);for(var i$1=0,_49=_3f;i$1<_49.length;i$1+=1){var _4a=_49[i$1];var _4b=this._tiles[_4a.key];if(_4b.hasData()){continue;}if(_40+1>this._source.maxzoom){var _4c=_4a.children(this._source.maxzoom)[0];var _4d=this.getTile(_4c);if(!!_4d&&_4d.hasData()){_41[_4c.key]=_4c;continue;}}else{var _4e=_4a.children(this._source.maxzoom);if(_41[_4e[0].key]&&_41[_4e[1].key]&&_41[_4e[2].key]&&_41[_4e[3].key]){continue;}}var _4f=_4b.wasRequested();for(var _50=_4a.overscaledZ-1;_50>=_43;--_50){var _51=_4a.scaledTo(_50);if(_42[_51.key]){break;}_42[_51.key]=true;_4b=this.getTile(_51);if(!_4b&&_4f){_4b=this._addTile(_51);}if(_4b){_41[_51.key]=_51;_4f=_4b.wasRequested();if(_4b.hasData()){break;}}}}return _41;};_9.prototype._reAddTile=function _reAddTile(_52){var _53=new _4(_52,this._source.tileSize*_52.overscaleFactor());this._loadTile(_53,this._tileReAddLoaded.bind(this,_53,_52.key,_53.state));};_9.prototype._tileReAddLoaded=function _tileLoaded(_54,id,_55,err){this._removeTile(id);this._tiles[_54.tileID.key]=_54;if(err){_54.state="errored";if(err.status===404){this.update(this.transform);}return;}_54.timeAdded=_8.now();this._setTileReloadTimer(id,_54);this.layer.layerViews[0]._sourcesDirty=true;this.view.threeRender();};_9.prototype._addTile=function _addTile(_56){var _57=this._tiles[_56.key];if(_57){return _57;}_57=this._cache.getAndRemove(_56);if(_57){this._setTileReloadTimer(_56.key,_57);_57.tileID=_56;if(this._cacheTimers[_56.key]){clearTimeout(this._cacheTimers[_56.key]);delete this._cacheTimers[_56.key];this._setTileReloadTimer(_56.key,_57);}}var _58=Boolean(_57);if(!_58){_57=new _4(_56,this._source.tileSize*_56.overscaleFactor());this._loadTile(_57,this._tileLoaded.bind(this,_57,_56.key,_57.state));}if(!_57){return (null);}_57.uses++;this._tiles[_56.key]=_57;return _57;};_9.prototype._setTileReloadTimer=function _setTileReloadTimer(id,_59){var _5a=this;if(id in this._timers){clearTimeout(this._timers[id]);delete this._timers[id];}var _5b=_59.getExpiryTimeout();if(_5b){this._timers[id]=setTimeout(function(){_5a._reloadTile(id,"expired");delete _5a._timers[id];},_5b);}};_9.prototype._removeTile=function _removeTile(id){var _5c=this._tiles[id];if(!_5c){return;}_5c.uses--;delete this._tiles[id];if(this._timers[id]){clearTimeout(this._timers[id]);delete this._timers[id];}if(_5c.uses>0){return;}if(_5c.hasData()){}else{_5c.aborted=true;this._abortTile(_5c);this._unloadTile(_5c);}};_9.prototype.clearTiles=function clearTiles(){this._shouldReloadOnResume=false;this._paused=false;for(var id in this._tiles){this._removeTile(id);}this._cache.reset();};_9.prototype.clearOtherLevel=function clearOtherLevel(_5d){this._shouldReloadOnResume=false;this._paused=false;for(var id in this._tiles){var _5e=this._tiles[id];if(_5e.tileID.canonical.z!==_5d){this._removeTile(id);}}};_9.prototype.tilesIn=function tilesIn(_5f,_60,_61){var _62=this;var _63=[];var _64=this.transform;if(!_64){return _63;}var _65=_61?_64.getCameraQueryGeometry(_5f):_5f;var _66=_5f.map(function(p){return _64.pointCoordinate(p);});var _67=_65.map(function(p){return _64.pointCoordinate(p);});var ids=this.getIds();var _68=Infinity;var _69=Infinity;var _6a=-Infinity;var _6b=-Infinity;for(var i$1=0,_6c=_67;i$1<_6c.length;i$1+=1){var p=_6c[i$1];_68=Math.min(_68,p.x);_69=Math.min(_69,p.y);_6a=Math.max(_6a,p.x);_6b=Math.max(_6b,p.y);}var _6d=function(i){var _6e=_62._tiles[ids[i]];if(_6e.holdingForFade()){return;}var _6f=_6e.tileID;var _70=Math.pow(2,_64.level-_6e.tileID.overscaledZ);var _71=_60*_6e.queryPadding*__chunk_1.EXTENT/_6e.tileSize/_70;var _72=[_6f.getTilePoint(new __chunk_1.MercatorCoordinate(_68,_69)),_6f.getTilePoint(new __chunk_1.MercatorCoordinate(_6a,_6b))];if(_72[0].x-_71<__chunk_1.EXTENT&&_72[0].y-_71<__chunk_1.EXTENT&&_72[1].x+_71>=0&&_72[1].y+_71>=0){var _73=_66.map(function(c){return _6f.getTilePoint(c);});var _74=_67.map(function(c){return _6f.getTilePoint(c);});_63.push({tile:_6e,tileID:_6f,queryGeometry:_73,cameraQueryGeometry:_74,scale:_70});}};for(var i=0;i<ids.length;i++){_6d(i);}return _63;};_9.prototype.getVisibleCoordinates=function getVisibleCoordinates(_75,_76){var _77=this;var _78=this.getRenderableIds().map(function(id){return _77._tiles[id].tileID;});this.currentCoords=[];for(var i=0,_79=_78;i<_79.length;i+=1){var _7a=_79[i];var _7b=_7a.toUnwrapped();if(!_7a.geometry){_7a.geometry=this.layer.tileInfo.getGeometry(_7b,_76.level);}_7a.posMatrix=_76.calculatePosMatrix(_7b,_7a.geometry,true);this.currentCoords.push(_7a);}return _78;};_9.prototype.updateTileMatrix=function updateTileMatrix(_7c,_7d){var _7e=this.currentCoords;for(var i=0,_7f=_7e;i<_7f.length;i+=1){var _80=_7f[i];_80.posMatrix=_7d.updatePosMatrix(_80.toUnwrapped(),_80.geometry,true);}return _7e;};_9.prototype.hasTransition=function hasTransition(){if(this._source.hasTransition()){return true;}for(var id in this._tiles){var _81=this._tiles[id];if(_81.fadeEndTime!==undefined&&_81.fadeEndTime>=_8.now()){return true;}}return false;};_9.maxOverzooming=10;_9.maxUnderzooming=3;return _9;});