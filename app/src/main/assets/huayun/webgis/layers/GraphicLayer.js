//>>built
define("com/huayun/webgis/layers/GraphicLayer",["dojo/_base/declare","./Layer","../views/3d/layers/GraphicLayerView3D","../data/GraphicIndex","com/huayun/webgis/symbols/PointSymbol","com/huayun/webgis/symbols/CircleSymbol","com/huayun/webgis/symbols/PolygonSymbol","com/huayun/webgis/symbols/LineSymbol","../renderer/SimpleRenderer"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9){return _1("com.huayun.webgis.layers.GraphicLayer",[_2],{constructor:function(_a){_a=_a||{};this.type="graphic";this.graphics=[];this.id="graphic";this.maxLevel=_a.maxLevel;this.minLevel=_a.minLevel;this.opacity=1;_1.safeMixin(this,_a);this.graphicIndex=new _4();this.queryPadding=20;this.indexNeedUpdate=true;this.selectEnabled=true;this.highlightGraphics=[];this.renderer=_a&&_a.renderer||new _9();if(_a){this.glowRatio=_a.glowRatio===undefined?8:_a.glowRatio;if(_a.graphics){_a.graphics.forEach(function(_b){this.addGraphic(_b);}.bind(this));}}},setRenderer:function(_c){this.renderer=_c;if(this.layerView){this.layerView.renderer=_c;}},createLayerView:function(_d,_e){var _f=new _3({opacity:this.opacity,visible:this.visible,view:_d,id:this.id,layer:this,glow:this.glow,renderer:this.renderer});this.layerView=_f;_f.transform=_d.viewpoint;this.graphics.forEach(function(_10){this.layerView.addGraphic(_10);}.bind(this));return _f;},addGraphic:function(_11,_12){if(_12){switch(_12){case "first":this.graphics.splice(0,0,_11);break;case "end":this.graphics.push(_11);break;}}else{this.graphics.push(_11);}_11.layer=this;if(this.layerView){this.layerView.addGraphic(_11);}this.indexNeedUpdate=true;},updateGraphic:function(_13){this.layerView.addGraphic(_13);},addGraphicBefore:function(_14,id){_14.layer=this;var ii=this.graphics.length;var _15=false;for(var i=0;i<ii;i++){if(id===this.graphics[i].id){this.graphics.splice(i,0,_14);_15=true;break;}}if(!_15){this.graphics.push(_14);}if(this.layerView){this.layerView.addGraphic(_14);}this.indexNeedUpdate=true;},removeGraphic:function(_16){if(!_16){return;}var ii=this.graphics.length;for(var i=0;i<ii;i++){if(_16.id===this.graphics[i].id){_16.buckets.forEach(function(_17){_17.destroy();});_16.buckets=[];this.graphics.splice(i,1);break;}}this.layerView.view.threeRender();},addMultiPoint:function(_18){this.graphics.push(_18);this.layerView.addMultiPoint(_18);},removeGraphics:function(_19){for(var i=0;i<_19.length;i++){this.removeGraphic(_19[i]);}},setVisible:function(_1a){this.visible=_1a;this.layerView.setVisible(_1a);},refresh:function(){this.layerView.view.threeRender();},clear:function(){this.graphics.forEach(function(_1b){if(_1b.bucket){_1b.bucket.destroy();}});this.graphics=[];this.layerView.view.threeRender();},queryFeaturesByGeometry:function(_1c,_1d){if(this.indexNeedUpdate){this.graphicIndex.clear();this.graphics.forEach(function(_1e){if(_1e.selectEnabled){var _1f;switch(_1e.feature.geometry.type){case "point":_1f=[[_1e.feature.geometry]];break;case "circle":_1f=[[_1e.feature.geometry.center]];break;case "multipoint":_1f=[_1e.feature.geometry.points];break;case "line":case "polygon":_1f=_1e.feature.geometry.path;break;default:_1f=[[]];}this.graphicIndex.insert(_1f,_1e.id);}}.bind(this));this.indexNeedUpdate=false;}_1d=_1d||this.queryPadding;switch(_1c.type){case "point":_1c=[_1c];break;}return this.graphicIndex.query(_1c,_1d,this.graphics,this.layerView.view.resolution,this.layerView.view.viewpoint);},captureFeaturesByGeometry:function(_20,_21){if(this.indexNeedUpdate){this.graphicIndex.clear();this.graphics.forEach(function(_22){if(_22.selectEnabled){var _23;switch(_22.symbol.type){case "point":_23=[[_22.feature.geometry]];break;case "circle":_23=[[_22.feature.geometry.center]];break;case "text":return;case "image":_23=[[_22.feature.geometry]];break;default:_23=_22.feature.geometry.path;}this.graphicIndex.insert(_23,_22.id);}}.bind(this));this.indexNeedUpdate=false;}_21=_21||this.queryPadding;switch(_20.type){case "point":_20=[_20];break;}return this.graphicIndex.captureQuery(_20,_21,this.graphics,this.layerView.view.resolution,this.layerView.view.viewpoint);},queryRenderFeaturesByGeometry:function(_24,_25){if(this.indexNeedUpdate){this.graphicIndex.clear();this.graphics.forEach(function(_26){if(_26.selectEnabled){var _27;switch(_26.symbol.type){case "point":_27=[[_26.feature.geometry]];break;case "circle":_27=[[_26.feature.geometry.center]];break;case "text":return;case "image":_27=[[_26.feature.geometry]];break;default:_27=_26.feature.geometry.path;}this.graphicIndex.insert(_27,_26.id);}}.bind(this));this.indexNeedUpdate=false;}_25=_25||this.queryPadding;switch(_24.type){case "point":_24=[_24];break;}return this.graphicIndex.queryRender(_24,_25,this.graphics,this.layerView.view.resolution,this.layerView.view.viewpoint);},highlightGraphic:function(_28){if(!this.highlightSymbol){this.highlightSymbol={point:new _5({color:"#FFFF00",radius:16}),line:new _8({color:"#BF2BFF",width:4,join:"round",cap:"round"}),polygon:new _7({color:"#FF4B37"})};}var _29=false;this.highlightGraphics.forEach(function(_2a){delete _2a.highLightSymbol;_29=true;}.bind(this));this.highlightGraphics=[];_28.forEach(function(_2b){_2b.highLightSymbol=this.highlightSymbol[_2b.symbol.type];_29=true;}.bind(this));this.highlightGraphics=_28;if(_29){this.layerView.view.threeRender();}}});});