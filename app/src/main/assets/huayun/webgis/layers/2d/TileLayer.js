//>>built
define("com/huayun/webgis/layers/2d/TileLayer","dojo/_base/declare dojo/_base/fx dojo/dom-construct dojo/dom-style dojo/topic ../../request ./FlatLayer ../../geometry/Extent ../../geometry/MapPoint ../../geometry/Point ../support/Tile ../support/LOD ../support/TileInfo ../../../facades/TileInfoFacade".split(" "),function(k,w,h,g,l,m,n,x,p,q,r,t,u,v){return k("com.huayun.webgis.layers.2d.TileLayer",[n],{url:null,tileInfo:null,_urlList:[],_newRenderUrlList:[],_removeRenderTileList:[],_currentRenderTileList:[],
_allRenderTileList:[],_animateRaf:null,constructor:function(a){k.safeMixin(this,a);this._tileInfoFacade=new v;this._getTileInfo()},postCreate:function(){this.inherited(arguments);this.ctx=this.canvasNode.getContext("2d");this.ctx.imageSmoothingEnabled=!1},_getTileInfo:function(){var a=/^\/[^/]*/.exec(location.pathname)[0]+"/config/tileInfoData.json";this._tileInfoFacade.getTileInfoData(a,function(a){for(var b=a.origin,b=new p(b[0],b[1]),c=[],d=0;d<a.lods.length;d++){var f=a.lods[d],f=new t({level:f.level,
scale:f.scale,resolution:f.resolution});c.push(f)}this.tileInfo=new u({lods:c,origin:b});l.publish("tileInfoComplete")}.bind(this),function(a){}.bind(this))},refresh:function(){if(this.visible&&(this._currentRenderTileList=[],this.map.zoomined&&this._zoomStart("zoomIn"),this.map.zoomouted&&this._zoomStart("zoomOut"),this.map.panned&&this.ctx.clearRect(0,0,this.map.width,this.map.height),this.tileInfo)){var a=this._calculationRenderingColAndRowData();this._getCurrentDrawTileList(a);this._drawImageToCanvas()}},
_calculationRenderingColAndRowData:function(){var a=this.tileInfo.origin,b=this.tileInfo.size,e=this.map.extent,c=this.map.resolution,d=Math.floor(Math.abs(a.x-e.minx)/(c*b)),f=Math.floor(Math.abs(a.y-e.maxy)/(c*b)),g=(d*c*b+a.x-e.minx)/c,a=(e.maxy-(a.y-f*c*b))/c;return{startCol:d,startRow:f,colNum:Math.ceil((this.width+Math.abs(g))/b),rowNum:Math.ceil((this.height+Math.abs(a))/b),offSetX:g,offSetY:a}},_getCurrentDrawTileList:function(a){this._newRenderUrlList=[];for(var b=a.startCol;b<a.startCol+
a.colNum;b++)for(var e=a.startRow;e<a.startRow+a.rowNum;e++){var c=this.url+this.map.level+"/"+b+"/"+e,d=new q(a.offSetX+(b-a.startCol)*this.tileInfo.size,a.offSetY+(e-a.startRow)*this.tileInfo.size);this._newRenderUrlList.push(c);-1===this._urlList.indexOf(c)?(this._urlList.push(c),d=new r(c,d,this.tileInfo.size),this._allRenderTileList[c]=d):this._allRenderTileList[c].updatePoint(d)}for(a=0;a<this._newRenderUrlList.length;a++)this._currentRenderTileList.push(this._allRenderTileList[this._newRenderUrlList[a]])},
_drawImageToCanvas:function(){for(var a=0;a<this._currentRenderTileList.length;a++){var b=this._currentRenderTileList[a];null!=b.image?this.ctx.drawImage(b.image,b.coordPoint.x,b.coordPoint.y,b.size,b.size):function(a){m(a.url,{responseType:"image",allowImageDataAccess:!1}).then(function(b){a.setImage(b.data);this.ctx.drawImage(a.image,a.coordPoint.x,a.coordPoint.y,a.size,a.size)}.bind(this),function(a){})}.call(this,b)}},_zoomStart:function(a){var b=h.toDom("\x3cimg id\x3d'animationImg' style\x3d'position: fixed;top: 0px'/\x3e");
b.src=this.canvasNode.toDataURL("image/png");h.place(b,this.id);this.ctx.clearRect(0,0,this.map.width,this.map.height);g.set(b,"transform","linear");"zoomIn"===a?this._animateZoomIn(null,0,0,b,30):"zoomOut"===a&&this._animateZoomOut(null,0,0,b,30)},_zoomEnd:function(a){h.destroy(a.id);window.cancelAnimationFrame(this._animateRaf)},_animateZoomOut:function(a,b,e,c,d){a||(a=performance.now());if(500<=performance.now()-a)this._zoomEnd(c);else{var f=--d/30;g.set(c,"-webkit-transform","scale(0.8)");g.set(c,
"opacity",f);this._animateRaf=window.requestAnimationFrame(this._animateZoomOut.bind(this,a,b,e,c,d))}},_animateZoomIn:function(a,b,e,c,d){a||(a=performance.now());if(500<=performance.now()-a)this._zoomEnd(c);else{var f=--d/30;g.set(c,"-webkit-transform","scale(1.4)");g.set(c,"opacity",f);this._animateRaf=window.requestAnimationFrame(this._animateZoomIn.bind(this,a,b,e,c,d))}}})});