//>>built
define("com/huayun/webgis/layers/2d/DynamicTileLayer",["dojo/_base/declare","dojo/topic","./FlatLayer","../../geometry/Extent","../../geometry/MapPoint","../../geometry/Point","../../request","dojo/dom-construct","dojo/dom-style","dojo/dom","dojo/when"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b){return _1("com.huayun.webgis.layers.2d.DynamicTileLayer",[_3],{_animateRaf:null,constructor:function(_c){},postCreate:function(){this.inherited(arguments);this.canvasNode.width=this.map.width;this.canvasNode.height=this.map.height;this.ctx=this.canvasNode.getContext("2d");this.ctx.imageSmoothingEnabled=false;},refresh:function(){if(this.map.zoomined){this._zoomStart("zoomIn");}else{if(this.map.zoomouted){this._zoomStart("zoomOut");}else{this.ctx.clearRect(0,0,this.map.width,this.map.height);}}if(!this.map.isPanning){var _d=this._getLoaderUrl();this._load(_d);}else{}},_getLoaderUrl:function(){var _e=this.map.extent;var _f=this.map.width;var _10=this.map.height;var box="&bbox="+_e.minx+","+_e.miny+","+_e.maxx+","+_e.maxy;var _11="&size="+_f+","+_10;return this.url+box+_11;},_load:function(url){_7(url,{responseType:"image",allowImageDataAccess:false}).then(function(_12){this._draw(_12.data);}.bind(this),function(err){});},_draw:function(_13){this.ctx.drawImage(_13,0,0,this.map.width,this.map.height);},_zoomStart:function(_14){var _15=_8.toDom("<img id='powerImg' style='position: fixed;top: 0px'/>");_15.src=this.canvasNode.toDataURL("image/png");_8.place(_15,this.id);this.ctx.clearRect(0,0,this.map.width,this.map.height);if(_14==="zoomIn"){this._animateZoomIn(null,0,0,_15);}else{if(_14==="zoomOut"){this._animateZoomOut(null,0,0,_15);}}},_zoomEnd:function(_16){_8.destroy(_16.id);window.cancelAnimationFrame(this._animateRaf);},_animateZoomOut:function(_17,x,y,_18){if(!_17){_17=performance.now();}var _19=performance.now()-_17;if(_19>=500){this._zoomEnd(_18);}else{_9.set(_18,"transform","linear");_9.set(_18,"-webkit-transform","scale(0.8)");this._animateRaf=window.requestAnimationFrame(this._animateZoomOut.bind(this,_17,x,y,_18));}},_animateZoomIn:function(_1a,x,y,_1b){if(!_1a){_1a=performance.now();}var _1c=performance.now()-_1a;if(_1c>=500){this._zoomEnd(_1b);}else{_9.set(_1b,"transform","linear");_9.set(_1b,"-webkit-transform","scale(1.2)");this._animateRaf=window.requestAnimationFrame(this._animateZoomIn.bind(this,_1a,x,y,_1b));}}});});