//>>built
define("com/huayun/webgis/layers/2d/BaseTileLayer",["dojo/_base/declare","dojo/topic","../../request","./TileLayer","../../geometry/Extent","../../geometry/MapPoint","../../geometry/Point","../support/Tile","dojo/dom-style","dojo/when"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){return _1("com.huayun.webgis.layers.2d.BaseTileLayer",[_4],{lastIndexArray:[],currentIndexArray:[],needRemovedArrayOfTielIndex:[],tileArray:[],screenPoint0:null,needLoadIndex:[],loadPromise:null,startCol:0,startRow:0,ctx:null,oldcanvasIsFull:false,constructor:function(_b){this.id=_b.id;this.visible=_b.visible?_b.visible:true;this.map=_b.map;this.url=_b.url;this.tileInfo=_b.tileInfo;this.width=_b.width;this.height=_b.height;this.fullExtent=this.tileInfo.fullExtent;this.lastIndexArray=[];this.currentIndexArray=[];this.needRemovedArrayOfTielIndex=[];this.tileArray=[];this.needLoadIndex=[];this.startCol=0;this.startRow=0;this.oldcanvas=document.createElement("canvas");this.oldcanvas.width=this.width;this.oldcanvas.height=this.height;this.oldctx=this.oldcanvas.getContext("2d");this.oldcanvasIsFull=false;this.loadPromise=new Object();this.oldctx.imageSmoothingEnabled=false;var _c=this;_2.subscribe("mapPan",function(_d,_e){_c.load(_d,_e);});_2.subscribe("d3mapPan",function(_f,_10){_c.load(_f,_10);});_2.subscribe("resizing",function(){_c.canvasNode.width=_c.map.width;_c.canvasNode.height=_c.map.height;_c.load();});},mapMove:function(_11,_12){this.load(_11,_12);},postCreate:function(){this.inherited(arguments);this.ctx=this.canvasNode.getContext("2d");this.ctx.imageSmoothingEnabled=false;},getResolution:function(_13){return this.tileInfo.lods[_13].resolution;},load:function(){this.computeIndex();this.removeTiles();this.oldcanvasIsFull=false;this.fetchTiles();this.render();},computeIndex:function(){var _14=this.tileInfo.origin,_15=this.tileInfo.size,_16=this.map.extent,_17=this.map.resolution,_18=this.map.level,rs=_17*_15,_19,_1a;var _1b=Math.floor((_16.minx-_14.x)/rs),_1c=Math.floor((_14.y-_16.maxy)/rs),_1d=Math.ceil((_16.maxx-_14.x)/rs),_1e=Math.ceil((_14.y-_16.miny)/rs);this.screenPoint0=null;if(!this.screenPoint0){_19=new _6(_1b*rs+_14.x,_14.y-_1c*rs);_1a=this.map.geometryToPosition(_19);this.screenPoint0=this.map.positionToScreen(_1a);}this.currentIndexArray=[];this.needLoadIndex=[];var x,y,_1f,_20,_21,i,j;this.startCol=_1b;this.startRow=_1c;for(i=_1c;i<_1e;i++){for(j=_1b;j<_1d;j++){if(i>=0&&j>=0){x=this.screenPoint0.x+(j-_1b)*_15;y=this.screenPoint0.y+(i-_1c)*_15;_20=new _7(x,y);_1f=_18+"/"+j+"/"+i;if(this.tileArray[_1f]==undefined||this.tileArray[_1f]==null){this.needLoadIndex.push(_1f);_21=new _8(_20);this.tileArray[_1f]=_21;}else{this.tileArray[_1f].screenPoint=_20;}this.currentIndexArray.push(_1f);}}}var _22=false,_23=false;var _24=this.lastIndexArray.concat(this.currentIndexArray);for(i=0;i<_24.length;i++){_22=false;_23=false;for(j=0;j<this.lastIndexArray.length;j++){if(_24[i]==this.lastIndexArray[j]){_22=true;break;}}for(j=0;j<this.currentIndexArray.length;j++){if(_24[i]==this.currentIndexArray[j]){_23=true;break;}}if(_22&&!_23){this.needRemovedArrayOfTielIndex.push(_24[i]);}}this.lastIndexArray=this.currentIndexArray;},removeTiles:function(){var _25;for(var n=0;n<this.needRemovedArrayOfTielIndex.length;n++){_25=this.needRemovedArrayOfTielIndex[n];delete this.tileArray[_25];}this.needRemovedArrayOfTielIndex=[];},fetchTiles:function(){var url=null,_26,len=this.needLoadIndex.length;for(var p=0;p<len;p++){_26=this.needLoadIndex[p];url=this.url+_26;this.loadPromise[_26]=this.fetchTile(url);}},render:function(){var _27=null,_28,ctx=this.ctx,x,y;var obj=this,_29=this.tileInfo.size,_2a;for(var _2b in this.tileArray){_27=this.tileArray[_2b];if(_27.image){_28=_27.screenPoint;ctx.drawImage(_27.image,_28.x,_28.y,_29,_29);}}var _2c,i,j,_2d,_2e=0;var _2f=this.needLoadIndex.length;if(_2f==0){_2.publish("tileLayer",true);}for(var _30 in this.loadPromise){_2d=_30.split("/");_2c=_2d[0]*1;j=_2d[1]*1;i=_2d[2]*1;(function(_31,j,i){obj.loadPromise[_31].then(function(_32){_2a=_32.data;_2e++;x=obj.screenPoint0.x+(j-obj.startCol)*_29;y=obj.screenPoint0.y+(i-obj.startRow)*_29;_28=new _7(x,y);if(!obj.tileArray[_31]){ctx.drawImage(_2a,_28.x,_28.y,_29,_29);var _33=new _8(_28);_33.image=_2a;obj.tileArray[_31]=_33;}else{if(_2a){ctx.drawImage(_2a,_28.x,_28.y,_29,_29);obj.tileArray[_31].screenPoint=_28;obj.tileArray[_31].image=_2a;}}if(_2e==_2f){_2.publish("tileLayer",true);}},function(_34){});})(_30,j,i);}},zoomStart:function(){this.computeIndex();this.removeTiles();this.fetchTiles();this.ctx.save();if(!this.oldcanvasIsFull){this.oldcanvas.width=this.map.width;this.oldcanvas.height=this.map.height;this.oldctx.drawImage(this.canvasNode,0,0);this.oldcanvasIsFull=true;}},zoomIn:function(x,y){this.ctx.clearRect(0,0,this.map.width,this.map.height);this.ctx.translate(-x*0.148698,-y*0.148698);this.ctx.scale(1.148698,1.148698);this.ctx.drawImage(this.oldcanvas,0,0);},zoomEnd:function(){this.ctx.restore();this.render();this.oldcanvasIsFull=false;},zoom3dStart:function(){this.computeIndex();this.removeTiles();this.fetchTiles();},zoom3dEnd:function(){this.render();},zoomOut:function(x,y){this.ctx.clearRect(0,0,this.map.width,this.map.height);this.ctx.translate(x*0.12945,y*0.12945);this.ctx.scale(0.87055,0.87055);this.ctx.drawImage(this.oldcanvas,0,0);},rotateStart:function(){this.oldctx.drawImage(this.canvasNode,0,0);},rotate:function(){this.ctx.clearRect(0,0,this.map.width,this.map.height);this.ctx.translate(this.map.width/2,this.map.height/2);this.ctx.rotate(5*Math.PI/180);this.ctx.translate(-this.map.width/2,-this.map.height/2);this.ctx.drawImage(this.oldcanvas,0,0);}});});