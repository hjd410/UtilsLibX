//>>built
define("com/huayun/webgis/layers/2d/VectorTileLayer",["dojo/_base/declare","dojo/topic","dojo/touch","../../request","./FlatLayer","../../geometry/Extent","../../geometry/MapPoint","../../geometry/Point","../support/Tile","../../featureloader","dojo/dom-style","dojo/when"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c){return _1("com.huayun.webgis.layers.2d.VectorTileLayer",[_5],{url:null,tileInfo:null,lastIndexArray:[],currentIndexArray:[],needRemovedArrayOfTielIndex:[],screenPoint0:null,needLoadIndex:[],startCol:0,startRow:0,endCol:0,endRow:0,ctx:null,oldcanvasIsFull:false,animateRaf:null,_loader:null,styleObj:null,vectorCache:null,filter:null,constructor:function(){this._loader=new _a();this.vectorCache={};this.filter={};},postCreate:function(){this.inherited(arguments);this.ctx=this.canvasNode.getContext("2d");this.ctx.imageSmoothingEnabled=false;this.canvasNode.width=this.map.width;this.canvasNode.height=this.map.height;this.ctx.fillStyle="#FF0000";this.ctx.fillRect(0,0,this.map.width,this.map.height);},refresh:function(){this.computeIndex();this.fetchTiles();},computeIndex:function(){var _d=this.tileInfo.origin,_e=this.tileInfo.size,_f=this.map.extent,_10=this.map.resolution,_11=this.map.level,rs=_10*_e,_12,_13;var _14=Math.floor((_f.minx-_d.x)/rs),_15=Math.floor((_d.y-_f.maxy)/rs),_16=Math.ceil((_f.maxx-_d.x)/rs),_17=Math.ceil((_d.y-_f.miny)/rs);this.screenPoint0=null;if(!this.screenPoint0){_12=new _7(_14*rs+_d.x,_d.y-_15*rs);_13=this.map.geometryToPosition(_12);this.screenPoint0=this.map.positionToScreen(_13);}this.currentIndexArray=[];this.needLoadIndex=[];var x,y,_18,_19,i,j;this.startCol=_14;this.startRow=_15;this.endCol=_16;this.endRow=_17;for(i=_15;i<_17;i++){for(j=_14;j<_16;j++){if(i>=0&&j>=0){x=this.screenPoint0.x+(j-_14)*_e;y=this.screenPoint0.y+(i-_15)*_e;_19=new _8(x,y);_18=_11+"/"+j+"/"+i;this.needLoadIndex.push(_18);}}}this.dx=((_16-_14)*_e-this.map.width)/2;this.dy=((_17-_15)*_e-this.map.height)/2;},removeTiles:function(){this.ctx.clearRect(0,0,this.map.width,this.map.height);this.ctx.fillStyle="#eeeeee";this.ctx.fillRect(0,0,this.map.width,this.map.height);},fetchTiles:function(){var url=null,_1a,len=this.needLoadIndex.length;this.removeTiles();for(var p=0;p<len;p++){_1a=this.needLoadIndex[p];url=this.url+_1a+".pbf";this._loader.loadFeaturesXhr(url,_1a,this.onload.bind(this),this.onError.bind(this));}},onload:function(_1b,_1c,_1d){if(_1b.length>0){var _1e=Number(_1c[1]);var _1f=Number(_1c[2]);var _20=new Object();var _21=[];for(var i=_1b.length-1;i>-1;i--){var _22=_1b[i].type_;if(_22!="Point"){var _23=_1b[i].flatCoordinates_;var _24=_1b[i].properties_;var _25=_24.layer.toUpperCase();if(_25=="BUILDING_AREA"){_21.push({data:_23,properties_:_24});}else{if(!_20.hasOwnProperty(_25)){_20[_25]=[];}_20[_25].push(_23);}}else{}}this.vectorCache[_1d]={tileData:_20,buildData:_21};this.drawWholeTile(_20,_1e-this.startCol,_1f-this.startRow,this.dx,this.dy);}},onError:function(){},update:function(_26){this.filter[_26]=true;this.ctx.clearRect(0,0,this.map.width,this.map.height);for(var id in this.vectorCache){var _27=id.split("/");var _28=Number(_27[1]);var _29=Number(_27[2]);this.drawWholeTile(this.vectorCache[id].tileData,_28-this.startCol,_29-this.startRow,this.dx,this.dy);}},drawWholeTile:function(_2a,_2b,_2c,ddx,ddy){var _2d=256;var dx=_2b*_2d-ddx;var dy=_2c*_2d-ddy;var _2e,_2f,_30,_31;for(var id in this.styleObj){_2e=this.styleObj[id];_2f=_2a[id];if(_2f){for(var i=0;i<_2e.length;i++){_30=_2e[i];if(_30.type=="fill"){for(var j=0;j<_2f.length;j++){this.ctx.beginPath();_31=_2f[j];var _32=_31[0]/16+dx;var _33=_31[1]/16+dy;this.ctx.fillStyle=_30.paint["fill-color"];this.ctx.moveTo(_32,_33);for(var k=2;k<_31.length;k=k+2){var _34,_35;_34=_31[k]/16+dx;_35=_31[k+1]/16+dy;this.ctx.lineTo(_34,_35);}this.ctx.fill();}}else{if(_30.type=="line"){for(var j=0;j<_2f.length;j++){this.ctx.beginPath();_31=_2f[j];var _32=_31[0]/16+dx;var _33=_31[1]/16+dy;this.ctx.strokeStyle=_30.paint["line-color"];this.ctx.lineWidth=_30.paint["line-width"];this.ctx.moveTo(_32,_33);for(var k=2;k<_31.length;k=k+2){var _34,_35;_34=_31[k]/16+dx;_35=_31[k+1]/16+dy;this.ctx.lineTo(_34,_35);}this.ctx.stroke();}}}}}}},drawTile:function(_36,_37,_38,_39,_3a){var _3b=this.tileInfo.size;var dx=_37*_3b;var dy=_38*_3b;var _3c=_36[0]/16+dx;var _3d=_36[1]/16+dy;if(_3a=="Point"){this.ctx.beginPath();this.ctx.fillStyle="black";this.ctx.arc(_3c,_3d,2,0,2*Math.PI);this.ctx.fill();}else{this.ctx.beginPath();var _3e=this.styleObj[_39];if(_3e){if(_3e.type=="fill"){this.ctx.fillStyle=_3e.paint["fill-color"];this.ctx.moveTo(_3c,_3d);for(var i=2;i<_36.length-2;i=i+2){var _3f,_40;_3f=_36[i]/16+dx;_40=_36[i+1]/16+dy;this.ctx.lineTo(_3f,_40);}this.ctx.fill();}else{if(_3e.type=="line"){this.ctx.strokeStyle=_3e.paint["line-color"];this.ctx.lineWidth=_3e.paint["line-width"];this.ctx.moveTo(_3c,_3d);for(var i=2;i<_36.length-2;i=i+2){var _3f,_40;_3f=_36[i]/16+dx;_40=_36[i+1]/16+dy;this.ctx.lineTo(_3f,_40);}this.ctx.stroke();}else{if(_3e.type=="symbol"){}}}}}}});});