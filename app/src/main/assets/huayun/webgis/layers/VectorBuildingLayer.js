//>>built
define("com/huayun/webgis/layers/VectorBuildingLayer",["../utils/Resource","./Layer","../work/Dispatcher","../views/3d/layers/VectorBuildingLayerView3D","./support/style/createStyleLayer","./support/VectorBuildSourceCache","../geometry/Extent","../geometry/Point","./support/LOD","./support/TileInfo","../utils/Constant","../utils/utils","../geometry/queryVectorFeatures"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d){var _e=function(_f){_2.call(this,_f);this.id=_f.id||"buildLayer";this.url=_f.url;this.name=_f.name||"建筑物图层";this.dispatcher=new _3(this);this.tileInfo=null;this.layerView=null;this._changed=false;this._updatedLayers={};this._removedLayers={};this._updatedSources={};this._updatedPaintProps={};this.maxLevel=_f.maxLevel;this.minLevel=_f.minLevel||11;};if(_2){_e.__proto__=_2;}_e.prototype=Object.create(_2&&_2.prototype);_e.prototype.constructor=_e;_e.prototype.createLayerView=function(_10,_11){var _12=new _4({visible:this.visible,view:_10,id:this.id,layer:this,minLevel:this.minLevel});_12.transform=_10.viewpoint;this.layerView=_12;this.loadMetaData(_10);return _12;};_e.prototype.loadMetaData=function(_13){_1.loadJson(this.url,function(_14,_15){if(_14){this.visible=false;return;}var _16=null;for(var id in _15.sources){_16=_15.sources[id].url;break;}var _17=_15.layers,_18;this._order=[];this._layers={};for(var i=0,ii=_17.length;i<ii;i+=1){_18=_17[i];this._order.push(_18.id);this._layers[_18.id]=_5(_18);}this.dispatcher.broadcast("setLayers",this._serializeLayers(this._order));_1.loadJson(_16,function(err,_19){if(err){this.visible=false;return;}this.sourceCache=new _6("vectorBuild",{type:"vector"},this.dispatcher,_13.width,_13.height,_19.tiles,this);this._read(_13,_19,{origin:"service"});}.bind(this));}.bind(this));};_e.prototype._serializeLayers=function(ids){var _1a=[];for(var i=0,_1b=ids;i<_1b.length;i+=1){var id=_1b[i];var _1c=this._layers[id];if(_1c.type!=="custom"){_1a.push(_1c.serialize());}}return _1a;};_e.prototype._read=function(_1d,_1e){var _1f=_1e.fullExtent;var _20=_1e.spatialReference;_1f=new _7(Number(_1f.xmin),Number(_1f.ymin),Number(_1f.xmax),Number(_1f.ymax),_20);var _21=_1e.tileInfo;var _22=_1e.tilesize;var dpi=_21.dpi,_23=_21.origin;_23=new _8(Number(_23.x),Number(_23.y));var _24=[];_21.lods.forEach(function(_25){_24.push(new _9({level:Number(_25.level),scale:Number(_25.scale),resolution:Number(_25.resolution)}));});this.tileInfo=new _a({lods:_24,origin:_23,size:_22});this.tileInfo.dpi=dpi;this.tileInfo.fullExtent=_1f;this.layerView.tileSize=_22;this.sourceCache.updateTileSize(_22);this.tilePixelRatio=_22/_b.layout.EXTENT;_1d.setTileInfo(this.tileInfo);};_e.prototype.setVisible=function(_26){this.visible=_26;this.layerView.setVisible(_26);};_e.prototype.setPaintProperty=function(_27,_28,_29,_2a){if(_2a===void 0){_2a={};}var _2b=this.getLayer(_27);if(_c.deepEqual(_2b.getPaintProperty(_28),_29)){return;}var _2c=_2b.setPaintProperty(_28,_29,_2a);if(_2c){this._updateLayer(_2b);}this._changed=true;this._updatedPaintProps[_27]=true;};_e.prototype.getLayer=function(id){return this._layers[id];};_e.prototype.setLayoutProperty=function(_2d,_2e,_2f,_30){if(_30===void 0){_30={};}var _31=this.getLayer(_2d);if(_c.deepEqual(_31.getLayoutProperty(_2e),_2f)){return;}_31.setLayoutProperty(_2e,_2f,_30);this._updateLayer(_31);};_e.prototype._updateWorkerLayers=function(_32,_33){this.dispatcher.broadcast("updateLayers",{layers:this._serializeLayers(_32),removedIds:_33});};_e.prototype._resetUpdates=function(){this._changed=false;this._updatedLayers={};this._removedLayers={};this._updatedSources={};this._updatedPaintProps={};};_e.prototype.update=function(_34){var _35=this._changed;if(this._changed){var _36=Object.keys(this._updatedLayers);var _37=Object.keys(this._removedLayers);if(_36.length||_37.length){this._updateWorkerLayers(_36,_37);}for(var id in this._updatedSources){var _38=this._updatedSources[id];if(_38==="reload"){this._reloadSource(id);}else{if(_38==="clear"){this._clearSource(id);}}}for(var _39 in this._updatedPaintProps){this._layers[_39].updateTransitions(_34);}this._resetUpdates();}this.sourceCache.used=false;for(var i=0,_3a=this._order;i<_3a.length;i+=1){var _3b=_3a[i];var _3c=this._layers[_3b];_3c.recalculate(_34);if(!_3c.isHidden(_34.zoom)&&_3c.source){this.sourceCache.used=false;}}this.z=_34.zoom;};_e.prototype._reloadSource=function(id){this.sourceCache.resume();this.sourceCache.reload();};_e.prototype._clearSource=function(id){this.sourceCache.clearTiles();};_e.prototype._updateLayer=function(_3d){this._updatedLayers[_3d.id]=true;if(_3d.source&&!this._updatedSources[_3d.source]){this._updatedSources[_3d.source]="reload";this.sourceCache.pause();}this._changed=true;};_e.prototype.queryFeaturesByGeometry=function(_3e,_3f){var _40=[];_3e=_3e.path[0];_40.push(_d.queryRenderedFeatures(this.sourceCache,this._layers,_3e,_3f,this.layerView.transform,false,this.layerView.view.resolution,this.layerView.view.level));return _40;};_e.prototype.setFeatureState=function(_41,_42){this.sourceCache.setFeatureState(_41.sourceLayer,_41.ids,_42);this.layerView.view.threeRender();};return _e;});