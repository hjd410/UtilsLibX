//>>built
define("com/huayun/webgis/layers/VelocityLayer",["./Layer","../views/3d/layers/VelocityLayerView3D"],function(_1,_2){var _3=function(_4){_1.call(this,_4);this.id=_4.id===undefined?"velocity":_4.id;this.opacity=_4.opacity===undefined?1:_4.opacity;this.visible=_4.visible===undefined?true:_4.visible;this.data=null;};if(_1){_3.__proto__=_1;}_3.prototype=Object.create(_1&&_1.prototype);_3.prototype.constructor=_3;_3.prototype.createLayerView=function(_5,_6){var _7=new _2({visible:this.visible,view:_5,id:this.id,opacity:this.opacity,layer:this});this.layerView=_7;_7.transform=_5.viewpoint;return _7;};_3.prototype.setData=function(_8){this.data=_8;this._buildGrid(_8);};_3.prototype._buildGrid=function(_9){this.builder=this._createBuilder(_9);var _a=this.builder.header;this.lonMin=_a.lo1;this.latMax=_a.la1;this.dx=_a.dx;this.dy=_a.dy;this.nx=_a.nx;this.ny=_a.ny;this.date=new Date(_a.refTime);this._grid=[];var p=0;for(var j=0;j<this.ny;j++){var _b=[];for(var i=0;i<this.nx;i++,p++){_b[i]=this.builder.data(p);}this._grid[j]=_b;}this.interpolateGrid={date:this.date,interpolate:this.interpolate};};_3.prototype._createBuilder=function(_c){var _d=null,_e=null,_f=null;_c.forEach(function(_10){switch(_10.header.parameterCategory+","+_10.header.parameterNumber){case "1,2":case "2,2":_d=_10;break;case "1,3":case "2,3":_e=_10;break;default:_f=_10;}});var _11=_d.data,_12=_e.data;return {header:_d.header,data:function _c(i){return [_11[i],_12[i]];},interpolate:this._bilinearInterpolateVector};};_3.prototype._bilinearInterpolateVector=function(x,y,g00,g10,g01,g11){var rx=1-x;var ry=1-y;var a=rx*ry,b=x*ry,c=rx*y,d=x*y;var u=g00[0]*a+g10[0]*b+g01[0]*c+g11[0]*d;var v=g00[1]*a+g10[1]*b+g01[1]*c+g11[1]*d;return [u,v,Math.sqrt(u*u+v*v)];};_3.prototype.repaint=function(){this.layerView.repaint();};_3.prototype.interpolate=function(x,y){if(!this._grid){return null;}var i=(x-this.lonMin)/this.dx,j=(this.latMax-y)/this.dy;var fi=Math.floor(i),ci=fi+1;var fj=Math.floor(j),cj=fj+1;var row=this._grid[fj];if(row){var g00=row[fi];var g10=row[ci];if(this._isValue(g00)&&this._isValue(g10)&&(row=this._grid[cj])){var g01=row[fi];var g11=row[ci];if(this._isValue(g01)&&this._isValue(g11)){return this.builder.interpolate(i-fi,j-fj,g00,g10,g01,g11);}}}return null;};_3.prototype._isValue=function(x){return x!==null&&x!==undefined;};_3.prototype.stop=function(){this.layerView.stop();};_3.prototype.setVisible=function(_13){this.visible=_13;this.layerView.setVisible(_13);};return _3;});