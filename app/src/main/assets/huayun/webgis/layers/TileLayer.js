//>>built
define("com/huayun/webgis/layers/TileLayer",["./Layer","../geometry/Extent","../views/3d/layers/TileLayerView3D","../geometry/Point","./support/TileSourceCache","./support/LOD","./support/TileInfo","../facade/TileFacade"],function(_1,_2,_3,_4,_5,_6,_7,_8){var _9=/(\/tile\/.+)/;var _a=function(_b){_1.call(this,_b);this.id=_b.id||"tileLayer";this.type="Tile";this.name=_b.name||"静态背景图";this.url=_b.url;this.visible=_b.visible===undefined?true:_b.visible;this.selectEnabled=false;this.loaded=false;this.tileInfo=null;this.layerView=null;this.sourceCache=null;this.maxLevel=_b.maxLevel;};if(_1){_a.__proto__=_1;}_a.prototype=Object.create(_1&&_1.prototype);_a.prototype.constructor=_a;_a.prototype.createLayerView=function(_c,_d){var _e=new _3({width:_c.width,height:_c.height,opacity:this.opacity,visible:this.visible,view:_c,id:this.id,layer:this});this._load(_c);this.layerView=_e;_e.transform=_c.viewpoint;return _e;};_a.prototype._load=function(_f){var _10=this.url.replace(_9,"");var _11=this.url.indexOf("?");if(_11>-1){var _12=this.url.substring(_11);_10=_10+_12+"&f=json";}else{_10=_10+"?f=json";}var _13=this;_8.getTileInfoData(_10,function(err,_14){if(err){_8.getTileInfoData(require.toUrl("com/huayun/webgis/layers/support/tileInfoData2385.json"),function(e,_15){if(e){throw new Error(e.message);}_13._resolve(_f,_15);});}else{_13._resolve(_f,_14);}});};_a.prototype._resolve=function(_16,_17){var _18=_17.tileInfo;var _19=_18.origin;_19=new _4(_19.x,_19.y);var _1a=[];_17.lods.forEach(function(_1b){_1a.push(new _6({level:_1b.level,scale:_1b.scale,resolution:_1b.resolution}));});var _1c=_17.fullExtent;var _1d=new _2(Number(_1c.xmin),Number(_1c.ymin),Number(_1c.xmax),Number(_1c.ymax));this.tileInfo=new _7({lods:_1a,origin:_19,size:_18.cols,fullExtent:_1d});var _1e={tileSize:this.tileInfo.size,type:"raster",minzoom:this.tileInfo.lods[0].level,maxzoom:this.tileInfo.lods[_1a.length-1].level};this.sourceCache=new _5(this.id,_1e,_16.width,_16.height,this.url,this);_16.setTileInfo(this.tileInfo);};_a.prototype.refresh=function(){this.layerView.view.threeRender();};_a.prototype.setVisible=function(_1f){this.visible=_1f;this.layerView.setVisible(_1f);};_a.prototype.setUrl=function(url){this.url=url;this.sourceCache.updateTileUrl(url);var ids=this.sourceCache.getIds();var _20=this.sourceCache;_20.clearOtherLevel(this.layerView.view.viewpoint.level);for(var i=0,_21=ids;i<_21.length;i+=1){var _22=_21[i];_20._reAddTile(_22);}};return _a;});