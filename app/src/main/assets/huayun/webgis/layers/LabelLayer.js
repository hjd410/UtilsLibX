//>>built
define("com/huayun/webgis/layers/LabelLayer","./Layer ./GraphicLayer ../Graphic ../Feature ../symbols/TextSymbol ../renderer/TextRenderer ../views/3d/layers/LabelLayerView3D ../geometry/Point ../utils/MathUtils".split(" "),function(t,v,w,A,x,y,z,r,q){function p(f){this.type="LabelLayer";this.id=f.id;this.renderer=new y;this.graphicsLayer=new v({id:this.id,renderer:this.renderer});this._layers=f.layers;this.state=!0;this.dataUpdate=!1;this.graphics=[]}var u=/\${(.*)}/g;t&&(p.__proto__=t);p.prototype=
Object.create(t&&t.prototype);p.prototype.constructor=p;p.prototype.addGraphic=function(f){this.graphicsLayer.addGraphic(f)};p.prototype.createLayerView=function(f){var d=new z({visible:!0,layer:this,view:f,id:this.id,graphicsLayerView:this.graphicsLayer.createLayerView(f)});this.layerView=d;d.transform=f.viewpoint;return d};p.prototype.handleGraphics=function(){this.graphics=[]};p.prototype.addTextGraphics=function(){if(this._layers)for(var f=0,d=this._layers.length;f<d;f++){var b=this._layers[f],
h=b.currentRule;if("FeatureLayer"===b.type&&h&&h.label&&!b.handleText){b.handleText=!0;var b=b.graphicsLayer.graphics,a=h.label;if(a.showLabel){var g=a.labelContent;if(void 0!==g){var e=g.text;u.lastIndex=0;if(u.test(e))for(var c=RegExp.$1,l=b.length-1;-1<l;l--){u.lastIndex=0;var m=b[l],n=m.getAttribute(c);if("undefined"!==typeof n){var k=new x(g.symbol);k.fixed={isFixed:h.isFixed,addratio:h.addratio};k.minScale=h.minScale;n=n&&n.value||"";n=e.replace(u,n);k.labelPlacement=a.labelPlacement;k.fixed.isFixed=
k.fixed.isFixed||h.label.fixedSize;n=this._formatLabel(k.fixed,h.minScale,this.layerView.view.scale,k.fontSize,n,a.labelPlacement);k.setText(n.text);k.rowNum=n.rowNum;k.oneW=n.oneW;k=this._createGraphic(m.feature,k);k.relateGraphic=m;this.graphicsLayer.addGraphic(k)}}}}}}};p.prototype.zoomEnd=function(f){this.addTextGraphics()};p.prototype.filterGraphics=function(){this.graphicsLayer.graphics.forEach(function(f){f.visible&&(f.visible=!!f.relateGraphic.symbol)})};p.prototype._formatLabel=function(f,
d,b,h,a,g){b=this._getRealScale(f,b,d);h*=b;for(d=f=0;d<a.length;d++)f=257>a.charCodeAt(d)?f+12:f+24;d="";if(null===g)return{text:a,rowNum:1,oneW:f};d=g.stackLabel;g=1;if(d&&d.autoWrap){d=d.wrapWidth;g=Math.ceil(f*h/24/(d*b));b*=d;var e={},c=0,l=1,m=!1;for(d=0;d<a.length;d++){c=h*l;if(c===b||c>b||1E-6>=Math.abs(c-b))e[d+1]="\r\n",l=0,m=!0;l++}d=this._insertTextAtIndices(a,e);m&&(f=24*Math.floor(b/h))}else d=a;return{text:d,rowNum:g,oneW:f}};p.prototype._getRealScale=function(f,d,b){if(f.isFixed||
0===b)return 1;if(0===f.addratio)return d/b;if(0<f.addratio)return 1+d/b*f.addratio};p.prototype._insertTextAtIndices=function(f,d){return f.replace(/./g,function(b,f){return d[f]?d[f]+b:b})};p.prototype._createGraphic=function(f,d){return new w({feature:f,symbol:d})};p.prototype.queryGraphicsByGeometry=function(f,d){return null};p.prototype.setVisible=function(f){this.visible=f;this.graphicsLayer.visible=f;this.layerView.setVisible(f)};p.prototype.revisePosition=function(f){var d=this;d.prevHandle&&
d.prevHandle();this.graphics=[];this.graphicsLayer.graphics.forEach(function(b){var h=b.relateGraphic;if(h&&!h.symbol)b.visible=!1;else{b.visible=!0;var a,g=b.feature.geometry,e,c=0,l=b.symbol;b.isLC?(h=b.isLC,b.selectEnabled=!0):(h=!1,b.selectEnabled=!1);var m=f.resolution,n=d._getRealScale(l.fixed,d.layerView.view.scale,l.minScale);a=l.fontSize*n;var k=l.oneW*a/24*m,m=l.height*a/24*m*l.rowNum;e=(l=(l=l.labelPlacement)&&l.position)&&l.layout;l=0;l=0*n;e&&(e=e.toLowerCase());if(h)switch(g.type){case "point":a=
d.getGraphicSizeWithPoint(f,g,b);e&&"best"!==e?e=d.getScreenLevelByOrientation(e):(c=[],c=d.getNewBestScreenLevel(f,k,m,a),e=c[0],c=c[1]);for(;0>e;)c=[],c=d.getNewBestScreenLevel(f,k,m,a),e=c[0],c=c[1];b.visible=!0;c=d.chooseBestScreenPoint(e,c,k,m,a,l);l=b.position;a=b.initPosition;"undefined"!==typeof a&&(l[0]=a[0]+c.x-g.x,l[1]=a[1]+c.y-g.y,k={id:b.id,g:b,minX:c.x-k/2,minY:c.y-m/2,maxX:c.x+k/2,maxY:c.y+m/2},d.graphics.push(k),f.insertItems([k]));d.callback&&h&&d.callback(g,c,b);break;case "multipoint":n=
g.points;g=d.getMultiPointOfCenter(b,n);a=d.getGraphicSizeWithPoint(f,g,b);e&&"best"!==e?e=d.getScreenLevelByOrientation(e):(c=[],c=d.getNewBestScreenLevel(f,k,m,a),e=c[0],c=c[1]);for(;0>e;)c=[],c=d.getNewBestScreenLevel(f,k,m,a),e=c[0],c=c[1];b.visible=!0;c=d.chooseBestScreenPoint(e,c,k,m,a,l);l=b.position;a=b.initPosition;n=n[1];l[0]=a[0]+c.x-n.x;l[1]=a[1]+c.y-n.y;k={id:b.id,g:b,minX:c.x-k/2,minY:c.y-m/2,maxX:c.x+k/2,maxY:c.y+m/2};d.graphics.push(k);f.insertItems([k]);d.callback&&h&&d.callback(g,
c,b);break;case "line":n=g.path;g=d.getLineCenterPoint(n);a=d.getGraphicSizeWithPoint(f,g,b);e&&"best"!==e?e=d.getScreenLevelByOrientation(e):(c=[],c=d.getNewBestScreenLevel(f,k,m,a),e=c[0],c=c[1]);for(;0>e;)c=[],c=d.getNewBestScreenLevel(f,k,m,a),e=c[0],c=c[1];b.visible=!0;c=d.chooseBestScreenPoint(e,c,k,m,a,l);l=b.position;a=b.initPosition;l[0]=a[0]+c.x-g.x;l[1]=a[1]+c.y-g.y;k={id:b.id,g:b,minX:c.x-k/2,minY:c.y-m/2,maxX:c.x+k/2,maxY:c.y+m/2};d.graphics.push(k);f.insertItems([k]);d.callback&&h&&
d.callback(g,c,b);break;case "polygon":n=g.path;g=q.calculateCoreOfPolygon(n[0]);if("inside"===e)c=q.calculateCoreOfPolygon(n[0]);else if("outside"===e){a=d.getGraphicSizeWithPoint(f,g,b,!0);for(e=-1;0>e;)c=[],c=d.getNewBestScreenLevel(f,k,m,a),e=c[0],c=c[1];b.visible=!0;c=d.chooseBestScreenPoint(e,c,k,m,a,l)}else c=q.calculateCoreOfPolygon(n[0]);l=b.position;a=b.initPosition;l[0]=a[0]+c.x-g.x;l[1]=a[1]+c.y-g.y;k={id:b.id,g:b,minX:c.x-k/2,minY:c.y-m/2,maxX:c.x+k/2,maxY:c.y+m/2};f.insertItems([k]);
d.graphics.push(k);d.callback&&h&&d.callback(g,c,b);break;case "multipolygon":g=g.getMaxAreaPolygon(),c=q.calculateCoreOfPolygon(g.path[0]),(n=f.checkExtentState(c.x-k/2,c.y-m/2,c.x+k/2,c.y+m/2,!1))?b.visible=!1:(b.visible=!0,g=q.calculateCoreOfPolygon(g.path[0]),l=b.position,a=b.initPosition,l[0]=a[0]+c.x-g.x,l[1]=a[1]+c.y-g.y,k={id:b.id,g:b,minX:c.x-k/2,minY:c.y-m/2,maxX:c.x+k/2,maxY:c.y+m/2},d.graphics.push(k),f.insertItems([k]),d.callback&&h&&d.callback(g,c,b))}else switch(g.type){case "point":a=
d.getGraphicSizeWithPoint(f,g,b);e=e&&"best"!==e?d.getScreenLevelByOrientation(e):d.getBestScreenLevel(f,k,m,a);0>e?b.visible=!1:(b.visible=!0,c=d.chooseBestScreenPoint(e,c,k,m,a,l),l=b.position,a=b.initPosition,"undefined"!==typeof a&&(l[0]=a[0]+c.x-g.x,l[1]=a[1]+c.y-g.y,f.insertItems([{id:b.id,g:b,minX:c.x-k/2,minY:c.y-m/2,maxX:c.x+k/2,maxY:c.y+m/2}])));break;case "multipoint":n=g.points;g=d.getMultiPointOfCenter(b,n);a=d.getGraphicSizeWithPoint(f,g,b);e=e&&"best"!==e?d.getScreenLevelByOrientation(e):
d.getBestScreenLevel(f,k,m,a);0>e?b.visible=!1:(b.visible=!0,c=d.chooseBestScreenPoint(e,c,k,m,a,l),l=b.position,a=b.initPosition,n=n[1],l[0]=a[0]+c.x-n.x,l[1]=a[1]+c.y-n.y,f.insertItems([{id:b.id,g:b,minX:c.x-k/2,minY:c.y-m/2,maxX:c.x+k/2,maxY:c.y+m/2}]));break;case "line":n=g.path;g=d.getLineCenterPoint(n);a=d.getGraphicSizeWithPoint(f,g,b);e=e&&"best"!==e?d.getScreenLevelByOrientation(e):d.getBestScreenLevel(f,k,m,a);0>e?b.visible=!1:(b.visible=!0,c=d.chooseBestScreenPoint(e,c,k,m,a,l),l=b.position,
a=b.initPosition,l[0]=a[0]+c.x-g.x,l[1]=a[1]+c.y-g.y,f.insertItems([{id:b.id,g:b,minX:c.x-k/2,minY:c.y-m/2,maxX:c.x+k/2,maxY:c.y+m/2}]));break;case "polygon":n=g.path;g=q.calculateCoreOfPolygon(n[0]);if("inside"===e)c=q.calculateCoreOfPolygon(n[0]);else if("outside"===e)if(a=d.getGraphicSizeWithPoint(f,g,b,!0),e=d.getBestScreenLevel(f,k,m,a),0>e){b.visible=!1;break}else b.visible=!0,c=d.chooseBestScreenPoint(e,c,k,m,a,l);else c=q.calculateCoreOfPolygon(n[0]);l=b.position;a=b.initPosition;l[0]=a[0]+
c.x-g.x;l[1]=a[1]+c.y-g.y;f.insertItems([{id:b.id,g:b,minX:c.x-k/2,minY:c.y-m/2,maxX:c.x+k/2,maxY:c.y+m/2}]);break;case "multipolygon":g=g.getMaxAreaPolygon(),c=q.calculateCoreOfPolygon(g.path[0]),(n=f.checkExtentState(c.x-k/2,c.y-m/2,c.x+k/2,c.y+m/2,!1))?b.visible=!1:(b.visible=!0,g=q.calculateCoreOfPolygon(g.path[0]),l=b.position,a=b.initPosition,l[0]=a[0]+c.x-g.x,l[1]=a[1]+c.y-g.y,f.insertItems([{id:b.id,g:b,minX:c.x-k/2,minY:c.y-m/2,maxX:c.x+k/2,maxY:c.y+m/2}]))}}})};p.prototype.getScreenLevelByOrientation=
function(f){f=f.toLowerCase();switch(f){case "south":return 0;case "north":return 1;case "east":return 2;case "west":return 3;case "southeast":return 4;case "southwest":return 5;case "northeast":return 6;case "northwest":return 7;case "centered":return 8;default:return-1}};p.prototype.getMultiPointOfCenter=function(f,d){return f.relateGraphic.drawCenterPoint||d[1]};p.prototype.getLineCenterPoint=function(f){return q.calculateCenterOfLine(f[0]).center};p.prototype.chooseBestScreenPoint=function(f,
d,b,h,a,g){if(!a[f])return null;a=a[f].position;var e=new r;switch(f){case 0:e.x=a.x;e.y=a.y-(h*(.5+d)+g);break;case 1:e.x=a.x;e.y=a.y+h*(.5+d)+g;break;case 2:e.x=a.x+b*(.5+d)+g;e.y=a.y;break;case 3:e.x=a.x-b*(.5+d)-g;e.y=a.y;break;case 4:e.x=a.x+b*(.5+d)+g;e.y=a.y-(h*(.5+d)+g);break;case 5:e.x=a.x-b*(.5+d)-g;e.y=a.y-(h*(.5+d)+g);break;case 6:e.x=a.x+b*(.5+d)+g;e.y=a.y+h*(.5+d)+g;break;case 7:e.x=a.x-b*(.5+d)-g;e.y=a.y+h*(.5+d)+g;break;default:e.x=a.x,e.y=a.y}return e};p.prototype.getGraphicSizeWithPoint=
function(f,d,b,h){var a=f.queryGraphicSizeByPoint(d,h);if(Infinity===a.width||Infinity===a.height)a=b.relateGraphic.extent;var g=(a.xmin+a.xmax)/2,e=(a.ymin+a.ymax)/2;b=new r(g,a.ymin);f=new r(g,a.ymax);d=new r(a.xmax,e);h=new r(a.xmin,e);var c=new r(a.xmax,a.ymin),l=new r(a.xmin,a.ymin),m=new r(a.xmax,a.ymax),a=new r(a.xmin,a.ymax),g=new r(g,e),e=[];e[0]={position:b,level:0,layer:0};e[1]={position:f,level:1,layer:0};e[2]={position:d,level:2,layer:0};e[3]={position:h,level:3,layer:0};e[4]={position:c,
level:4,layer:0};e[5]={position:l,level:5,layer:0};e[6]={position:m,level:6,layer:0};e[7]={position:a,level:7,layer:0};e[8]={position:g,level:8,layer:0};return e};p.prototype.getNewBestScreenLevel=function(f,d,b,h){for(var a=0;a<h.length;a++){if(!this._checkBestPositionState(f,h[a],d,b))return[h[a].level,h[a].layer];h[a].layer++}return[-1,0]};p.prototype.getBestScreenLevel=function(f,d,b,h){for(var a=0;a<h.length;a++)if(!this._checkBestPositionState(f,h[a],d,b))return h[a].level;return-1};p.prototype._checkBestPositionState=
function(f,d,b,h){var a=d.position;return a?this._checkCellStateWithLevel(f,d.level,d.layer,a,b,h):!0};p.prototype._checkCellStateWithLevel=function(f,d,b,h,a,g){var e,c;switch(d){case 0:return d=h.x-a*(.5+b),a=h.x+a*(.5+b),e=h.y-g*(1+b)-1E-6,c=h.y-g*(0+b)-1E-6,f.checkExtentState(d,e,a,c,!0);case 1:return d=h.x-a*(.5+b),a=h.x+a*(.5+b),e=h.y+g*(0+b)+1E-6,c=h.y+g*(1+b)+1E-6,f.checkExtentState(d,e,a,c,!0);case 2:return d=h.x+a*(0+b)+1E-6,a=h.x+a*(1+b)+1E-6,e=h.y-g*(.5+b),c=h.y+g*(.5+b),f.checkExtentState(d,
e,a,c,!0);case 3:return d=h.x-a*(1+b)-1E-6,a=h.x-a*(0+b)-1E-6,e=h.y-g*(.5+b),c=h.y+g*(.5+b),f.checkExtentState(d,e,a,c,!0);case 4:return d=h.x+a*(0+b)+1E-6,a=h.x+a*(1+b)+1E-6,c=h.y-g*(0+b)-1E-6,e=h.y-g*(1+b)-1E-6,f.checkExtentState(d,e,a,c,!0);case 5:return d=h.x-a*(1+b)-1E-6,a=h.x-a*(0+b)-1E-6,e=h.y-g*(1+b)-1E-6,c=h.y-g*(0+b)-1E-6,f.checkExtentState(d,e,a,c,!0);case 6:return d=h.x+a*(0+b)+1E-6,a=h.x+a*(1+b)+1E-6,e=h.y+g*(0+b)+1E-6,c=h.y+g*(1+b)+1E-6,f.checkExtentState(d,e,a,c,!0);case 7:return d=
h.x-a*(1+b)-1E-6,a=h.x-a*(0+b)-1E-6,e=h.y+g*(0+b)+1E-6,c=h.y+g*(1+b)+1E-6,f.checkExtentState(d,e,a,c,!0);case 8:return!0}};p.prototype.removeGraphic=function(f){this.graphicsLayer.removeGraphic(f)};p.prototype.clear=function(f){this.graphicsLayer.clear(f)};return p});