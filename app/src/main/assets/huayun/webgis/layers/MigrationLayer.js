//>>built
define("com/huayun/webgis/layers/MigrationLayer",["require","./Layer","../views/3d/layers/MigrationLayerView3D","../geometry/Point","../geometry/Multipoint","../geometry/Polyline","../symbols/CanvasSymbol","../symbols/LineSymbol","../symbols/ImageSymbol","../symbols/TextSymbol","../Feature","../Graphic","../utils/geometryGenerate","../data/GraphicIndex","../views/3d/AnimateGraphicsView"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f){var _10=function(_11){_2.call(this,_11);this.id=_11.id===undefined?"migration":_11.id;this.graphics=[];this.iconGraphics=[];this.graphicIndex=new _e();this.geometryArr=[];this.visible=_11.visible===undefined?true:_11.visible;this.animate=_11.animate===undefined?true:_11.animate;this.iconPosition=_11.iconPosition;this.segment=_11.segment===undefined?50:_11.segment;this.speed=_11.gapTime===undefined?50:_11.gapTime;this.curvature=_11.curvature===undefined?4:_11.curvature;this.moveLine=!!_11.moveLine;this.textStyle=_11.textStyle||{color:"#000",size:12};this.showLineName=!!_11.showLineName;if(_11.nodeSymbol){this.nodeSymbol=_11.nodeSymbol;}else{this.nodeSymbol=new _7({width:40,height:40,render:function(){var _12=1000;var t=(performance.now()%_12)/_12;var _13=(this.width/2)*0.3;var _14=(this.width/2)*0.7*t+_13;var ctx=this.ctx;ctx.clearRect(0,0,this.width,this.height);ctx.beginPath();ctx.arc(this.width/2,this.height/2,_14,0,Math.PI*2);ctx.fillStyle="rgba(255, 200, 200, "+(1-t)+")";ctx.fill();ctx.beginPath();ctx.arc(this.width/2,this.height/2,_13,0,Math.PI*2);ctx.fillStyle="rgba(255, 100, 100, 1)";ctx.strokeStyle="white";ctx.lineWidth=1;ctx.fill();ctx.stroke();return ctx.getImageData(0,0,this.width,this.height).data;}});}if(_11.lineSymbol){this.lineSymbol=_11.lineSymbol;}else{this.lineSymbol=new _8({color:"#0000FF",width:2});}if(_11.iconSymbol){this.iconSymbol=_11.iconSymbol;}else{this.iconSymbol=new _9({url:_1.toUrl("com/huayun/webgis/css/images/feijichang.png"),width:20,height:20,isRotate:true});}if(_11.moveLineSymbol){this.moveLineSymbol=_11.moveLineSymbol;}else{this.moveLineSymbol=new _8({color:"#ffffff",width:6.5,length:16});}if(_11.data){this.setData(_11.data);}};if(_2){_10.__proto__=_2;}_10.prototype=Object.create(_2&&_2.prototype);_10.prototype.constructor=_10;_10.prototype.createLayerView=function(_15,_16){var _17=new _3({visible:this.visible,view:_15,id:this.id,layer:this});this.layerView=_17;_17.transform=_15.viewpoint;this.graphics.forEach(function(_18){this.layerView.addGraphic(_18);}.bind(this));this.iconGraphics.forEach(function(_19){this.layerView.addGraphic(_19);}.bind(this));if(this.graphics.length>0){this._repaint();}return _17;};_10.prototype.setData=function(_1a){this.geometryArr=[];this.iconGraphics=[];this.graphics=[];this.indexNeedUpdate=true;this.data=_1a;this.addGraphics(this.data);};_10.prototype.addGraphics=function(_1b){var _1c=0;var _1d=[];var _1e=Math.round(this.segment/2);this.lineData=[];this.moveLineData=[];var _1f=this.lineSymbol.width+this.textStyle.size;for(var id in _1b){var _20=_1b[id];var p=_20.geometry.coordinates;p=new _4(p[0],p[1]);_1d.push(p);this.geometryArr.push({feature:{attributes:_20,geometry:p},symbol:this.nodeSymbol,id:_1c,visible:true});_1c++;var _21=_20.flows;var _22,_23;var _24={};for(var j=0,jj=_21.length;j<jj;j++){_22=_21[j];var _25=_22.curvature;if(!_25){var _26=_24[_22.to];if(_26){_24[_22.to]=_26+1;}else{_24[_22.to]=1;}_25=this.curvature*_24[_22.to];}_23=_1b[_22.to].geometry.coordinates;var _27=new _4(_23[0],_23[1]);var _28=_d.generateBezierCurveByTwoPoints(p,_27,this.segment,_25);var _29=_28.line;var _2a=_28.normal;this.lineData.push(_29.path[0]);if(this.moveLine){this.moveLineData.push([p,_28.middle,_27]);}var _2b=new _b({attributes:_22.lineConfig,geometry:_29});var _2c=new _c({feature:_2b,symbol:this.lineSymbol});this.graphics.push(_2c);this.geometryArr.push(_2c);if(this.showLineName){var _2d=_22.lineConfig.lineName;var _2e=_29.path[0][_1e];var _2f=_29.path[0][_1e+1];var _30=new _a({text:_2d,color:this.textStyle.color,size:this.textStyle.size,isRotate:true,rotateRadian:_2e.angleTo(_2f)});_30.setOffset([_2a.x*_1f,_2a.y*_1f]);var _31=new _b({attributes:{name:_2d},geometry:_2e});var _32=new _c({feature:_31,symbol:_30});this.graphics.push(_32);}}}var _33=new _5(_1d);var _34=new _b({attributes:null,geometry:_33});var _35=new _c({feature:_34,symbol:this.nodeSymbol});this.graphics.push(_35);var geo;var _36;var _37;for(var i=0,ii=this.lineData.length;i<ii;i++){if(this.iconPosition){switch(this.iconPosition){case _10.START:geo=this.lineData[i][0];_36=this.lineData[i][1];_37=geo.angleTo(_36)+Math.PI/2;break;case _10.END:geo=this.lineData[i][this.segment-2];_36=this.lineData[i][this.segment-1];_37=geo.angleTo(_36)+Math.PI/2;geo=_36;break;default:geo=this.lineData[i][_1e];_36=this.lineData[i][_1e+1];_37=geo.angleTo(_36)+Math.PI/2;break;}}else{geo=this.lineData[i][0];_36=this.lineData[i][1];}var _38=new _b({attributes:null,geometry:geo});var _39=new _c({feature:_38,symbol:this.iconSymbol});_39.curPos=geo;_39.radian=_37;this.iconGraphics.push(_39);}if(this.moveLine){var _3a=new _6(this.moveLineData);_34=new _b({attributes:{},geometry:_3a});_35=new _c({feature:_34,symbol:this.moveLineSymbol,renderer:_f});this.graphics.push(_35);}if(this.layerView){this.graphics.forEach(function(_3b){this.layerView.addGraphic(_3b);}.bind(this));this.iconGraphics.forEach(function(_3c){this.layerView.addGraphic(_3c);}.bind(this));if(this.graphics.length>0){this._repaint();}}};_10.prototype._repaint=function(){if(!this.animate||this.interval){this.layerView.view.threeRender();}else{var _3d=0;var obj=this;var _3e=this.layerView.view;this.interval=setInterval(function(){_3d++;if(_3d>obj.segment-2){_3d=0;}obj.iconGraphics.forEach(function(_3f,_40){if(!obj.iconPosition){var _41=obj.lineData[_40][_3d];var p=obj.lineData[_40][_3d+1];_3f.radian=_41.angleTo(p)+Math.PI/2;_3f.updatePosition(_41.x-_3f.curPos.x,_41.y-_3f.curPos.y);_3f.curPos=_41;}if(obj.moveLine){obj.moveLineSymbol.uniforms.ratio=(obj.moveLineSymbol.uniforms.ratio+0.00005*obj.speed)%1;}});_3e.threeRender();},obj.speed);}};_10.prototype.setVisible=function(_42){if(_42&&!this.interval){this._repaint();}if(!_42){clearInterval(this.interval);this.interval=null;}};_10.prototype.queryFeaturesByGeometry=function(_43,_44){if(this.indexNeedUpdate){this.graphicIndex.clear();this.geometryArr.forEach(function(_45){var _46;switch(_45.symbol.type){case "point":_46=[[_45.feature.geometry]];break;case "circle":_46=[[_45.feature.geometry.center]];break;case "text":return;case "canvas":case "image":_46=[[_45.feature.geometry]];break;default:_46=_45.feature.geometry.path;}this.graphicIndex.insert(_46,_45.id);}.bind(this));this.indexNeedUpdate=false;}_44=_44||this.queryPadding;switch(_43.type){case "point":_43=[_43];break;}return this.graphicIndex.queryRender(_43,_44,this.geometryArr,this.layerView.view.resolution,this.layerView.view.viewpoint);};_10.START=0;_10.CENTER=1;_10.END=2;return _10;});