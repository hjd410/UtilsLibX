//>>built
define("com/huayun/webgis/layers/MapImageLayer",["dojo/_base/declare","dojo/topic","dojo/request","../data/GraphicIndex","./Layer","../request","../facade/PowerFacade","../geometry/Point","../geometry/Polyline","../geometry/Multipoint","../geometry/Polygon","../views/3d/layers/MapImageLayerView3D","../utils/Resource"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d){return _1("com.huayun.webgis.layers.MapImageLayer",[_5],{type:"Image",name:"动态图层",spatialReference:null,sublayers:null,_powerFacade:null,_results:null,constructor:function(_e){_1.safeMixin(this,_e);if(_e.filterLayer){this.filter=_e.filterLayer;}else{if(_e.options&&_e.options.filterLayer){this.filter=_e.options.filterLayer;}else{this.filter=null;}}this.id=_e.id?_e.id:"power";this.selectEnabled=true;this.url=_e.url;this.initUrl=this.url;this._initUrl=this.url.substring(0,this.url.indexOf("?"));this._initUrl=this._initUrl.substring(0,this._initUrl.lastIndexOf("/"));this.token=RegExp(/access[\u0000-\u00ff]+(&|$)/g).exec(this.url)===null?"":RegExp(/access[\u0000-\u00ff]+(&|$)/g).exec(this.url)[0];this.sublayers=[];this.layerData={};this.tolerance=_e.tolerance?_e.tolerance:5;this.identifyType="visible";this._powerFacade=new _7({url:this.url});this._getMapInfoMethod();this.graphicIndex=new _4();this.indexNeedUpdate=true;this._filterUse=false;this.maxLevel=_e.maxLevel;this.getFilterData();},createLayerView:function(_f,_10){var _11=new _c({width:_f.width,height:_f.height,opacity:this.opacity,visible:this.visible,view:_f,id:this.id,layer:this});this.layerView=_11;_11.transform=_f.viewpoint;return _11;},_getMapInfoMethod:function(){this._powerFacade.getMapInfoData(function(_12){this.sublayers=_12["layers"];}.bind(this),function(_13){}.bind(this));},_setVisibleAttr:function(_14){this.layerView.setVisible(_14);},fetchImage:function(_15,_16,_17){_16=this.getImageUrl(_15,_16,_17);var _18=dojoConfig.token;var _19=_18?{headers:{"access-key":_18}}:undefined;return _d.loadImagePromise(_16,_19);},getFilterData:function(){if(this.filter){_3.get(this.filter,{handleAs:"json"}).then(function(_1a){for(var i=0;i<_1a.data.length;i++){var key=_1a.data[i].level;var _1b=_1a.data[i].layers.join();this.layerData[key]=_1b;}if(this._filterUse){this.getMSCdata(this.layerView.view.getExtent());}}.bind(this));}},getMSCdata:function(_1c){if(this.filter){if(!this._filterUse){this._filterUse=true;return;}this._filterUse=true;var _1d=this.layerView.view.level;var _1e=this.layerData[_1d];if(_1e){if(_1e.length===0){this._results=null;}else{var url=this._initUrl+"/identify?layers="+_1e+"&"+this.token+"&f=json&geometryType=esriGeometryEnvelope&geometry="+_1c.minx+","+_1c.miny+","+_1c.maxx+","+_1c.maxy+"&tolerance="+this.tolerance;return _3.get(url,{handleAs:"json"}).then(function(_1f){this.indexNeedUpdate=true;this._results=_1f.results;}.bind(this));}}}},queryFeaturesByGeometry:function(_20,_21){if(this._results){if(this.indexNeedUpdate){this.graphicIndex.clear();this._results.forEach(function(_22){var _23;switch(_22.geometryType){case "esriGeometryPoint":_23=_22.geometry;_22.feature=new _8(_23.x,_23.y);_23=[[_22.feature]];break;case "esriGeometryMultipoint":var _24=_22.geometry.points.map(function(_25){return new _8(_25[0],_25[1]);});_22.feature=new _a(_24);_23=[_22.feature.points];break;case "esriGeometryPolyline":var _26=_22.geometry.paths.map(function(_27){return _27.map(function(p){return new _8(p[0],p[1]);});});_22.feature=new _9(_26);_23=_22.feature.path;break;default:_23=new _b(_22.geometry.rings).path;_22.feature=new _b(_22.geometry.rings);}this.graphicIndex.insertMsc(_23,_22);}.bind(this));this.indexNeedUpdate=false;}_21=_21||this.tolerance;switch(_20.type){case "point":_20=[_20];break;case "polygon":_20=[_20];break;}return this.graphicIndex.queryMsc(_20,_21,this.layerView.view.resolution,this.layerView.view.viewpoint);}return null;},getImageUrl:function(_28,_29,_2a){var _2b=/\{minx\}/;var _2c=/\{miny\}/;var _2d=/\{maxx\}/;var _2e=/\{maxy\}/;var _2f=/\{w\}/;var _30=/\{h\}/;var _31=this.url.replace(_2b,_28.minx);_31=_31.replace(_2c,_28.miny);_31=_31.replace(_2d,_28.maxx);_31=_31.replace(_2e,_28.maxy);_31=_31.replace(_2f,_29);_31=_31.replace(_30,_2a);return _31;},setUrl:function(url){this.url=url;this._initUrl=this.url.substring(0,this.url.indexOf("?"));this._initUrl=this._initUrl.substring(0,this._initUrl.lastIndexOf("/"));},setFilter:function(_32){if(_32){if(_32 instanceof Object){for(var key in _32){if(this.initUrl.indexOf("?")>0){this.url=this.initUrl+"&"+key+"="+_32[key];}else{this.url=this.initUrl+"?"+key+"="+_32[key];}}}else{this.url=this.initUrl+_32;}}else{this.url=this.initUrl;}},refresh:function(){this.layerView.refresh();},setVisible:function(_33){_2.publish("mapImageLayerVisibleChange",_33,this.id);this.layerView.setVisible(_33);},setOpacity:function(_34){this.layerView.setOpacity(_34);},getBounds:function(_35){if(_35.type==="point"){return {xmin:_35.x,ymin:_35.y,xmax:_35.x,ymax:_35.y};}else{return _35.extent;}}});});